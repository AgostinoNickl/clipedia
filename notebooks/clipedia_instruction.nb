(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 13.2' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[    510965,      11343]
NotebookOptionsPosition[    494265,      11107]
NotebookOutlinePosition[    494710,      11124]
CellTagsIndexPosition[    494667,      11121]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell[TextData[StyleBox["CLIPedia Building Manual",
 FontSize->36,
 FontWeight->"Bold",
 FontColor->RGBColor[0., 0., 0.]]], "Subtitle",
 CellChangeTimes->{{3.899963859343124*^9, 3.899963864923728*^9}, {
   3.899987107019384*^9, 3.8999871160106163`*^9}, {3.900384093368415*^9, 
   3.9003840936376147`*^9}, 3.900384129286695*^9, {3.9003841714232264`*^9, 
   3.900384182613977*^9}, {3.904466857952484*^9, 3.904466922224772*^9}, 
   3.90446706636226*^9, {3.904546744951761*^9, 3.904546750998646*^9}, 
   3.905013397916657*^9, 3.905015000439328*^9, {3.905068584250581*^9, 
   3.905068585326581*^9}, 3.905078145167767*^9, 3.9054967468875723`*^9, {
   3.905839703541869*^9, 3.905839704486261*^9}, {3.91970813097229*^9, 
   3.919708171673967*^9}, {3.919708948649808*^9, 3.9197089488529615`*^9}, 
   3.919709434248659*^9, {3.919784389103811*^9, 3.919784393544221*^9}, {
   3.919786662498159*^9, 3.919786667317017*^9}, {3.919956634012026*^9, 
   3.9199566608850727`*^9}, {3.919970125120337*^9, 3.919970129298948*^9}, {
   3.935473661334729*^9, 3.9354736896455584`*^9}, {3.9355664759759007`*^9, 
   3.9355664785343027`*^9}, {3.940522161189048*^9, 3.9405221622230587`*^9}, {
   3.940608915475966*^9, 3.9406089259133663`*^9}, 3.9406095278506527`*^9, {
   3.940610228663659*^9, 3.9406102452849483`*^9}, {3.942236058960567*^9, 
   3.942236061481798*^9}, {3.9613109368208027`*^9, 3.9613109380483427`*^9}, {
   3.96131109810781*^9, 3.9613110990789127`*^9}, {3.961338620035666*^9, 
   3.9613386261267767`*^9}, {3.961426860552054*^9, 3.961426864441001*^9}, {
   3.961470162278582*^9, 3.961470206883325*^9}, {3.96147259277564*^9, 
   3.961472597030876*^9}, {3.961472956568712*^9, 3.961472960802991*^9}},
 FontSize->25,ExpressionUUID->"5ed89776-d21c-4e98-9c6c-7fac37757c5a"],

Cell[TextData[{
 "Published by Agostino Nickl, 2025, under the MIT License, in tandem with \
the paper Nickl, Agostino, \[OpenCurlyDoubleQuote]Navigating CLIPedia: \
Architectonic Instruments for Querying and Questing a Latent Encyclopedia,\
\[CloseCurlyDoubleQuote] Frontiers of Architectural Research (forthcoming). \
For more information, refer to the paper and the README.md. \n\n",
 StyleBox["Note: ",
  FontWeight->"Bold"],
 "Building CLIPedia from raw Wikipedia dumps is a complex, iterative, and \
non-linear process that can unfold over several months. However, by following \
the steps outlined below and using the specialized functions provided in this \
notebook, advanced users can construct their own version of CLIPedia, \
matching the scale and key parameters described in the paper. This notebook \
runs by default in a small-scale demo mode (~10 batches, ca. 3-4 hours of \
processing) for demonstration and testing; to scale to the full ~250,000 \
Wikipedia batches, follow the comments in the code to remove limits. In such \
a small-scale run, features like the large SOM size, long-term stability \
functions, crash logging, and memory optimization strategies are excessive \
\[LongDash] but they become essential when working with the complete dataset. \
This build process assumes coding experience; working with millions of \
external datapoints means occasional corruptions, network failures, or \
partial runs are normal. Users can typically choose to ignore small failures \
and sacrifice datapoints, or address them manually.\n\n",
 StyleBox["Requirements:",
  FontWeight->"Bold"],
 " This notebook was tested on Mathematica 13.2.1, Apple M1 Max (64\:202fGB \
RAM), and while designed for memory efficiency, building CLIPedia \[LongDash] \
especially from the full dataset \[LongDash] benefits from strong hardware. \
Most of the pretrained CLIPedia build was performed on a Windows workstation \
(64\:202fGB RAM, GTX 3080\:202fTi), which allowed for GPU acceleration during \
encoding. The demo can also work on CPU, but it requires ca. 30GB of free \
disk space, including the Wikipedia dumps. To build a full CLIPedia, 600-800 \
GB of free disk space are required. \n\n",
 StyleBox["Licenses and Credits:",
  FontWeight->"Bold"],
 "\n- CLIPedia Code: \[Copyright] 2025 Agostino Nickl, MIT License.\n- \
Wikipedia Dumps: \[Copyright] Wikimedia Foundation, licensed under Creative \
Commons Attribution-ShareAlike (CC BY-SA 4.0). \
https://dumps.wikimedia.org/legal.html\n- OpenCLIP models: \[Copyright] \
2012-2021 Gabriel Ilharco, Mitchell Wortsman, Nicholas Carlini, Rohan Taori, \
Achal Dave, Vaishaal Shankar, John Miller, Hongseok Namkoong, Hannaneh \
Hajishirzi, Ali Farhadi, Ludwig Schmidt. \
https://github.com/mlfoundations/open_clip/blob/main/LICENSE.\nUsers are \
responsible for complying with external data and model licenses if \
redistributing or repackaging."
}], "Text",
 CellChangeTimes->{{3.96125194944234*^9, 3.9612521572845*^9}, {
   3.961252388025564*^9, 3.961252390569215*^9}, {3.961252541877954*^9, 
   3.961252626284953*^9}, {3.961309768149461*^9, 3.961309769023304*^9}, {
   3.961310990128149*^9, 3.961310997305282*^9}, 3.961323944826689*^9, {
   3.9613386388542233`*^9, 3.961338850133051*^9}, {3.961339290932042*^9, 
   3.961339298179674*^9}, {3.9613830507085648`*^9, 3.961383070920392*^9}, {
   3.961392937134944*^9, 3.961392938199939*^9}, {3.961472619431415*^9, 
   3.961472702068638*^9}, {3.9614727466675167`*^9, 3.961472827523252*^9}, {
   3.961472908283641*^9, 3.961472928989506*^9}, {3.961474204732635*^9, 
   3.961474214216404*^9}, {3.961491785674735*^9, 3.961491786204088*^9}, {
   3.9614919497050323`*^9, 3.961491956307518*^9}, {3.961492824494869*^9, 
   3.961492853635145*^9}, {3.961512098884151*^9, 3.961512305334201*^9}, {
   3.961551555430284*^9, 3.961551587360215*^9}, {3.9615516451257687`*^9, 
   3.961551647966411*^9}, {3.961554573195301*^9, 3.961554660560359*^9}, 
   3.9615557021808977`*^9, {3.961555809609105*^9, 3.9615559556207542`*^9}, 
   3.961561152496501*^9, {3.961561699191614*^9, 3.961561707481957*^9}, {
   3.961572897065782*^9, 
   3.961572897140643*^9}},ExpressionUUID->"817b3842-8789-4a43-8eaa-\
553f12d61677"],

Cell[CellGroupData[{

Cell["\<\
Load dependencies here. Run first, then you can resume the sequence at any \
heading below. \[DownArrow]\
\>", "Subsubsection",
 CellChangeTimes->{{3.873539554198429*^9, 3.87353956385848*^9}, {
   3.873539727707151*^9, 3.873539729825041*^9}, {3.898786755033476*^9, 
   3.89878675719049*^9}, {3.924495732441723*^9, 3.924495734646626*^9}, {
   3.9244958499842787`*^9, 3.9244958527424803`*^9}, {3.9245780250834208`*^9, 
   3.924578048578133*^9}, {3.9245797348292227`*^9, 3.9245797424691677`*^9}, {
   3.9248566618382673`*^9, 3.924856688667219*^9}, {3.925728131426392*^9, 
   3.925728139659712*^9}, 3.940609394928306*^9, {3.94090823339426*^9, 
   3.940908235488429*^9}, {3.9412411859460573`*^9, 3.9412412198115396`*^9}, {
   3.941241676978043*^9, 3.9412416988338127`*^9}, {3.941242131239408*^9, 
   3.941242132684956*^9}, {3.94124219501884*^9, 3.941242195717648*^9}, {
   3.941242893020556*^9, 3.941242894359537*^9}, {3.94142681589089*^9, 
   3.9414268318731327`*^9}, {3.941426914698303*^9, 3.941426919487544*^9}, {
   3.961491977049696*^9, 3.961492064316546*^9}, {3.961492108679325*^9, 
   3.961492169718219*^9}, {3.9615516738771544`*^9, 3.961551676202374*^9}},
 FontSize->18,
 FontColor->RGBColor[
  0., 0., 0.],ExpressionUUID->"b8ac1c47-f94d-4380-b270-3098cd6f14c3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"1.", " ", "If", " ", "you", " ", 
      RowBox[{"haven", "'"}], "t", " ", "done", " ", "yet", " ", "with", " ", 
      "the", " ", "pop"}], "-", "up"}], ",", " ", 
    RowBox[{
    "run", " ", "initialization", " ", "functions", " ", "in", " ", "this", 
     " ", 
     RowBox[{"notebook", ".", " ", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{
        "Can", " ", "be", " ", "done", " ", "manually", " ", "by", " ", 
         "clicking", " ", "on", " ", "Evaluation"}], " ", "->", " ", 
        RowBox[{"Evaluate", " ", "Initialization", " ", "Cells"}]}], 
       ")"}]}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"FrontEndExecute", "[", 
    RowBox[{"FrontEndToken", "[", "\"\<EvaluateInitialization\>\"", "]"}], 
    "]"}], ";"}]}]], "Input",
 CellChangeTimes->{{3.9615137806042213`*^9, 3.96151383686061*^9}, {
  3.961551725557432*^9, 3.961551737380577*^9}},
 CellLabel->"In[27]:=",ExpressionUUID->"b39657be-9544-4ffb-90c7-6b7bf751051f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "2.", " ", "Set", " ", "the", " ", "root", " ", "folder", " ", "of", " ", 
    "the", " ", "CLIPedia", " ", "repository"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"$repoFolder", "=", 
   RowBox[{"SystemDialogInput", "[", "\"\<Directory\>\"", "]"}]}]}]], "Input",
 CellChangeTimes->{{3.961465423182762*^9, 3.9614654246939096`*^9}, {
   3.961472976984912*^9, 3.961472990998959*^9}, 3.961473123526808*^9, {
   3.961513841451857*^9, 3.9615138415276823`*^9}},
 CellLabel->"In[28]:=",ExpressionUUID->"e47c6931-5574-4043-9923-498be9c01ef4"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "3.", " ", "Set", " ", "the", " ", "folder", " ", "where", " ", "to", " ", 
    "build", " ", "your", " ", "CLIPedia", " ", "repository"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"$buildFolder", "=", 
   RowBox[{"SystemDialogInput", "[", "\"\<Directory\>\"", "]"}]}]}]], "Input",
 CellChangeTimes->{{3.961465423182762*^9, 3.9614654246939096`*^9}, {
  3.961472976984912*^9, 3.961473122593646*^9}, {3.961474085951805*^9, 
  3.961474086147045*^9}, {3.961513842947009*^9, 3.961513843028162*^9}},
 CellLabel->"In[55]:=",ExpressionUUID->"0d4ce933-d37a-4dcf-8e9d-64a72c4ce194"]
}, Closed]]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["1. Get Wikipedia Dump Offset Lists",
 FontSize->24,
 FontColor->RGBColor[0., 0., 0.]]], "Subtitle",
 CellChangeTimes->{{3.899963859343124*^9, 3.899963864923728*^9}, {
   3.899987107019384*^9, 3.8999871160106163`*^9}, {3.904468101364925*^9, 
   3.904468103508287*^9}, {3.9044817932137403`*^9, 3.90448179859904*^9}, {
   3.90448183172145*^9, 3.904481832731874*^9}, 3.904488775997137*^9, {
   3.904628996339195*^9, 3.90462900899477*^9}, {3.904645707151421*^9, 
   3.904645709165501*^9}, 3.904645785460524*^9, 3.9197087452870736`*^9, {
   3.919708931024672*^9, 3.91970893155314*^9}, {3.9197094458275824`*^9, 
   3.91970944624327*^9}, {3.919784417453474*^9, 3.919784433239765*^9}, {
   3.91978667625179*^9, 3.919786677064802*^9}, {3.91995669384198*^9, 
   3.919956694997596*^9}, {3.91996823464153*^9, 3.919968236693644*^9}, {
   3.919970130938319*^9, 3.91997013193384*^9}, {3.9406089564665327`*^9, 
   3.940608962912077*^9}, {3.940609524871455*^9, 3.9406095603230553`*^9}, {
   3.941426430462029*^9, 3.941426435191821*^9}, {3.941426766178721*^9, 
   3.941426766321773*^9}, {3.941426880261994*^9, 3.941426880525215*^9}, {
   3.961257548918165*^9, 3.961257558934288*^9}, 3.9613393591452827`*^9, {
   3.96142687481388*^9, 3.961426885420086*^9}, {3.96142746845982*^9, 
   3.96142749170961*^9}},
 FontSize->25,ExpressionUUID->"07c07820-a8cb-4be4-ba1d-db0d1f98c9db"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "1.", " ", "Create", " ", "directory", " ", "for", " ", "the", " ", 
    "Wikipedia", " ", "Dumps"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"dumpFolder", "=", 
     RowBox[{"CreateDirectory", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{"$buildFolder", ",", "\"\<dumps\>\""}], "}"}], "]"}], "]"}]}],
     ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"SystemOpen", "[", "dumpFolder", "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.961473704450556*^9, 3.961473744111491*^9}, {
  3.961473803658588*^9, 3.9614738537366037`*^9}, {3.961486742997613*^9, 
  3.961486748199333*^9}},
 CellLabel->"In[56]:=",ExpressionUUID->"1af6b969-00fc-411c-8dea-e2862d6aadba"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "2.", " ", "Download", " ", "the", " ", "latest", " ", "Wikipedia", " ", 
     "dumps", " ", "and", " ", "place", " ", "them", " ", "in", " ", "the", 
     " ", "dump", " ", 
     RowBox[{"folder", ".", " ", "You"}], " ", "need", " ", "a", " ", 
     "small"}], ",", 
    RowBox[{"decompressed", " ", "index", " ", "file", " ", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"e", ".", "g", "."}], ",", " ", 
       RowBox[{
       "enwiki", "-", "20250401", "-", "pages", "-", "articles", "-", 
        "multistream", "-", 
        RowBox[{"index", ".", "txt"}]}]}], ")"}], " ", "and", " ", "a", " ", 
     "large"}], ",", 
    RowBox[{"compressed", " ", "dump", " ", "file", " ", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"e", ".", "g", "."}], ",", " ", 
        RowBox[{"enwiki", "-", "20250401", "-", "pages", "-", "articles", "-", 
         RowBox[{"multistream", ".", "xml", ".", "bz2"}]}]}], ")"}], ".", " ",
       "Open"}], " ", 
     RowBox[{"below", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
  "SystemOpen", "[", "\"\<https://dumps.wikimedia.org/enwiki/\>\"", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.961338537731008*^9, 3.961338544749401*^9}, {
   3.9613809948327*^9, 3.96138100284094*^9}, {3.961381344651537*^9, 
   3.961381390873831*^9}, {3.9613816276839*^9, 3.961381670850079*^9}, {
   3.961381792058896*^9, 3.961381793647256*^9}, 3.961382577127329*^9, {
   3.961382614968997*^9, 3.961382633335598*^9}, {3.9613827219617567`*^9, 
   3.9613827786024427`*^9}, {3.961382829187484*^9, 3.96138283826443*^9}, {
   3.961382871309869*^9, 3.9613829018035727`*^9}, 3.961388649885498*^9, {
   3.961473683545594*^9, 3.961473691289516*^9}, {3.961473792397059*^9, 
   3.961473792574338*^9}, {3.961473827259062*^9, 3.961473829754162*^9}, {
   3.96147388593333*^9, 3.9614738983590593`*^9}},
 CellLabel->
  "In[183]:=",ExpressionUUID->"7ba81ac7-a0f4-4009-9651-eb158c3b0d54"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "2.", " ", "Select", " ", "the", " ", "folder", " ", "containing", " ", 
     "both", " ", 
     RowBox[{"files", ".", " ", "If"}], " ", "successful"}], ",", 
    RowBox[{
    "the", " ", "paths", " ", "for", " ", "the", " ", "XML", " ", "and", " ", 
     "TXT", " ", "files", " ", "should", " ", "appear", " ", 
     RowBox[{"below", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"dumpFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<dumps\>\""}], "}"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"contentPath", "=", 
    RowBox[{"First", "[", 
     RowBox[{"Select", "[", 
      RowBox[{
       RowBox[{"FileNames", "[", 
        RowBox[{"All", ",", "dumpFolder"}], "]"}], ",", 
       RowBox[{"StringEndsQ", "[", "\"\<xml.bz2\>\"", "]"}]}], "]"}], "]"}]}],
    "\[IndentingNewLine]", 
   RowBox[{"indexPath", "=", 
    RowBox[{"First", "[", 
     RowBox[{"Select", "[", 
      RowBox[{
       RowBox[{"FileNames", "[", 
        RowBox[{"All", ",", "dumpFolder"}], "]"}], ",", 
       RowBox[{"StringEndsQ", "[", "\"\<txt\>\"", "]"}]}], "]"}], 
     "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.961381676013238*^9, 3.9613817537475843`*^9}, 
   3.961381796483788*^9, 3.961382580597423*^9, {3.961382637409004*^9, 
   3.961382658506124*^9}, {3.961382908423334*^9, 3.961382947986833*^9}, 
   3.961382983174151*^9, {3.961388880469634*^9, 3.961388882372498*^9}, {
   3.961473771180674*^9, 3.9614737845995607`*^9}, {3.96147393215029*^9, 
   3.961473951982956*^9}},
 CellLabel->"In[58]:=",ExpressionUUID->"513b3646-c5d1-41d4-a8c1-125273d69dc8"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "3.", " ", "Import", " ", "and", " ", "process", " ", "the", " ", "index",
      " ", 
     RowBox[{"file", ".", " ", "This"}], " ", "generates", " ", "a", " ", 
     "list", " ", "of", " ", "byte", " ", "offsets", " ", "marking", " ", 
     "the", " ", "start", " ", "of", " ", "each", " ", "article", " ", 
     "batch"}], ",", 
    RowBox[{
    "an", " ", "association", " ", "mapping", " ", "offsets", " ", "to", " ", 
     "page", " ", "IDs", " ", "and", " ", "titles"}], ",", " ", 
    RowBox[{
    "and", " ", "a", " ", "cleaned", " ", "list", " ", "of", " ", "unique", 
     " ", "byte", " ", 
     RowBox[{"offsets", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"indexDataRaw", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"indexPath", ",", 
       RowBox[{"CharacterEncoding", "->", "\"\<UTF8\>\""}]}], "]"}]}], ";"}], 
   "\n", 
   RowBox[{
    RowBox[{"indexData", "=", 
     RowBox[{"DeleteCases", "[", 
      RowBox[{
       RowBox[{"StringSplit", "[", 
        RowBox[{"indexDataRaw", ",", "\"\<\\n\>\""}], "]"}], ",", 
       "\"\<\>\""}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"indexList", "=", 
     RowBox[{"Map", "[", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"StringSplit", "[", 
          RowBox[{"#", ",", "\"\<:\>\"", ",", "3"}], "]"}], "&"}], ")"}], ",",
        "indexData"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"indexListIds", "=", 
     RowBox[{"Merge", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"Association", "[", 
          RowBox[{
           RowBox[{"#", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "->", 
           RowBox[{"Association", "[", 
            RowBox[{
             RowBox[{"\"\<id\>\"", "->", 
              RowBox[{"#", "[", 
               RowBox[{"[", "2", "]"}], "]"}]}], ",", 
             RowBox[{"\"\<title\>\"", "->", 
              RowBox[{"#", "[", 
               RowBox[{"[", "3", "]"}], "]"}]}]}], "]"}]}], "]"}], "&"}], "/@",
         "indexList"}], ",", "Identity"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"noDupIndex", "=", 
     RowBox[{"DeleteDuplicates", "@", 
      RowBox[{"indexList", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"offsets", "=", 
     RowBox[{"ToExpression", "/@", "noDupIndex"}]}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.9234681365838757`*^9, 3.9234681634516106`*^9}, {
   3.9234682341392756`*^9, 3.9234682369712763`*^9}, {3.923484711333387*^9, 
   3.923484718897688*^9}, {3.9234849671649218`*^9, 3.923485011345746*^9}, {
   3.9234903924914055`*^9, 3.923490393011405*^9}, 3.9235470292640085`*^9, {
   3.9235534893081694`*^9, 3.9235534916519465`*^9}, {3.923553522205908*^9, 
   3.9235535323364067`*^9}, {3.9235536478080015`*^9, 
   3.9235536537995253`*^9}, {3.9235538964657707`*^9, 3.923553896629798*^9}, {
   3.923553981085636*^9, 3.9235539812646637`*^9}, {3.9235562523939133`*^9, 
   3.9235562552819147`*^9}, {3.923655991336763*^9, 3.9236560003671093`*^9}, {
   3.961336887589501*^9, 3.9613368952999573`*^9}, {3.9613817610850973`*^9, 
   3.9613817869509087`*^9}, {3.961381962010344*^9, 3.961381982491287*^9}, {
   3.961382055075056*^9, 3.961382089868294*^9}, {3.9613821701092587`*^9, 
   3.961382329020784*^9}, {3.9613823642652187`*^9, 3.961382425169827*^9}, {
   3.961382682582374*^9, 3.961382685714184*^9}, {3.9613829240229893`*^9, 
   3.961382943576172*^9}, 3.96138297641584*^9, 3.96147397143791*^9},
 CellLabel->"In[61]:=",ExpressionUUID->"e8b5eac9-3c01-4836-8abf-94b56b3b9b3b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"4.", " ", "Export", " ", "pre"}], "-", 
    RowBox[{"processed", " ", "files", " ", "for", " ", "downstream", " ", 
     RowBox[{"use", ".", "These"}], " ", "will", " ", "be", " ", "saved", " ",
      "in", " ", "the", " ", "same", " ", 
     RowBox[{"folder", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<build\>\"", ",", "\"\<offsets.wxf\>\""}], 
        "}"}], "]"}], ",", "offsets"}], "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<build\>\"", ",", 
         "\"\<indexListIds.wxf\>\""}], "}"}], "]"}], ",", "indexListIds"}], 
     "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<build\>\"", ",", "\"\<indexList.wxf\>\""}], 
        "}"}], "]"}], ",", "indexList"}], "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.961381815965837*^9, 3.961381850009273*^9}, {
  3.961381910119101*^9, 3.961381915561935*^9}, {3.9613819864747763`*^9, 
  3.9613819966507196`*^9}, {3.961382431076008*^9, 3.961382473036553*^9}, {
  3.9613829547062387`*^9, 3.961382973019835*^9}, {3.961388873863769*^9, 
  3.9613888754974813`*^9}, {3.9614740017629147`*^9, 3.9614740034993877`*^9}, {
  3.961474355758791*^9, 3.9614743661618633`*^9}},
 CellLabel->"In[67]:=",ExpressionUUID->"166624bb-21ab-486c-bde7-09ee304fd3ca"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["2. Parse from Wikipedia Dump to WikiCode",
 FontSize->24,
 FontColor->RGBColor[0., 0., 0.]]], "Subtitle",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004653855638*^9}, {
   3.9255429588956685`*^9, 3.9255429656805353`*^9}, {3.933419738072833*^9, 
   3.933419738467922*^9}, {3.961339364151065*^9, 3.9613393807873783`*^9}, 
   3.9613831760079327`*^9, {3.961426891860717*^9, 
   3.9614268929798393`*^9}},ExpressionUUID->"c67c0c38-1c91-462a-b556-\
a20ea0290db9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "1.", " ", "Select", " ", "project", " ", "folder", " ", "and", " ", 
     "import", " ", "all", " ", "pre"}], "-", 
    RowBox[{"processed", " ", "files"}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"contentPath", "=", 
     RowBox[{"First", "[", 
      RowBox[{"Select", "[", 
       RowBox[{
        RowBox[{"FileNames", "[", 
         RowBox[{"All", ",", 
          RowBox[{"FileNameJoin", "[", 
           RowBox[{"{", 
            RowBox[{"$buildFolder", ",", "\"\<dumps\>\""}], "}"}], "]"}]}], 
         "]"}], ",", 
        RowBox[{"StringEndsQ", "[", "\"\<xml.bz2\>\"", "]"}]}], "]"}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"offsets", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<build\>\"", ",", "\"\<offsets.wxf\>\""}], 
        "}"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"indexListIds", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<build\>\"", ",", 
         "\"\<indexListIds.wxf\>\""}], "}"}], "]"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"indexList", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<build\>\"", ",", "\"\<indexList.wxf\>\""}], 
        "}"}], "]"}], "]"}]}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.961383088603787*^9, 3.9613831466442003`*^9}, {
  3.961383391579172*^9, 3.961383394683593*^9}, {3.961384422696929*^9, 
  3.961384440274076*^9}, {3.961474139557683*^9, 3.96147414835935*^9}, {
  3.961474431000848*^9, 3.961474475607136*^9}, {3.961474586210104*^9, 
  3.961474589068057*^9}},
 CellLabel->"In[61]:=",ExpressionUUID->"fbce3267-2c48-4aba-8e94-b49831e059e3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"2.", " ", "Extract", " ", "from", " ", "Wikipedia", " ", 
     RowBox[{"dump", ":", " ", 
      RowBox[{"Loop", " ", "through", " ", "offset", " ", "ranges"}]}]}], ",",
     " ", 
    RowBox[{"extract", " ", "byte", " ", "chunks"}], ",", " ", 
    RowBox[{
    "decompress", " ", "them", " ", "as", " ", "WikiCode", " ", "XMLs", " ", 
     "using", " ", "a", " ", "temporary", " ", "folder"}], ",", " ", 
    RowBox[{"parse", " ", "XML", " ", "documents"}], ",", " ", 
    RowBox[{
    "match", " ", "them", " ", "to", " ", "page", " ", "IDs", " ", "and", " ",
      "titles"}], ",", " ", 
    RowBox[{"check", " ", "page", " ", "consistency"}], ",", " ", 
    RowBox[{
    "and", " ", "export", " ", "the", " ", "cleaned", " ", "Association", " ",
      "as", " ", "JSON", " ", "files", " ", "named", " ", "by", " ", "their", 
     " ", "starting", " ", "offset", " ", "into", " ", "a", " ", "dedicated", 
     " ", 
     RowBox[{"folder", ".", " ", 
      RowBox[{"Note", ":", " ", 
       RowBox[{"Uncomment", " ", 
        RowBox[{"Length", "@", "offsets"}], " ", "and", " ", "remove", " ", 
        "the", " ", "10", " ", "to", " ", "process", " ", "the", " ", "full", 
        " ", "dump"}]}]}]}], ",", " ", 
    RowBox[{
    "but", " ", "be", " ", "aware", " ", "this", " ", "may", " ", "take", " ",
      "long"}], " ", "\[Dash]", " ", 
    RowBox[{
    "the", " ", "current", " ", "setup", " ", "runs", " ", "only", " ", "a", 
     " ", "small", " ", "test", " ", 
     RowBox[{"sample", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"xmlFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<build\>\"", ",", "\"\<xml\>\""}], 
       "}"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"tempFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<build\>\"", ",", "\"\<temp\>\""}], 
       "}"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Monitor", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"Table", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"start", "=", 
           RowBox[{"offsets", "[", 
            RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"end", "=", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"i", "==", 
              RowBox[{"Length", "@", "offsets"}]}], ",", 
             RowBox[{
              RowBox[{"Last", "[", 
               RowBox[{"Flatten", "[", 
                RowBox[{"Position", "[", 
                 RowBox[{
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", 
                    RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
                  RowBox[{"ToString", "@", 
                   RowBox[{"offsets", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}]}], "]"}], "]"}], "]"}], 
              "+", 
              RowBox[{"offsets", "[", 
               RowBox[{"[", "i", "]"}], "]"}]}], ",", 
             RowBox[{"offsets", "[", 
              RowBox[{"[", 
               RowBox[{"i", "+", "1"}], "]"}], "]"}]}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"ids", "=", 
           RowBox[{"indexListIds", "[", 
            RowBox[{"[", 
             RowBox[{"i", ",", "All", ",", "\"\<id\>\""}], "]"}], "]"}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{"titles", "=", 
           RowBox[{"indexListIds", "[", 
            RowBox[{"[", 
             RowBox[{"i", ",", "All", ",", "\"\<title\>\""}], "]"}], "]"}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{"decompressedContent", "=", 
           RowBox[{"ExtractXMLsFromWikiDump", "[", 
            RowBox[{
            "contentPath", ",", "start", ",", "end", ",", "tempFolder"}], 
            "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"xmls", "=", 
           RowBox[{"ExtractXMLDocuments", "[", "decompressedContent", "]"}]}],
           ";", "\[IndentingNewLine]", 
          RowBox[{"assoc", "=", 
           RowBox[{"Association", "[", 
            RowBox[{"DeleteCases", "[", 
             RowBox[{
              RowBox[{"Table", "[", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{"CheckPages", "[", 
                   RowBox[{
                    RowBox[{"titles", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", 
                    RowBox[{"xmls", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], "]"}], ",", 
                  RowBox[{
                   RowBox[{"ids", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "->", 
                   RowBox[{"xmls", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], ",", "\"\<\>\""}], 
                 "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"j", ",", 
                  RowBox[{"Length", "@", "xmls"}]}], "}"}]}], "]"}], ",", 
              "\"\<\>\""}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"Export", "[", 
           RowBox[{
            RowBox[{"FileNameJoin", "[", 
             RowBox[{"{", 
              RowBox[{"xmlFolder", ",", 
               RowBox[{"StringTake", "[", 
                RowBox[{
                 RowBox[{"ToString", "@", "start"}], ",", 
                 RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
               RowBox[{
                RowBox[{"ToString", "@", "start"}], "<>", "\"\<.json\>\""}]}],
               "}"}], "]"}], ",", "assoc"}], "]"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", 
           RowBox[{"(*", 
            RowBox[{"Length", "@", "offsets"}], "*)"}], "10"}], "}"}]}], 
        "]"}], ";"}], ",", "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{"i", ",", "j"}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"DeleteDirectory", "[", 
     RowBox[{"tempFolder", ",", 
      RowBox[{"DeleteContents", "->", "True"}]}], "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.9235502295154715`*^9, 3.923550264962468*^9}, {
   3.923550374288472*^9, 3.923550379851156*^9}, {3.923550490063797*^9, 
   3.923550587947754*^9}, 3.9235506442735157`*^9, {3.923552015977482*^9, 
   3.9235520683925*^9}, {3.923552104992798*^9, 3.923552220686734*^9}, {
   3.9235522719044456`*^9, 3.923552272289182*^9}, {3.9235586106386805`*^9, 
   3.9235586152948256`*^9}, {3.923558714829382*^9, 3.923558732602172*^9}, {
   3.9235588205137568`*^9, 3.9235588329270053`*^9}, {3.9235588759814186`*^9, 
   3.9235588761384387`*^9}, {3.9235597390695405`*^9, 
   3.9235597608483777`*^9}, {3.923559890617809*^9, 3.923559910662099*^9}, 
   3.9235600629636497`*^9, {3.923560186237133*^9, 3.923560188580654*^9}, {
   3.923560298973283*^9, 3.9235603095659175`*^9}, {3.9235606577685747`*^9, 
   3.9235606608238373`*^9}, {3.9235607737325726`*^9, 3.923560783590774*^9}, {
   3.9235609080969534`*^9, 3.923560910745637*^9}, {3.9235684444919915`*^9, 
   3.923568495684601*^9}, {3.9235689437219*^9, 3.9235690086325264`*^9}, {
   3.9235691011208596`*^9, 3.9235691352477655`*^9}, {3.9235693811414557`*^9, 
   3.9235694380978727`*^9}, {3.9235699212163105`*^9, 3.923569938157895*^9}, {
   3.9235701254039183`*^9, 3.923570132646141*^9}, {3.9235715811705675`*^9, 
   3.9235716407380486`*^9}, {3.9235716894977417`*^9, 3.923571708802373*^9}, {
   3.923571878641443*^9, 3.9235718788765783`*^9}, {3.9235721091838903`*^9, 
   3.9235721103989925`*^9}, {3.9236503545511613`*^9, 
   3.9236503560146284`*^9}, {3.923668069887185*^9, 3.923668072665986*^9}, {
   3.923724376406532*^9, 3.9237243769501834`*^9}, 3.9241012995754166`*^9, 
   3.9241821296044917`*^9, {3.9241859900915246`*^9, 3.9241860037196827`*^9}, {
   3.924540342838342*^9, 3.9245403505638795`*^9}, 3.9245902581554766`*^9, {
   3.9245903047010565`*^9, 3.924590305690761*^9}, {3.9246747298656235`*^9, 
   3.924674735425782*^9}, {3.924929801171253*^9, 3.9249298015606422`*^9}, {
   3.961338564597826*^9, 3.961338581059677*^9}, {3.961383434399798*^9, 
   3.9613834752384443`*^9}, {3.961383683487833*^9, 3.961383734889449*^9}, {
   3.9613837874091797`*^9, 3.9613840003122797`*^9}, {3.961384060642812*^9, 
   3.961384123606987*^9}, {3.9613841945976973`*^9, 3.961384231099626*^9}, {
   3.961384272376834*^9, 3.961384355691205*^9}, {3.961384389158896*^9, 
   3.9613843926404448`*^9}, {3.9613844402751837`*^9, 3.96138444027602*^9}, {
   3.961389503253089*^9, 3.961389508005054*^9}, {3.9614742357881117`*^9, 
   3.961474258822721*^9}, {3.961474488008885*^9, 3.961474489310152*^9}},
 CellLabel->"In[65]:=",ExpressionUUID->"517f4ccb-9008-4719-9d87-24f863c06d14"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["3. Parse from WikiCode to Page Batches",
 FontSize->24,
 FontColor->RGBColor[0., 0., 0.]]], "Subtitle",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004653855638*^9}, {
  3.9255429588956685`*^9, 3.9255429656805353`*^9}, {3.933419738072833*^9, 
  3.933419738467922*^9}, {3.961339364151065*^9, 3.961339392280257*^9}, {
  3.961427184543558*^9, 3.961427184644375*^9}, {3.961427626559976*^9, 
  3.9614276342100773`*^9}},ExpressionUUID->"9beedf0b-c77e-41f7-87de-\
1ba51c63f2a3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "1.", " ", "Select", " ", "project", " ", "folder", " ", "and", " ", 
     "import", " ", "pre"}], "-", 
    RowBox[{"processed", " ", 
     RowBox[{"files", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"xmlFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<build\>\"", ",", "\"\<xml\>\""}], 
       "}"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"offsets", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<build\>\"", ",", "\"\<offsets.wxf\>\""}], 
        "}"}], "]"}], "]"}]}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.9241010527273207`*^9, 3.9241010957977104`*^9}, 
   3.924490251295165*^9, {3.924795717561464*^9, 3.92479571793163*^9}, {
   3.924930683274341*^9, 3.924930686476282*^9}, {3.9613844084259653`*^9, 
   3.9613844092892017`*^9}, {3.961384458331336*^9, 3.961384519627919*^9}, {
   3.9613846447293386`*^9, 3.96138464505732*^9}, 3.96138472301958*^9, {
   3.961474282504657*^9, 3.961474291740049*^9}, {3.961474542251767*^9, 
   3.961474573768278*^9}, {3.96147461365057*^9, 3.961474621254898*^9}, {
   3.9615118460459423`*^9, 3.9615118462408123`*^9}},
 CellLabel->"In[56]:=",ExpressionUUID->"d38a2dbc-454a-4df6-bdad-cf559458552a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "2.", " ", "Set", " ", "new", " ", "folder", " ", "paths", " ", "for", 
     " ", "all", " ", "the", " ", "parsed", " ", "and", " ", "Cleaed", " ", 
     "WikiCode", " ", "on", " ", "Page", " ", "level"}], ",", " ", 
    RowBox[{
    "and", " ", "a", " ", "log", " ", "folder", " ", "to", " ", "aid", " ", 
     "in", " ", "the", " ", "parsing", " ", 
     RowBox[{"process", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"pageBatchFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<build\>\"", ",", "\"\<batches\>\""}],
        "}"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"logFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<build\>\"", ",", "\"\<logs\>\""}], 
       "}"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Quiet", "[", 
     RowBox[{"CreateDirectory", "[", "logFolder", "]"}], "]"}], 
    ";"}]}]}]], "Input",
 CellChangeTimes->{{3.961384647289177*^9, 3.9613847812838917`*^9}, {
  3.961396085346868*^9, 3.961396094143888*^9}, {3.9614742960400457`*^9, 
  3.96147429729996*^9}, {3.961474641567881*^9, 3.9614746531989117`*^9}, {
  3.961474885194951*^9, 3.961474897785513*^9}},
 CellLabel->"In[58]:=",ExpressionUUID->"d89ef00d-e4cf-4708-9988-2fac207ce7f5"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "X", " ", "1.", " ", "If", " ", "you", " ", "are", " ", "picking", " ", 
     "up", " ", "after", " ", "a", " ", "crash"}], ",", " ", 
    RowBox[{
    "copy", " ", "and", " ", "paste", " ", "the", " ", "log", " ", "filepath",
      " ", "printed", " ", "underneath", " ", "the", " ", "main", " ", "cell",
      " ", "here", " ", "to", " ", "see", " ", "if", " ", "you", " ", "can", 
     " ", "recover", " ", "the", " ", "last", " ", "position", " ", "or", " ", 
     RowBox[{"errors", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"interruptedLog", "=", "\"\<Paste your log file here\>\""}], 
   ";"}]}]], "Input",
 CellChangeTimes->{{3.961384793935541*^9, 3.961384894238484*^9}, {
   3.9613849437844152`*^9, 3.961384979722855*^9}, {3.961385009903261*^9, 
   3.961385015825605*^9}, {3.961385380661331*^9, 3.961385384296179*^9}, {
   3.9613883840974197`*^9, 3.961388386478304*^9}, {3.961388428193701*^9, 
   3.961388437051355*^9}, 3.9614746656267357`*^9, {3.961475499464253*^9, 
   3.961475536583756*^9}},ExpressionUUID->"a2136016-fc8c-40a8-8695-\
51e75935481f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "X", " ", "2.", " ", "Seek", " ", "last", " ", "processed", " ", 
    "position", " ", "and", " ", "problems", " ", "in", " ", "the", " ", 
    "log", " ", "file"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"log", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"interruptedLog", ",", "\"\<List\>\""}], "]"}]}], ";"}], "\n", 
   RowBox[{"last", "=", 
    RowBox[{"Last", "[", 
     RowBox[{"Flatten", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"ToExpression", "/@", 
         RowBox[{"StringTrim", "[", 
          RowBox[{"StringCases", "[", 
           RowBox[{"#", ",", 
            RowBox[{
             RowBox[{"\"\<at\>\"", "~~", 
              RowBox[{"number", ":", 
               RowBox[{"Shortest", "[", "___", "]"}]}], "~~", "\"\<-\>\""}], ":>",
              "number"}]}], "]"}], "]"}]}], "&"}], "/@", "log"}], "]"}], 
     "]"}]}], "\[IndentingNewLine]", 
   RowBox[{"problems", "=", 
    RowBox[{"ToExpression", "/@", 
     RowBox[{"Flatten", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"StringTrim", "[", 
         RowBox[{"StringCases", "[", 
          RowBox[{"#", ",", 
           RowBox[{
            RowBox[{"\"\<Errors at\>\"", "~~", 
             RowBox[{"number", ":", 
              RowBox[{"Shortest", "[", "___", "]"}]}], "~~", "\"\<-\>\""}], ":>",
             "number"}]}], "]"}], "]"}], "&"}], "/@", 
       RowBox[{"Extract", "[", 
        RowBox[{"log", ",", 
         RowBox[{"Position", "[", 
          RowBox[{
           RowBox[{"StringContainsQ", "[", 
            RowBox[{"log", ",", "\"\<Errors\>\""}], "]"}], ",", "True"}], 
          "]"}]}], "]"}]}], "]"}]}]}]}]}]], "Input",
 CellChangeTimes->{{3.9613849656165657`*^9, 3.961385007885482*^9}, {
  3.961385084439522*^9, 3.961385086017082*^9}, {3.961388399272698*^9, 
  3.961388417231164*^9}},
 CellLabel->
  "In[277]:=",ExpressionUUID->"c23c9f21-2454-4428-b6e3-fc111fcfeab7"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "3.", " ", "Input", " ", "start", " ", "and", " ", "end", " ", "positions",
     " ", "of", " ", "the", " ", "offset", " ", "list", " ", "to", " ", 
    "start", " ", 
    RowBox[{"parsing", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"start", "=", "1"}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Start", " ", "position", " ", "for", " ", 
      RowBox[{"parsing", ".", " ", 
       RowBox[{"Add", " ", "'"}]}], "last"}], "+", 
     RowBox[{
      RowBox[{"1", "'"}], " ", "here", " ", "if", " ", "you", " ", "are", " ",
       "picking", " ", "up", " ", "after", " ", "an", " ", 
      RowBox[{"interruption", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"end", "=", "10"}], ";"}], "  ", 
   RowBox[{"(*", 
    RowBox[{"End", " ", "position", " ", "for", " ", 
     RowBox[{"parsing", ".", " ", "Change"}], " ", 
     RowBox[{"to", " ", "'"}], 
     RowBox[{
      RowBox[{"Length", "@", "offset"}], "'"}], " ", "to", " ", "process", 
     " ", "the", " ", "full", " ", 
     RowBox[{"dump", "."}]}], "*)"}]}]}]], "Input",
 CellChangeTimes->{{3.961385181673884*^9, 3.961385319558234*^9}, 
   3.961385466479279*^9, {3.96138591470935*^9, 3.961385939154346*^9}, {
   3.961387051399459*^9, 3.9613870548909893`*^9}, {3.961389123466876*^9, 
   3.9613891237469263`*^9}, 3.961389518560048*^9, {3.961474686367153*^9, 
   3.9614746885936403`*^9}, 3.9614749521151114`*^9},
 CellLabel->"In[61]:=",ExpressionUUID->"f47b576d-69c2-44e5-8af8-adfe97d50bf1"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "4.", " ", "This", " ", "loop", " ", "processes", " ", "all", " ", "XML", 
     " ", "batches", " ", 
     RowBox[{"(", 
      RowBox[{"up", " ", "to", " ", "100", " ", "pages", " ", "each"}], 
      ")"}]}], ",", 
    RowBox[{
    "cleans", " ", "their", " ", "WikiCode", " ", "into", " ", "plain", " ", 
     "text", " ", "while", " ", "preserving", " ", "markers", " ", "for", " ",
      "references", " ", "and", " ", "images"}], ",", " ", 
    RowBox[{
     RowBox[{
     "and", " ", "records", " ", "these", " ", "separately", " ", "for", " ", 
      "downstream", " ", 
      RowBox[{"use", ".", " ", "Parsing"}], " ", "is", " ", "error"}], "-", 
     RowBox[{"prone", " ", "and", " ", "slow", " ", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"e", ".", "g", "."}], ",", " ", 
         RowBox[{
          RowBox[{"~", "7"}], " ", "min", " ", "per", " ", "10", " ", 
          "offsets"}], ",", " ", 
         RowBox[{
          RowBox[{"~", "2800"}], " ", "hours", " ", "total", " ", "without", 
          " ", "optimization"}]}], ")"}], ".", " ", "A"}], " ", "dated", " ", 
      "log", " ", "file", " ", "tracks", " ", "progress", " ", "and", " ", 
      "helps", " ", "recover", " ", "in", " ", "case", " ", "of", " ", 
      "interruptions"}]}], ",", " ", 
    RowBox[{"output", " ", 
     RowBox[{"below", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"logFilePath", "=", 
    RowBox[{"FileNameJoin", "[", 
     RowBox[{"{", 
      RowBox[{"logFolder", ",", 
       RowBox[{
        RowBox[{"DateString", "[", 
         RowBox[{"{", 
          RowBox[{
          "\"\<YearShort\>\"", ",", "\"\<Month\>\"", ",", "\"\<Day\>\"", ",", 
           "\"\<Hour\>\"", ",", "\"\<Minute\>\""}], "}"}], "]"}], "<>", 
        "\"\<_CleanWikisLog\>\"", "<>", "\"\<.txt\>\""}]}], "}"}], "]"}]}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Delete", " ", "old", " ", "Logs"}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Quiet", "[", 
     RowBox[{"Close", "[", "logFilePath", "]"}], "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Quiet", "@", 
     RowBox[{"DeleteFile", "[", "logFilePath", "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"$HistoryLength", "=", "0"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"Monitor", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"OpenWrite", "[", "logFilePath", "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"date", "=", 
          RowBox[{"DateString", "[", 
           RowBox[{"{", 
            RowBox[{
            "\"\<Hour\>\"", ",", "\"\<:\>\"", ",", "\"\<Minute\>\"", ",", 
             "\"\<:\>\"", ",", "\"\<Second\>\""}], "}"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"Module", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
            "assoc", ",", "ids", ",", "resultsBatch", ",", "results", ",", 
             "resultsAssoc", ",", "errors", ",", " ", "successes"}], "}"}], 
           ",", 
           RowBox[{"(*", 
            RowBox[{"Import", " ", "JSON", " ", "data"}], "*)"}], 
           RowBox[{
            RowBox[{"assoc", "=", 
             RowBox[{"Import", "[", 
              RowBox[{
               RowBox[{"FileNameJoin", "[", 
                RowBox[{"{", 
                 RowBox[{"xmlFolder", ",", 
                  RowBox[{"StringTake", "[", 
                   RowBox[{
                    RowBox[{"ToString", "@", 
                    RowBox[{"offsets", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], ",", 
                    RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
                  RowBox[{
                   RowBox[{"ToString", "@", 
                    RowBox[{"offsets", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], "<>", 
                   "\"\<.json\>\""}]}], "}"}], "]"}], ",", 
               "\"\<RawJSON\>\""}], "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{"Extract", " ", "IDs"}], "*)"}], "\[IndentingNewLine]", 
            RowBox[{"ids", "=", 
             RowBox[{"Keys", "[", "assoc", "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"resultsBatch", "=", 
             RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"results", "=", 
             RowBox[{"Check", "[", 
              RowBox[{
               RowBox[{"Table", "[", 
                RowBox[{
                 RowBox[{"Block", "[", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"title", ",", "wikiCode", ",", "info"}], "}"}], 
                   ",", "\[IndentingNewLine]", 
                   RowBox[{"(*", 
                    RowBox[{"Extract", " ", "Title"}], "*)"}], 
                   RowBox[{
                    RowBox[{"title", "=", 
                    RowBox[{"Quiet", "@", 
                    RowBox[{"First", "[", 
                    RowBox[{"StringCases", "[", 
                    RowBox[{
                    RowBox[{"assoc", "[", 
                    RowBox[{"ids", "[", 
                    RowBox[{"[", "k", "]"}], "]"}], "]"}], ",", 
                    RowBox[{
                    RowBox[{"Shortest", "[", 
                    RowBox[{"\"\<<title>\>\"", "~~", 
                    RowBox[{"title", ":", 
                    RowBox[{
                    RowBox[{"Except", "[", "\"\<<\>\"", "]"}], "..."}]}], 
                    "~~", "\"\<</title>\>\""}], "]"}], ":>", "title"}]}], 
                    "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
                    RowBox[{"(*", 
                    RowBox[{"Extract", " ", "WikiCode"}], "*)"}], 
                    "\[IndentingNewLine]", 
                    RowBox[{"wikiCode", "=", 
                    RowBox[{"Quiet", "@", 
                    RowBox[{"First", "[", 
                    RowBox[{"StringCases", "[", 
                    RowBox[{
                    RowBox[{"assoc", "[", 
                    RowBox[{"ids", "[", 
                    RowBox[{"[", "k", "]"}], "]"}], "]"}], ",", 
                    RowBox[{
                    RowBox[{"Shortest", "[", 
                    RowBox[{
                    "\"\<<text\>\"", "~~", "attributes___", "~~", "\"\<>\>\"",
                     "~~", "text___", "~~", "\"\<</text>\>\""}], "]"}], ":>", 
                    "text"}]}], "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"MemberQ", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"StringQ", "[", "#", "]"}], "&"}], "/@", 
                    RowBox[{"{", 
                    RowBox[{"title", ",", "wikiCode"}], "}"}]}], ",", 
                    "False"}], "]"}], ",", 
                    RowBox[{"1", "/", "0"}], ",", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"info", "=", 
                    RowBox[{"CleanWikiCode", "[", "wikiCode", "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"Pause", "[", "0.05", "]"}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"{", 
                    RowBox[{"title", ",", "info", ",", "wikiCode"}], 
                    "}"}]}]}], "]"}]}]}], "]"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"k", ",", 
                   RowBox[{"Length", "@", "ids"}]}], "}"}]}], "]"}], ",", 
               "\"\<Error\>\""}], "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{"Write", " ", "Logs"}], "*)"}], "\[IndentingNewLine]", 
            RowBox[{"If", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"results", "===", "\"\<Error\>\""}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"WriteString", "[", 
               RowBox[{"logFilePath", ",", 
                RowBox[{"\"\<Errors at \>\"", "<>", 
                 RowBox[{"ToString", "[", "j", "]"}], "<>", 
                 "\"\< \[Dash]\[NonBreakingSpace]\>\"", "<>", 
                 RowBox[{"DateString", "[", 
                  RowBox[{"{", 
                   RowBox[{
                   "\"\<Hour\>\"", ",", "\"\<:\>\"", ",", "\"\<Minute\>\"", 
                    ",", "\"\<:\>\"", ",", "\"\<Second\>\""}], "}"}], "]"}], 
                 "<>", "\"\<\\n\>\""}]}], "]"}], ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"WriteString", "[", 
                RowBox[{"logFilePath", ",", 
                 RowBox[{"\"\<Success at \>\"", "<>", 
                  RowBox[{"ToString", "[", "j", "]"}], "<>", 
                  "\"\< \[Dash]\[NonBreakingSpace]\>\"", "<>", 
                  RowBox[{"DateString", "[", 
                   RowBox[{"{", 
                    RowBox[{
                    "\"\<Hour\>\"", ",", "\"\<:\>\"", ",", "\"\<Minute\>\"", 
                    ",", "\"\<:\>\"", ",", "\"\<Second\>\""}], "}"}], "]"}], 
                  "<>", "\"\<\\n\>\""}]}], "]"}], ";", "\[IndentingNewLine]", 
               RowBox[{"resultsBatch", "=", 
                RowBox[{"Join", "[", 
                 RowBox[{"resultsBatch", ",", "results"}], "]"}]}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"resultsAssoc", "=", 
                RowBox[{"Association", "[", 
                 RowBox[{"Table", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"ids", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "->", 
                    RowBox[{"Merge", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"resultsBatch", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}], ",", 
                    RowBox[{"Association", "[", 
                    RowBox[{
                    RowBox[{"\"\<id\>\"", "->", 
                    RowBox[{"ids", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], ",", 
                    RowBox[{"\"\<title\>\"", "->", 
                    RowBox[{"resultsBatch", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}]}], ",", 
                    RowBox[{"\"\<wikiCode\>\"", "->", 
                    RowBox[{"resultsBatch", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "3"}], "]"}], "]"}]}]}], "]"}]}], "}"}],
                     ",", "First"}], "]"}]}], ",", 
                   RowBox[{"{", 
                    RowBox[{"i", ",", 
                    RowBox[{"Length", "@", "resultsBatch"}]}], "}"}]}], "]"}],
                  "]"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"Export", "[", 
                RowBox[{
                 RowBox[{"FileNameJoin", "[", 
                  RowBox[{"{", 
                   RowBox[{"pageBatchFolder", ",", 
                    RowBox[{"StringTake", "[", 
                    RowBox[{
                    RowBox[{"ToString", "@", 
                    RowBox[{"offsets", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], ",", 
                    RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
                    RowBox[{
                    RowBox[{"ToString", "@", 
                    RowBox[{"offsets", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], "<>", 
                    "\"\<.json\>\""}]}], "}"}], "]"}], ",", "resultsAssoc", 
                 ",", "\"\<JSON\>\""}], "]"}]}]}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{"Increase", " ", "Runtime", " ", "Stability"}], "*)"}], 
            "\[IndentingNewLine]", 
            RowBox[{"Pause", "[", "0.1", "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{"Clear", " ", "Memory"}], "*)"}], "\[IndentingNewLine]", 
            RowBox[{"ClearAll", "[", 
             RowBox[{
             "assoc", ",", "ids", ",", "results", ",", "resultsBatch", ",", 
              "resultsAssoc"}], "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"ClearSystemCache", "[", "]"}], ";"}]}], "]"}]}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "start", ",", "end"}], "}"}]}], "]"}], ";"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "k", ",", "date"}], "}"}]}], "]"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Close", " ", "the", " ", "log", " ", "file"}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Close", "[", "logFilePath", "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.9242448238452764`*^9, 3.924244877515713*^9}, 
   3.924252840271407*^9, {3.9242529047836475`*^9, 3.9242529143846464`*^9}, {
   3.9242530590548716`*^9, 3.92425312393552*^9}, {3.924254406423884*^9, 
   3.924254420502885*^9}, 3.9242544862235804`*^9, {3.9242545200476437`*^9, 
   3.924254521511644*^9}, {3.9242545562237005`*^9, 3.92425458033582*^9}, 
   3.924254638087446*^9, {3.924254791911853*^9, 3.9242549630396805`*^9}, 
   3.924255129544587*^9, {3.9242551742188263`*^9, 3.9242551857597313`*^9}, {
   3.9242553710634975`*^9, 3.924255386679561*^9}, {3.924255433682682*^9, 
   3.9242554664710436`*^9}, {3.9242555167637463`*^9, 
   3.9242555308157473`*^9}, {3.9242555676799335`*^9, 3.924255583238934*^9}, 
   3.924255825137803*^9, 3.9242559290834274`*^9, {3.924256021527387*^9, 
   3.9242560227273855`*^9}, {3.924256395232005*^9, 3.924256400920005*^9}, {
   3.9242564748239174`*^9, 3.9242564817199173`*^9}, 3.924256712703812*^9, 
   3.9242567437518787`*^9, {3.924256794609189*^9, 3.924256826643664*^9}, {
   3.9242569368399134`*^9, 3.924256943903245*^9}, {3.9242570454765024`*^9, 
   3.9242571484159203`*^9}, {3.9242572184637766`*^9, 
   3.9242572616398425`*^9}, {3.9242573123490925`*^9, 
   3.9242573210000935`*^9}, {3.9242574040680003`*^9, 
   3.9242574378961515`*^9}, {3.9242575385003357`*^9, 3.924257541247337*^9}, {
   3.9242576543082047`*^9, 3.924257663816266*^9}, {3.9242577846527987`*^9, 
   3.9242577961197987`*^9}, {3.9242578866051025`*^9, 3.924257917528269*^9}, {
   3.9242579606052732`*^9, 3.924257989543496*^9}, 3.924258153841516*^9, {
   3.9242581960476017`*^9, 3.9242581963596015`*^9}, {3.924258237199803*^9, 
   3.924258281311528*^9}, {3.9242583155606675`*^9, 3.9242583364558163`*^9}, {
   3.9244468698273*^9, 3.92444691010244*^9}, {3.9244469462206497`*^9, 
   3.924447005362345*^9}, {3.92444789976894*^9, 3.924447901848832*^9}, {
   3.924454266892096*^9, 3.924454289235768*^9}, {3.9244543430219755`*^9, 
   3.9244543493139467`*^9}, {3.9244902378866196`*^9, 
   3.9244902391318684`*^9}, {3.924490843806408*^9, 3.9244908475733156`*^9}, {
   3.924491424238769*^9, 3.9244915127999153`*^9}, {3.92449177336497*^9, 
   3.924491843425181*^9}, {3.9244919663721776`*^9, 3.9244919808204203`*^9}, {
   3.9245221465584097`*^9, 3.9245221863789053`*^9}, {3.9245222595773983`*^9, 
   3.9245222798399935`*^9}, {3.9245231068639107`*^9, 
   3.9245232757158747`*^9}, {3.924523313291029*^9, 3.9245234528132915`*^9}, {
   3.9245235101582613`*^9, 3.924523510796443*^9}, {3.924523569554922*^9, 
   3.9245235767527046`*^9}, {3.924523611887061*^9, 3.924523644099474*^9}, {
   3.924523968606987*^9, 3.924523999257266*^9}, {3.924524038694395*^9, 
   3.924524043132168*^9}, {3.9245240817777877`*^9, 3.9245240882843313`*^9}, {
   3.9245247233661757`*^9, 3.924524723945331*^9}, 3.924532423729905*^9, {
   3.924575182962023*^9, 3.924575184405701*^9}, {3.924575334620139*^9, 
   3.9245753351542706`*^9}, {3.9245754531815815`*^9, 
   3.9245754693821564`*^9}, {3.924668867713752*^9, 3.9246688722469935`*^9}, {
   3.924669367220508*^9, 3.9246693680931654`*^9}, {3.924669470928632*^9, 
   3.924669499966655*^9}, {3.924669575235615*^9, 3.924669575250614*^9}, {
   3.924669623556405*^9, 3.9246696299316*^9}, {3.924669686629197*^9, 
   3.9246696981797185`*^9}, {3.924669770493347*^9, 3.924669772172022*^9}, {
   3.9246698092760153`*^9, 3.924669876755108*^9}, 3.9246699523414326`*^9, {
   3.9246699831479716`*^9, 3.9246699874684134`*^9}, {3.9246744489305134`*^9, 
   3.9246744661948605`*^9}, {3.9246746503952093`*^9, 
   3.9246746742028103`*^9}, {3.924674758035798*^9, 3.924674761962886*^9}, {
   3.9246781359065027`*^9, 3.9246781708512187`*^9}, {3.9246782059225187`*^9, 
   3.9246782168036237`*^9}, 3.9246785699624205`*^9, {3.924678818563619*^9, 
   3.924678831562216*^9}, {3.924678873491603*^9, 3.924678895554674*^9}, {
   3.924678931794837*^9, 3.92467893402781*^9}, {3.924678970563809*^9, 
   3.9246789726747427`*^9}, {3.9246805306427774`*^9, 
   3.9246805638673162`*^9}, {3.9246805981540594`*^9, 
   3.9246806081777716`*^9}, {3.9246821467866373`*^9, 3.924682150818638*^9}, {
   3.9246900893649035`*^9, 3.9246900895079036`*^9}, {3.9246901551540766`*^9, 
   3.9246901603260756`*^9}, {3.9246901912655797`*^9, 3.9246902001050305`*^9}, 
   3.924690391187852*^9, {3.9246906327865295`*^9, 3.924690660200658*^9}, {
   3.924690830105097*^9, 3.9246908603641677`*^9}, {3.9246908989854565`*^9, 
   3.924690945889661*^9}, {3.9246909911068363`*^9, 3.9246910440410275`*^9}, {
   3.9246911952018414`*^9, 3.924691271752206*^9}, {3.9247508996259794`*^9, 
   3.9247509031369143`*^9}, 3.924923250012105*^9, {3.924923351520632*^9, 
   3.9249233557662754`*^9}, {3.9249283454177437`*^9, 3.924928347941989*^9}, {
   3.9249285214248905`*^9, 3.9249285233849163`*^9}, {3.9249292110589714`*^9, 
   3.924929218159333*^9}, 3.924929536129645*^9, {3.924930379125004*^9, 
   3.924930387213829*^9}, {3.92493045742723*^9, 3.9249304864840193`*^9}, {
   3.9249324032149935`*^9, 3.9249324265287237`*^9}, {3.9249324811221876`*^9, 
   3.9249325419935145`*^9}, {3.924948676425067*^9, 3.92494868347253*^9}, {
   3.9249499670928106`*^9, 3.924949972421422*^9}, {3.925223356760952*^9, 
   3.9252233575182414`*^9}, {3.961336983984023*^9, 3.961336984515581*^9}, 
   3.961384759886424*^9, {3.96138532508169*^9, 3.961385349477231*^9}, {
   3.9613855965158663`*^9, 3.961385596572309*^9}, {3.9613858739717216`*^9, 
   3.961385875695942*^9}, {3.9613859103245296`*^9, 3.961385943622221*^9}, {
   3.961386051944706*^9, 3.9613860702867823`*^9}, {3.961386111580204*^9, 
   3.961386200801361*^9}, {3.961387060666472*^9, 3.961387268765819*^9}, {
   3.961387331378696*^9, 3.9613873973697968`*^9}, {3.961388136297324*^9, 
   3.9613881908098803`*^9}, {3.961388288408845*^9, 3.9613883045341187`*^9}, {
   3.961388509369763*^9, 3.961388535925343*^9}, {3.961474722887466*^9, 
   3.961474729802713*^9}, 3.9614747643770447`*^9, {3.961475550494893*^9, 
   3.9614755530213833`*^9}},
 CellLabel->"In[63]:=",ExpressionUUID->"cc16824e-220f-41af-9b6f-2a71b7cde641"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["4. Collect Wikipedia Images",
 FontSize->24,
 FontColor->RGBColor[0., 0., 0.]]], "Subtitle",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004653855638*^9}, {
  3.9255429588956685`*^9, 3.9255429656805353`*^9}, {3.933419738072833*^9, 
  3.933419738467922*^9}, {3.961339364151065*^9, 3.961339392280257*^9}, {
  3.961390164835906*^9, 3.961390173814896*^9}, {3.961426911785955*^9, 
  3.961426915654869*^9}, {3.961427185900691*^9, 3.9614271859820757`*^9}, {
  3.961427539661703*^9, 
  3.961427540578404*^9}},ExpressionUUID->"ef86ed98-ed0e-41b2-9130-\
c5284615441a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "1.", " ", "Set", " ", "directories", " ", "and", " ", "import", " ", 
     "pre"}], "-", 
    RowBox[{"processed", " ", 
     RowBox[{"files", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"pageBatchFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<build\>\"", ",", "\"\<batches\>\""}],
        "}"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"offsets", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<build\>\"", ",", "\"\<offsets.wxf\>\""}], 
        "}"}], "]"}], "]"}]}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.961383088603787*^9, 3.9613831466442003`*^9}, {
   3.961383391579172*^9, 3.961383394683593*^9}, {3.961384422696929*^9, 
   3.961384440274076*^9}, 3.9613902012132883`*^9, {3.961396100836308*^9, 
   3.9613961042634974`*^9}, {3.961475020083589*^9, 3.961475022769126*^9}, {
   3.961475563964078*^9, 3.961475591883165*^9}, 3.961475722491952*^9, {
   3.961511840514358*^9, 3.9615118406863537`*^9}},
 CellLabel->"In[56]:=",ExpressionUUID->"053ca3c0-4f12-45b3-9a33-9ab80e5aabe4"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "2.", " ", "Import", " ", "a", " ", "classifier", " ", "trained", " ", 
     "to", " ", "detect", " ", "Wikipedia", " ", "icons"}], ",", " ", 
    RowBox[{
    "which", " ", "many", " ", "pages", " ", "share", " ", "and", " ", 
     "which", " ", "will", " ", "reduce", " ", "download", " ", "time"}]}], 
   "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"iconClassifier", "=", 
    RowBox[{"Import", "[", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{
       "$repoFolder", ",", "\"\<code\>\"", ",", "\"\<functions\>\"", ",", 
        "\"\<240317_wikiIconClassifier.wxf\>\""}], "}"}], "]"}], "]"}]}], 
   ";"}]}]], "Input",
 CellChangeTimes->{{3.961391601554585*^9, 3.961391612819234*^9}, {
  3.961391836030295*^9, 3.961391885208008*^9}},
 CellLabel->"In[58]:=",ExpressionUUID->"40195b49-f13c-4b86-ad77-45bb617622be"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "3.", " ", "Set", " ", "the", " ", "path", " ", "were", " ", "images", 
     " ", 
     RowBox[{"are", "/", "were"}], " ", "downloaded"}], ",", " ", 
    RowBox[{"and", " ", "one", " ", "for", " ", "a", " ", "hashlist", " ", 
     RowBox[{"file", ".", " ", "If"}], " ", "you", " ", "run", " ", "this", 
     " ", "cell", " ", "at", " ", "a", " ", "later", " ", "stage"}], ",", " ", 
    RowBox[{
    "it", " ", "will", " ", "record", " ", "which", " ", "URLs", " ", "were", 
     " ", "already", " ", "downloaded", " ", "to", " ", "save", " ", "time"}],
     ",", " ", 
    RowBox[{"as", " ", "images", " ", "are", " ", "shared", " ", "among", " ", 
     RowBox[{"pages", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"hashFilePath", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<data\>\"", ",", "\"\<img\>\"", ",", 
        RowBox[{"\"\<hashlist\>\"", "<>", "\"\<.txt\>\""}]}], "}"}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"downloadPath", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<data\>\"", ",", "\"\<img\>\""}], 
       "}"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"downloadedImages", "=", 
     RowBox[{"AssociationThread", "[", 
      RowBox[{
       RowBox[{"LoadHashes", "[", "hashFilePath", "]"}], "->", "True"}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"lastHash", "=", 
     RowBox[{"Quiet", "@", 
      RowBox[{"Last", "@", 
       RowBox[{"Keys", "@", "downloadedImages"}]}]}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"allHashes", "=", 
     RowBox[{"Keys", "@", "downloadedImages"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"Print", "[", 
    RowBox[{"\"\<Currently Downloaded: \>\"", "<>", 
     RowBox[{"ToString", "@", 
      RowBox[{"Length", "@", "allHashes"}]}]}], "]"}]}]}]], "Input",
 CellChangeTimes->{{3.961390468648498*^9, 3.96139048057226*^9}, {
  3.9613919134784193`*^9, 3.9613919648202868`*^9}, {3.961392487812229*^9, 
  3.961392502608191*^9}, {3.9613925622156563`*^9, 3.961392607770731*^9}, {
  3.961396462763723*^9, 3.961396464768177*^9}, {3.961475028493902*^9, 
  3.961475028530427*^9}, {3.961475617648457*^9, 3.961475636968277*^9}},
 CellLabel->"In[59]:=",ExpressionUUID->"3997653e-29a3-4f4e-80af-8af97f19491f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "4.", " ", "Create", " ", "a", " ", "single", " ", "log", " ", "file", " ",
     "to", " ", "record", " ", 
    RowBox[{"process", ".", " ", "This"}], " ", "will", " ", "be", " ", 
    "overwritten", " ", "for", " ", "each", " ", "new", " ", "downloading", 
    " ", 
    RowBox[{"session", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"logFilePath", "=", 
    RowBox[{"FileNameJoin", "[", 
     RowBox[{"{", 
      RowBox[{
      "$buildFolder", ",", "\"\<build\>\"", ",", "\"\<logs\>\"", ",", 
       "\"\<imageLog.txt\>\""}], "}"}], "]"}]}], ";"}]}]], "Input",
 CellChangeTimes->{{3.961390238746747*^9, 3.961390261430812*^9}, {
  3.9613915555711117`*^9, 3.9613915568930693`*^9}, {3.961392516686161*^9, 
  3.9613925167271433`*^9}, {3.961475031146309*^9, 3.961475031221594*^9}, {
  3.961475650045854*^9, 3.961475659432436*^9}},
 CellLabel->"In[65]:=",ExpressionUUID->"74cf77bf-8b13-4046-9b62-8c7a4d5f61ed"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"X", ".", " ", "Check"}], " ", "for", " ", "the", " ", "last", 
    " ", "successully", " ", "downloaded", " ", 
    RowBox[{"offset", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"log", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"logFilePath", ",", "\"\<List\>\""}], "]"}]}], ";"}], "\n", 
   RowBox[{"last", "=", 
    RowBox[{"Last", "[", 
     RowBox[{"Flatten", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"ToExpression", "/@", 
         RowBox[{"StringTrim", "[", 
          RowBox[{"StringCases", "[", 
           RowBox[{"#", ",", 
            RowBox[{
             RowBox[{"\"\<at\>\"", "~~", 
              RowBox[{"number", ":", 
               RowBox[{"Shortest", "[", "___", "]"}]}], "~~", "\"\<-\>\""}], ":>",
              "number"}]}], "]"}], "]"}]}], "&"}], "/@", "log"}], "]"}], 
     "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.9245240635103617`*^9, 3.9245240642534246`*^9}, {
   3.924524097462801*^9, 3.924524106628332*^9}, {3.924524152726975*^9, 
   3.9245241555239286`*^9}, 3.9245244988184147`*^9, {3.9245246735451164`*^9, 
   3.924524676782171*^9}, 3.924532317652954*^9, {3.9245751746152763`*^9, 
   3.9245751763124*^9}, 3.9246805737615414`*^9, 3.924690050687664*^9, 
   3.924691186759841*^9, {3.9247508302691927`*^9, 3.9247508450941668`*^9}, 
   3.9247996400126815`*^9, {3.9249294431838923`*^9, 3.924929453065591*^9}, {
   3.961392522602338*^9, 3.961392542680275*^9}, {3.961392744499715*^9, 
   3.961392745443557*^9}, {3.961392852373827*^9, 3.961392852477668*^9}, {
   3.9614918482082987`*^9, 
   3.961491850542927*^9}},ExpressionUUID->"0924d4f4-f3b1-4f92-abf3-\
f16dc69b4398"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "5.", " ", "Input", " ", "start", " ", "and", " ", "end", " ", "positions",
     " ", "of", " ", "the", " ", "offset", " ", "list", " ", "to", " ", 
    "start", " ", 
    RowBox[{"downloading", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"start", "=", "1"}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Start", " ", "position", " ", "for", " ", 
      RowBox[{"downloading", ".", " ", 
       RowBox[{"Add", " ", "'"}]}], "last"}], "+", 
     RowBox[{
      RowBox[{"1", "'"}], " ", "here", " ", "if", " ", "you", " ", "are", " ",
       "picking", " ", "up", " ", "after", " ", "an", " ", 
      RowBox[{"interruption", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"end", "=", "10"}], ";"}], "  ", 
   RowBox[{"(*", 
    RowBox[{"End", " ", "position", " ", "for", " ", 
     RowBox[{"downloading", ".", " ", "Change"}], " ", 
     RowBox[{"to", " ", "'"}], 
     RowBox[{
      RowBox[{"Length", "@", "offset"}], "'"}], " ", "to", " ", "process", 
     " ", "the", " ", "full", " ", 
     RowBox[{"dump", "."}]}], "*)"}]}]}]], "Input",
 CellChangeTimes->{{3.961392651079564*^9, 3.96139266771244*^9}, {
   3.961392999143167*^9, 3.961393009201879*^9}, {3.961475038081003*^9, 
   3.961475038147655*^9}, 3.961475675274736*^9, {3.9614817280883493`*^9, 
   3.9614817290126867`*^9}},
 CellLabel->"In[66]:=",ExpressionUUID->"e393f7bd-07a8-450f-ae72-ffaefa484415"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"6.", " ", "Start", " ", "the", " ", "download", " ", 
     RowBox[{"loop", ".", " ", "The"}], " ", "URLs", " ", "of", " ", 
     "unsuccesful", " ", "downloads", " ", "are", " ", "listed", " ", "below",
      " ", "for", " ", "checking"}], " ", "\[Dash]", " ", 
    RowBox[{"often", " ", 
     RowBox[{"dead", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"Monitor", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Quiet", "[", 
      RowBox[{"Close", "[", "logFilePath", "]"}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Quiet", "@", 
      RowBox[{"DeleteFile", "[", "logFilePath", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"OpenWrite", "[", "logFilePath", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Table", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"assoc", "=", 
         RowBox[{"Import", "[", 
          RowBox[{
           RowBox[{"FileNameJoin", "[", 
            RowBox[{"{", 
             RowBox[{"pageBatchFolder", ",", 
              RowBox[{"StringTake", "[", 
               RowBox[{
                RowBox[{"ToString", "@", 
                 RowBox[{"offsets", "[", 
                  RowBox[{"[", "i", "]"}], "]"}]}], ",", 
                RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
              RowBox[{
               RowBox[{"ToString", "@", 
                RowBox[{"offsets", "[", 
                 RowBox[{"[", "i", "]"}], "]"}]}], "<>", "\"\<.json\>\""}]}], 
             "}"}], "]"}], ",", "\"\<RawJSON\>\""}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"ids", "=", 
         RowBox[{"Keys", "@", "assoc"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"urlsPicksOffset", "=", 
         RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"urlHashesOffset", "=", 
         RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"urlsClean", "=", 
            RowBox[{
             RowBox[{
              RowBox[{"StringReplace", "[", 
               RowBox[{"#", ",", 
                RowBox[{
                 RowBox[{"FileExtension", "[", "#", "]"}], "->", 
                 RowBox[{"StringDelete", "[", 
                  RowBox[{
                   RowBox[{"FileExtension", "[", "#", "]"}], ",", 
                   "\"\<_\>\""}], "]"}]}]}], "]"}], "&"}], "/@", 
             RowBox[{"Values", "[", 
              RowBox[{"assoc", "[", 
               RowBox[{"[", 
                RowBox[{"j", ",", "\"\<mediaLinks\>\""}], "]"}], "]"}], 
              "]"}]}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"urlsPos", "=", 
            RowBox[{"Position", "[", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"StringMatchQ", "[", 
                 RowBox[{
                  RowBox[{"FileExtension", "[", "#", "]"}], ",", 
                  RowBox[{"Alternatives", "@@", 
                   RowBox[{"{", 
                    RowBox[{
                    "\"\<jpg\>\"", ",", "\"\<jpeg\>\"", ",", "\"\<png\>\"", 
                    ",", "\"\<tif\>\"", ",", "\"\<tiff\>\""}], "}"}]}], ",", 
                  RowBox[{"IgnoreCase", "->", "True"}]}], "]"}], "&"}], "/@", 
               "urlsClean"}], ",", "True"}], "]"}]}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"picks", "=", "Infinity"}], ";", "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"Length", "@", "urlsPos"}], ">=", "1"}], "&&", 
              RowBox[{
               RowBox[{"Length", "@", "urlsPos"}], "<=", "picks"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"urlsPicksPos", "=", 
               RowBox[{"Take", "[", 
                RowBox[{"urlsPos", ",", 
                 RowBox[{"UpTo", "[", "picks", "]"}]}], "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"urlsPicks", "=", 
               RowBox[{"Extract", "[", 
                RowBox[{"urlsClean", ",", "urlsPicksPos"}], "]"}]}], ";", 
              RowBox[{"urlHashes", "=", 
               RowBox[{"Extract", "[", 
                RowBox[{
                 RowBox[{"Values", "[", 
                  RowBox[{"assoc", "[", 
                   RowBox[{"[", 
                    RowBox[{"j", ",", "\"\<mediaLinks\>\""}], "]"}], "]"}], 
                  "]"}], ",", "urlsPicksPos"}], "]"}]}], ";"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"urlsPicks", "=", 
               RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"urlHashes", "=", 
               RowBox[{"{", "}"}]}], ";"}]}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"AppendTo", "[", 
            RowBox[{"urlsPicksOffset", ",", "urlsPicks"}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"AppendTo", "[", 
            RowBox[{"urlHashesOffset", ",", "urlHashes"}], "]"}], ";"}], 
          "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"j", ",", 
            RowBox[{"Length", "@", "assoc"}]}], "}"}]}], "]"}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"goodPos", "=", 
         RowBox[{"Flatten", "[", 
          RowBox[{"Position", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"MatchQ", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", "}"}]}], "]"}], "&"}], "/@", "urlsPicksOffset"}],
             ",", "False"}], "]"}], "]"}]}], ";", 
        RowBox[{"partitionedCalls", "=", 
         RowBox[{"Partition", "[", 
          RowBox[{
           RowBox[{"Flatten", "[", "urlsPicksOffset", "]"}], ",", 
           RowBox[{"UpTo", "[", "50", "]"}]}], "]"}]}], ";", 
        RowBox[{"resultAssoc", "=", 
         RowBox[{"Merge", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"FetchImageListURL", "[", "#", "]"}], "&"}], "/@", 
            "partitionedCalls"}], ",", "First"}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"Table", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"DownloadImageFast", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"resultAssoc", "[", 
               RowBox[{"StringDelete", "[", 
                RowBox[{
                 RowBox[{"urlsPicksOffset", "[", 
                  RowBox[{"[", 
                   RowBox[{"d", ",", "e"}], "]"}], "]"}], ",", 
                 "\"\<https://en.wikipedia.org/wiki/\>\""}], "]"}], "]"}], 
              ",", 
              RowBox[{"urlHashesOffset", "[", 
               RowBox[{"[", 
                RowBox[{"d", ",", "e"}], "]"}], "]"}], ",", "downloadPath", 
              ",", "hashFilePath"}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"e", ",", 
              RowBox[{"Length", "@", 
               RowBox[{"urlsPicksOffset", "[", 
                RowBox[{"[", "d", "]"}], "]"}]}]}], "}"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"d", ",", "goodPos"}], "}"}]}], "]"}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"ClearAll", "[", 
         RowBox[{
         "assoc", ",", "ids", ",", "urlsClean", ",", "urlsPos", ",", 
          "urlsPicksPos", ",", "urlsPicks", ",", "urlHashes"}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"ClearSystemCache", "[", "]"}], ";", 
        RowBox[{"WriteString", "[", 
         RowBox[{"logFilePath", ",", 
          RowBox[{"\"\<Success at \>\"", "<>", 
           RowBox[{"ToString", "[", "i", "]"}], "<>", 
           "\"\< \[Dash]\[NonBreakingSpace]\>\"", "<>", 
           RowBox[{"DateString", "[", 
            RowBox[{"{", 
             RowBox[{
             "\"\<Hour\>\"", ",", "\"\<:\>\"", ",", "\"\<Minute\>\"", ",", 
              "\"\<:\>\"", ",", "\"\<Second\>\""}], "}"}], "]"}], "<>", 
           "\"\<\\n\>\""}]}], "]"}], ";"}], "\[IndentingNewLine]", 
       "\[IndentingNewLine]", ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "start", ",", "end"}], "}"}]}], "]"}], ";"}], ",", 
    RowBox[{"{", 
     RowBox[{"i", ",", "d", ",", "e"}], "}"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.9247794853311996`*^9, 3.924779487158616*^9}, {
   3.9247795825365357`*^9, 3.924779589030897*^9}, {3.9247796288458214`*^9, 
   3.924779734024513*^9}, 3.924779778117179*^9, 3.924780138232963*^9, {
   3.924780180467921*^9, 3.924780225411071*^9}, 3.9247802858295813`*^9, {
   3.9247804214926405`*^9, 3.924780487128275*^9}, {3.9247834759368105`*^9, 
   3.924783479811145*^9}, {3.9247836991478443`*^9, 3.924783699321583*^9}, {
   3.9247838563810954`*^9, 3.924783931816762*^9}, {3.9247874543253107`*^9, 
   3.9247875183360677`*^9}, {3.9247876080092583`*^9, 3.924787638409031*^9}, {
   3.924787672785576*^9, 3.9247876872837567`*^9}, {3.9247995964741907`*^9, 
   3.9247995974031963`*^9}, {3.924838590926773*^9, 3.924838591277655*^9}, {
   3.9248478012625923`*^9, 3.924847804541862*^9}, {3.9248525473648977`*^9, 
   3.924852634348715*^9}, {3.92485269206087*^9, 3.924852704980836*^9}, {
   3.9248528494863734`*^9, 3.9248528541150923`*^9}, {3.924860432315325*^9, 
   3.924860444074911*^9}, {3.9248692183764906`*^9, 3.9248692666556606`*^9}, {
   3.9249212164212933`*^9, 3.9249212362432585`*^9}, {3.9249284095091743`*^9, 
   3.9249284174942207`*^9}, 3.924929516599745*^9, {3.9249305357917433`*^9, 
   3.92493053817131*^9}, {3.924931259908141*^9, 3.92493126013663*^9}, {
   3.9249313064149537`*^9, 3.9249313246638813`*^9}, {3.924932004702873*^9, 
   3.924932019212714*^9}, {3.9249530196843433`*^9, 3.9249530233460073`*^9}, {
   3.9249581524863405`*^9, 3.9249581617291937`*^9}, {3.925109784951676*^9, 
   3.9251097928107843`*^9}, {3.925127970798621*^9, 3.925127972884755*^9}, {
   3.9251280511480846`*^9, 3.925128052264267*^9}, {3.925184346976667*^9, 
   3.925184354677496*^9}, 3.925186781175117*^9, {3.9252702625548515`*^9, 
   3.9252702641113567`*^9}, {3.9252703516809044`*^9, 3.92527036538589*^9}, {
   3.925270402883873*^9, 3.9252704114258747`*^9}, {3.926392405226226*^9, 
   3.926392419077319*^9}, {3.9263924970213213`*^9, 3.926392499784401*^9}, 
   3.9263927949762964`*^9, 3.9263930972409315`*^9, {3.9263931429254217`*^9, 
   3.926393146803368*^9}, 3.9263941621760035`*^9, 3.926394424697567*^9, {
   3.9263945192991133`*^9, 3.926394521042627*^9}, {3.926394921445381*^9, 
   3.926394991957073*^9}, {3.926395557129274*^9, 3.926395561922949*^9}, {
   3.9264263114528093`*^9, 3.9264263116769266`*^9}, {3.9265710302809043`*^9, 
   3.926571030647043*^9}, {3.926580175639187*^9, 3.92658017616325*^9}, {
   3.9266531407853317`*^9, 3.9266531412983685`*^9}, {3.961392620947247*^9, 
   3.961392632094948*^9}, {3.9613927048584414`*^9, 3.9613927151514597`*^9}, {
   3.961393951150448*^9, 3.961393951352565*^9}, {3.9613961473531733`*^9, 
   3.961396148901135*^9}, {3.961475040176673*^9, 3.961475040245686*^9}, {
   3.961475690575169*^9, 3.96147569091964*^9}, {3.9614794098704453`*^9, 
   3.961479445149118*^9}, {3.961479668021185*^9, 3.9614796686678658`*^9}, {
   3.9614800717535048`*^9, 3.961480073049712*^9}, {3.9614806372326717`*^9, 
   3.961480637999902*^9}, {3.961480681731415*^9, 3.961480683275427*^9}, {
   3.961481500432527*^9, 3.9614815799660597`*^9}},
 CellLabel->"In[68]:=",ExpressionUUID->"806236d5-4db9-4034-b560-e02cda9fea8b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "7.", " ", "Create", " ", "Image", " ", "Hash", " ", "Indexes", " ", 
     "for", " ", "downstream", " ", "use"}], " ", "\[Dash]", " ", 
    RowBox[{
    "MD5", " ", "is", " ", "stable", " ", "across", " ", "systems"}]}], 
   "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"pageBatches", "=", 
     RowBox[{"Select", "[", 
      RowBox[{
       RowBox[{"FileNames", "[", 
        RowBox[{"All", ",", "pageBatchFolder", ",", "2"}], "]"}], ",", 
       RowBox[{"StringContainsQ", "[", "\"\<json\>\"", "]"}]}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
    "Find", " ", "all", " ", "URLs", " ", "in", " ", "Page", " ", 
     "Metadata"}], "*)"}], "\n", 
   RowBox[{"Monitor", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"mediaLinks", "=", 
       RowBox[{"DeleteDuplicates", "@", 
        RowBox[{"Flatten", "[", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"Values", "[", 
            RowBox[{"Values", "[", 
             RowBox[{
              RowBox[{"Import", "[", 
               RowBox[{
                RowBox[{"pageBatches", "[", 
                 RowBox[{"[", "i", "]"}], "]"}], ",", "\"\<RawJSON\>\""}], 
               "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "\"\<mediaLinks\>\""}], "]"}], "]"}], 
             "]"}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "@", "pageBatches"}]}], "}"}]}], "]"}], 
         "]"}]}]}], ";"}], ",", "i"}], "]"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Hash", " ", "them", " ", "all"}], "*)"}], "\n", 
   RowBox[{
    RowBox[{"mediaLinksHashed", "=", 
     RowBox[{
      RowBox[{
       RowBox[{"StringTake", "[", 
        RowBox[{
         RowBox[{"ToString", "[", 
          RowBox[{"Abs", "[", 
           RowBox[{"Hash", "[", 
            RowBox[{"#", ",", "\"\<MD5\>\""}], "]"}], "]"}], "]"}], ",", 
         "18"}], "]"}], "&"}], "/@", "mediaLinks"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"mediaLinksAssoc", "=", 
     RowBox[{"AssociationThread", "[", 
      RowBox[{"mediaLinks", ",", "mediaLinksHashed"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"mediaLinksAssocReversed", "=", 
     RowBox[{"AssociationThread", "[", 
      RowBox[{"mediaLinksHashed", ",", "mediaLinks"}], "]"}]}], ";"}], "\n", 
   RowBox[{"(*", 
    RowBox[{
    "Only", " ", "included", " ", "entries", " ", "for", " ", "downloaded", 
     " ", "images"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"existingHashs", "=", 
     RowBox[{
      RowBox[{
       RowBox[{"FileBaseName", "[", "#", "]"}], "&"}], "/@", 
      RowBox[{"Select", "[", 
       RowBox[{
        RowBox[{"FileNames", "[", 
         RowBox[{"All", ",", 
          RowBox[{"FileNameJoin", "[", 
           RowBox[{"{", 
            RowBox[{"$buildFolder", ",", "\"\<data\>\"", ",", "\"\<img\>\""}],
             "}"}], "]"}], ",", "2"}], "]"}], ",", 
        RowBox[{"StringContainsQ", "[", "\"\<.jpg\>\"", "]"}]}], "]"}]}]}], 
    ";"}], "\n", 
   RowBox[{
    RowBox[{"mediaLinksFiltered", "=", 
     RowBox[{"Association", "[", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"existingHashs", "[", 
          RowBox[{"[", "i", "]"}], "]"}], "->", 
         RowBox[{"mediaLinksAssocReversed", "[", 
          RowBox[{"[", 
           RowBox[{"existingHashs", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "]"}], "]"}]}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Length", "@", "existingHashs"}]}], "}"}]}], "]"}], "]"}]}],
     ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"mediaLinksDictionary", "=", 
     RowBox[{"AssociationThread", "[", 
      RowBox[{
       RowBox[{"Values", "[", "mediaLinksFiltered", "]"}], ",", 
       RowBox[{"Keys", "[", "mediaLinksFiltered", "]"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<indices\>\"", ",", 
         "\"\<imgHashIndex.wxf\>\""}], "}"}], "]"}], ",", 
      "mediaLinksDictionary"}], "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.961394826779564*^9, 3.961394826839863*^9}, {
   3.961394858186837*^9, 3.9613948869571466`*^9}, {3.9613951566664553`*^9, 
   3.9613951582046223`*^9}, {3.9613952924862556`*^9, 3.961395297001417*^9}, {
   3.9613953371401052`*^9, 3.961395495996005*^9}, 3.961395581790243*^9, {
   3.9613956271930647`*^9, 3.9613956290661707`*^9}, {3.9613958719192753`*^9, 
   3.961395875879912*^9}, {3.961395927992391*^9, 3.9613959507907457`*^9}, {
   3.9613961409813967`*^9, 3.9613961436984177`*^9}, {3.9613964769853773`*^9, 
   3.96139647712705*^9}, {3.9613966970961742`*^9, 3.9613966973043413`*^9}, {
   3.961397943687434*^9, 3.9613980053997183`*^9}, {3.961398147835602*^9, 
   3.961398148139559*^9}, {3.961398704497107*^9, 3.9613987045524683`*^9}, {
   3.961400529170039*^9, 3.96140052924926*^9}, {3.9614750454279222`*^9, 
   3.961475045522624*^9}, {3.961483464569715*^9, 3.96148349979677*^9}, {
   3.961483571025223*^9, 3.9614836053247213`*^9}, {3.9614855234885273`*^9, 
   3.961485531235784*^9}, 3.961485563622889*^9, {3.961485684124694*^9, 
   3.961485686191392*^9}, {3.961485742016056*^9, 3.961485782278676*^9}, {
   3.961486175288031*^9, 3.9614861753929787`*^9}, {3.961486320651561*^9, 
   3.961486321098385*^9}, {3.961569317552061*^9, 
   3.9615693178531723`*^9}},ExpressionUUID->"b88fd2ee-7567-482b-82c0-\
c8b759680c08"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "8.", " ", "Check", " ", "if", " ", "the", " ", "hash", " ", "index", " ",
      "works"}], ",", " ", 
    RowBox[{
    "translating", " ", "from", " ", "a", " ", "URL", " ", "to", " ", "has", 
     " ", "and", " ", 
     RowBox[{"import", ".", " ", "Evaluate"}], " ", "the", " ", "cells", " ", 
     "a", " ", "couple", " ", "of", " ", "times"}], ",", " ", 
    RowBox[{
    "a", " ", "random", " ", "hash", " ", "is", " ", "picked", " ", "each", 
     " ", 
     RowBox[{"time", "."}]}]}], "*)"}], "\n", 
  RowBox[{
   RowBox[{
    RowBox[{"mediaLinksDictionary", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<indices\>\"", ",", 
         "\"\<imgHashIndex.wxf\>\""}], "}"}], "]"}], "]"}]}], ";"}], "\n", 
   RowBox[{"link", "=", 
    RowBox[{
     RowBox[{"Keys", "[", "mediaLinksDictionary", "]"}], "[", 
     RowBox[{"[", 
      RowBox[{"RandomInteger", "[", 
       RowBox[{"Length", "[", "mediaLinksDictionary", "]"}], "]"}], "]"}], 
     "]"}]}], "\[IndentingNewLine]", 
   RowBox[{"hash", "=", 
    RowBox[{"mediaLinksDictionary", "[", 
     RowBox[{"[", "link", "]"}], "]"}]}], "\[IndentingNewLine]", 
   RowBox[{"Image", "[", 
    RowBox[{
     RowBox[{"Import", "@", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{"$buildFolder", ",", "\"\<data\>\"", ",", "\"\<img\>\"", ",", 
         RowBox[{"StringTake", "[", 
          RowBox[{"hash", ",", 
           RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
         RowBox[{"hash", "<>", "\"\<.jpg\>\""}]}], "}"}], "]"}]}], ",", 
     RowBox[{"ImageSize", "->", "Tiny"}]}], "]"}]}]}]], "Input",
 CellChangeTimes->{{3.9414241096881933`*^9, 3.941424111789119*^9}, {
  3.961396779064644*^9, 3.961396815635171*^9}, {3.961485575096335*^9, 
  3.961485576002943*^9}, {3.961489229896719*^9, 3.961489256559765*^9}},
 CellLabel->"In[84]:=",ExpressionUUID->"8dfcc14b-4404-4e79-9a96-76d1e855d628"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["5. Collect Image Metadata",
 FontSize->24,
 FontColor->RGBColor[0., 0., 0.]]], "Subtitle",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004653855638*^9}, {
   3.9255429588956685`*^9, 3.9255429656805353`*^9}, {3.933419738072833*^9, 
   3.933419738467922*^9}, {3.961339364151065*^9, 3.961339392280257*^9}, {
   3.961390164835906*^9, 3.961390173814896*^9}, 3.961393054862067*^9, {
   3.961426955932397*^9, 3.9614270283665447`*^9}, 3.961427104011215*^9, {
   3.961427204583488*^9, 3.961427204660143*^9}, {3.961427434486286*^9, 
   3.961427441977523*^9}, {3.9614275420539713`*^9, 3.961427552660529*^9}, 
   3.961427728316593*^9},ExpressionUUID->"68ef834e-4c19-4129-ad21-\
37f8d0e2166e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "1.", " ", "Set", " ", "directories", " ", "and", " ", "import", " ", 
     "pre"}], "-", 
    RowBox[{"processed", " ", 
     RowBox[{"files", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"offsets", "=", 
     RowBox[{"Import", "@", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<build\>\"", ",", "\"\<offsets.wxf\>\""}], 
        "}"}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"imgHashes", "=", 
     RowBox[{"ToString", "/@", 
      RowBox[{"Import", "[", 
       RowBox[{
        RowBox[{"FileNameJoin", "[", 
         RowBox[{"{", 
          RowBox[{
          "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<img\>\"", ",", 
           RowBox[{"\"\<hashlist\>\"", "<>", "\"\<.txt\>\""}]}], "}"}], "]"}],
         ",", "\"\<List\>\""}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"mediaLinksDictionary", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<indices\>\"", ",", 
         "\"\<imgHashIndex.wxf\>\""}], "}"}], "]"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"imgBioFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<data\>\"", ",", "\"\<imgBios\>\""}], 
       "}"}], "]"}]}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.931345926176607*^9, 3.9313459302730165`*^9}, {
   3.9313459962659707`*^9, 3.9313460051133456`*^9}, 3.9314094073560534`*^9, {
   3.9613930783924913`*^9, 3.961393083245582*^9}, {3.961393644716013*^9, 
   3.9613936726259203`*^9}, {3.961396493495132*^9, 3.961396493584055*^9}, {
   3.961396863867239*^9, 3.961396871034445*^9}, {3.961397608843356*^9, 
   3.96139760917109*^9}, 3.961415450206719*^9, {3.9614159034999027`*^9, 
   3.961415917420772*^9}, {3.9614162645269938`*^9, 3.961416264682867*^9}, {
   3.961416360259807*^9, 3.961416430785597*^9}, {3.961475072311408*^9, 
   3.961475078511977*^9}, {3.961475841496595*^9, 3.961475849879511*^9}, {
   3.961511835458453*^9, 
   3.961511835721079*^9}},ExpressionUUID->"edd0a86a-d92e-4a36-88c2-\
8542e41c4e20"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "2.", " ", "Define", " ", "a", " ", "single", " ", "log", " ", "file", " ",
     "to", " ", "record", " ", 
    RowBox[{"process", ".", " ", "This"}], " ", "will", " ", "be", " ", 
    "overwritten", " ", "for", " ", "each", " ", "new", " ", "encoding", " ", 
    RowBox[{"session", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"logFilePath", "=", 
    RowBox[{"FileNameJoin", "[", 
     RowBox[{"{", 
      RowBox[{"$buildFolder", ",", "\"\<build\>\"", ",", "\"\<logs\>\"", ",", 
       RowBox[{"\"\<imgBioLog\>\"", "<>", "\"\<.txt\>\""}]}], "}"}], "]"}]}], 
   ";"}]}]], "Input",
 CellChangeTimes->{{3.925545195607813*^9, 3.9255452032863975`*^9}, {
   3.9256290441589828`*^9, 3.9256290686145725`*^9}, 3.925646844922707*^9, {
   3.9613890927890673`*^9, 3.961389096458434*^9}, {3.9613893494581623`*^9, 
   3.961389392335256*^9}, {3.961396954904188*^9, 3.9613969615630207`*^9}, {
   3.9613970288323727`*^9, 3.961397028963064*^9}, {3.961415981881052*^9, 
   3.9614159870764017`*^9}, {3.961416026619151*^9, 3.961416026956019*^9}, {
   3.961475082076515*^9, 3.961475082153089*^9}, {3.9614758559201317`*^9, 
   3.9614758587887774`*^9}},
 CellLabel->"In[92]:=",ExpressionUUID->"6faee354-432f-4dd2-9234-de704f7fba60"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "3.", " ", "If", " ", "you", " ", "encoded", " ", "texts", " ", 
     "already"}], ",", " ", 
    RowBox[{
    "see", " ", "at", " ", "which", " ", "batch", " ", "you", " ", "left", 
     " ", "off", " ", "by", " ", "reading", " ", "the", " ", "log", " ", 
     "file"}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"log", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"logFilePath", ",", "\"\<List\>\""}], "]"}]}], ";"}], "\n", 
   RowBox[{"last", "=", 
    RowBox[{"Last", "@", "log"}]}]}]}]], "Input",
 CellChangeTimes->{{3.925545195607813*^9, 3.9255452032863975`*^9}, {
   3.9256290441589828`*^9, 3.9256290686145725`*^9}, 3.925646844922707*^9, {
   3.9313455928764706`*^9, 3.9313455943917017`*^9}, {3.934258906596924*^9, 
   3.9342589184861164`*^9}, {3.961415983530541*^9, 3.961416019011993*^9}, {
   3.961475083738206*^9, 3.961475083844564*^9}},
 CellLabel->"In[93]:=",ExpressionUUID->"d6cf7414-71d1-450e-9c0b-dd4c05b9c723"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "3.", " ", "Input", " ", "start", " ", "and", " ", "end", " ", "positions",
     " ", "of", " ", "the", " ", "offset", " ", "list", " ", "to", " ", 
    "start", " ", "the", " ", "next", " ", 
    RowBox[{"loop", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"start", "=", "1"}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Start", " ", 
      RowBox[{"position", ".", " ", 
       RowBox[{"Add", " ", "'"}]}], "last"}], "+", 
     RowBox[{
      RowBox[{"1", "'"}], " ", "here", " ", "if", " ", "you", " ", "are", " ",
       "picking", " ", "up", " ", "after", " ", "an", " ", 
      RowBox[{"interruption", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"end", "=", "10"}], ";"}], "  ", 
   RowBox[{"(*", 
    RowBox[{"End", " ", 
     RowBox[{"position", ".", " ", "Change"}], " ", 
     RowBox[{"to", " ", "'"}], 
     RowBox[{
      RowBox[{"Length", "@", "offset"}], "'"}], " ", "to", " ", "process", 
     " ", "the", " ", "full", " ", 
     RowBox[{"dump", "."}]}], "*)"}]}]}]], "Input",
 CellChangeTimes->{{3.961475277227673*^9, 3.961475308234008*^9}},
 CellLabel->"In[95]:=",ExpressionUUID->"5aed0ec9-de2e-4656-b58e-dc3fb34c1edf"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "4.", " ", "Run", " ", "this", " ", "cell", " ", "to", " ", "export", " ",
      "the", " ", "positions", " ", "of", " ", "images", " ", "on", " ", 
     "pages", " ", "of", " ", "appearance"}], ",", " ", 
    RowBox[{
    "an", " ", "indicator", " ", "for", " ", "relative", " ", 
     "importance"}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"Quiet", "[", 
     RowBox[{"Close", "[", "logFilePath", "]"}], "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Quiet", "@", 
     RowBox[{"DeleteFile", "[", "logFilePath", "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"OpenWrite", "[", "logFilePath", "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"Monitor", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"offset", "=", 
          RowBox[{"offsets", "[", 
           RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"assoc", "=", 
          RowBox[{"Import", "[", 
           RowBox[{
            RowBox[{"FileNameJoin", "[", 
             RowBox[{"{", 
              RowBox[{
              "$buildFolder", ",", "\"\<build\>\"", ",", "\"\<batches\>\"", 
               ",", 
               RowBox[{"StringTake", "[", 
                RowBox[{
                 RowBox[{"ToString", "@", "offset"}], ",", 
                 RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
               RowBox[{
                RowBox[{"ToString", "@", "offset"}], "<>", 
                "\"\<.json\>\""}]}], "}"}], "]"}], ",", "\"\<RawJSON\>\""}], 
           "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"ids", "=", 
          RowBox[{"Keys", "@", "assoc"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"Table", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"id", "=", 
             RowBox[{"ids", "[", 
              RowBox[{"[", "j", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"pageHashes", "=", 
             RowBox[{
              RowBox[{
               RowBox[{"mediaLinksDictionary", "[", "#", "]"}], "&"}], "/@", 
              RowBox[{"Values", "[", 
               RowBox[{"assoc", "[", 
                RowBox[{"id", ",", "\"\<mediaLinks\>\""}], "]"}], "]"}]}]}], 
            ";", 
            RowBox[{"downloadedHashes", "=", 
             RowBox[{"Pick", "[", 
              RowBox[{"pageHashes", ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"MemberQ", "[", 
                  RowBox[{"imgHashes", ",", "#"}], "]"}], "&"}], "/@", 
                "pageHashes"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"Table", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"hash", "=", 
                RowBox[{"downloadedHashes", "[", 
                 RowBox[{"[", "k", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"pos", "=", 
                RowBox[{"First", "@", 
                 RowBox[{"First", "@", 
                  RowBox[{"Position", "[", 
                   RowBox[{"pageHashes", ",", "hash"}], "]"}]}]}]}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"fileName", "=", 
                RowBox[{"FileNameJoin", "[", 
                 RowBox[{"{", 
                  RowBox[{"imgBioFolder", ",", "\"\<txt\>\"", ",", 
                   RowBox[{"StringTake", "[", 
                    RowBox[{"hash", ",", 
                    RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
                   RowBox[{"hash", "<>", "\"\<.txt\>\""}]}], "}"}], "]"}]}], 
               ";", "\[IndentingNewLine]", 
               RowBox[{"Quiet", "[", 
                RowBox[{"CreateFile", "[", "fileName", "]"}], "]"}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"stream", "=", 
                RowBox[{"OpenAppend", "[", "fileName", "]"}]}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"Write", "[", 
                RowBox[{"stream", ",", 
                 RowBox[{"id", "<>", "\"\<p\>\"", "<>", 
                  RowBox[{"ToString", "@", "pos"}]}]}], "]"}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"Close", "[", "fileName", "]"}], ";"}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"{", 
               RowBox[{"k", ",", 
                RowBox[{"Length", "@", "downloadedHashes"}]}], "}"}]}], "]"}],
             ";"}], ",", "\[IndentingNewLine]", 
           RowBox[{"{", 
            RowBox[{"j", ",", 
             RowBox[{"Length", "@", "ids"}]}], "}"}]}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"WriteString", "[", 
          RowBox[{"logFilePath", ",", 
           RowBox[{
            RowBox[{"ToString", "@", "i"}], "<>", "\"\<\\n\>\""}]}], "]"}], 
         ";"}], ",", "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"i", ",", "start", ",", "end"}], "}"}]}], "]"}], ";"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "j", ",", "k"}], "}"}]}], "]"}]}]}]], "Input",
 CellChangeTimes->{{3.934255697291608*^9, 3.934255707609355*^9}, {
  3.9342587622850285`*^9, 3.934258836943488*^9}, {3.9342589504309416`*^9, 
  3.934258980090562*^9}, {3.934259073809778*^9, 3.934259106688233*^9}, {
  3.934259188038446*^9, 3.934259197909831*^9}, {3.934259297897297*^9, 
  3.9342593657835417`*^9}, {3.9614161493549128`*^9, 3.9614161908793783`*^9}, {
  3.9614163317833633`*^9, 3.961416335575588*^9}, {3.961426047120036*^9, 
  3.961426049146809*^9}, {3.9614751026322107`*^9, 3.96147525347016*^9}, {
  3.961475333230884*^9, 3.961475365869711*^9}, {3.961475872181645*^9, 
  3.9614758854499807`*^9}},
 CellLabel->"In[97]:=",ExpressionUUID->"d1bc3eef-eea7-4797-b3a9-ae47fbbca2b7"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "5.", " ", "Input", " ", "start", " ", "and", " ", "end", " ", "positions",
     " ", "of", " ", "the", " ", "offset", " ", "list", " ", "to", " ", 
    "start", " ", "the", " ", "next", " ", 
    RowBox[{"loop", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"start", "=", "1"}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Start", " ", 
      RowBox[{"position", ".", " ", 
       RowBox[{"Add", " ", "'"}]}], "last"}], "+", 
     RowBox[{
      RowBox[{"1", "'"}], " ", "here", " ", "if", " ", "you", " ", "are", " ",
       "picking", " ", "up", " ", "after", " ", "an", " ", 
      RowBox[{"interruption", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"end", "=", "10"}], ";"}], "  ", 
   RowBox[{"(*", 
    RowBox[{"End", " ", 
     RowBox[{"position", ".", " ", "Change"}], " ", 
     RowBox[{"to", " ", "'"}], 
     RowBox[{
      RowBox[{"Length", "@", "offset"}], "'"}], " ", "to", " ", "process", 
     " ", "the", " ", "full", " ", 
     RowBox[{"dump", "."}]}], "*)"}]}]}]], "Input",
 CellChangeTimes->{{3.961475277227673*^9, 3.9614753213838463`*^9}},
 CellLabel->
  "In[101]:=",ExpressionUUID->"3d972c8b-de6a-498a-af7f-96d633a6016b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "6.", " ", "Run", " ", "this", " ", "cell", " ", "to", " ", "export", " ",
      "the", " ", "captions", " ", "of", " ", "images", " ", "on", " ", 
     "pages", " ", "of", " ", "appearance"}], ",", " ", 
    RowBox[{
    "as", " ", "one", " ", "image", " ", "can", " ", "have", " ", "many"}]}], 
   "*)"}], 
  RowBox[{
   RowBox[{
    RowBox[{"Quiet", "[", 
     RowBox[{"Close", "[", "logFilePath", "]"}], "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Quiet", "@", 
     RowBox[{"DeleteFile", "[", "logFilePath", "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"OpenWrite", "[", "logFilePath", "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"Monitor", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"offset", "=", 
          RowBox[{"offsets", "[", 
           RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"assoc", "=", 
          RowBox[{"Import", "[", 
           RowBox[{
            RowBox[{"FileNameJoin", "[", 
             RowBox[{"{", 
              RowBox[{
              "$buildFolder", ",", "\"\<build\>\"", ",", "\"\<batches\>\"", 
               ",", 
               RowBox[{"StringTake", "[", 
                RowBox[{
                 RowBox[{"ToString", "@", "offset"}], ",", 
                 RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
               RowBox[{
                RowBox[{"ToString", "@", "offset"}], "<>", 
                "\"\<.json\>\""}]}], "}"}], "]"}], ",", "\"\<RawJSON\>\""}], 
           "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"ids", "=", 
          RowBox[{"Keys", "@", "assoc"}]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"Table", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"id", "=", 
             RowBox[{"ids", "[", 
              RowBox[{"[", "j", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"pageHashes", "=", 
             RowBox[{
              RowBox[{
               RowBox[{"mediaLinksDictionary", "[", "#", "]"}], "&"}], "/@", 
              RowBox[{"Values", "[", 
               RowBox[{"assoc", "[", 
                RowBox[{"id", ",", "\"\<mediaLinks\>\""}], "]"}], "]"}]}]}], 
            ";", 
            RowBox[{"downloadedHashes", "=", 
             RowBox[{"Pick", "[", 
              RowBox[{"pageHashes", ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"MemberQ", "[", 
                  RowBox[{"imgHashes", ",", "#"}], "]"}], "&"}], "/@", 
                "pageHashes"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
            "\[IndentingNewLine]", 
            RowBox[{"Table", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"hash", "=", 
                RowBox[{"downloadedHashes", "[", 
                 RowBox[{"[", "k", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"pos", "=", 
                RowBox[{"First", "@", 
                 RowBox[{"First", "@", 
                  RowBox[{"Position", "[", 
                   RowBox[{"pageHashes", ",", "hash"}], "]"}]}]}]}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"fileName", "=", 
                RowBox[{"FileNameJoin", "[", 
                 RowBox[{"{", 
                  RowBox[{"imgBioFolder", ",", "\"\<txt\>\"", ",", 
                   RowBox[{"StringTake", "[", 
                    RowBox[{"hash", ",", 
                    RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
                   RowBox[{"hash", "<>", "\"\<_cap.txt\>\""}]}], "}"}], 
                 "]"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"Quiet", "[", 
                RowBox[{"CreateFile", "[", "fileName", "]"}], "]"}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"stream", "=", 
                RowBox[{"OpenAppend", "[", "fileName", "]"}]}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"caption", "=", 
                RowBox[{"assoc", "[", 
                 RowBox[{"[", 
                  RowBox[{
                   RowBox[{"ids", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", 
                   "\"\<mediaCaptions\>\"", ",", "pos"}], "]"}], "]"}]}], ";",
                "\[IndentingNewLine]", 
               RowBox[{"WriteString", "[", 
                RowBox[{"stream", ",", 
                 RowBox[{
                 "id", "<>", "\"\<_imageCaption_\>\"", "<>", "caption", "<>", 
                  "\"\<\\n\>\""}]}], "]"}], ";", "\[IndentingNewLine]", 
               RowBox[{"Close", "[", "fileName", "]"}], ";"}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"{", 
               RowBox[{"k", ",", 
                RowBox[{"Length", "@", "downloadedHashes"}]}], "}"}]}], "]"}],
             ";"}], ",", "\[IndentingNewLine]", 
           RowBox[{"{", 
            RowBox[{"j", ",", 
             RowBox[{"Length", "@", "ids"}]}], "}"}]}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"WriteString", "[", 
          RowBox[{"logFilePath", ",", 
           RowBox[{
            RowBox[{"ToString", "@", "i"}], "<>", "\"\<\\n\>\""}]}], "]"}], 
         ";"}], ",", "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"i", ",", "start", ",", "end"}], "}"}]}], "]"}], ";"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "j", ",", "k"}], "}"}]}], "]"}]}]}]], "Input",
 CellChangeTimes->{{3.934255697291608*^9, 3.934255707609355*^9}, {
  3.9342587622850285`*^9, 3.934258836943488*^9}, {3.9342589504309416`*^9, 
  3.934258980090562*^9}, {3.934259073809778*^9, 3.934259106688233*^9}, {
  3.934259188038446*^9, 3.934259197909831*^9}, {3.934259297897297*^9, 
  3.9342593657835417`*^9}, {3.9343405091931343`*^9, 3.934340581869293*^9}, {
  3.934340628729838*^9, 3.9343406326803927`*^9}, {3.9614166682631483`*^9, 
  3.961416686050396*^9}, {3.9614167216131763`*^9, 3.961416725046269*^9}, {
  3.9614751466207027`*^9, 3.961475147816759*^9}, {3.961475342647299*^9, 
  3.961475418476428*^9}, {3.961475902709299*^9, 3.961475912683077*^9}, {
  3.961489294925125*^9, 3.961489299371264*^9}},
 CellLabel->
  "In[103]:=",ExpressionUUID->"79cfe75b-d75f-4a1a-a504-79ed09fb563e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "7.", " ", "Run", " ", "this", " ", "cell", " ", "to", " ", "make", " ", 
    "clean", " ", "JSON", " ", "files", " ", "metadata", " ", "files", " ", 
    "with", " ", "sorted", " ", "mentions", " ", "and", " ", "captions", " ", 
    "for", " ", "each", " ", "hashed", " ", "image"}], "*)"}], "\n", 
  RowBox[{"Monitor", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"Table", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"hash", "=", 
         RowBox[{"imgHashes", "[", 
          RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"mentions", "=", 
         RowBox[{"ToString", "/@", 
          RowBox[{"Import", "[", 
           RowBox[{
            RowBox[{"FileNameJoin", "[", 
             RowBox[{"{", 
              RowBox[{"imgBioFolder", ",", "\"\<txt\>\"", ",", 
               RowBox[{"StringTake", "[", 
                RowBox[{"hash", ",", 
                 RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
               RowBox[{"hash", "<>", "\"\<.txt\>\""}]}], "}"}], "]"}], ",", 
            "\"\<List\>\""}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"captions", "=", 
         RowBox[{"ToString", "/@", 
          RowBox[{"Import", "[", 
           RowBox[{
            RowBox[{"FileNameJoin", "[", 
             RowBox[{"{", 
              RowBox[{"imgBioFolder", ",", "\"\<txt\>\"", ",", 
               RowBox[{"StringTake", "[", 
                RowBox[{"hash", ",", 
                 RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
               RowBox[{"hash", "<>", "\"\<_cap.txt\>\""}]}], "}"}], "]"}], 
            ",", "\"\<List\>\""}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"mentionsSorted", "=", 
         RowBox[{"SortBy", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"ToExpression", "/@", 
              RowBox[{"StringSplit", "[", 
               RowBox[{"#", ",", "\"\<p\>\""}], "]"}]}], "&"}], "/@", 
            "mentions"}], ",", 
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "&"}]}], "]"}]}], ";", "\n", 
        RowBox[{"mentionsSortedAssoc", "=", 
         RowBox[{"AssociationThread", "[", 
          RowBox[{
           RowBox[{"ToString", "/@", 
            RowBox[{"mentionsSorted", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ",", 
           RowBox[{
            RowBox[{
             RowBox[{"Association", "[", 
              RowBox[{"\"\<pos\>\"", "->", "#"}], "]"}], "&"}], "/@", 
            RowBox[{"mentionsSorted", "[", 
             RowBox[{"[", 
              RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], "]"}]}], ";", "\n", 
        RowBox[{"keys", "=", 
         RowBox[{"Keys", "[", "mentionsSortedAssoc", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"mentionsSortedAssoc", "[", 
             RowBox[{"[", 
              RowBox[{"keys", "[", 
               RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], "=", 
            "\[IndentingNewLine]", 
            RowBox[{"Join", "[", 
             RowBox[{
              RowBox[{"mentionsSortedAssoc", "[", 
               RowBox[{"[", 
                RowBox[{"keys", "[", 
                 RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
              RowBox[{"Association", "[", 
               RowBox[{"\"\<cap\>\"", "->", 
                RowBox[{"StringDelete", "[", 
                 RowBox[{
                  RowBox[{"StringDelete", "[", 
                   RowBox[{
                    RowBox[{"First", "[", 
                    RowBox[{"Extract", "[", 
                    RowBox[{"captions", ",", 
                    RowBox[{"Position", "[", 
                    RowBox[{
                    RowBox[{"StringStartsQ", "[", 
                    RowBox[{"captions", ",", 
                    RowBox[{"keys", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], "]"}], ",", "True"}], 
                    "]"}]}], "]"}], "]"}], ",", 
                    RowBox[{
                    RowBox[{"keys", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "<>", 
                    "\"\<_imageCaption_\>\""}]}], "]"}], ",", 
                  RowBox[{
                  "RegularExpression", "[", "\"\<\\\\d+\\\\s+px\>\"", "]"}]}],
                  "]"}]}], "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
          ",", 
          RowBox[{"{", 
           RowBox[{"j", ",", 
            RowBox[{"Length", "@", "keys"}]}], "}"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Export", "[", 
         RowBox[{
          RowBox[{"FileNameJoin", "[", 
           RowBox[{"{", 
            RowBox[{"imgBioFolder", ",", "\"\<json\>\"", ",", 
             RowBox[{"StringTake", "[", 
              RowBox[{"hash", ",", 
               RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
             RowBox[{"hash", "<>", "\"\<.json\>\""}]}], "}"}], "]"}], ",", 
          "mentionsSortedAssoc", ",", "\"\<JSON\>\""}], "]"}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", 
         RowBox[{"Length", "@", "imgHashes"}]}], "}"}]}], "]"}], ";"}], ",", 
    "i"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.934336893009285*^9, 3.9343368976753254`*^9}, {
   3.9344414398400545`*^9, 3.934441475205626*^9}, 3.9344431472005444`*^9, {
   3.961475429942527*^9, 3.961475478509177*^9}, {3.961475940188074*^9, 
   3.961475946443327*^9}},
 CellLabel->
  "In[107]:=",ExpressionUUID->"146dccab-1fe0-4017-8106-48169e097172"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["6. Import Encoding Models",
 FontSize->24,
 FontColor->RGBColor[0., 0., 0.]]], "Subtitle",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004653855638*^9}, {
  3.9255429588956685`*^9, 3.9255429656805353`*^9}, {3.933419738072833*^9, 
  3.933419738467922*^9}, {3.961339364151065*^9, 3.961339392280257*^9}, {
  3.961339440143086*^9, 3.9613394435077543`*^9}, {3.961427187056706*^9, 
  3.961427187152214*^9}, {3.9614277299309177`*^9, 
  3.961427730020862*^9}},ExpressionUUID->"36a39720-2e12-4747-b06b-\
b6db4f5c5b90"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "1.", " ", "Evaluate", " ", "all", " ", "CLIPedia", " ", "initialization",
      " ", "functions", " ", "by", " ", "clicking", " ", "yes", " ", "on", 
     " ", "the", " ", "notebook", " ", "pop"}], "-", "up"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"functions", "=", 
     RowBox[{"NotebookOpen", "[", 
      RowBox[{
       RowBox[{"FileNameJoin", "[", 
        RowBox[{"{", 
         RowBox[{
         "$repoFolder", ",", "\"\<code\>\"", ",", 
          "\"\<clipedia_functions.nb\>\""}], "}"}], "]"}], ",", 
       RowBox[{"Visible", "->", "True"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"SelectionMove", "[", 
     RowBox[{"functions", ",", "Before", ",", "Notebook"}], "]"}], ";", 
    RowBox[{"SelectionMove", "[", 
     RowBox[{"functions", ",", "Next", ",", "Cell"}], "]"}], ";", 
    RowBox[{"SelectionEvaluate", "[", "functions", "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.907645997965927*^9, 3.907646078557015*^9}, {
   3.907646185435628*^9, 3.907646186015532*^9}, {3.907646774687398*^9, 
   3.907646814543491*^9}, {3.907661852666642*^9, 3.907661892204844*^9}, {
   3.907662006350642*^9, 3.9076620119726*^9}, {3.9076663041483603`*^9, 
   3.907666304789756*^9}, {3.907686797040777*^9, 3.907686797747974*^9}, {
   3.919525496418584*^9, 3.919525497699961*^9}, {3.9197060623198233`*^9, 
   3.9197060667885957`*^9}, {3.919706114058092*^9, 3.919706128982294*^9}, {
   3.919781912755134*^9, 3.919781912795006*^9}, {3.919781947934552*^9, 
   3.919781966935747*^9}, {3.919848414262558*^9, 3.9198484146468883`*^9}, 
   3.935473720200501*^9, {3.935473838189433*^9, 3.935473841354582*^9}, {
   3.935638957223358*^9, 3.935638957326006*^9}, {3.9356390560379343`*^9, 
   3.935639058711771*^9}, {3.935658322424658*^9, 3.9356583225402327`*^9}, {
   3.935723004354435*^9, 3.935723004805295*^9}, {3.9359163367825336`*^9, 
   3.93591633723468*^9}, {3.936092399212842*^9, 3.936092399329157*^9}, 
   3.936158161570262*^9, {3.936260859452054*^9, 3.936260860115284*^9}, {
   3.937883982539661*^9, 3.9378839829721127`*^9}, {3.937995756107422*^9, 
   3.937995756221203*^9}, {3.938014732793124*^9, 3.9380147341018*^9}, 
   3.938016470467143*^9, 3.938016528755129*^9, {3.940414521626555*^9, 
   3.94041452456884*^9}, {3.9409089709718437`*^9, 3.940908971329804*^9}, {
   3.941016945740665*^9, 3.941016946103167*^9}, {3.9411006293110933`*^9, 
   3.9411006299214354`*^9}, {3.941234308389617*^9, 3.94123430887071*^9}, {
   3.9416718384564342`*^9, 3.941671838551146*^9}, {3.942299796095441*^9, 
   3.942299797625595*^9}, {3.943377137832711*^9, 3.943377138576899*^9}, {
   3.9563266467496433`*^9, 3.956326653817576*^9}, 3.961253113290951*^9, {
   3.961253529276929*^9, 3.9612535802263517`*^9}, {3.961253673538267*^9, 
   3.961253684603194*^9}, {3.96125372879198*^9, 3.961253766586738*^9}, 
   3.961314552173787*^9, {3.961321579753784*^9, 3.9613215894888973`*^9}, {
   3.961489392814011*^9, 3.961489392888639*^9}, {3.9615712508792887`*^9, 
   3.9615712524345007`*^9}},ExpressionUUID->"e28a3d0a-c3d3-43a4-b1e8-\
c537692e0685"],

Cell[TextData[{
 "CLIPedia requires OpenCLIP to work. If you haven\[CloseCurlyQuote]t done so \
already, the next step will download the OpenCLIP models from the ",
 ButtonBox["Wolfram Net Repository",
  BaseStyle->"Hyperlink",
  ButtonData->{
    URL["https://resources.wolframcloud.com/NeuralNetRepository/resources/\
OpenCLIP-Multi-domain-Feature-Extractor-Trained-on-LAION-2B-Data/?i=OpenCLIP+\
Multi-domain+Feature+Extractor+Trained+on+LAION-2B+Data&searchapi=https%3A%2F%\
2Fresources.wolframcloud.com%2FNeuralNetRepository%2Fsearch"], None},
  ButtonNote->
   "https://resources.wolframcloud.com/NeuralNetRepository/resources/OpenCLIP-\
Multi-domain-Feature-Extractor-Trained-on-LAION-2B-Data/?i=OpenCLIP+Multi-\
domain+Feature+Extractor+Trained+on+LAION-2B+Data&searchapi=https%3A%2F%\
2Fresources.wolframcloud.com%2FNeuralNetRepository%2Fsearch"],
 ". By proceeding, you accept OpenClip\[CloseCurlyQuote]s ",
 ButtonBox["license",
  BaseStyle->"Hyperlink",
  ButtonData->{
    URL["https://github.com/mlfoundations/open_clip/blob/main/LICENSE"], None},
  ButtonNote->"https://github.com/mlfoundations/open_clip/blob/main/LICENSE"],
 " and terms. OpenCLIP was published with a paper by ",
 ButtonBox["M. Cherti, R. Beaumont, R. Wightman, M. Wortsman, G. Ilharco, C. \
Gordon, C. Schuhmann, L. Schmidt, J. Jitsev, \"Reproducible Scaling Laws for \
Contrastive Language\[Dash]Image Learning,\" arXiv:2212.07143 (2022)",
  BaseStyle->"Hyperlink",
  ButtonData->{
    URL["https://arxiv.org/abs/2212.07143"], None},
  ButtonNote->"https://arxiv.org/abs/2212.07143"],
 "."
}], "Text",
 CellChangeTimes->{{3.961322656840361*^9, 3.9613228190407867`*^9}, {
  3.96132308812971*^9, 3.961323101513279*^9}, {3.961323324973174*^9, 
  3.961323327043833*^9}, {3.961323680950322*^9, 
  3.961323732393532*^9}},ExpressionUUID->"3c8c002b-d897-490c-a1a0-\
5dffd17f1b0a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "2.", " ", "If", " ", "not", " ", "done", " ", "so", " ", "already"}], 
    ",", " ", 
    RowBox[{"download", " ", "OpenCLIP", " ", "models"}]}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"DownloadCLIP", "[", "$repoFolder", "]"}], ";"}]}]], "Input",
 CellChangeTimes->{{3.961322564428425*^9, 3.9613225879180927`*^9}, 
   3.961322823569273*^9, {3.9613238599350367`*^9, 3.961323889053797*^9}, {
   3.961388791163472*^9, 3.961388791210835*^9}, {3.961475959985304*^9, 
   3.961475960828989*^9}, {3.961489412249569*^9, 3.961489412326252*^9}},
 CellLabel->
  "In[216]:=",ExpressionUUID->"6c586f73-a23a-4df4-aa5c-7c3de6ee67e8"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "3.", " ", "Load", " ", "OpenCLIP", " ", "Models", " ", "to", " ", 
    "Memory"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"textModel", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$repoFolder", ",", "\"\<code\>\"", ",", "\"\<models\>\"", ",", 
         "\"\<OpenCLIP_fe_textViT-B32.wxf\>\""}], "}"}], "]"}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"imgModel", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$repoFolder", ",", "\"\<code\>\"", ",", "\"\<models\>\"", ",", 
         "\"\<OpenCLIP_fe_imgViT-B32.wxf\>\""}], "}"}], "]"}], "]"}]}], 
    ";"}]}]}]], "Input",
 CellChangeTimes->{{3.925543296795121*^9, 3.9255433026881204`*^9}, {
  3.9255434041441245`*^9, 3.925543463020486*^9}, {3.9255434999575047`*^9, 
  3.925543523344516*^9}, {3.96138871943876*^9, 3.96138880635017*^9}, {
  3.961475967882641*^9, 3.961475977679576*^9}, {3.961489425265852*^9, 
  3.961489425405971*^9}},
 CellLabel->
  "In[217]:=",ExpressionUUID->"c8c5b91b-e3bb-4dc1-a066-5e9a205a96a8"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["7. Encode Text as Paragraphs",
 FontSize->24,
 FontColor->RGBColor[0., 0., 0.]]], "Subtitle",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004653855638*^9}, {
  3.9255429588956685`*^9, 3.9255429656805353`*^9}, {3.933419738072833*^9, 
  3.933419738467922*^9}, {3.961339364151065*^9, 3.961339392280257*^9}, {
  3.961339440143086*^9, 3.9613394547095613`*^9}, {3.961426928023511*^9, 
  3.961426930974004*^9}, {3.961427188539792*^9, 3.9614271886258497`*^9}, {
  3.961427731666916*^9, 3.961427731735064*^9}, {3.9614278555212708`*^9, 
  3.961427873447591*^9}},ExpressionUUID->"e33843b0-8cd5-43f6-a2df-\
1f01adb03be9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"1.", " ", "First", " ", "load", " ", "models", " ", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"Heading", " ", "6"}], ")"}], ".", " ", "Then"}], " ", "set", 
     " ", "directories", " ", "and", " ", "import", " ", "pre"}], "-", 
    RowBox[{"processed", " ", 
     RowBox[{"files", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"pageBatchFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<build\>\"", ",", "\"\<batches\>\""}],
        "}"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"offsets", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<build\>\"", ",", "\"\<offsets.wxf\>\""}], 
        "}"}], "]"}], "]"}]}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.9241010527273207`*^9, 3.9241010957977104`*^9}, 
   3.924490251295165*^9, {3.924795717561464*^9, 3.92479571793163*^9}, {
   3.924930683274341*^9, 3.924930686476282*^9}, {3.9613844084259653`*^9, 
   3.9613844092892017`*^9}, {3.961384458331336*^9, 3.961384519627919*^9}, {
   3.9613846447293386`*^9, 3.96138464505732*^9}, 3.96138472301958*^9, {
   3.961388842372552*^9, 3.961388846338296*^9}, {3.961396116241313*^9, 
   3.961396119367984*^9}, {3.9613961860038023`*^9, 3.9613961908194447`*^9}, {
   3.9614759869359837`*^9, 3.961476009915646*^9}, 3.96147609218812*^9, {
   3.9615118681140738`*^9, 3.961511868371242*^9}, {3.9615692500246487`*^9, 
   3.961569274054051*^9}},ExpressionUUID->"5342ae80-29f7-4b79-a782-\
f979635219f8"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"2.", " ", "Hardware", " ", 
     RowBox[{"setting", ":", " ", 
      RowBox[{
      "If", " ", "your", " ", "system", " ", "allows", " ", "Mathematica", 
       " ", "to", " ", "use", " ", "the", " ", "GPU", " ", "for", " ", 
       "encoding"}]}]}], ",", " ", 
    RowBox[{
    "this", " ", "will", " ", "speed", " ", "up", " ", "the", " ", "process", 
     " ", 
     RowBox[{"considerably", ".", " ", "Put"}], " ", "in", " ", "\"\<CPU\>\"",
      " ", "or", " ", 
     RowBox[{"\"\<GPU\>\"", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"targetDevice", "=", "\"\<CPU\>\""}], ";"}]}]], "Input",
 CellChangeTimes->{{3.961389181895177*^9, 3.961389244562353*^9}, {
  3.961389317845099*^9, 3.961389339937944*^9}},
 CellLabel->
  "In[221]:=",ExpressionUUID->"80c891b3-d7de-4368-a5a7-5e3c2154e6e0"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "3.", " ", "Define", " ", "a", " ", "single", " ", "log", " ", "file", " ",
     "to", " ", "record", " ", 
    RowBox[{"process", ".", " ", "This"}], " ", "will", " ", "be", " ", 
    "overwritten", " ", "for", " ", "each", " ", "new", " ", "encoding", " ", 
    RowBox[{"session", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"logFilePath", "=", 
    RowBox[{"FileNameJoin", "[", 
     RowBox[{"{", 
      RowBox[{"$buildFolder", ",", "\"\<build\>\"", ",", "\"\<logs\>\"", ",", 
       RowBox[{"\"\<textEncodedLog\>\"", "<>", "\"\<.txt\>\""}]}], "}"}], 
     "]"}]}], ";"}]}]], "Input",
 CellChangeTimes->{{3.925545195607813*^9, 3.9255452032863975`*^9}, {
   3.9256290441589828`*^9, 3.9256290686145725`*^9}, 3.925646844922707*^9, {
   3.9613890927890673`*^9, 3.961389096458434*^9}, {3.9613893494581623`*^9, 
   3.961389392335256*^9}, {3.961396954904188*^9, 3.9613969615630207`*^9}, {
   3.961476015054117*^9, 3.96147601654233*^9}},
 CellLabel->
  "In[222]:=",ExpressionUUID->"003d96e0-6241-4eef-9385-fc70c2778b93"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"X", ".", " ", "If"}], " ", "you", " ", "encoded", " ", "texts", 
     " ", "already"}], ",", " ", 
    RowBox[{
    "see", " ", "at", " ", "which", " ", "batch", " ", "you", " ", "left", 
     " ", "off", " ", "by", " ", "reading", " ", "the", " ", "log", " ", 
     "file"}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"log", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"logFilePath", ",", "\"\<List\>\""}], "]"}]}], ";"}], "\n", 
   RowBox[{"last", "=", 
    RowBox[{"Last", "[", 
     RowBox[{"Flatten", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"ToExpression", "/@", 
         RowBox[{"StringTrim", "[", 
          RowBox[{"StringCases", "[", 
           RowBox[{"#", ",", 
            RowBox[{
             RowBox[{"\"\<at\>\"", "~~", 
              RowBox[{"number", ":", 
               RowBox[{"Shortest", "[", "___", "]"}]}], "~~", "\"\<-\>\""}], ":>",
              "number"}]}], "]"}], "]"}]}], "&"}], "/@", "log"}], "]"}], 
     "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.961396967631997*^9, 3.961397002923461*^9}, {
  3.961489448087544*^9, 
  3.961489448492178*^9}},ExpressionUUID->"8a626119-c1e9-42d7-bdd4-\
eef520d605c2"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "4.", " ", "Input", " ", "start", " ", "and", " ", "end", " ", "positions",
     " ", "of", " ", "the", " ", "offset", " ", "list", " ", "to", " ", 
    "start", " ", 
    RowBox[{"encoding", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"start", "=", "1"}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Start", " ", "position", " ", "for", " ", 
      RowBox[{"encoding", ".", " ", 
       RowBox[{"Add", " ", "'"}]}], "last"}], "+", 
     RowBox[{
      RowBox[{"1", "'"}], " ", "here", " ", "if", " ", "you", " ", "are", " ",
       "picking", " ", "up", " ", "after", " ", "an", " ", 
      RowBox[{"interruption", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"end", "=", "10"}], ";"}], "  ", 
   RowBox[{"(*", 
    RowBox[{"End", " ", "position", " ", "for", " ", 
     RowBox[{"encoding", ".", " ", "Change"}], " ", 
     RowBox[{"to", " ", "'"}], 
     RowBox[{
      RowBox[{"Length", "@", "offset"}], "'"}], " ", "to", " ", "process", 
     " ", "the", " ", "full", " ", 
     RowBox[{"dump", "."}]}], "*)"}]}]}]], "Input",
 CellChangeTimes->{{3.96138914366825*^9, 3.9613891451780767`*^9}, {
   3.9613893980155*^9, 3.9613893980914288`*^9}, 3.961389527237825*^9, {
   3.9613970140095463`*^9, 3.961397014085291*^9}, {3.9613976875875998`*^9, 
   3.96139768863741*^9}, {3.961426063227446*^9, 3.961426063407547*^9}, 
   3.9614760233647547`*^9, {3.961489453180019*^9, 3.961489453216745*^9}},
 CellLabel->
  "In[225]:=",ExpressionUUID->"d49eb4f3-caaf-4648-a6af-0eb8cbfa2442"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "5.", " ", "Split", " ", "text", " ", "into", " ", "paragraphs", " ", 
    "and", " ", "encode", " ", "with", " ", "CLIP"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"$HistoryLength", "=", "0"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"AbsoluteTiming", "[", 
    RowBox[{"Monitor", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Table", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"Module", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
             "paragraphsVectors", ",", "paragraphsFiltered", ",", 
              "paragraphsKeys", ",", "paragraphsValues", ",", 
              "paragraphsFilteredAssoc", ",", "vectors", ",", 
              "paragraphsKeyed", ",", "paragraphsSplit", ",", "text", ",", 
              "assoc", ",", "offset", ",", "id", ",", "minLen", ",", 
              "maxLen"}], "}"}], ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"offset", "=", 
              RowBox[{"offsets", "[", 
               RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"assoc", "=", 
              RowBox[{"Import", "[", 
               RowBox[{
                RowBox[{"FileNameJoin", "[", 
                 RowBox[{"{", 
                  RowBox[{"pageBatchFolder", ",", 
                   RowBox[{"StringTake", "[", 
                    RowBox[{
                    RowBox[{"ToString", "@", "offset"}], ",", 
                    RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
                   RowBox[{
                    RowBox[{"ToString", "@", "offset"}], "<>", 
                    "\"\<.json\>\""}]}], "}"}], "]"}], ",", 
                "\"\<RawJSON\>\""}], "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"Table", "[", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"id", "=", 
                 RowBox[{"assoc", "[", 
                  RowBox[{"[", 
                   RowBox[{"j", ",", "\"\<id\>\""}], "]"}], "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{"MemberQ", "[", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"FileExistsQ", "[", "#", "]"}], ",", 
                    RowBox[{
                    RowBox[{"FileByteCount", "[", "#", "]"}], ">", "10"}], 
                    ",", "False"}], "]"}], "&"}], "@", 
                    RowBox[{"FileNameJoin", "[", 
                    RowBox[{"{", 
                    RowBox[{
                    "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<text\>\"", 
                    ",", 
                    RowBox[{"StringTake", "[", 
                    RowBox[{"id", ",", 
                    RowBox[{"UpTo", "[", "4", "]"}]}], "]"}], ",", 
                    RowBox[{"id", "<>", "\"\<.json\>\""}]}], "}"}], "]"}]}], 
                    ",", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"FileExistsQ", "[", "#", "]"}], ",", 
                    RowBox[{
                    RowBox[{"FileByteCount", "[", "#", "]"}], ">", "10"}], 
                    ",", "False"}], "]"}], "&"}], "@", 
                    RowBox[{"FileNameJoin", "[", 
                    RowBox[{"{", 
                    RowBox[{
                    "$buildFolder", ",", "\"\<data\>\"", ",", 
                    "\"\<textVecs\>\"", ",", 
                    RowBox[{"StringTake", "[", 
                    RowBox[{"id", ",", 
                    RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
                    RowBox[{"id", "<>", "\"\<.json\>\""}]}], "}"}], "]"}]}]}],
                     "}"}], ",", "False"}], "]"}], ",", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{"text", "=", 
                    RowBox[{"assoc", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", ",", "\"\<text\>\""}], "]"}], "]"}]}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{"minLen", "=", "200"}], ";", " ", 
                   RowBox[{"(*", 
                    RowBox[{"Minimum", " ", "Paragraph", " ", "Length"}], 
                    "*)"}], "\[IndentingNewLine]", 
                   RowBox[{"maxLen", "=", "500"}], ";", " ", 
                   RowBox[{"(*", 
                    RowBox[{"Maximum", " ", "Paragraph", " ", "Length"}], 
                    "*)"}], "\[IndentingNewLine]", 
                   RowBox[{"paragraphsSplit", "=", 
                    RowBox[{"Paragraphize", "[", 
                    RowBox[{"text", ",", "minLen", ",", "maxLen"}], "]"}]}], 
                   ";", 
                   RowBox[{"paragraphsKeyed", "=", 
                    RowBox[{"Flatten", "[", 
                    RowBox[{
                    RowBox[{"Table", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"id", "<>", "\"\<_\>\"", "<>", 
                    RowBox[{"ToString", "@", "k"}], "<>", "\"\<-\>\"", "<>", 
                    RowBox[{"ToString", "@", "l"}]}], "->", 
                    RowBox[{"paragraphsSplit", "[", 
                    RowBox[{"[", 
                    RowBox[{"k", ",", "l"}], "]"}], "]"}]}], ",", 
                    RowBox[{"{", 
                    RowBox[{"k", ",", 
                    RowBox[{"Length", "@", "paragraphsSplit"}]}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"l", ",", 
                    RowBox[{"Length", "@", 
                    RowBox[{"paragraphsSplit", "[", 
                    RowBox[{"[", "k", "]"}], "]"}]}]}], "}"}]}], "]"}], ",", 
                    "2"}], "]"}]}], ";", "\[IndentingNewLine]", 
                   RowBox[{"paragraphsFiltered", "=", 
                    RowBox[{"Extract", "[", 
                    RowBox[{"paragraphsKeyed", ",", 
                    RowBox[{"Position", "[", 
                    RowBox[{
                    RowBox[{"StringLength", "[", 
                    RowBox[{"paragraphsKeyed", "[", 
                    RowBox[{"[", 
                    RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}], ",", 
                    RowBox[{"_", "?", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"#", ">", "minLen"}], "&"}], ")"}]}]}], "]"}]}], 
                    "]"}]}], ";", 
                   RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"paragraphsFiltered", "=!=", 
                    RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"paragraphsFilteredAssoc", "=", 
                    RowBox[{"Association", "[", "paragraphsFiltered", "]"}]}],
                     ";", "\[IndentingNewLine]", 
                    RowBox[{"paragraphsKeys", "=", 
                    RowBox[{"Keys", "[", "paragraphsFilteredAssoc", "]"}]}], 
                    ";", "\[IndentingNewLine]", 
                    RowBox[{"paragraphsValues", "=", 
                    RowBox[{"Values", "[", "paragraphsFilteredAssoc", "]"}]}],
                     ";", "\[IndentingNewLine]", 
                    RowBox[{"vectors", "=", 
                    RowBox[{"textModel", "[", 
                    RowBox[{"paragraphsValues", ",", 
                    RowBox[{"TargetDevice", "->", "targetDevice"}]}], "]"}]}],
                     ";", "\[IndentingNewLine]", 
                    RowBox[{"paragraphsVectors", "=", 
                    RowBox[{"AssociationThread", "[", 
                    RowBox[{"paragraphsKeys", ",", "vectors"}], "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"Export", "[", 
                    RowBox[{
                    RowBox[{"FileNameJoin", "[", 
                    RowBox[{"{", 
                    RowBox[{
                    "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<text\>\"", 
                    ",", 
                    RowBox[{"StringTake", "[", 
                    RowBox[{"id", ",", 
                    RowBox[{"UpTo", "[", "4", "]"}]}], "]"}], ",", 
                    RowBox[{"id", "<>", "\"\<.json\>\""}]}], "}"}], "]"}], 
                    ",", "paragraphsFiltered", ",", "\"\<JSON\>\""}], "]"}], 
                    ";", 
                    RowBox[{"Export", "[", 
                    RowBox[{
                    RowBox[{"FileNameJoin", "[", 
                    RowBox[{"{", 
                    RowBox[{
                    "$buildFolder", ",", "\"\<data\>\"", ",", 
                    "\"\<textVecs\>\"", ",", 
                    RowBox[{"StringTake", "[", 
                    RowBox[{"id", ",", 
                    RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
                    RowBox[{"id", "<>", "\"\<.json\>\""}]}], "}"}], "]"}], 
                    ",", "paragraphsVectors", ",", "\"\<JSON\>\""}], 
                    "]"}]}]}], "]"}]}]}], "]"}], ";"}], "\[IndentingNewLine]",
                ",", 
               RowBox[{"{", 
                RowBox[{"j", ",", 
                 RowBox[{"Length", "@", "assoc"}]}], "}"}]}], "]"}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"ClearSystemCache", "[", "]"}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"Remove", "[", 
              RowBox[{"{", 
               RowBox[{
               "paragraphsVectors", ",", "paragraphsFiltered", ",", 
                "paragraphsKeys", ",", "paragraphsValues", ",", 
                "paragraphsFilteredAssoc", ",", "vectors", ",", 
                "paragraphsKeyed", ",", "paragraphsSplit", ",", "text", ",", 
                "assoc"}], "}"}], "]"}], ";", "\[IndentingNewLine]", 
             RowBox[{"WriteString", "[", 
              RowBox[{"logFilePath", ",", 
               RowBox[{"\"\<Success at \>\"", "<>", 
                RowBox[{"ToString", "[", "i", "]"}], "<>", 
                "\"\< \[Dash]\[NonBreakingSpace]\>\"", "<>", 
                RowBox[{"DateString", "[", 
                 RowBox[{"{", 
                  RowBox[{
                  "\"\<Hour\>\"", ",", "\"\<:\>\"", ",", "\"\<Minute\>\"", 
                   ",", "\"\<:\>\"", ",", "\"\<Second\>\""}], "}"}], "]"}], 
                "<>", "\"\<\\n\>\""}]}], "]"}]}]}], "]"}], ";"}], 
         "\[IndentingNewLine]", ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "start", ",", "end"}], "}"}]}], "]"}], ";"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", "j"}], "}"}]}], "]"}], "]"}], " "}]}]], "Input",
 CellChangeTimes->{{3.9255441074643693`*^9, 3.9255441154251766`*^9}, 
   3.925544155873804*^9, {3.9255452465804167`*^9, 3.925545268821376*^9}, {
   3.9255456482080917`*^9, 3.925545675600334*^9}, {3.9255458199466333`*^9, 
   3.925545827641274*^9}, 3.9255458619203396`*^9, {3.9255468629601564`*^9, 
   3.9255468707843084`*^9}, {3.9255754332321105`*^9, 3.925575451356865*^9}, 
   3.9255755228587203`*^9, {3.925575644435901*^9, 3.925575651649965*^9}, {
   3.9256223108934126`*^9, 3.9256223706160884`*^9}, {3.9256228084253836`*^9, 
   3.9256228334472914`*^9}, {3.9256228709338493`*^9, 3.925622894023033*^9}, {
   3.9256229312393007`*^9, 3.9256229351596966`*^9}, {3.9256232946199512`*^9, 
   3.9256233033642664`*^9}, {3.925625957026249*^9, 3.925625962730109*^9}, {
   3.9256305551025505`*^9, 3.9256305733006277`*^9}, {3.9256468621246357`*^9, 
   3.9256468644716144`*^9}, {3.9257012477786922`*^9, 
   3.9257012518754635`*^9}, {3.9257274369879174`*^9, 
   3.9257275674408245`*^9}, {3.9257276698499002`*^9, 
   3.9257276742411466`*^9}, {3.9257279851691823`*^9, 3.925727988316053*^9}, {
   3.9257936773899145`*^9, 3.925793687753083*^9}, {3.9263092278747406`*^9, 
   3.926309283656546*^9}, {3.926309673073454*^9, 3.9263096824226933`*^9}, {
   3.9264106618760347`*^9, 3.926410662131485*^9}, {3.961388969307633*^9, 
   3.961388969856022*^9}, {3.961389010865889*^9, 3.961389023375703*^9}, {
   3.961389161067144*^9, 3.961389162500824*^9}, {3.961389253327286*^9, 
   3.961389257007707*^9}, {3.9613893993912573`*^9, 3.961389407589102*^9}, {
   3.96139612932593*^9, 3.961396135185005*^9}, {3.961396270237752*^9, 
   3.961396277374217*^9}, {3.961396547741832*^9, 3.961396574292802*^9}, {
   3.961397016237536*^9, 3.9613970166264467`*^9}, {3.961476025961619*^9, 
   3.961476036072199*^9}, {3.9614894552653103`*^9, 3.9614894553294153`*^9}, {
   3.961556039292506*^9, 3.961556050497212*^9}, {3.961556093989932*^9, 
   3.961556098045764*^9}},ExpressionUUID->"a3f72262-4a11-4460-a5b2-\
b9ed7ae1521a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "6.", " ", "Export", " ", "a", " ", "list", " ", "with", " ", "all", " ", 
    "text", " ", "ids", " ", "for", " ", "downstream", " ", 
    RowBox[{"use", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"allTextFolders", "=", 
     RowBox[{"FileNames", "[", 
      RowBox[{"All", ",", 
       RowBox[{"FileNameJoin", "[", 
        RowBox[{"{", 
         RowBox[{
         "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<textVecs\>\""}], 
         "}"}], "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"pageIds", "=", 
     RowBox[{"Flatten", "@", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"FileBaseName", "/@", 
         RowBox[{"Select", "[", 
          RowBox[{
           RowBox[{"FileNames", "[", 
            RowBox[{"All", ",", 
             RowBox[{"allTextFolders", "[", 
              RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
           RowBox[{"StringContainsQ", "[", "\"\<json\>\"", "]"}]}], "]"}]}], 
        ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Length", "@", "allTextFolders"}]}], "}"}]}], "]"}]}]}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<indices\>\"", ",", 
         "\"\<pageIds.json\>\""}], "}"}], "]"}], ",", "pageIds"}], "]"}], 
    ";"}]}]}]], "Input",
 CellChangeTimes->{{3.931861981132905*^9, 3.931861982324023*^9}, {
   3.9318620138404846`*^9, 3.931862038009262*^9}, {3.931862080679385*^9, 
   3.9318621428075604`*^9}, {3.9318621926854086`*^9, 3.931862263082183*^9}, {
   3.961398068344598*^9, 3.961398122863551*^9}, {3.9613981561333027`*^9, 
   3.9613981738082523`*^9}, 3.9613986137557907`*^9, {3.961398722963469*^9, 
   3.961398801294195*^9}, {3.9614005932533407`*^9, 3.961400593327486*^9}, {
   3.961401610657256*^9, 3.961401644119508*^9}, {3.961476041071067*^9, 
   3.961476043458725*^9}, {3.961489461187358*^9, 3.9614894612850437`*^9}, 
   3.961556041805513*^9},ExpressionUUID->"e65f8261-a3ca-482a-ba9d-\
8e0234a317e0"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"7.", " ", 
     RowBox[{"Test", ":", " ", 
      RowBox[{
      "Check", " ", "a", " ", "processed", " ", "offset", " ", "batch"}]}]}], 
    ",", " ", "here", ",", " ", 
    RowBox[{"the", " ", 
     RowBox[{"first", ":"}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"offset", "=", 
     RowBox[{"offsets", "[", 
      RowBox[{"[", "1", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"assoc", "=", 
    RowBox[{
     RowBox[{"Import", "[", 
      RowBox[{
       RowBox[{"FileNameJoin", "[", 
        RowBox[{"{", 
         RowBox[{"pageBatchFolder", ",", 
          RowBox[{"StringTake", "[", 
           RowBox[{
            RowBox[{"ToString", "@", "offset"}], ",", 
            RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
          RowBox[{
           RowBox[{"ToString", "@", "offset"}], "<>", "\"\<.json\>\""}]}], 
         "}"}], "]"}], ",", "\"\<RawJSON\>\""}], "]"}], "//", 
     "Keys"}]}]}]}]], "Input",
 CellChangeTimes->{{3.9613897026876793`*^9, 3.9613897051294737`*^9}, {
  3.961389798183815*^9, 3.961389856330906*^9}, {3.961389957702972*^9, 
  3.96138996379675*^9}, {3.961401380036069*^9, 3.961401400759801*^9}, {
  3.961401465780569*^9, 3.96140146585699*^9}, {3.9614894679077682`*^9, 
  3.961489471736986*^9}, {3.961496881450821*^9, 3.9614968815129757`*^9}},
 CellLabel->
  "In[244]:=",ExpressionUUID->"200ddaa2-eb0d-4aa0-8b61-66a25fc89b11"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"8.", " ", 
     RowBox[{"Test", ":", " ", 
      RowBox[{"Check", " ", "out", " ", "paragraphs"}]}]}], ",", " ", 
    RowBox[{
    "here", " ", "of", " ", "the", " ", "first", " ", "page", " ", "ID", " ", 
     "contained"}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"id", "=", 
     RowBox[{"assoc", "[", 
      RowBox[{"[", "1", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"test1", "=", 
    RowBox[{"Import", "[", 
     RowBox[{
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{"$buildFolder", ",", "\"\<data\>\"", ",", "\"\<text\>\"", ",", 
         RowBox[{"StringTake", "[", 
          RowBox[{"id", ",", 
           RowBox[{"UpTo", "[", "4", "]"}]}], "]"}], ",", 
         RowBox[{"id", "<>", "\"\<.json\>\""}]}], "}"}], "]"}], ",", 
      "\"\<RawJSON\>\""}], "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.9257277525760994`*^9, 3.9257277550708714`*^9}, {
   3.925727835113147*^9, 3.925727862261984*^9}, 3.961389726774908*^9, {
   3.961389764651436*^9, 3.961389772536804*^9}, {3.9613898885313673`*^9, 
   3.961389905455645*^9}, {3.961389966536368*^9, 3.9613899678086023`*^9}, 
   3.9614760554117107`*^9, {3.9614894776761417`*^9, 3.9614894806977987`*^9}, {
   3.961496872098032*^9, 3.9614968737237062`*^9}},
 CellLabel->
  "In[247]:=",ExpressionUUID->"997055a7-d0e8-47eb-b46d-c0cd6158cdb9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"9.", " ", 
    RowBox[{"Test", ":", " ", 
     RowBox[{"Check", " ", "out", " ", "encodings"}]}]}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"test2", "=", 
   RowBox[{"Import", "[", 
    RowBox[{
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{
       "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<textVecs\>\"", ",", 
        RowBox[{"StringTake", "[", 
         RowBox[{"id", ",", 
          RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
        RowBox[{"id", "<>", "\"\<.json\>\""}]}], "}"}], "]"}], ",", 
     "\"\<RawJSON\>\""}], "]"}]}]}]], "Input",
 CellChangeTimes->{{3.9257278867630243`*^9, 3.9257279022061524`*^9}, {
   3.961389739299645*^9, 3.9613897622185173`*^9}, {3.961389969037703*^9, 
   3.961389970791768*^9}, {3.96139628196976*^9, 3.961396283553035*^9}, {
   3.961396583350247*^9, 3.961396592005205*^9}, 3.961476056070969*^9, {
   3.961489483198352*^9, 3.9614894856937227`*^9}, 3.961556044035307*^9, {
   3.961556086959091*^9, 
   3.961556088059711*^9}},ExpressionUUID->"f8bc7bfa-562a-4a4c-b22a-\
6989bb8a88e6"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["8. Encode Images",
 FontSize->24,
 FontColor->RGBColor[0., 0., 0.]]], "Subtitle",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004653855638*^9}, {
   3.9255429588956685`*^9, 3.9255429656805353`*^9}, {3.933419738072833*^9, 
   3.933419738467922*^9}, {3.961339364151065*^9, 3.961339392280257*^9}, {
   3.961390164835906*^9, 3.961390173814896*^9}, 3.961393054862067*^9, {
   3.9614271924313917`*^9, 3.961427192542469*^9}, {3.96142773431047*^9, 
   3.961427734592314*^9}},ExpressionUUID->"dd260183-d7e8-40a1-b44e-\
4b189156f773"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"1.", " ", "First", " ", "load", " ", "models", " ", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"Heading", " ", "6"}], ")"}], ".", " ", "Then"}], " ", "set", 
     " ", "directories", " ", "and", " ", "import", " ", "pre"}], "-", 
    RowBox[{"processed", " ", 
     RowBox[{"files", ".", " ", "Displays"}], " ", "amount", " ", "of", " ", 
     RowBox[{"images", "."}]}]}], "*)"}], "\n", 
  RowBox[{
   RowBox[{
    RowBox[{"imgHashes", "=", 
     RowBox[{"ToString", "/@", 
      RowBox[{"Import", "[", 
       RowBox[{
        RowBox[{"FileNameJoin", "[", 
         RowBox[{"{", 
          RowBox[{
          "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<img\>\"", ",", 
           RowBox[{"\"\<hashlist\>\"", "<>", "\"\<.txt\>\""}]}], "}"}], "]"}],
         ",", "\"\<List\>\""}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Print", "[", 
     RowBox[{"Length", "@", "imgHashes"}], "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.931345926176607*^9, 3.9313459302730165`*^9}, {
   3.9313459962659707`*^9, 3.9313460051133456`*^9}, 3.9314094073560534`*^9, {
   3.9613930783924913`*^9, 3.961393083245582*^9}, {3.961393644716013*^9, 
   3.9613936726259203`*^9}, {3.961396493495132*^9, 3.961396493584055*^9}, {
   3.961396863867239*^9, 3.961396871034445*^9}, {3.961397608843356*^9, 
   3.96139760917109*^9}, {3.961476066052401*^9, 3.961476073398286*^9}, 
   3.961476105406149*^9, {3.96149691923179*^9, 3.9614969232964373`*^9}, {
   3.96151187286232*^9, 3.961511873133986*^9}, {3.9615693288452873`*^9, 
   3.961569330400469*^9}},ExpressionUUID->"df7a0ea1-ee1e-42f3-a090-\
29f015c9148a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"2.", " ", "Hardware", " ", 
     RowBox[{"setting", ":", " ", 
      RowBox[{
      "If", " ", "your", " ", "system", " ", "allows", " ", "Mathematica", 
       " ", "to", " ", "use", " ", "the", " ", "GPU", " ", "for", " ", 
       "encoding"}]}]}], ",", " ", 
    RowBox[{
    "this", " ", "will", " ", "speed", " ", "up", " ", "the", " ", "process", 
     " ", 
     RowBox[{"considerably", ".", " ", "Put"}], " ", "in", " ", "\"\<CPU\>\"",
      " ", "or", " ", 
     RowBox[{"\"\<GPU\>\"", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"targetDevice", "=", "\"\<CPU\>\""}], ";"}]}]], "Input",
 CellChangeTimes->{{3.961389181895177*^9, 3.961389244562353*^9}, {
  3.961389317845099*^9, 3.961389339937944*^9}},
 CellLabel->
  "In[252]:=",ExpressionUUID->"7c235dcf-305c-45f8-b2d0-eebc02aebb0a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "3.", " ", "Define", " ", "a", " ", "single", " ", "log", " ", "file", " ",
     "to", " ", "record", " ", 
    RowBox[{"process", ".", " ", "This"}], " ", "will", " ", "be", " ", 
    "overwritten", " ", "for", " ", "each", " ", "new", " ", "encoding", " ", 
    RowBox[{"session", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"logFilePath", "=", 
    RowBox[{"FileNameJoin", "[", 
     RowBox[{"{", 
      RowBox[{"$buildFolder", ",", "\"\<build\>\"", ",", "\"\<logs\>\"", ",", 
       RowBox[{"\"\<imgEncodedLog\>\"", "<>", "\"\<.txt\>\""}]}], "}"}], 
     "]"}]}], ";"}]}]], "Input",
 CellChangeTimes->{{3.925545195607813*^9, 3.9255452032863975`*^9}, {
   3.9256290441589828`*^9, 3.9256290686145725`*^9}, 3.925646844922707*^9, {
   3.9613890927890673`*^9, 3.961389096458434*^9}, {3.9613893494581623`*^9, 
   3.961389392335256*^9}, {3.961396954904188*^9, 3.9613969615630207`*^9}, {
   3.9613970288323727`*^9, 3.961397028963064*^9}, {3.961476109002907*^9, 
   3.961476117768112*^9}},
 CellLabel->
  "In[253]:=",ExpressionUUID->"8eb974d8-412e-40f6-ac0f-8f99d9fde1f2"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"X", ".", " ", "If"}], " ", "you", " ", "encoded", " ", "texts", 
     " ", "already"}], ",", " ", 
    RowBox[{
    "see", " ", "at", " ", "which", " ", "batch", " ", "you", " ", "left", 
     " ", "off", " ", "by", " ", "reading", " ", "the", " ", "log", " ", 
     "file"}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"log", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"logFilePath", ",", "\"\<List\>\""}], "]"}]}], ";"}], "\n", 
   RowBox[{"last", "=", 
    RowBox[{"Last", "[", 
     RowBox[{"Flatten", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"ToExpression", "/@", 
         RowBox[{"StringTrim", "[", 
          RowBox[{"StringCases", "[", 
           RowBox[{"#", ",", 
            RowBox[{
             RowBox[{"\"\<at\>\"", "~~", 
              RowBox[{"number", ":", 
               RowBox[{"Shortest", "[", "___", "]"}]}], "~~", "\"\<-\>\""}], ":>",
              "number"}]}], "]"}], "]"}]}], "&"}], "/@", "log"}], "]"}], 
     "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.961396967631997*^9, 3.961397002923461*^9}, 
   3.961397235943904*^9, 3.961397349163155*^9, {3.961496933937085*^9, 
   3.9614969341008883`*^9}},ExpressionUUID->"ed2e60fe-8eb2-4490-9fab-\
83f70068c975"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"X", ".", " ", "If"}], " ", "the", " ", "logFilePath", " ", 
     "got", " ", "corrupted"}], ",", " ", 
    RowBox[{"you", " ", "can", " ", "rebuild", " ", "one", " ", "here"}], ",",
     " ", 
    RowBox[{
    "checking", " ", "for", " ", "all", " ", "encoded", " ", "images", " ", 
     "by", " ", "brute", " ", 
     RowBox[{"force", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"Quiet", "[", 
     RowBox[{"Close", "[", "logFilePath", "]"}], "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Quiet", "@", 
     RowBox[{"DeleteFile", "[", "logFilePath", "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"OpenWrite", "[", "logFilePath", "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"i", "=", "0"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"Monitor", "[", 
     RowBox[{
      RowBox[{"While", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"counter", "=", "i"}], ";", "\[IndentingNewLine]", 
         RowBox[{"i", "=", 
          RowBox[{"i", "+", "1"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"FileExistsQ", "[", 
          RowBox[{"FileNameJoin", "[", 
           RowBox[{"{", 
            RowBox[{
            "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<imgVecs\>\"", ",", 
             RowBox[{"StringTake", "[", 
              RowBox[{
               RowBox[{"imgHashes", "[", 
                RowBox[{"[", "i", "]"}], "]"}], ",", 
               RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
             RowBox[{
              RowBox[{"imgHashes", "[", 
               RowBox[{"[", "i", "]"}], "]"}], "<>", "\"\<.json\>\""}]}], 
            "}"}], "]"}], "]"}]}], ",", "counter"}], "]"}], ",", "i"}], "]"}],
     ";"}], "\[IndentingNewLine]", 
   RowBox[{"last", "=", "counter"}]}]}]], "Input",
 CellChangeTimes->{{3.931409189660524*^9, 3.931409269912258*^9}, {
   3.961396291046617*^9, 3.961396292069964*^9}, {3.961397062838401*^9, 
   3.961397063550088*^9}, {3.9613971187579327`*^9, 3.961397124915967*^9}, {
   3.961397359040954*^9, 3.961397419963675*^9}, {3.9614761304657288`*^9, 
   3.9614761358960037`*^9}, {3.96148950645123*^9, 3.961489529995481*^9}, {
   3.961489763294032*^9, 3.9614897688035088`*^9}, 3.961556012195829*^9, {
   3.9615561442821283`*^9, 
   3.96155614538979*^9}},ExpressionUUID->"79f079b9-b59c-425f-99d3-\
725e35ae11e0"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "5.", " ", "Input", " ", "start", " ", "and", " ", "end", " ", "positions",
     " ", "of", " ", "the", " ", "hash", " ", "list", " ", "to", " ", "start",
     " ", 
    RowBox[{"encoding", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"start", "=", "1"}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Start", " ", "position", " ", "for", " ", 
      RowBox[{"encoding", ".", " ", "Change"}], " ", "to", " ", "last"}], "+", 
     RowBox[{"1", " ", "after", " ", "an", " ", 
      RowBox[{"interruption", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{"end", "=", 
    RowBox[{"Length", "@", "imgHashes", " ", 
     RowBox[{"(*", 
      RowBox[{"End", " ", "position", " ", "for", " ", 
       RowBox[{"encoding", "."}]}], "*)"}]}]}]}]}]], "Input",
 CellChangeTimes->{{3.961397674807482*^9, 3.961397801445301*^9}, {
  3.961476158343122*^9, 3.961476186818358*^9}},
 CellLabel->
  "In[262]:=",ExpressionUUID->"3fbac153-4ea3-48ab-9878-5415e842ebd0"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "6.", " ", "Encode", " ", "all", " ", "images", " ", "into", " ", "CLIP", 
    " ", "and", " ", "export"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"Monitor", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Table", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"id", "=", 
         RowBox[{"imgHashes", "[", 
          RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Export", "[", 
         RowBox[{
          RowBox[{"FileNameJoin", "[", 
           RowBox[{"{", 
            RowBox[{
            "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<imgVecs\>\"", ",", 
             RowBox[{"StringTake", "[", 
              RowBox[{"id", ",", 
               RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
             RowBox[{"id", "<>", "\"\<.json\>\""}]}], "}"}], "]"}], ",", 
          RowBox[{"Association", "[", 
           RowBox[{"id", "->", 
            RowBox[{"imgModel", "[", 
             RowBox[{
              RowBox[{"Import", "[", 
               RowBox[{"FileNameJoin", "[", 
                RowBox[{"{", 
                 RowBox[{
                 "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<img\>\"", ",", 
                  RowBox[{"StringTake", "[", 
                   RowBox[{"id", ",", "3"}], "]"}], ",", 
                  RowBox[{"id", "<>", "\"\<.jpg\>\""}]}], "}"}], "]"}], "]"}],
               ",", 
              RowBox[{"TargetDevice", "->", "targetDevice"}]}], "]"}]}], 
           "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"WriteString", "[", 
         RowBox[{"logFilePath", ",", 
          RowBox[{"\"\<Success at \>\"", "<>", 
           RowBox[{"ToString", "[", "i", "]"}], "<>", 
           "\"\< \[Dash]\[NonBreakingSpace]\>\"", "<>", 
           RowBox[{"DateString", "[", 
            RowBox[{"{", 
             RowBox[{
             "\"\<Hour\>\"", ",", "\"\<:\>\"", ",", "\"\<Minute\>\"", ",", 
              "\"\<:\>\"", ",", "\"\<Second\>\""}], "}"}], "]"}], "<>", 
           "\"\<\\n\>\""}]}], "]"}], ";"}], ",", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"i", ",", 
         RowBox[{"last", "+", "1"}], ",", 
         RowBox[{"Length", "@", "imgHashes"}]}], "}"}]}], "]"}], ";"}], ",", 
    RowBox[{
     RowBox[{"ToString", "@", "i"}], "<>", "\"\< encoded of \>\"", "<>", 
     RowBox[{"ToString", "@", 
      RowBox[{"Length", "@", "imgHashes"}]}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.9095899997096643`*^9, 3.909590014940879*^9}, {
   3.909590104174726*^9, 3.9095901215298257`*^9}, {3.909590187857623*^9, 
   3.909590190609027*^9}, {3.909590234338344*^9, 3.9095903829261293`*^9}, {
   3.909590416793869*^9, 3.909590444743513*^9}, {3.90959050152678*^9, 
   3.9095905017018037`*^9}, {3.90959054735465*^9, 3.9095905498462086`*^9}, {
   3.909590650811532*^9, 3.9095906508970413`*^9}, {3.9095906936557145`*^9, 
   3.909590718317607*^9}, 3.909638356353367*^9, 3.909676786709669*^9, {
   3.909677101283978*^9, 3.9096771036126056`*^9}, {3.9105065127177954`*^9, 
   3.910506515492707*^9}, {3.9196986942214527`*^9, 3.9196987298850536`*^9}, {
   3.919698833151639*^9, 3.919698854405695*^9}, {3.9196989768755674`*^9, 
   3.9196990309763613`*^9}, {3.9196990935139847`*^9, 
   3.9196991230765047`*^9}, {3.9196991594552975`*^9, 
   3.9196991611735287`*^9}, {3.919699219086439*^9, 3.9196992397724304`*^9}, {
   3.9196992889557266`*^9, 3.9196993093766756`*^9}, {3.9197070689615116`*^9, 
   3.919707069103526*^9}, {3.919785278370105*^9, 3.919785279749579*^9}, {
   3.919857315139863*^9, 3.919857315217012*^9}, {3.9216638175437613`*^9, 
   3.9216638459077682`*^9}, {3.921667389293148*^9, 3.921667394072282*^9}, 
   3.9313457596735306`*^9, {3.9313464395954456`*^9, 3.931346448725726*^9}, {
   3.9313466398522716`*^9, 3.931346686594784*^9}, {3.931346750666172*^9, 
   3.9313467763251257`*^9}, {3.9313468093937426`*^9, 
   3.9313468476334057`*^9}, {3.9313469495535135`*^9, 3.931346949715575*^9}, {
   3.9327046616459103`*^9, 3.9327046626454983`*^9}, {3.961397452463667*^9, 
   3.961397467753072*^9}, {3.9613976499727592`*^9, 3.961397653141012*^9}, {
   3.961400542538004*^9, 3.961400542800064*^9}, {3.961476197556879*^9, 
   3.9614762056362467`*^9}, 3.9614969675179996`*^9, 3.961556017045186*^9, {
   3.961556101788053*^9, 
   3.961556101890554*^9}},ExpressionUUID->"c01180ae-89c1-4da2-a63c-\
8d86b0b9c599"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "7.", " ", "Export", " ", "a", " ", "list", " ", "with", " ", "all", " ", 
    "image", " ", "ids", " ", 
    RowBox[{"(", 
     RowBox[{"=", "hashs"}], ")"}], " ", "for", " ", "downstream", " ", 
    RowBox[{"use", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"imgIds", "=", 
     RowBox[{"ToString", "/@", 
      RowBox[{"Import", "[", 
       RowBox[{
        RowBox[{"FileNameJoin", "[", 
         RowBox[{"{", 
          RowBox[{
          "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<img\>\"", ",", 
           RowBox[{"\"\<hashlist\>\"", "<>", "\"\<.txt\>\""}]}], "}"}], "]"}],
         ",", "\"\<List\>\""}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<indices\>\"", ",", 
         "\"\<imgIds.json\>\""}], "}"}], "]"}], ",", "imgIds"}], "]"}], 
    ";"}]}]}]], "Input",
 CellChangeTimes->{{3.961400551709306*^9, 3.9614005524228*^9}, {
  3.961476210763205*^9, 3.961476211584175*^9}},
 CellLabel->
  "In[265]:=",ExpressionUUID->"dbfda469-8de6-4eb8-be0f-e38a341b567a"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["9. Package Training Data",
 FontSize->24,
 FontColor->RGBColor[0., 0., 0.]]], "Subtitle",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004653855638*^9}, {
   3.9255429588956685`*^9, 3.9255429656805353`*^9}, {3.933419738072833*^9, 
   3.933419738467922*^9}, {3.961339364151065*^9, 3.961339392280257*^9}, {
   3.961390164835906*^9, 3.961390173814896*^9}, 3.961393054862067*^9, {
   3.961426955932397*^9, 3.961426977035719*^9}, {3.9614271941619873`*^9, 
   3.961427194502921*^9}, {3.961427737671319*^9, 
   3.961427737870017*^9}},ExpressionUUID->"5d47f12a-30df-4b89-8298-\
a8c9e68b1fe7"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "1.", " ", "Set", " ", "directories", " ", "and", " ", "import", " ", 
     "pre"}], "-", 
    RowBox[{"processed", " ", 
     RowBox[{"files", ".", " ", "Lengths"}], " ", "of", " ", "hashed", " ", 
     "images", " ", "and", " ", "pages", " ", "are", " ", "shown", " ", 
     RowBox[{"below", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"somFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<soms\>\""}], "}"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"imgIds", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<indices\>\"", ",", 
         "\"\<imgIds.json\>\""}], "}"}], "]"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"pageIds", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<indices\>\"", ",", 
         "\"\<pageIds.json\>\""}], "}"}], "]"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"imgIds", "//", "Length"}], "\[IndentingNewLine]", 
   RowBox[{"pageIds", "//", "Length"}]}]}]], "Input",
 CellChangeTimes->{{3.931345926176607*^9, 3.9313459302730165`*^9}, {
   3.9313459962659707`*^9, 3.9313460051133456`*^9}, 3.9314094073560534`*^9, {
   3.961397858042974*^9, 3.9613978990634117`*^9}, {3.9613981099842567`*^9, 
   3.961398116874123*^9}, {3.96140178828743*^9, 3.96140178893659*^9}, {
   3.9614762269761333`*^9, 3.9614762576689167`*^9}, {3.9614838108529453`*^9, 
   3.961483845441136*^9}, {3.9615118765147*^9, 
   3.961511876708502*^9}},ExpressionUUID->"01351a9b-6802-45cc-9fe5-\
ca0aa547b698"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"2.", " ", "For", " ", "image", " ", "vectors"}], ",", " ", 
    RowBox[{
    "we", " ", "export", " ", "a", " ", "formatted", " ", "list", " ", "of", 
     " ", "embeddings", " ", "and", " ", "their", " ", "ids", " ", "for", " ",
      "later", " ", 
     RowBox[{"use", "."}]}]}], "*)"}], "\n", 
  RowBox[{
   RowBox[{
    RowBox[{"Monitor", "[", 
     RowBox[{
      RowBox[{"imgVecList", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"Import", "[", 
             RowBox[{
              RowBox[{"FileNameJoin", "[", 
               RowBox[{"{", 
                RowBox[{
                "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<imgVecs\>\"", 
                 ",", 
                 RowBox[{"StringTake", "[", 
                  RowBox[{
                   RowBox[{"imgIds", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ",", 
                   RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
                 RowBox[{
                  RowBox[{"imgIds", "[", 
                   RowBox[{"[", "i", "]"}], "]"}], "<>", "\"\<.json\>\""}]}], 
                "}"}], "]"}], ",", "\"\<RawJSON\>\""}], "]"}], "[", 
            RowBox[{"[", "1", "]"}], "]"}], ",", 
           RowBox[{"imgIds", "[", 
            RowBox[{"[", "i", "]"}], "]"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"Length", "@", "imgIds"}]}], "}"}]}], "]"}]}], ",", "i"}], 
     "]"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<soms\>\"", ",", "\"\<training\>\"", ",", 
         "\"\<vectors\>\"", ",", "\"\<imgVecList.wxf\>\""}], "}"}], "]"}], 
      ",", "imgVecList"}], "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.961483640845367*^9, 3.9614837235262623`*^9}, {
   3.9614837689223022`*^9, 3.961483768994218*^9}, {3.961483849619855*^9, 
   3.961483852333419*^9}, {3.9615106901413393`*^9, 3.961510698435034*^9}, 
   3.961510732347886*^9, 3.961556020119145*^9, {3.961556116289401*^9, 
   3.961556116372905*^9}},ExpressionUUID->"d7710ac5-52d1-42be-b0b2-\
ca9bac7a9799"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "3.", " ", "Set", " ", "the", " ", "parameters", " ", "for", " ", "SOM", 
    " ", 
    RowBox[{"training", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"y", "=", "32"}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{"how", " ", "many", " ", "cells", " ", "high"}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"x", " ", "=", "32"}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{"how", " ", "many", " ", "cells", " ", "wide"}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"iterations", "=", "32"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.882449994042162*^9, 3.882449995134954*^9}, {
   3.88245011463309*^9, 3.882450121323331*^9}, {3.8824502397687883`*^9, 
   3.882450239946505*^9}, {3.882457674725965*^9, 3.882457776549086*^9}, {
   3.882458583441099*^9, 3.882458584702725*^9}, {3.882459163998745*^9, 
   3.8824591681577253`*^9}, {3.8824593040849237`*^9, 3.882459319917411*^9}, {
   3.8824594175906363`*^9, 3.882459420220604*^9}, {3.882459548759346*^9, 
   3.8824595546983843`*^9}, {3.8824596769465237`*^9, 3.882459693455284*^9}, {
   3.8824597436002417`*^9, 3.882459744803959*^9}, {3.882460946040634*^9, 
   3.8824609787391043`*^9}, {3.8824640048433447`*^9, 3.882464011108779*^9}, {
   3.882812676017245*^9, 3.8828127059296827`*^9}, {3.8828128030540676`*^9, 
   3.882812847058278*^9}, {3.8829431453362665`*^9, 3.882943146725439*^9}, {
   3.882943180867655*^9, 3.8829431842099247`*^9}, 3.882943493093461*^9, {
   3.882955502950881*^9, 3.882955523713438*^9}, {3.882955722602542*^9, 
   3.8829557578180256`*^9}, {3.8829627557515726`*^9, 
   3.8829627591931257`*^9}, {3.882964124697157*^9, 3.882964134007926*^9}, 
   3.8829644777072124`*^9, {3.8830350960126286`*^9, 3.883035111959911*^9}, {
   3.883047127537958*^9, 3.883047142006354*^9}, {3.883047974789547*^9, 
   3.883047978435791*^9}, {3.884593966970477*^9, 3.8845939742355633`*^9}, {
   3.884594136070307*^9, 3.884594138093498*^9}, {3.8845942648179083`*^9, 
   3.8845942672029886`*^9}, 3.887865997914552*^9, {3.889111667845641*^9, 
   3.8891116742494287`*^9}, {3.8893403418843956`*^9, 3.889340344681269*^9}, 
   3.8893403748301296`*^9, {3.889340409119749*^9, 3.889340416197838*^9}, {
   3.8893410879377503`*^9, 3.8893410897658796`*^9}, 3.8938725421271486`*^9, {
   3.893946992762194*^9, 3.8939469958675933`*^9}, {3.89878828347036*^9, 
   3.898788286686163*^9}, {3.8990175842084293`*^9, 3.8990176073866467`*^9}, {
   3.899017657577583*^9, 3.8990176733397274`*^9}, {3.8990180510661125`*^9, 
   3.8990180516039567`*^9}, {3.8990182021392546`*^9, 3.899018205743702*^9}, {
   3.8990196740835977`*^9, 3.899019677480842*^9}, {3.899019797238371*^9, 
   3.8990198092445583`*^9}, {3.8990199907619333`*^9, 3.899019992306824*^9}, {
   3.899020532049719*^9, 3.899020532317411*^9}, {3.899020623043991*^9, 
   3.8990206232462697`*^9}, {3.8990265701938086`*^9, 
   3.8990266111727138`*^9}, {3.8990266413411827`*^9, 3.899026654246947*^9}, {
   3.899044976328525*^9, 3.8990449791515384`*^9}, {3.899045117273819*^9, 
   3.899045156165286*^9}, {3.899045308003684*^9, 3.899045317297123*^9}, {
   3.899047493376655*^9, 3.899047502915279*^9}, 3.89904894284826*^9, {
   3.899050345517627*^9, 3.899050345859519*^9}, {3.899051640878549*^9, 
   3.899051652151497*^9}, {3.8990578328988714`*^9, 3.899057833162945*^9}, {
   3.8990601471754036`*^9, 3.8990601756269903`*^9}, {3.899095862617872*^9, 
   3.8990958825247717`*^9}, 3.8990966693076406`*^9, {3.8990999138434324`*^9, 
   3.8990999138854365`*^9}, {3.899116545686198*^9, 3.8991165460498266`*^9}, {
   3.899136673289461*^9, 3.899136673664096*^9}, {3.9180373690647535`*^9, 
   3.9180373736092567`*^9}, {3.918400509394311*^9, 3.9184005098154097`*^9}, {
   3.918536044733382*^9, 3.918536052740163*^9}, {3.9185764258952246`*^9, 
   3.918576426542612*^9}, {3.9185764676265297`*^9, 3.91857646871633*^9}, 
   3.9186311003515654`*^9, {3.9186676731030436`*^9, 3.9186676735640426`*^9}, 
   3.9187116809200563`*^9, 3.9187117611883087`*^9, {3.9187555985512056`*^9, 
   3.9187555995203943`*^9}, {3.91875569558475*^9, 3.9187556960403013`*^9}, {
   3.9187559456365204`*^9, 3.918755946198363*^9}, {3.9187564508842883`*^9, 
   3.918756450951806*^9}, {3.918830098932061*^9, 3.9188301023638954`*^9}, {
   3.91897014002456*^9, 3.9189701403862796`*^9}, {3.9190629385445423`*^9, 
   3.919062938560542*^9}, {3.919063046857574*^9, 3.919063047484849*^9}, {
   3.9190631626279173`*^9, 3.919063163798787*^9}, {3.9190632308755646`*^9, 
   3.9190632311881733`*^9}, {3.9190633177156243`*^9, 
   3.9190633178011713`*^9}, {3.9190634050598392`*^9, 
   3.9190634052083244`*^9}, {3.9190636617249813`*^9, 
   3.9190636619835415`*^9}, {3.9190639398077383`*^9, 
   3.9190639442836466`*^9}, {3.919065425422225*^9, 3.9190654281980023`*^9}, {
   3.9190654938818502`*^9, 3.9190654942129545`*^9}, {3.9190658850884867`*^9, 
   3.9190658853941207`*^9}, {3.919066170170498*^9, 3.9190661703475404`*^9}, {
   3.93183681083832*^9, 3.9318368277623177`*^9}, 3.931855648161652*^9, {
   3.932227901755708*^9, 3.9322279141042566`*^9}, {3.961399266662607*^9, 
   3.961399267700782*^9}, {3.961399707241927*^9, 3.961399707951388*^9}, {
   3.961401898048835*^9, 3.961401899475491*^9}, {3.961402462788975*^9, 
   3.9614024638102417`*^9}, {3.96140252819689*^9, 3.96140254413675*^9}, 
   3.9614026888332243`*^9, 3.9614027286527967`*^9, {3.9614029348573503`*^9, 
   3.961402935018848*^9}, {3.961403657561957*^9, 3.961403661323704*^9}, {
   3.961483726723239*^9, 3.961483806914071*^9}, {3.9614842853811626`*^9, 
   3.961484291719509*^9}, {3.961497779660634*^9, 3.961497795775586*^9}, {
   3.961497961477828*^9, 3.961497987924396*^9}, {3.961508602874042*^9, 
   3.961508603238729*^9}, 
   3.9615695736555433`*^9},ExpressionUUID->"6de1e746-d5d3-4428-91ff-\
ace0c6e38fd3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"4.", " ", "Determine", " ", "sample", " ", 
     RowBox[{"length", ".", " ", "Should"}], " ", "be", " ", "much", " ", 
     "higher", " ", "for", " ", "full", " ", "setup"}], " ", "\[Dash]", " ", 
    RowBox[{
    "uncomment", " ", "the", " ", "1000", " ", "if", " ", "you", " ", "run", 
     " ", "the", " ", "full", " ", 
     RowBox[{"batch", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"sampleLength", "=", 
   RowBox[{"x", "*", "y", 
    RowBox[{"(*", 
     RowBox[{"*", "1000"}], "*)"}]}]}]}]], "Input",
 CellChangeTimes->{{3.8990266804575496`*^9, 3.8990266807531013`*^9}, {
   3.899050189182572*^9, 3.8990501915290413`*^9}, {3.8990503011202946`*^9, 
   3.899050303262952*^9}, {3.899095850122733*^9, 3.899095851697138*^9}, {
   3.9180374808574457`*^9, 3.91803748392936*^9}, {3.9180388588179784`*^9, 
   3.9180388692260313`*^9}, {3.9318568543723555`*^9, 3.931856877733474*^9}, {
   3.9318569565428157`*^9, 3.9318569610412073`*^9}, {3.931857690636225*^9, 
   3.931857697045097*^9}, 3.931926254338673*^9, {3.931930073702071*^9, 
   3.931930074004908*^9}, 3.961400800040615*^9, {3.961401873549426*^9, 
   3.961401873797002*^9}, {3.961401929149535*^9, 3.9614019450926247`*^9}, {
   3.961483784154299*^9, 3.9614837969117737`*^9}, {3.961484306217214*^9, 
   3.9614843429807787`*^9}, {3.9614848188130407`*^9, 3.961484864364758*^9}, {
   3.961484959554966*^9, 3.961485006677719*^9}},
 CellLabel->
  "In[280]:=",ExpressionUUID->"8725f7af-e302-4429-821d-8cc1e9c50d35"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"5.", " ", "Export", " ", "pre"}], "-", 
     RowBox[{"packaged", " ", "training", " ", "samples"}]}], ",", " ", 
    RowBox[{"containing", " ", 
     RowBox[{"ca", ".", " ", "50"}], "%", " ", "image", " ", "and", " ", "50",
      "%", " ", "text", " ", "vectors"}], ",", " ", 
    RowBox[{
    "so", " ", "that", " ", "the", " ", "SOM", " ", "learns", " ", "from", 
     " ", "both", " ", "modalities"}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"Monitor", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Table", "[", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Sample", " ", "50", "%", " ", "image", " ", "encodings"}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"imgVec", "=", 
         RowBox[{"RandomSample", "[", 
          RowBox[{
           RowBox[{"imgVecList", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", 
           RowBox[{"Round", "[", 
            RowBox[{"sampleLength", "/", "2"}], "]"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
          RowBox[{"Sample", " ", "50", "%", " ", "text", " ", "encodings"}], 
          ",", " ", 
          RowBox[{
          "drawing", " ", "them", " ", "from", " ", "pages", " ", "until", 
           " ", "threshold", " ", "is", " ", "met"}]}], "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"randomInt", "=", 
         RowBox[{"RandomInteger", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"1", ",", 
             RowBox[{"Length", "@", "pageIds"}]}], "}"}], ",", 
           RowBox[{"sampleLength", "/", "2"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"target", "=", 
         RowBox[{"Round", "[", 
          RowBox[{"sampleLength", "/", "2"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"count", "=", "0"}], ";", "\[IndentingNewLine]", 
        RowBox[{"textVec", "=", 
         RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"len", "=", "0"}], ";", "\[IndentingNewLine]", 
        RowBox[{"While", "[", 
         RowBox[{
          RowBox[{"len", "<", "target"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"count", "=", 
            RowBox[{"count", "+", "1"}]}], ";", 
           RowBox[{"textVec", "=", 
            RowBox[{"Flatten", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"textVec", ",", 
                RowBox[{"Values", "[", 
                 RowBox[{"Import", "[", 
                  RowBox[{
                   RowBox[{"FileNameJoin", "[", 
                    RowBox[{"{", 
                    RowBox[{
                    "$buildFolder", ",", "\"\<data\>\"", ",", 
                    "\"\<textVecs\>\"", ",", 
                    RowBox[{"StringTake", "[", 
                    RowBox[{
                    RowBox[{"pageIds", "[", 
                    RowBox[{"[", 
                    RowBox[{"randomInt", "[", 
                    RowBox[{"[", "count", "]"}], "]"}], "]"}], "]"}], ",", 
                    RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
                    RowBox[{
                    RowBox[{"pageIds", "[", 
                    RowBox[{"[", 
                    RowBox[{"randomInt", "[", 
                    RowBox[{"[", "count", "]"}], "]"}], "]"}], "]"}], "<>", 
                    "\"\<.json\>\""}]}], "}"}], "]"}], ",", 
                   "\"\<RawJSON\>\""}], "]"}], "]"}]}], "}"}], ",", "1"}], 
             "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"len", "=", 
            RowBox[{"Length", "@", "textVec"}]}]}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"badPos", "=", 
         RowBox[{"Position", "[", 
          RowBox[{
           RowBox[{"Length", "/@", "textVec"}], ",", "1"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"textVec", "=", 
         RowBox[{"Delete", "[", 
          RowBox[{"textVec", ",", "badPos"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"Combine", " ", "Samples"}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{"sample", "=", 
         RowBox[{"Catenate", "@", 
          RowBox[{"Join", "[", 
           RowBox[{"{", 
            RowBox[{"imgVec", ",", 
             RowBox[{"RandomSample", "[", 
              RowBox[{"textVec", ",", 
               RowBox[{"sampleLength", "/", "2"}]}], "]"}]}], "}"}], 
           "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Export", "[", 
         RowBox[{
          RowBox[{"FileNameJoin", "[", 
           RowBox[{"{", 
            RowBox[{
            "somFolder", ",", "\"\<training\>\"", ",", "\"\<samples\>\"", ",", 
             RowBox[{
              RowBox[{"ToString", "@", "i"}], "<>", "\"\<.wxf\>\""}]}], "}"}],
            "]"}], ",", 
          RowBox[{"RandomSample", "@", "sample"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Clear", "[", 
         RowBox[{"{", 
          RowBox[{"sample", ",", "textVec", ",", "imgVec"}], "}"}], "]"}], 
        ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "1", ",", "iterations"}], "}"}]}], "]"}], ";"}], 
    ",", "i"}], "]"}]}]], "Input",
 CellChangeTimes->{
  3.931862849839431*^9, {3.9318629358823566`*^9, 3.931862939611563*^9}, {
   3.9318638672851057`*^9, 3.931864095131999*^9}, {3.9318641355311365`*^9, 
   3.931864286462048*^9}, {3.9318644030262547`*^9, 3.931864425461631*^9}, 
   3.9318646933273525`*^9, 3.9319262668001056`*^9, {3.931929967020261*^9, 
   3.9319299822081776`*^9}, {3.931930111663454*^9, 3.9319301300820727`*^9}, {
   3.9319301642787867`*^9, 3.931930234104513*^9}, {3.9319302643147345`*^9, 
   3.9319302842540407`*^9}, {3.9319303708707743`*^9, 3.931930386573155*^9}, {
   3.9320104707747965`*^9, 3.9320104711578484`*^9}, {3.932534992261984*^9, 
   3.9325349960206995`*^9}, {3.961399790048805*^9, 3.961399868714583*^9}, {
   3.961399901129796*^9, 3.961399916386688*^9}, 3.961400240926051*^9, 
   3.961400367876346*^9, {3.961402155506731*^9, 3.9614021613234386`*^9}, 
   3.961405849519424*^9, {3.9614849880784883`*^9, 3.9614850213868313`*^9}, {
   3.9614850900526133`*^9, 3.961485111120072*^9}, {3.961497811517622*^9, 
   3.9614979044163837`*^9}, 3.96155603233208*^9, {3.961556122186674*^9, 
   3.961556122252552*^9}},ExpressionUUID->"4e0b063c-2210-4b8f-af16-\
3004228c1387"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["10. Train a Global SOM",
 FontSize->24,
 FontColor->RGBColor[0., 0., 0.]]], "Subtitle",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004653855638*^9}, {
   3.9255429588956685`*^9, 3.9255429656805353`*^9}, {3.933419738072833*^9, 
   3.933419738467922*^9}, {3.961339364151065*^9, 3.961339392280257*^9}, {
   3.961390164835906*^9, 3.961390173814896*^9}, 3.961393054862067*^9, {
   3.961426955932397*^9, 3.96142700870084*^9}, {3.96142719807768*^9, 
   3.9614271983425303`*^9}, {3.961427761036393*^9, 
   3.961427761357655*^9}},ExpressionUUID->"6f60c0b3-9822-4974-b90b-\
42b0618094f3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "1.", " ", "Set", " ", "directories", " ", "and", " ", "import", " ", 
     "pre"}], "-", 
    RowBox[{"processed", " ", 
     RowBox[{"files", ".", " ", "Lengths"}], " ", "of", " ", "hashed", " ", 
     "images", " ", "and", " ", "pages", " ", "are", " ", "shown", " ", 
     RowBox[{"below", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"somFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<soms\>\""}], "}"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"vecListSample", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "somFolder", ",", "\"\<training\>\"", ",", "\"\<samples\>\"", ",", 
         RowBox[{
          RowBox[{"ToString", "@", "1"}], "<>", "\"\<.wxf\>\""}]}], "}"}], 
       "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"sampleLength", "=", 
     RowBox[{"Length", "@", "vecListSample"}]}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.931345926176607*^9, 3.9313459302730165`*^9}, {
   3.9313459962659707`*^9, 3.9313460051133456`*^9}, 3.9314094073560534`*^9, {
   3.961397858042974*^9, 3.9613978990634117`*^9}, {3.9613981099842567`*^9, 
   3.961398116874123*^9}, {3.96140178828743*^9, 3.96140178893659*^9}, {
   3.9614762269761333`*^9, 3.9614762576689167`*^9}, {3.9614838108529453`*^9, 
   3.961483845441136*^9}, {3.961485148373307*^9, 3.961485148737534*^9}, {
   3.961485213243493*^9, 3.961485220228598*^9}, {3.9615086262193727`*^9, 
   3.9615086363259783`*^9}, {3.961508685515854*^9, 3.9615086855876913`*^9}, {
   3.961511881913372*^9, 3.961511882171919*^9}, {3.96157129971975*^9, 
   3.961571299812291*^9}},ExpressionUUID->"14db4755-fa2a-4ac8-a8b5-\
c9f72f9bf272"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "2.", " ", "If", " ", "not", " ", "done", " ", "already", " ", "in", " ", 
     "this", " ", "session"}], ",", " ", 
    RowBox[{
     RowBox[{
     "evaluate", " ", "CLIPedia", " ", "initialization", " ", "functions", 
      " ", "by", " ", "clicking", " ", "yes", " ", "on", " ", "the", " ", 
      "notebook", " ", "pop"}], "-", "up"}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"functions", "=", 
     RowBox[{"NotebookOpen", "[", 
      RowBox[{
       RowBox[{"FileNameJoin", "[", 
        RowBox[{"{", 
         RowBox[{
         "$repoFolder", ",", "\"\<code\>\"", ",", 
          "\"\<clipedia_functions.nb\>\""}], "}"}], "]"}], ",", 
       RowBox[{"Visible", "->", "True"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"SelectionMove", "[", 
     RowBox[{"functions", ",", "Before", ",", "Notebook"}], "]"}], ";", 
    RowBox[{"SelectionMove", "[", 
     RowBox[{"functions", ",", "Next", ",", "Cell"}], "]"}], ";", 
    RowBox[{"SelectionEvaluate", "[", "functions", "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.907645997965927*^9, 3.907646078557015*^9}, {
   3.907646185435628*^9, 3.907646186015532*^9}, {3.907646774687398*^9, 
   3.907646814543491*^9}, {3.907661852666642*^9, 3.907661892204844*^9}, {
   3.907662006350642*^9, 3.9076620119726*^9}, {3.9076663041483603`*^9, 
   3.907666304789756*^9}, {3.907686797040777*^9, 3.907686797747974*^9}, {
   3.919525496418584*^9, 3.919525497699961*^9}, {3.9197060623198233`*^9, 
   3.9197060667885957`*^9}, {3.919706114058092*^9, 3.919706128982294*^9}, {
   3.919781912755134*^9, 3.919781912795006*^9}, {3.919781947934552*^9, 
   3.919781966935747*^9}, {3.919848414262558*^9, 3.9198484146468883`*^9}, 
   3.935473720200501*^9, {3.935473838189433*^9, 3.935473841354582*^9}, {
   3.935638957223358*^9, 3.935638957326006*^9}, {3.9356390560379343`*^9, 
   3.935639058711771*^9}, {3.935658322424658*^9, 3.9356583225402327`*^9}, {
   3.935723004354435*^9, 3.935723004805295*^9}, {3.9359163367825336`*^9, 
   3.93591633723468*^9}, {3.936092399212842*^9, 3.936092399329157*^9}, 
   3.936158161570262*^9, {3.936260859452054*^9, 3.936260860115284*^9}, {
   3.937883982539661*^9, 3.9378839829721127`*^9}, {3.937995756107422*^9, 
   3.937995756221203*^9}, {3.938014732793124*^9, 3.9380147341018*^9}, 
   3.938016470467143*^9, 3.938016528755129*^9, {3.940414521626555*^9, 
   3.94041452456884*^9}, {3.9409089709718437`*^9, 3.940908971329804*^9}, {
   3.941016945740665*^9, 3.941016946103167*^9}, {3.9411006293110933`*^9, 
   3.9411006299214354`*^9}, {3.941234308389617*^9, 3.94123430887071*^9}, {
   3.9416718384564342`*^9, 3.941671838551146*^9}, {3.942299796095441*^9, 
   3.942299797625595*^9}, {3.943377137832711*^9, 3.943377138576899*^9}, {
   3.9563266467496433`*^9, 3.956326653817576*^9}, 3.961253113290951*^9, {
   3.961253529276929*^9, 3.9612535802263517`*^9}, {3.961253673538267*^9, 
   3.961253684603194*^9}, {3.96125372879198*^9, 3.961253766586738*^9}, 
   3.961314552173787*^9, {3.961321579753784*^9, 3.9613215894888973`*^9}, {
   3.961489392814011*^9, 3.961489392888639*^9}, {3.961571238425026*^9, 
   3.961571291582671*^9}},ExpressionUUID->"08bc8266-d436-433e-b90a-\
2c8622ac5fae"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "3.", " ", "Set", " ", "the", " ", "parameters", " ", "for", " ", "SOM", 
    " ", 
    RowBox[{"training", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"y", "=", "32"}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{"how", " ", "many", " ", "cells", " ", "high"}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"x", " ", "=", "32"}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{"how", " ", "many", " ", "cells", " ", "wide"}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"iterations", "=", "32"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.961485281142989*^9, 3.9614852921474333`*^9}, {
   3.961497941506394*^9, 3.9614979583782883`*^9}, 3.961497994122737*^9, {
   3.9615086886413317`*^9, 
   3.961508688695256*^9}},ExpressionUUID->"eea333cd-e8dd-4bdf-b53a-\
e9c93740231c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "4.", " ", "Initialize", " ", "a", " ", "SOM", " ", "kernel", " ", "from", 
    " ", "training", " ", "samples"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"dim", "=", 
     RowBox[{"Length", "@", 
      RowBox[{"vecListSample", "[", 
       RowBox[{"[", "1", "]"}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"somKernel", "=", 
     RowBox[{"CreateSomGridRandomSample", "[", 
      RowBox[{"vecListSample", ",", "y", ",", "x", ",", "dim", ",", "True"}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "somFolder", ",", "\"\<training\>\"", ",", "\"\<kernel.wxf\>\""}], 
        "}"}], "]"}], ",", "somKernel"}], "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.8990196285932107`*^9, 3.8990196705207653`*^9}, {
   3.899019705432223*^9, 3.899019913623831*^9}, {3.8990199444449883`*^9, 
   3.8990199851408377`*^9}, {3.8990200427022157`*^9, 3.899020056106284*^9}, {
   3.8990205304415493`*^9, 3.8990205308532696`*^9}, {3.899020603549752*^9, 
   3.899020621498853*^9}, {3.89902662429031*^9, 3.89902662537862*^9}, {
   3.8990266785808077`*^9, 3.8990266790940533`*^9}, {3.8990449910351143`*^9, 
   3.899044996250246*^9}, {3.899045045653536*^9, 3.899045047426427*^9}, {
   3.8990451399953623`*^9, 3.8990451482131424`*^9}, {3.8990475168956327`*^9, 
   3.899047518539893*^9}, {3.8990501560586843`*^9, 3.8990501588153906`*^9}, {
   3.8990508016569147`*^9, 3.8990508029306984`*^9}, 3.8990608226817365`*^9, {
   3.899097915815462*^9, 3.8990979235750537`*^9}, {3.9318557428408556`*^9, 
   3.931855746048732*^9}, {3.931855898294766*^9, 3.931855899089117*^9}, {
   3.9318577327930775`*^9, 3.9318577685963593`*^9}, {3.9318614557227955`*^9, 
   3.9318614631505423`*^9}, {3.931963773688487*^9, 3.9319637924532022`*^9}, {
   3.93210516028084*^9, 3.9321051722120833`*^9}, {3.9322280251525097`*^9, 
   3.932228026324808*^9}, {3.961485178165254*^9, 3.961485223133215*^9}, 
   3.961498003866159*^9, {3.961508488143367*^9, 3.961508488214883*^9}, {
   3.9615098922518377`*^9, 3.9615098923271017`*^9}},
 CellLabel->
  "In[202]:=",ExpressionUUID->"4ea7e9b4-78c7-41c2-ba79-f08e9549cc34"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"5.", " ", "Re"}], "-", 
     RowBox[{
     "import", " ", "the", " ", "SOM", " ", "kernel", " ", "and", " ", 
      "train", " ", "a", " ", "SOM"}]}], " ", "\[Dash]", " ", 
    RowBox[{
    "it", " ", "picks", " ", "its", " ", "training", " ", "samples", " ", 
     "automatically", " ", "from", " ", "its", " ", 
     RowBox[{"folder", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"somKernel", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "somFolder", ",", "\"\<training\>\"", ",", "\"\<kernel.wxf\>\""}], 
        "}"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"BatchSOM", "[", 
     RowBox[{
     "somKernel", ",", "\"\<\>\"", ",", "sampleLength", ",", "0.01", ",", 
      "iterations", ",", "\"\<Stats\>\"", ",", "\"\<Visible\>\"", ",", 
      "\"\<Exponential\>\"", ",", "\"\<EuclideanDistance\>\"", ",", 
      "\"\<GrayTones\>\"", ",", "somFolder"}], "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.883032712911953*^9, 3.883032732836834*^9}, {
   3.8830351215117054`*^9, 3.8830351371014276`*^9}, {3.8830351959008045`*^9, 
   3.8830352066834884`*^9}, {3.883046634687385*^9, 3.883046639545291*^9}, {
   3.8830472256565957`*^9, 3.8830472434551473`*^9}, 3.88304736474644*^9, {
   3.8830474140112357`*^9, 3.8830474171841564`*^9}, {3.8830474655284014`*^9, 
   3.8830474662471333`*^9}, {3.8830478878918486`*^9, 3.883047889343164*^9}, {
   3.8830479225778146`*^9, 3.883047947143632*^9}, {3.8830479861528697`*^9, 
   3.8830479948554077`*^9}, {3.884595750181782*^9, 3.8845957528262224`*^9}, {
   3.884595856064088*^9, 3.884595856654687*^9}, {3.884596233763604*^9, 
   3.8845962341204147`*^9}, {3.8845963910213037`*^9, 3.884596404765682*^9}, {
   3.899018055257341*^9, 3.899018056336166*^9}, 3.899019622159719*^9, {
   3.8990219594271655`*^9, 3.899021968365224*^9}, {3.899022002920374*^9, 
   3.899022030224688*^9}, {3.8990223273977823`*^9, 3.899022329306341*^9}, {
   3.8990489820371227`*^9, 3.89904898320457*^9}, 3.8990979306697807`*^9, {
   3.8990999034896116`*^9, 3.899099903658098*^9}, {3.9185764765779305`*^9, 
   3.9185764797709055`*^9}, {3.918633700775464*^9, 3.918633702430462*^9}, 
   3.918791163114112*^9, {3.9318565458742647`*^9, 3.931856554376462*^9}, {
   3.93196380756365*^9, 3.9319638318635902`*^9}, {3.9319638809283805`*^9, 
   3.931963882835514*^9}, {3.9322286125274596`*^9, 3.932228613592828*^9}, {
   3.93244579676674*^9, 3.9324457994141912`*^9}, {3.961402506849073*^9, 
   3.961402507938774*^9}, {3.961402612396806*^9, 3.9614026475025063`*^9}, {
   3.961402761744401*^9, 3.961402761810038*^9}, {3.961402796934026*^9, 
   3.961402798221902*^9}, {3.961403468906301*^9, 3.9614034887515793`*^9}, 
   3.961403612231879*^9, {3.961403664233912*^9, 3.961403668378726*^9}, {
   3.96140400723514*^9, 3.961404007470553*^9}, {3.9614852321315947`*^9, 
   3.961485252420802*^9}, {3.961485304950629*^9, 3.961485313320036*^9}, {
   3.961508690267685*^9, 3.961508690308918*^9}, {3.961509894490038*^9, 
   3.961509894605651*^9}},
 CellLabel->
  "In[219]:=",ExpressionUUID->"7e2d6fdc-ffa7-4c45-9ff3-75cf71b5e98a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "6.", " ", "Import", " ", "all", " ", "iterations", " ", "for", " ", 
    RowBox[{"review", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"trainedSomKernels", "=", 
    RowBox[{
     RowBox[{
      RowBox[{"Import", "[", "#", "]"}], "&"}], "/@", 
     RowBox[{"FileNames", "[", 
      RowBox[{"All", ",", 
       RowBox[{"FileNameJoin", "[", 
        RowBox[{"{", 
         RowBox[{
         "somFolder", ",", "\"\<training\>\"", ",", "\"\<iterations\>\""}], 
         "}"}], "]"}]}], "]"}]}]}], ";"}]}]], "Input",
 CellChangeTimes->{{3.8893411119164653`*^9, 3.8893411243855686`*^9}, {
   3.889341627163065*^9, 3.889341664183589*^9}, {3.893872551592636*^9, 
   3.8938725545008893`*^9}, {3.8990442620900335`*^9, 3.8990442638467903`*^9}, 
   3.961404005628211*^9, {3.961485320851261*^9, 3.9614853420759*^9}, {
   3.9615119025612383`*^9, 
   3.9615119032653437`*^9}},ExpressionUUID->"49c6bc1b-0d40-4450-bf68-\
29de7e955eb0"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "7.", " ", "Calculate", " ", "the", " ", "position", " ", "where", " ", 
     "both", " ", "the", " ", "TE", " ", "and", " ", "the", " ", "QE", " ", 
     "are", " ", "low"}], ",", " ", 
    RowBox[{"to", " ", "find", " ", "the", " ", "best", " ", 
     RowBox[{"iteration", ".", " ", "You"}], " ", "can", " ", "also", " ", 
     "flick", " ", "through", " ", "the", " ", "graphs", " ", "and", " ", 
     "renders", " ", "to", " ", "make", " ", "your", " ", 
     RowBox[{"pick", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"error", "=", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"trainedSomKernels", "[", 
          RowBox[{"[", 
           RowBox[{
           "i", ",", "\"\<training history\>\"", ",", "\"\<info\>\"", ",", 
            "\"\<infoQEN\>\""}], "]"}], "]"}], "+", 
         RowBox[{"(", 
          RowBox[{"trainedSomKernels", "[", 
           RowBox[{"[", 
            RowBox[{
            "i", ",", "\"\<training history\>\"", ",", "\"\<info\>\"", ",", 
             "\"\<infoTE\>\""}], "]"}], "]"}], ")"}]}], ")"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", 
         RowBox[{"Length", "@", "trainedSomKernels"}]}], "}"}]}], "]"}]}], 
    ";"}], "\n", 
   RowBox[{
    RowBox[{"errorMinPos", "=", 
     RowBox[{"First", "@", 
      RowBox[{"Flatten", "[", 
       RowBox[{"Position", "[", 
        RowBox[{"error", ",", 
         RowBox[{"Min", "[", "error", "]"}]}], "]"}], "]"}]}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Print", "[", 
     RowBox[{"\"\<Iteration \>\"", "<>", 
      RowBox[{"ToString", "@", "errorMinPos"}], "<>", 
      "\"\< seems best.\>\""}], "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"TabView", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"ShowSOMStats", "[", "#", "]"}], "&"}], "/@", 
     RowBox[{"trainedSomKernels", "[", 
      RowBox[{"[", 
       RowBox[{"All", ",", "\"\<training history\>\""}], "]"}], "]"}]}], 
    "]"}]}]}]], "Input",
 CellChangeTimes->{{3.889341798300456*^9, 3.889341826651073*^9}, {
  3.9614037262066298`*^9, 3.961403726723043*^9}, {3.961485345016127*^9, 
  3.961485430652172*^9}, {3.9615119046270657`*^9, 
  3.961511905193829*^9}},ExpressionUUID->"cd7c3dc5-ad45-4aba-ba51-\
2d9965237b6a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "8.", " ", "Set", " ", "the", " ", "iteration", " ", "number", " ", "you", 
    " ", "want", " ", "your", " ", "CLIPedia", " ", "to", " ", "be", " ", 
    "based", " ", "on"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"chosenIte", "=", "18"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"somKernel", "[", 
      RowBox[{"[", "\"\<weights\>\"", "]"}], "]"}], "=", 
     RowBox[{"Normalize", "/@", 
      RowBox[{"trainedSomKernels", "[", 
       RowBox[{"[", 
        RowBox[{"chosenIte", ",", "\"\<weights\>\""}], "]"}], "]"}]}]}], 
    ";"}], "\n", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "somFolder", ",", "\"\<kernels\>\"", ",", 
         "\"\<global_som_kernel.wxf\>\""}], "}"}], "]"}], ",", "somKernel"}], 
     "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{
  3.8846337496228867`*^9, {3.8846339029388437`*^9, 3.8846339029954443`*^9}, {
   3.8846339637956877`*^9, 3.8846339718842354`*^9}, 3.893950144009386*^9, {
   3.893992389409684*^9, 3.8939923900659313`*^9}, 3.8991361953511496`*^9, {
   3.899645896011045*^9, 3.8996459112526073`*^9}, {3.932533385485119*^9, 
   3.9325333859192114`*^9}, {3.961403736516828*^9, 3.9614037597083263`*^9}, 
   3.961403978970755*^9, {3.961409976186104*^9, 3.961409991970845*^9}, 
   3.9614659166368217`*^9, {3.961485435186212*^9, 3.961485459161274*^9}, {
   3.961511907102242*^9, 3.9615119074462748`*^9}, {3.961573099052514*^9, 
   3.9615730993349657`*^9}},ExpressionUUID->"7bc5ee36-e937-4c4c-8199-\
594ca3205afa"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["11. Allocate Embeddings to Global SOM",
 FontSize->24,
 FontColor->RGBColor[0., 0., 0.]]], "Subtitle",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004653855638*^9}, {
   3.9255429588956685`*^9, 3.9255429656805353`*^9}, {3.933419738072833*^9, 
   3.933419738467922*^9}, {3.961339364151065*^9, 3.961339392280257*^9}, {
   3.961390164835906*^9, 3.961390173814896*^9}, 3.961393054862067*^9, {
   3.961426955932397*^9, 3.9614270283665447`*^9}, {3.961427200249331*^9, 
   3.961427201190227*^9}, {3.961427763011438*^9, 
   3.96142776312297*^9}},ExpressionUUID->"b0cc2099-e438-478c-8350-\
eed824b016fe"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "1.", " ", "Select", " ", "project", " ", "folder", " ", "and", " ", 
     "import", " ", "pre"}], "-", 
    RowBox[{"processed", " ", 
     RowBox[{"files", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"somFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<soms\>\""}], "}"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"somKernel", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "somFolder", ",", "\"\<kernels\>\"", ",", 
         "\"\<global_som_kernel.wxf\>\""}], "}"}], "]"}], "]"}]}], ";"}], 
   "\n", 
   RowBox[{
    RowBox[{"somCellFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"somFolder", ",", "\"\<alloc\>\""}], "}"}], "]"}]}], 
    ";"}]}]}]], "Input",
 CellChangeTimes->{{3.961511917271699*^9, 3.961511917550503*^9}, 
   3.961571947013853*^9, 3.961571992527676*^9},
 CellLabel->"In[60]:=",ExpressionUUID->"da7f74db-540c-4e24-8d71-edcfcfc3ef5b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "2.", " ", "If", " ", "not", " ", "done", " ", "already", " ", "in", " ", 
     "this", " ", "session"}], ",", " ", 
    RowBox[{
     RowBox[{
     "evaluate", " ", "CLIPedia", " ", "initialization", " ", "functions", 
      " ", "by", " ", "clicking", " ", "yes", " ", "on", " ", "the", " ", 
      "notebook", " ", "pop"}], "-", "up"}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"functions", "=", 
     RowBox[{"NotebookOpen", "[", 
      RowBox[{
       RowBox[{"FileNameJoin", "[", 
        RowBox[{"{", 
         RowBox[{
         "$repoFolder", ",", "\"\<code\>\"", ",", 
          "\"\<clipedia_functions.nb\>\""}], "}"}], "]"}], ",", 
       RowBox[{"Visible", "->", "True"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"SelectionMove", "[", 
     RowBox[{"functions", ",", "Before", ",", "Notebook"}], "]"}], ";", 
    RowBox[{"SelectionMove", "[", 
     RowBox[{"functions", ",", "Next", ",", "Cell"}], "]"}], ";", 
    RowBox[{"SelectionEvaluate", "[", "functions", "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.907645997965927*^9, 3.907646078557015*^9}, {
   3.907646185435628*^9, 3.907646186015532*^9}, {3.907646774687398*^9, 
   3.907646814543491*^9}, {3.907661852666642*^9, 3.907661892204844*^9}, {
   3.907662006350642*^9, 3.9076620119726*^9}, {3.9076663041483603`*^9, 
   3.907666304789756*^9}, {3.907686797040777*^9, 3.907686797747974*^9}, {
   3.919525496418584*^9, 3.919525497699961*^9}, {3.9197060623198233`*^9, 
   3.9197060667885957`*^9}, {3.919706114058092*^9, 3.919706128982294*^9}, {
   3.919781912755134*^9, 3.919781912795006*^9}, {3.919781947934552*^9, 
   3.919781966935747*^9}, {3.919848414262558*^9, 3.9198484146468883`*^9}, 
   3.935473720200501*^9, {3.935473838189433*^9, 3.935473841354582*^9}, {
   3.935638957223358*^9, 3.935638957326006*^9}, {3.9356390560379343`*^9, 
   3.935639058711771*^9}, {3.935658322424658*^9, 3.9356583225402327`*^9}, {
   3.935723004354435*^9, 3.935723004805295*^9}, {3.9359163367825336`*^9, 
   3.93591633723468*^9}, {3.936092399212842*^9, 3.936092399329157*^9}, 
   3.936158161570262*^9, {3.936260859452054*^9, 3.936260860115284*^9}, {
   3.937883982539661*^9, 3.9378839829721127`*^9}, {3.937995756107422*^9, 
   3.937995756221203*^9}, {3.938014732793124*^9, 3.9380147341018*^9}, 
   3.938016470467143*^9, 3.938016528755129*^9, {3.940414521626555*^9, 
   3.94041452456884*^9}, {3.9409089709718437`*^9, 3.940908971329804*^9}, {
   3.941016945740665*^9, 3.941016946103167*^9}, {3.9411006293110933`*^9, 
   3.9411006299214354`*^9}, {3.941234308389617*^9, 3.94123430887071*^9}, {
   3.9416718384564342`*^9, 3.941671838551146*^9}, {3.942299796095441*^9, 
   3.942299797625595*^9}, {3.943377137832711*^9, 3.943377138576899*^9}, {
   3.9563266467496433`*^9, 3.956326653817576*^9}, 3.961253113290951*^9, {
   3.961253529276929*^9, 3.9612535802263517`*^9}, {3.961253673538267*^9, 
   3.961253684603194*^9}, {3.96125372879198*^9, 3.961253766586738*^9}, 
   3.961314552173787*^9, {3.961321579753784*^9, 3.9613215894888973`*^9}, {
   3.961489392814011*^9, 3.961489392888639*^9}, 3.9615707454610157`*^9, {
   3.9615708916307364`*^9, 3.961570891922319*^9}, {3.961571194299787*^9, 
   3.961571218950098*^9}},
 CellLabel->"In[63]:=",ExpressionUUID->"f478c23f-f9dd-4171-998f-b9800faff8a0"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"3.", " ", "Import", " ", "all", " ", "image", " ", "encoding"}], 
    "-", 
    RowBox[{
    "id", " ", "pairs", " ", "to", " ", "associate", " ", "to", " ", "the", 
     " ", "global", " ", "SOM"}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"imgVecList", "=", 
    RowBox[{"Import", "[", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{
       "somFolder", ",", "\"\<training\>\"", ",", "\"\<vectors\>\"", ",", 
        "\"\<imgVecList.wxf\>\""}], "}"}], "]"}], "]"}]}], ";"}]}]], "Input",
 CellChangeTimes->{{3.931345926176607*^9, 3.9313459302730165`*^9}, {
   3.9313459962659707`*^9, 3.9313460051133456`*^9}, 3.9314094073560534`*^9, {
   3.961397858042974*^9, 3.9613978990634117`*^9}, {3.9613981099842567`*^9, 
   3.961398116874123*^9}, {3.96140178828743*^9, 3.96140178893659*^9}, {
   3.961486855273451*^9, 3.961486975055129*^9}, {3.9615105421326857`*^9, 
   3.961510550605467*^9}, {3.961510766144071*^9, 3.961510778739623*^9}, {
   3.961570894440709*^9, 3.9615708945421247`*^9}},
 CellLabel->
  "In[171]:=",ExpressionUUID->"8c94445a-6148-4759-9e29-039f1db25ab2"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "4.", " ", "As", " ", "evaluating", " ", "and", " ", "updating", " ", 
     "the", " ", "mappings", " ", "to", " ", "each", " ", "cell", " ", "is", 
     " ", "too", " ", "memory", " ", "intensive", " ", "for", " ", "tens", 
     " ", "of", " ", "millions", " ", "of", " ", "files"}], ",", " ", 
    RowBox[{
    "we", " ", "launch", " ", "individual", " ", "text", " ", "files", " ", 
     "for", " ", "each", " ", "SOM", " ", "cell"}], ",", " ", 
    RowBox[{
    "into", " ", "which", " ", "we", " ", "can", " ", "incrementally", " ", 
     RowBox[{"write", ".", " ", "Setup"}], " ", "these", " ", "intermediate", 
     " ", 
     RowBox[{"files", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"cellLogPathList", "=", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"FileNameJoin", "[", 
        RowBox[{"{", 
         RowBox[{"somCellFolder", ",", "\"\<images\>\"", ",", 
          RowBox[{
           RowBox[{"ToString", "@", "i"}], "<>", "\"\<.txt\>\""}]}], "}"}], 
        "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", 
         RowBox[{"somKernel", "[", 
          RowBox[{"[", 
           RowBox[{"\"\<dimensions\>\"", ",", "\"\<len\>\""}], "]"}], "]"}]}],
         "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"Quiet", "@", 
       RowBox[{"DeleteFile", "[", "#", "]"}]}], "&"}], "/@", 
     "cellLogPathList"}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"Quiet", "@", 
       RowBox[{"CreateFile", "[", "#", "]"}]}], "&"}], "/@", 
     "cellLogPathList"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"Quiet", "@", 
       RowBox[{"Close", "[", "#", "]"}]}], "&"}], "/@", "cellLogPathList"}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"OpenWrite", "[", "#", "]"}], "&"}], "/@", "cellLogPathList"}], 
    ";"}]}]}]], "Input",
 CellChangeTimes->{{3.93253428485207*^9, 3.932534340608079*^9}, {
  3.932534566032584*^9, 3.9325345732990303`*^9}, {3.9325353320278473`*^9, 
  3.9325353361185417`*^9}, {3.9614869310079737`*^9, 3.9614869362174263`*^9}, {
  3.961486982002849*^9, 3.961487182253847*^9}, {3.9615708959144173`*^9, 
  3.961570896005989*^9}},
 CellLabel->
  "In[172]:=",ExpressionUUID->"b346586a-4ea5-4f99-a48d-ac675d5cee9e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "5.", " ", "Run", " ", "this", " ", "loop", " ", "to", " ", "associate", 
    " ", "all", " ", "encoded", " ", "images", " ", "to", " ", "their", " ", 
    "BMU", " ", "SOM", " ", 
    RowBox[{"cells", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"Monitor", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"embedding", "=", 
          RowBox[{"imgVecList", "[", 
           RowBox[{"[", "i", "]"}], "]"}]}], ";", 
         RowBox[{"nearest", "=", 
          RowBox[{"First", "[", 
           RowBox[{"Ordering", "[", 
            RowBox[{"CosineDistanceFast", "[", 
             RowBox[{
              RowBox[{"embedding", "[", 
               RowBox[{"[", "1", "]"}], "]"}], ",", 
              RowBox[{"somKernel", "[", 
               RowBox[{"[", "\"\<weights\>\"", "]"}], "]"}]}], "]"}], "]"}], 
           "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"WriteString", "[", 
          RowBox[{
           RowBox[{"cellLogPathList", "[", 
            RowBox[{"[", "nearest", "]"}], "]"}], ",", 
           RowBox[{
            RowBox[{"ToString", "[", 
             RowBox[{"embedding", ",", "StandardForm"}], "]"}], "<>", 
            "\"\<\\n\>\""}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"Clear", "[", "embedding", "]"}], ";"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Length", "@", "imgVecList"}]}], "}"}]}], "]"}], ";"}], ",",
      "i"}], "]"}], ";"}]}]], "Input",
 CellChangeTimes->{{3.932534441236036*^9, 3.932534449264597*^9}, {
   3.9325345918252797`*^9, 3.9325346226728277`*^9}, {3.932534753776112*^9, 
   3.932534782018377*^9}, {3.9325355002772703`*^9, 3.9325355004842606`*^9}, 
   3.9325355321883907`*^9, {3.9325356048787827`*^9, 3.93253562559669*^9}, {
   3.9325356572081223`*^9, 3.9325356636593113`*^9}, {3.932535744048729*^9, 
   3.9325357463109407`*^9}, {3.932535842433531*^9, 3.932535846963481*^9}, {
   3.932535963726276*^9, 3.932535964381282*^9}, {3.93257563081282*^9, 
   3.932575633078306*^9}, {3.932575671458535*^9, 3.9325756956397038`*^9}, {
   3.9325757440800476`*^9, 3.9325758449981956`*^9}, {3.932575888127947*^9, 
   3.9325759216331205`*^9}, {3.9325760317853503`*^9, 3.932576064689903*^9}, {
   3.9329776224787025`*^9, 3.932977622876756*^9}, {3.961404252496313*^9, 
   3.961404255616948*^9}, {3.961487203466145*^9, 3.961487230765517*^9}, {
   3.961570898236306*^9, 3.961570898325334*^9}},
 CellLabel->
  "In[177]:=",ExpressionUUID->"2c3b7ca5-4908-4162-be53-1a663e725e02"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"6.", " ", "Convert", " ", 
    RowBox[{"the", " ", ".", "txt"}], " ", "files", " ", 
    RowBox[{"to", " ", ".", "wxf"}], " ", "files", " ", "for", " ", "later", 
    " ", 
    RowBox[{"use", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"Monitor", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"Export", "[", 
         RowBox[{
          RowBox[{"StringReplace", "[", 
           RowBox[{
            RowBox[{"cellLogPathList", "[", 
             RowBox[{"[", "k", "]"}], "]"}], ",", 
            RowBox[{"\"\<.txt\>\"", "->", "\"\<.wxf\>\""}]}], "]"}], ",", 
          RowBox[{
           RowBox[{
            RowBox[{"StringElemToExp", "[", "#", "]"}], "&"}], "/@", 
           RowBox[{"Import", "[", 
            RowBox[{
             RowBox[{"cellLogPathList", "[", 
              RowBox[{"[", "k", "]"}], "]"}], ",", "\"\<List\>\""}], 
            "]"}]}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"k", ",", 
          RowBox[{"Length", "@", "cellLogPathList"}]}], "}"}]}], "]"}], ";"}],
      ",", "k"}], "]"}], ";"}]}]], "Input",
 CellChangeTimes->{{3.93297739390629*^9, 3.9329774049008875`*^9}, 
   3.9330461044334664`*^9, {3.9614872334012117`*^9, 3.9614872549301777`*^9}, {
   3.961570900017292*^9, 3.961570900077436*^9}},
 CellLabel->
  "In[178]:=",ExpressionUUID->"478a1aaf-b586-4cce-921b-026818658212"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "7.", " ", "See", " ", "if", " ", "the", " ", "number", " ", "of", " ", 
    "image", " ", "vectors", " ", "in", " ", "the", " ", "list", " ", "and", 
    " ", "the", " ", "ones", " ", "associated", " ", "in", " ", "the", " ", 
    "SOM", " ", 
    RowBox[{"coincide", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"test", "=", 
     RowBox[{
      RowBox[{
       RowBox[{"Import", "[", 
        RowBox[{"#", ",", "\"\<List\>\""}], "]"}], "&"}], "/@", 
      "cellLogPathList"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Total", "[", 
     RowBox[{"Length", "/@", "test"}], "]"}], "==", 
    RowBox[{"Length", "@", "imgVecList"}]}]}]}]], "Input",
 CellChangeTimes->{{3.9325445187318134`*^9, 3.9325445321804457`*^9}, {
  3.9614873104379883`*^9, 3.9614873461686087`*^9}, {3.961488462223604*^9, 
  3.961488462329232*^9}, {3.961570902481654*^9, 3.961570902563479*^9}},
 CellLabel->
  "In[179]:=",ExpressionUUID->"a4f07034-0003-4e9b-aa63-d2f8ad5b6478"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "8.", " ", "Prepare", " ", "for", " ", "associating", " ", "all", " ", 
     "encoded", " ", "texts", " ", "to", " ", "the", " ", "SOM"}], ",", " ", 
    RowBox[{"and", " ", 
     RowBox[{"create", " ", ".", "txt"}], " ", "files", " ", "for", " ", 
     "incremental", " ", "allocation"}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"pageIds", "=", 
    RowBox[{"Import", "[", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{
       "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<indices\>\"", ",", 
        "\"\<pageIds.json\>\""}], "}"}], "]"}], "]"}]}], ";"}]}]], "Input",
 CellChangeTimes->{{3.9325381900835075`*^9, 3.9325382098346186`*^9}, {
   3.932538245579333*^9, 3.932538258771989*^9}, {3.9325386474464235`*^9, 
   3.932538649872388*^9}, {3.961408138011113*^9, 3.961408143958639*^9}, {
   3.961487361870453*^9, 3.961487425849249*^9}, {3.961488458328322*^9, 
   3.961488465423751*^9}, 3.961488520222917*^9, 3.961511059832901*^9, {
   3.961570905222818*^9, 3.9615709052727118`*^9}},
 CellLabel->
  "In[181]:=",ExpressionUUID->"ba47e437-c8ca-4930-a898-e66c226c5b70"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "9.", " ", "Check", " ", "the", " ", "number", " ", "of", " ", 
    "individual", " ", "paragraphs", " ", "to", " ", "encode", " ", "for", 
    " ", "each", " ", 
    RowBox[{"page", "."}]}], "*)"}], 
  RowBox[{
   RowBox[{
    RowBox[{"Monitor", "[", 
     RowBox[{
      RowBox[{"textLengths", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Quiet", "[", 
          RowBox[{"Check", "[", 
           RowBox[{
            RowBox[{"Length", "@", 
             RowBox[{"Import", "[", 
              RowBox[{
               RowBox[{"FileNameJoin", "[", 
                RowBox[{"{", 
                 RowBox[{
                 "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<text\>\"", 
                  ",", 
                  RowBox[{"StringTake", "[", 
                   RowBox[{
                    RowBox[{"pageIds", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ",", 
                    RowBox[{"UpTo", "[", "4", "]"}]}], "]"}], ",", 
                  RowBox[{
                   RowBox[{"pageIds", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "<>", "\"\<.json\>\""}]}],
                  "}"}], "]"}], ",", "\"\<RawJSON\>\""}], "]"}]}], ",", "0"}],
            "]"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"Length", "@", "pageIds"}]}], "}"}]}], "]"}]}], ",", "i"}],
      "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"Length", "@", "textLengths"}]}]}]], "Input",
 CellChangeTimes->{{3.933144539695367*^9, 3.9331446362064395`*^9}, {
   3.9331446698364506`*^9, 3.9331446752142344`*^9}, {3.933144741716042*^9, 
   3.933144775119977*^9}, {3.9614083664326153`*^9, 3.961408378054669*^9}, {
   3.9614875743125057`*^9, 3.961487577035845*^9}, 3.961488331729062*^9, {
   3.9614883639395103`*^9, 3.961488468098078*^9}, 3.96148852164002*^9, {
   3.961511071891341*^9, 3.961511093568737*^9}, {3.961570907051715*^9, 
   3.961570907119453*^9}},
 CellLabel->
  "In[182]:=",ExpressionUUID->"21916066-a37b-4072-8b9d-2f5476a98205"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"10.", " ", "Launch", " ", "allocation", " ", "text", " ", 
     RowBox[{"files", ".", " ", "As"}], " ", "there", " ", "are", " ", 
     "normally", " ", 
     RowBox[{"ca", ".", " ", "10"}], " ", "times", " ", "as", " ", "many", 
     " ", "texts", " ", "as", " ", "images"}], ",", " ", 
    RowBox[{
    "we", " ", "launch", " ", "a", " ", "log", " ", "file", " ", "to", " ", 
     "pick", " ", "up", " ", "after", " ", "a", " ", 
     RowBox[{"crash", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"cellLogPathList", "=", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"FileNameJoin", "[", 
        RowBox[{"{", 
         RowBox[{"somCellFolder", ",", "\"\<text\>\"", ",", 
          RowBox[{
           RowBox[{"ToString", "@", "i"}], "<>", "\"\<.txt\>\""}]}], "}"}], 
        "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", 
         RowBox[{"somKernel", "[", 
          RowBox[{"[", 
           RowBox[{"\"\<dimensions\>\"", ",", "\"\<len\>\""}], "]"}], "]"}]}],
         "}"}]}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"progressLogPath", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{
       "$buildFolder", ",", "\"\<build\>\"", ",", "\"\<logs\>\"", ",", 
        "\"\<textAllocationLog.txt\>\""}], "}"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"Quiet", "@", 
       RowBox[{"DeleteFile", "[", "#", "]"}]}], "&"}], "/@", 
     "cellLogPathList"}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"Quiet", "@", 
       RowBox[{"CreateFile", "[", "#", "]"}]}], "&"}], "/@", 
     "cellLogPathList"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"Quiet", "@", 
       RowBox[{"Close", "[", "#", "]"}]}], "&"}], "/@", "cellLogPathList"}], 
    ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"OpenWrite", "[", "#", "]"}], "&"}], "/@", "cellLogPathList"}], 
    ";"}]}]}]], "Input",
 CellChangeTimes->{
  3.9325717734633017`*^9, 3.9325718275438824`*^9, 3.932712389324368*^9, {
   3.9614082220763597`*^9, 3.9614082565987167`*^9}, {3.961487439301807*^9, 
   3.961487490749807*^9}, {3.9614884725776253`*^9, 3.961488476349867*^9}, {
   3.961488696359317*^9, 3.961488722007028*^9}, 3.9614907217889442`*^9, {
   3.961511118879056*^9, 3.961511121708735*^9}, {3.9615709096714497`*^9, 
   3.961570910192585*^9}},
 CellLabel->
  "In[184]:=",ExpressionUUID->"ae6a6418-5e6c-4005-947c-1716abf7a394"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"X", ".", " ", "Identify"}], " ", "the", " ", "last", " ", 
     "well"}], "-", 
    RowBox[{
    "allocated", " ", "position", " ", "in", " ", "case", " ", "of", " ", "a",
      " ", 
     RowBox[{"crash", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"last", "=", 
   RowBox[{"Last", "[", 
    RowBox[{"Import", "[", 
     RowBox[{"progressLogPath", ",", "\"\<List\>\""}], "]"}], 
    "]"}]}]}]], "Input",
 CellChangeTimes->{{3.9327047203263774`*^9, 3.9327047635622897`*^9}, {
  3.961487497631109*^9, 3.961487540799024*^9}, {3.9614884845431147`*^9, 
  3.961488492256665*^9}, {3.961489787377893*^9, 3.961489790925865*^9}},
 CellLabel->"",ExpressionUUID->"af2cb664-e47b-4053-bd2f-6da0231b7b71"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "11.", " ", "Input", " ", "start", " ", "and", " ", "end", " ", 
    "positions", " ", "of", " ", "the", " ", "offset", " ", "list", " ", "to",
     " ", "start", " ", 
    RowBox[{"encoding", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"start", "=", "1"}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Start", " ", "position", " ", "for", " ", 
      RowBox[{"encoding", ".", " ", 
       RowBox[{"Add", " ", "'"}]}], "last"}], "+", 
     RowBox[{
      RowBox[{"1", "'"}], " ", "here", " ", "if", " ", "you", " ", "are", " ",
       "picking", " ", "up", " ", "after", " ", "an", " ", 
      RowBox[{"interruption", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"end", "=", 
     RowBox[{"Length", "@", "pageIds"}]}], ";"}], "  ", 
   RowBox[{"(*", 
    RowBox[{"End", " ", "position", " ", "for", " ", 
     RowBox[{"encoding", ".", " ", "Change"}], " ", 
     RowBox[{"to", " ", "'"}], 
     RowBox[{
      RowBox[{"Length", "@", "offset"}], "'"}], " ", "to", " ", "process", 
     " ", "the", " ", "full", " ", 
     RowBox[{"dump", "."}]}], "*)"}]}]}]], "Input",
 CellChangeTimes->{{3.9614084810095253`*^9, 3.961408481104834*^9}, {
  3.961426056183332*^9, 3.961426056373399*^9}, {3.961488504135017*^9, 
  3.961488504843001*^9}, {3.961570912979808*^9, 3.961570913010153*^9}},
 CellLabel->
  "In[190]:=",ExpressionUUID->"fe54f940-f3d0-49d1-bd08-2ab988a617d9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "12.", " ", "Run", " ", "this", " ", "loop", " ", "to", " ", "associate", 
    " ", "all", " ", "encoded", " ", "texts", " ", 
    RowBox[{"(", 
     RowBox[{"paragraph", "-", "level"}], ")"}], " ", "to", " ", "their", " ",
     "BMU", " ", "SOM", " ", 
    RowBox[{"cells", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"Quiet", "@", 
     RowBox[{"DeleteFile", "[", "progressLogPath", "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"Quiet", "@", 
     RowBox[{"CreateFile", "[", "progressLogPath", "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Quiet", "@", 
     RowBox[{"Close", "[", "progressLogPath", "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"len", "=", 
     RowBox[{"Length", "@", "pageIds"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"Quiet", "@", 
       RowBox[{"OpenAppend", "[", "#", "]"}]}], "&"}], "/@", 
     "cellLogPathList"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"OpenAppend", "[", "progressLogPath", "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Monitor", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"Table", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"batch", "=", 
           RowBox[{"Quiet", "[", 
            RowBox[{"Check", "[", 
             RowBox[{
              RowBox[{"Import", "[", 
               RowBox[{
                RowBox[{"FileNameJoin", "[", 
                 RowBox[{"{", 
                  RowBox[{
                  "$buildFolder", ",", "\"\<data\>\"", ",", 
                   "\"\<textVecs\>\"", ",", 
                   RowBox[{"StringTake", "[", 
                    RowBox[{
                    RowBox[{"pageIds", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ",", 
                    RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
                   RowBox[{
                    RowBox[{"pageIds", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "<>", "\"\<.json\>\""}]}],
                   "}"}], "]"}], ",", "\"\<RawJSON\>\""}], "]"}], ",", 
              "\"\<prob\>\""}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"batch", "=!=", "\"\<prob\>\""}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"embeddings", "=", 
              RowBox[{"Transpose", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"Values", "@", "#"}], ",", 
                   RowBox[{"Keys", "@", "#"}]}], "}"}], "&"}], "@", "batch"}],
                "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"Table", "[", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"embedding", "=", 
                 RowBox[{"embeddings", "[", 
                  RowBox[{"[", "j", "]"}], "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"nearest", "=", 
                 RowBox[{"First", "[", 
                  RowBox[{"Ordering", "[", 
                   RowBox[{"CosineDistanceFast", "[", 
                    RowBox[{
                    RowBox[{"embedding", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], ",", 
                    RowBox[{"somKernel", "[", 
                    RowBox[{"[", "\"\<weights\>\"", "]"}], "]"}]}], "]"}], 
                   "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
                RowBox[{"WriteString", "[", 
                 RowBox[{
                  RowBox[{"cellLogPathList", "[", 
                   RowBox[{"[", "nearest", "]"}], "]"}], ",", 
                  RowBox[{
                   RowBox[{"ToString", "[", 
                    RowBox[{"embedding", ",", "StandardForm"}], "]"}], "<>", 
                   "\"\<\\n\>\""}]}], "]"}], ";", "\[IndentingNewLine]", 
                RowBox[{"Clear", "[", 
                 RowBox[{"{", 
                  RowBox[{"embedding", ",", "nearest"}], "}"}], "]"}], ";"}], 
               ",", 
               RowBox[{"{", 
                RowBox[{"j", ",", 
                 RowBox[{"Length", "@", "embeddings"}]}], "}"}]}], "]"}], ";",
              "\[IndentingNewLine]", 
             RowBox[{"Clear", "[", "embeddings", "]"}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"WriteString", "[", 
              RowBox[{"progressLogPath", ",", 
               RowBox[{
                RowBox[{"ToString", "@", "i"}], "<>", "\"\<\\n\>\""}]}], 
              "]"}]}]}], "]"}], ";"}], "\[IndentingNewLine]", ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "start", ",", "end"}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"Quiet", "@", 
          RowBox[{"Close", "[", "#", "]"}]}], "&"}], "/@", 
        "cellLogPathList"}], ";", "\[IndentingNewLine]", 
       RowBox[{"Quiet", "@", 
        RowBox[{"Close", "[", "progressLogPath", "]"}]}], ";"}], 
      "\[IndentingNewLine]", ",", "i"}], "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.9325475999779215`*^9, 3.9325476013585386`*^9}, {
   3.9325476638574786`*^9, 3.9325476778953753`*^9}, {3.932547900660038*^9, 
   3.932548100976508*^9}, {3.9325482074980245`*^9, 3.932548246752272*^9}, {
   3.9325482937239857`*^9, 3.932548294175065*^9}, {3.932548342961914*^9, 
   3.932548369873309*^9}, {3.9325484581621184`*^9, 3.93254846450719*^9}, {
   3.9325486535188465`*^9, 3.9325486703187313`*^9}, {3.932548799405534*^9, 
   3.9325488033689404`*^9}, {3.932549296493842*^9, 3.932549334104952*^9}, {
   3.932569974289135*^9, 3.932569975513087*^9}, {3.9325700528653183`*^9, 
   3.9325700757369933`*^9}, {3.932570429087016*^9, 3.932570450151171*^9}, {
   3.932570611835552*^9, 3.932570713360698*^9}, 3.9325714998209596`*^9, 
   3.9325718234232526`*^9, {3.93257424485454*^9, 3.9325742558750467`*^9}, {
   3.9325744948721113`*^9, 3.9325745015385356`*^9}, {3.932574578881855*^9, 
   3.932574657820541*^9}, {3.9325747093006334`*^9, 3.9325748900756283`*^9}, {
   3.9325749241411047`*^9, 3.932575031431508*^9}, {3.932575441894021*^9, 
   3.9325754601686215`*^9}, {3.932575515331098*^9, 3.9325755575504093`*^9}, {
   3.932575951677782*^9, 3.932575990862852*^9}, {3.932576072196107*^9, 
   3.9325761018157043`*^9}, {3.932613683938301*^9, 3.9326136956388197`*^9}, {
   3.932616195353837*^9, 3.932616201625458*^9}, {3.9326163408849983`*^9, 
   3.932616348780572*^9}, {3.9327113109460716`*^9, 3.932711341755102*^9}, {
   3.932711601155294*^9, 3.9327116468815384`*^9}, {3.9327116995341*^9, 
   3.9327117039078016`*^9}, {3.9327117384884996`*^9, 3.932711742289401*^9}, {
   3.932711851378085*^9, 3.932711859605604*^9}, {3.932711934638812*^9, 
   3.9327119362381105`*^9}, {3.9327119871101017`*^9, 3.93271200714762*^9}, {
   3.9327124211032577`*^9, 3.932712428030939*^9}, {3.9329648079486036`*^9, 
   3.932964833821513*^9}, {3.9329773870928726`*^9, 3.9329774103643494`*^9}, {
   3.961405318227137*^9, 3.961405318568761*^9}, {3.961405514069948*^9, 
   3.961405515630707*^9}, {3.961405615222794*^9, 3.961405615673727*^9}, {
   3.961408470771027*^9, 3.961408475305345*^9}, {3.9614085062275753`*^9, 
   3.961408523585362*^9}, {3.9614095485992203`*^9, 3.961409548720889*^9}, {
   3.961488334737783*^9, 3.961488336284217*^9}, {3.961488509530781*^9, 
   3.961488512480412*^9}, {3.961488573996311*^9, 3.961488575878648*^9}, {
   3.9614886121886177`*^9, 3.961488694452218*^9}, {3.961488735310758*^9, 
   3.9614887500981627`*^9}, {3.9615111404745197`*^9, 3.961511155478279*^9}, 
   3.9615560469623413`*^9, {3.9615561288152657`*^9, 3.961556128954856*^9}, {
   3.9615709143989697`*^9, 3.961570914486689*^9}},
 CellLabel->
  "In[192]:=",ExpressionUUID->"8aaf3241-445f-4230-a84b-69487cd609d9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"13.", " ", 
     RowBox[{"Test", ":", " ", 
      RowBox[{
      "Check", " ", "for", " ", "broken", " ", "text", " ", "files"}]}]}], 
    ",", " ", 
    RowBox[{"that", " ", "got", " ", "corrupted", " ", "in", " ", "the", " ", 
     RowBox[{"process", ".", " ", "1"}], "st", " ", "row", " ", "shows", " ", 
     "allocation", " ", "problems"}], ",", " ", 
    RowBox[{
    "2", "nd", " ", "whether", " ", "the", " ", "number", " ", "of", " ", 
     "page", " ", "paragraphs", " ", "identified", " ", "earlier", " ", 
     "match", " ", "with", " ", "number", " ", "of", " ", "allocated", " ", 
     RowBox[{"elements", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"Monitor", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"test", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Quiet", "@", 
          RowBox[{"Check", "[", 
           RowBox[{
            RowBox[{"Import", "[", 
             RowBox[{
              RowBox[{"cellLogPathList", "[", 
               RowBox[{"[", "i", "]"}], "]"}], ",", "\"\<List\>\""}], "]"}], 
            ",", "\"\<}}\>\""}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"Length", "@", "cellLogPathList"}]}], "}"}]}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"cellTextLengths", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "[", 
          RowBox[{"StringCases", "[", 
           RowBox[{"#", ",", "\"\<{{\>\""}], "]"}], "]"}], "&"}], "/@", 
        "test"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Position", "[", 
       RowBox[{"cellTextLengths", ",", " ", 
        RowBox[{
         RowBox[{"#", "!=", "2"}], "&"}]}], "]"}]}], ",", "i"}], "]"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Total", "[", "textLengths", "]"}], "==", 
    RowBox[{"Total", "[", "cellTextLengths", "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.9327049623338585`*^9, 3.9327050112526665`*^9}, {
  3.932705086253699*^9, 3.9327051129834504`*^9}, {3.932705149552101*^9, 
  3.9327051536438646`*^9}, {3.9327096753793507`*^9, 3.9327096872889304`*^9}, {
  3.9327103753530974`*^9, 3.9327104546608987`*^9}, {3.9327105302249713`*^9, 
  3.9327105441031446`*^9}, {3.932711484751768*^9, 3.93271148994344*^9}, {
  3.961408592542676*^9, 3.961408593409184*^9}, {3.9614095754856853`*^9, 
  3.961409608925716*^9}, {3.961409752922099*^9, 3.9614097793774147`*^9}, {
  3.961488759608366*^9, 3.961488791461094*^9}, {3.961488953372573*^9, 
  3.961489054220254*^9}, {3.9615113049642553`*^9, 3.961511332722046*^9}, {
  3.96157092009461*^9, 3.9615709201800747`*^9}},
 CellLabel->
  "In[199]:=",ExpressionUUID->"9737e175-73ec-4f54-a076-e2ddcc96e65a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"14.", " ", "Convert", " ", 
    RowBox[{"the", " ", ".", "txt"}], " ", "files", " ", 
    RowBox[{"to", " ", ".", "wxf"}], " ", "files", " ", "for", " ", "later", 
    " ", 
    RowBox[{"use", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"Monitor", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"Export", "[", 
        RowBox[{
         RowBox[{"StringReplace", "[", 
          RowBox[{
           RowBox[{"cellLogPathList", "[", 
            RowBox[{"[", "k", "]"}], "]"}], ",", 
           RowBox[{"\"\<.txt\>\"", "->", "\"\<.wxf\>\""}]}], "]"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"StringElemToExp", "[", "#", "]"}], "&"}], "/@", 
          RowBox[{"Import", "[", 
           RowBox[{
            RowBox[{"cellLogPathList", "[", 
             RowBox[{"[", "k", "]"}], "]"}], ",", "\"\<List\>\""}], "]"}]}]}],
         "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"k", ",", 
         RowBox[{"Length", "@", "cellLogPathList"}]}], "}"}]}], "]"}], ";"}], 
    ",", "k"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.93297739390629*^9, 3.9329774049008875`*^9}, {
  3.961489076368813*^9, 3.961489079370767*^9}, {3.9615709215824137`*^9, 
  3.961570921666368*^9}},
 CellLabel->
  "In[201]:=",ExpressionUUID->"ce0dd666-569e-4bf0-850d-cbb92a45da0e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "15.", " ", "Combine", " ", "the", " ", "allocations", " ", "between", " ",
     "image", " ", "and", " ", "text", " ", "into", " ", "one", " ", "file", 
    " ", "per", " ", "cell", " ", "for", " ", "downstream", " ", 
    RowBox[{"use", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"cellPathList", "=", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"FileNameJoin", "[", 
        RowBox[{"{", 
         RowBox[{"somCellFolder", ",", "\"\<combined\>\"", ",", 
          RowBox[{
           RowBox[{"ToString", "@", "i"}], "<>", "\"\<.wxf\>\""}]}], "}"}], 
        "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", 
         RowBox[{"somKernel", "[", 
          RowBox[{"[", 
           RowBox[{"\"\<dimensions\>\"", ",", "\"\<len\>\""}], "]"}], "]"}]}],
         "}"}]}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"cellPathListText", "=", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"FileNameJoin", "[", 
        RowBox[{"{", 
         RowBox[{"somCellFolder", ",", "\"\<text\>\"", ",", 
          RowBox[{
           RowBox[{"ToString", "@", "i"}], "<>", "\"\<.wxf\>\""}]}], "}"}], 
        "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", 
         RowBox[{"somKernel", "[", 
          RowBox[{"[", 
           RowBox[{"\"\<dimensions\>\"", ",", "\"\<len\>\""}], "]"}], "]"}]}],
         "}"}]}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"cellPathListImage", "=", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"FileNameJoin", "[", 
        RowBox[{"{", 
         RowBox[{"somCellFolder", ",", "\"\<images\>\"", ",", 
          RowBox[{
           RowBox[{"ToString", "@", "i"}], "<>", "\"\<.wxf\>\""}]}], "}"}], 
        "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", 
         RowBox[{"somKernel", "[", 
          RowBox[{"[", 
           RowBox[{"\"\<dimensions\>\"", ",", "\"\<len\>\""}], "]"}], "]"}]}],
         "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"Monitor", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"textVecList", "=", 
          RowBox[{"Import", "[", 
           RowBox[{"cellPathListText", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"imageVecList", "=", 
          RowBox[{"Import", "[", 
           RowBox[{"cellPathListImage", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"combined", "=", 
          RowBox[{"Join", "[", 
           RowBox[{"textVecList", ",", "imageVecList"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"order", "=", 
          RowBox[{"Ordering", "[", 
           RowBox[{"CosineDistanceFast", "[", 
            RowBox[{
             RowBox[{"somKernel", "[", 
              RowBox[{"[", 
               RowBox[{"\"\<weights\>\"", ",", "i"}], "]"}], "]"}], ",", 
             RowBox[{"combined", "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "1"}], "]"}], "]"}]}], "]"}], "]"}]}], ";",
          "\[IndentingNewLine]", 
         RowBox[{"combinedVecList", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"combined", "[", 
             RowBox[{"[", "#", "]"}], "]"}], "&"}], "/@", "order"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"Export", "[", 
          RowBox[{
           RowBox[{"cellPathList", "[", 
            RowBox[{"[", "i", "]"}], "]"}], ",", "combinedVecList"}], "]"}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"Clear", "[", 
          RowBox[{
          "textVecList", ",", "imageVecList", ",", "combined", ",", "order", 
           ",", "combinedVecList"}], "]"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Length", "@", "cellPathList"}]}], "}"}]}], "]"}], ";"}], 
     ",", "i"}], "]"}]}]}]], "Input",
 CellChangeTimes->{{3.9326137740681863`*^9, 3.9326137775850224`*^9}, {
  3.9330691066202*^9, 3.9330691076329155`*^9}, {3.961489083407938*^9, 
  3.9614891177064743`*^9}, {3.961489151916938*^9, 3.961489184047454*^9}, {
  3.9615707663997507`*^9, 3.961570766510169*^9}},
 CellLabel->
  "In[202]:=",ExpressionUUID->"ec59775e-cb76-474a-bb4b-d5c4c524841c"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["12. Train Local SOMs",
 FontSize->24,
 FontColor->RGBColor[0., 0., 0.]]], "Subtitle",
 CellChangeTimes->{{3.8986890518721814`*^9, 3.898689122376096*^9}, {
  3.898763097098298*^9, 3.8987631021979275`*^9}, {3.898763143577179*^9, 
  3.898763144167167*^9}, {3.898768431448584*^9, 3.89876843739193*^9}, {
  3.898777868907117*^9, 3.8987778701335845`*^9}, {3.8987779173921003`*^9, 
  3.8987779211221685`*^9}, {3.8987797554116793`*^9, 3.898779764967306*^9}, {
  3.89878632261063*^9, 3.8987863264599733`*^9}, {3.9325349767262917`*^9, 
  3.932534981212059*^9}, {3.932535012052425*^9, 3.9325350233073072`*^9}, {
  3.9325381218296995`*^9, 3.932538126732298*^9}, {3.9331315304342375`*^9, 
  3.933131534505217*^9}, {3.9334155615177135`*^9, 3.9334155664933443`*^9}, {
  3.9334197587343636`*^9, 3.933419759365839*^9}, {3.961427058556315*^9, 
  3.961427096242107*^9}, {3.961427203248431*^9, 3.961427203392973*^9}, {
  3.9614277646994143`*^9, 3.961427764847485*^9}, {3.961465949188809*^9, 
  3.961465949955724*^9}},ExpressionUUID->"b48c9232-109e-4eb3-9cef-\
598fdf8aa314"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "1.", " ", "Select", " ", "project", " ", "folder", " ", "and", " ", 
     "import", " ", "all", " ", "pre"}], "-", 
    RowBox[{"processed", " ", 
     RowBox[{"files", "."}]}]}], "*)"}], "\n", 
  RowBox[{
   RowBox[{
    RowBox[{"somKernel", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<soms\>\"", ",", "\"\<kernels\>\"", ",", 
         "\"\<global_som_kernel.wxf\>\""}], "}"}], "]"}], "]"}]}], ";"}], 
   "\n", 
   RowBox[{
    RowBox[{"somFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<soms\>\""}], "}"}], "]"}]}], ";"}], 
   "\n", 
   RowBox[{
    RowBox[{"somCellFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"somFolder", ",", "\"\<alloc\>\""}], "}"}], "]"}]}], ";"}], 
   "\n", 
   RowBox[{
    RowBox[{"subSomFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"somFolder", ",", "\"\<soms_sub\>\""}], "}"}], "]"}]}], ";"}], 
   "\n", 
   RowBox[{
    RowBox[{"vecPackageFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"somFolder", ",", "\"\<alloc_sub_vec\>\""}], "}"}], "]"}]}], 
    ";"}]}]}]], "Input",
 CellChangeTimes->{{3.9325338580358334`*^9, 3.9325338768739276`*^9}, {
   3.932534045199814*^9, 3.9325340470769567`*^9}, 3.9327123711989546`*^9, {
   3.933064241556818*^9, 3.9330642450304136`*^9}, {3.9331315958330936`*^9, 
   3.933131621240777*^9}, 3.9331436065916376`*^9, {3.961409904537304*^9, 
   3.961409931113456*^9}, {3.961410005725567*^9, 3.961410033772026*^9}, {
   3.9614128575249777`*^9, 3.961412930805299*^9}, {3.961467099499322*^9, 
   3.961467100174039*^9}, {3.961489828292288*^9, 3.96148982946723*^9}, {
   3.961489867666176*^9, 3.961489884537664*^9}, {3.961489917409875*^9, 
   3.961489917758171*^9}, {3.9615125852370167`*^9, 3.961512585773202*^9}, {
   3.961512664520419*^9, 3.961512666191469*^9}},
 CellLabel->
  "In[206]:=",ExpressionUUID->"00b302bb-3bfb-4e06-b49c-afb75a82a4e6"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "2.", " ", "If", " ", "not", " ", "done", " ", "already", " ", "in", " ", 
     "this", " ", "session"}], ",", " ", 
    RowBox[{
     RowBox[{
     "evaluate", " ", "CLIPedia", " ", "initialization", " ", "functions", 
      " ", "by", " ", "clicking", " ", "yes", " ", "on", " ", "the", " ", 
      "notebook", " ", "pop"}], "-", "up"}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"functions", "=", 
     RowBox[{"NotebookOpen", "[", 
      RowBox[{
       RowBox[{"FileNameJoin", "[", 
        RowBox[{"{", 
         RowBox[{
         "$repoFolder", ",", "\"\<code\>\"", ",", 
          "\"\<clipedia_functions.nb\>\""}], "}"}], "]"}], ",", 
       RowBox[{"Visible", "->", "True"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"SelectionMove", "[", 
     RowBox[{"functions", ",", "Before", ",", "Notebook"}], "]"}], ";", 
    RowBox[{"SelectionMove", "[", 
     RowBox[{"functions", ",", "Next", ",", "Cell"}], "]"}], ";", 
    RowBox[{"SelectionEvaluate", "[", "functions", "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.907645997965927*^9, 3.907646078557015*^9}, {
   3.907646185435628*^9, 3.907646186015532*^9}, {3.907646774687398*^9, 
   3.907646814543491*^9}, {3.907661852666642*^9, 3.907661892204844*^9}, {
   3.907662006350642*^9, 3.9076620119726*^9}, {3.9076663041483603`*^9, 
   3.907666304789756*^9}, {3.907686797040777*^9, 3.907686797747974*^9}, {
   3.919525496418584*^9, 3.919525497699961*^9}, {3.9197060623198233`*^9, 
   3.9197060667885957`*^9}, {3.919706114058092*^9, 3.919706128982294*^9}, {
   3.919781912755134*^9, 3.919781912795006*^9}, {3.919781947934552*^9, 
   3.919781966935747*^9}, {3.919848414262558*^9, 3.9198484146468883`*^9}, 
   3.935473720200501*^9, {3.935473838189433*^9, 3.935473841354582*^9}, {
   3.935638957223358*^9, 3.935638957326006*^9}, {3.9356390560379343`*^9, 
   3.935639058711771*^9}, {3.935658322424658*^9, 3.9356583225402327`*^9}, {
   3.935723004354435*^9, 3.935723004805295*^9}, {3.9359163367825336`*^9, 
   3.93591633723468*^9}, {3.936092399212842*^9, 3.936092399329157*^9}, 
   3.936158161570262*^9, {3.936260859452054*^9, 3.936260860115284*^9}, {
   3.937883982539661*^9, 3.9378839829721127`*^9}, {3.937995756107422*^9, 
   3.937995756221203*^9}, {3.938014732793124*^9, 3.9380147341018*^9}, 
   3.938016470467143*^9, 3.938016528755129*^9, {3.940414521626555*^9, 
   3.94041452456884*^9}, {3.9409089709718437`*^9, 3.940908971329804*^9}, {
   3.941016945740665*^9, 3.941016946103167*^9}, {3.9411006293110933`*^9, 
   3.9411006299214354`*^9}, {3.941234308389617*^9, 3.94123430887071*^9}, {
   3.9416718384564342`*^9, 3.941671838551146*^9}, {3.942299796095441*^9, 
   3.942299797625595*^9}, {3.943377137832711*^9, 3.943377138576899*^9}, {
   3.9563266467496433`*^9, 3.956326653817576*^9}, 3.961253113290951*^9, {
   3.961253529276929*^9, 3.9612535802263517`*^9}, {3.961253673538267*^9, 
   3.961253684603194*^9}, {3.96125372879198*^9, 3.961253766586738*^9}, 
   3.961314552173787*^9, {3.961321579753784*^9, 3.9613215894888973`*^9}, {
   3.961489392814011*^9, 3.961489392888639*^9}, 3.9615707454610157`*^9, {
   3.9615708916307364`*^9, 3.961570891922319*^9}, 
   3.961572371308964*^9},ExpressionUUID->"adc4fda1-e852-4a65-8f46-\
fcfb5aa37e05"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "3.", " ", "Set", " ", "the", " ", "locations", " ", "for", " ", "the", 
     " ", "lists", " ", "containing", " ", "combined", " ", "cell", " ", 
     "allocations"}], " ", "\[Dash]", " ", 
    RowBox[{
    "now", " ", "used", " ", "to", " ", "train", " ", "a", " ", "SOM", " ", 
     "on", " ", "each", " ", 
     RowBox[{"cell", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"cellPathList", "=", 
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{"somCellFolder", ",", "\"\<combined\>\"", ",", 
         RowBox[{
          RowBox[{"ToString", "@", "i"}], "<>", "\"\<.wxf\>\""}]}], "}"}], 
       "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", 
        RowBox[{"somKernel", "[", 
         RowBox[{"[", 
          RowBox[{"\"\<dimensions\>\"", ",", "\"\<len\>\""}], "]"}], "]"}]}], 
       "}"}]}], "]"}]}], ";"}]}]], "Input",
 CellChangeTimes->{
  3.9332459482661*^9, {3.961489961065236*^9, 3.9614900208610983`*^9}, {
   3.961571033705505*^9, 3.9615710337768297`*^9}},
 CellLabel->
  "In[319]:=",ExpressionUUID->"7822cb52-00b8-4493-9e69-182815f65edd"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "4.", " ", "Train", " ", "a", " ", "1", "D", " ", "SOM", " ", "for", " ", 
     "each", " ", "cell"}], ",", " ", 
    RowBox[{
    "allocate", " ", "encoded", " ", "elements", " ", "to", " ", "each", " ", 
     "cell"}], ",", " ", 
    RowBox[{"record", " ", "lengths", " ", "for", " ", "each", " ", "mode"}], 
    ",", " ", 
    RowBox[{"and", " ", 
     RowBox[{"export", ".", " ", "Every"}], " ", "successful", " ", "cell", 
     " ", "is", " ", "printed"}], ",", " ", 
    RowBox[{
    "which", " ", "makes", " ", "it", " ", "easier", " ", "to", " ", "know", 
     " ", "in", " ", "a", " ", "case", " ", "of", " ", "a", " ", "crash", " ",
      "which", " ", "cell", " ", "might", " ", "be", " ", "problematic"}], 
    ",", " ", 
    RowBox[{
    "or", " ", "from", " ", "where", " ", "to", " ", "start", " ", "training",
      " ", 
     RowBox[{"again", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"Monitor", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Table", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"dataList", "=", 
         RowBox[{"Import", "[", 
          RowBox[{"cellPathList", "[", 
           RowBox[{"[", "i", "]"}], "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"vecList", "=", 
         RowBox[{"dataList", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"x", "=", 
         RowBox[{"Round", "[", 
          RowBox[{"N", "[", 
           RowBox[{"Max", "[", 
            RowBox[{
             RowBox[{"Floor", "[", 
              RowBox[{
               RowBox[{"Length", "@", "vecList"}], "/", "1000"}], "]"}], ",", 
             "2"}], "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"sampleLength", "=", 
         RowBox[{"Min", "[", 
          RowBox[{
           RowBox[{"x", "*", "100"}], ",", 
           RowBox[{"Length", "@", "vecList"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"dim", "=", "512"}], ";", "\[IndentingNewLine]", 
        RowBox[{"Print", "[", "i", "]"}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"Train", " ", "Subsom"}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "@", "vecList"}], "<=", "1"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"somKernel", "=", 
            RowBox[{"SomKernel1D", "[", 
             RowBox[{"vecList", ",", "dim"}], "]"}]}], ";"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"somKernel", "=", 
            RowBox[{"CreateSomGridRandomSample", "[", 
             RowBox[{"vecList", ",", "1", ",", "x", ",", "dim", ",", "True"}],
              "]"}]}], ";", 
           RowBox[{"trainedSomKernels", "=", 
            RowBox[{"BatchSOM", "[", 
             RowBox[{"somKernel", ",", "vecList", ",", 
              RowBox[{"Length", "@", "vecList"}], ",", "0.02", ",", "15", 
              ",", "\"\<Stats\>\"", ",", "\"\<Invisible\>\"", ",", 
              "\"\<Exponential\>\"", ",", "\"\<EuclideanDistance\>\"", ",", 
              "\"\<GrayTones\>\"", ",", "\"\<\>\""}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"error", "=", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"trainedSomKernels", "[", 
                 RowBox[{"[", 
                  RowBox[{
                  "i", ",", "\"\<training history\>\"", ",", "\"\<info\>\"", 
                   ",", "\"\<infoQEN\>\""}], "]"}], "]"}], "+", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"trainedSomKernels", "[", 
                   RowBox[{"[", 
                    RowBox[{
                    "i", ",", "\"\<training history\>\"", ",", "\"\<info\>\"",
                     ",", "\"\<infoTE\>\""}], "]"}], "]"}], "/", "10"}], ")"}]
                 }], ")"}], ",", 
              RowBox[{"{", 
               RowBox[{"i", ",", 
                RowBox[{"Length", "@", "trainedSomKernels"}]}], "}"}]}], 
             "]"}]}], ";", 
           RowBox[{"errorMinPos", "=", 
            RowBox[{"First", "@", 
             RowBox[{"Flatten", "[", 
              RowBox[{"Position", "[", 
               RowBox[{"error", ",", 
                RowBox[{"Min", "[", "error", "]"}]}], "]"}], "]"}]}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"somKernel", "[", 
             RowBox[{"[", "\"\<weights\>\"", "]"}], "]"}], "=", 
            RowBox[{"Normalize", "/@", 
             RowBox[{"trainedSomKernels", "[", 
              RowBox[{"[", 
               RowBox[{"errorMinPos", ",", "\"\<weights\>\""}], "]"}], 
              "]"}]}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"som", "=", 
         RowBox[{"GetSOMList", "[", 
          RowBox[{"dataList", ",", "somKernel"}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"vecAssocs", "=", 
         RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"test", "=", 
            RowBox[{"StringContainsQ", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"som", "[", "\"\<eventListSorted\>\"", "]"}], "[", 
               RowBox[{"[", 
                RowBox[{"j", ",", "All", ",", "2"}], "]"}], "]"}], ",", 
              "\"\<_\>\""}], "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"textPos", "=", 
            RowBox[{"Position", "[", 
             RowBox[{"test", ",", "True"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"imgPos", "=", 
            RowBox[{"Position", "[", 
             RowBox[{"test", ",", "False"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"vecAssoc", "=", 
            RowBox[{"Association", "[", 
             RowBox[{
              RowBox[{"\"\<text\>\"", "->", 
               RowBox[{"Extract", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"som", "[", "\"\<eventListSorted\>\"", "]"}], "[", 
                  RowBox[{"[", "j", "]"}], "]"}], ",", "textPos"}], "]"}]}], 
              ",", 
              RowBox[{"\"\<img\>\"", "->", 
               RowBox[{"Extract", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"som", "[", "\"\<eventListSorted\>\"", "]"}], "[", 
                  RowBox[{"[", "j", "]"}], "]"}], ",", "imgPos"}], "]"}]}]}], 
             "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"vecAssocs", "=", 
            RowBox[{"Join", "[", 
             RowBox[{"vecAssocs", ",", 
              RowBox[{"{", "vecAssoc", "}"}]}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"Clear", "[", 
            RowBox[{"{", 
             RowBox[{"test", ",", "textPos", ",", "imgPos", ",", "vecAssoc"}],
              "}"}], "]"}], ";"}], ",", 
          RowBox[{"{", 
           RowBox[{"j", ",", 
            RowBox[{"Length", "@", 
             RowBox[{"som", "[", "\"\<eventListSorted\>\"", "]"}]}]}], 
           "}"}]}], "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"Export", " ", "SubAllocs"}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Length", "@", 
               RowBox[{"vecAssocs", "[", 
                RowBox[{"[", 
                 RowBox[{"j", ",", "\"\<img\>\"", ",", "All", ",", "1"}], 
                 "]"}], "]"}]}], ">", "0"}], ",", 
             RowBox[{"Export", "[", 
              RowBox[{
               RowBox[{"FileNameJoin", "[", 
                RowBox[{"{", 
                 RowBox[{
                 "vecPackageFolder", ",", "\"\<hdf5\>\"", ",", "\"\<img\>\"", 
                  ",", 
                  RowBox[{"ToString", "@", "i"}], ",", 
                  RowBox[{
                   RowBox[{"ToString", "@", "j"}], "<>", "\"\<.h5\>\""}]}], 
                 "}"}], "]"}], ",", "\[IndentingNewLine]", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"\"\<vecs\>\"", "->", 
                  RowBox[{"vecAssocs", "[", 
                   RowBox[{"[", 
                    RowBox[{"j", ",", "\"\<img\>\"", ",", "All", ",", "1"}], 
                    "]"}], "]"}]}], ",", "\[IndentingNewLine]", 
                 RowBox[{"\"\<ids\>\"", "->", 
                  RowBox[{"vecAssocs", "[", 
                   RowBox[{"[", 
                    RowBox[{"j", ",", "\"\<img\>\"", ",", "All", ",", "2"}], 
                    "]"}], "]"}]}]}], "}"}], ",", "\"\<Datasets\>\""}], 
              "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Length", "@", 
               RowBox[{"vecAssocs", "[", 
                RowBox[{"[", 
                 RowBox[{"j", ",", "\"\<text\>\"", ",", "All", ",", "1"}], 
                 "]"}], "]"}]}], ">", "0"}], ",", 
             RowBox[{"Export", "[", 
              RowBox[{
               RowBox[{"FileNameJoin", "[", 
                RowBox[{"{", 
                 RowBox[{
                 "vecPackageFolder", ",", "\"\<hdf5\>\"", ",", "\"\<txt\>\"", 
                  ",", 
                  RowBox[{"ToString", "@", "i"}], ",", 
                  RowBox[{
                   RowBox[{"ToString", "@", "j"}], "<>", "\"\<.h5\>\""}]}], 
                 "}"}], "]"}], ",", "\[IndentingNewLine]", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"\"\<vecs\>\"", "->", 
                  RowBox[{"vecAssocs", "[", 
                   RowBox[{"[", 
                    RowBox[{"j", ",", "\"\<text\>\"", ",", "All", ",", "1"}], 
                    "]"}], "]"}]}], ",", "\[IndentingNewLine]", 
                 RowBox[{"\"\<ids\>\"", "->", 
                  RowBox[{"vecAssocs", "[", 
                   RowBox[{"[", 
                    RowBox[{"j", ",", "\"\<text\>\"", ",", "All", ",", "2"}], 
                    "]"}], "]"}]}]}], "}"}], ",", "\"\<Datasets\>\""}], 
              "]"}]}], "]"}], ";"}], ",", "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"j", ",", 
            RowBox[{"Length", "@", "vecAssocs"}]}], "}"}]}], "]"}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"Export", " ", "Subsom"}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{"Export", "[", 
         RowBox[{
          RowBox[{"FileNameJoin", "[", 
           RowBox[{"{", 
            RowBox[{"subSomFolder", ",", 
             RowBox[{
              RowBox[{"ToString", "@", "i"}], "<>", "\"\<.wxf\>\""}]}], "}"}],
            "]"}], ",", 
          RowBox[{"Append", "[", 
           RowBox[{
            RowBox[{"KeyDrop", "[", 
             RowBox[{"som", ",", 
              RowBox[{"{", 
               RowBox[{"\"\<eventListSorted\>\"", ",", "\"\<bmus\>\""}], 
               "}"}]}], "]"}], ",", 
            RowBox[{"\"\<lengths\>\"", "->", "\[IndentingNewLine]", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{
                RowBox[{"Association", "[", "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"\"\<txt\>\"", "->", 
                   RowBox[{"Length", "@", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "\"\<text\>\"", "]"}], "]"}]}]}], ",", 
                  "\[IndentingNewLine]", 
                  RowBox[{"\"\<img\>\"", "->", 
                   RowBox[{"Length", "@", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "\"\<img\>\"", "]"}], "]"}]}]}], ",", 
                  RowBox[{"\"\<all\>\"", "->", 
                   RowBox[{"Total", "[", 
                    RowBox[{
                    RowBox[{"Length", "@", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "\"\<text\>\"", "]"}], "]"}]}], ",", 
                    RowBox[{"Length", "@", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "\"\<img\>\"", "]"}], "]"}]}]}], "]"}]}]}], 
                 "]"}], "&"}], "/@", "vecAssocs"}], ")"}]}]}], "]"}]}], "]"}],
         ";", "\[IndentingNewLine]", 
        RowBox[{"Clear", "[", 
         RowBox[{"{", 
          RowBox[{
          "dataList", ",", "vecList", ",", "x", ",", "sampleLength", ",", 
           "dim", ",", "vecAssocs", ",", "som", ",", "somKernel", ",", 
           "trainedSomKernels", ",", "error", ",", "errorMinPos", ",", 
           "vecAssocs"}], "}"}], "]"}], ";"}], ",", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"i", ",", 
         RowBox[{"Length", "@", "cellPathList"}]}], "}"}]}], "]"}], ";"}], 
    ",", 
    RowBox[{"{", 
     RowBox[{"i", ",", "j"}], "}"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.933126514306612*^9, 3.933126547060676*^9}, {
   3.933127354786316*^9, 3.9331273549594603`*^9}, {3.933127685393822*^9, 
   3.933127686113312*^9}, {3.9331277923805847`*^9, 3.9331278306781225`*^9}, 
   3.933127879746519*^9, {3.933128145331904*^9, 3.9331281550448685`*^9}, {
   3.9331288403441963`*^9, 3.933128842887965*^9}, {3.933128913841219*^9, 
   3.9331289141144876`*^9}, {3.9331310243674035`*^9, 3.933131024438462*^9}, {
   3.9331312393384185`*^9, 3.9331312400478325`*^9}, {3.9331321882073183`*^9, 
   3.9331321987647696`*^9}, 3.933136820058282*^9, {3.933142465579542*^9, 
   3.933142466217494*^9}, {3.9331426128821793`*^9, 3.9331426449488134`*^9}, 
   3.9331427590015182`*^9, {3.933143392341693*^9, 3.9331435414928164`*^9}, {
   3.9331436982016597`*^9, 3.9331437584787054`*^9}, {3.933143813413273*^9, 
   3.9331438458161445`*^9}, {3.933144919145301*^9, 3.9331449234506273`*^9}, {
   3.9331547400531187`*^9, 3.933154781240958*^9}, {3.933154828283652*^9, 
   3.9331548357524424`*^9}, {3.9331549970011363`*^9, 
   3.9331550337013254`*^9}, {3.9331553896451015`*^9, 3.933155403242901*^9}, {
   3.933155472301799*^9, 3.9331554726415367`*^9}, {3.933155512055105*^9, 
   3.933155516450771*^9}, {3.9331555939541464`*^9, 3.9331555980270786`*^9}, {
   3.9331556382375107`*^9, 3.9331556559650784`*^9}, {3.9331557314649596`*^9, 
   3.9331557347326155`*^9}, {3.9332458993962903`*^9, 
   3.9332459008405967`*^9}, {3.9333347560425797`*^9, 3.933334761309114*^9}, {
   3.961410143058817*^9, 3.961410145334873*^9}, {3.961413207638912*^9, 
   3.961413230585382*^9}, {3.961413285527412*^9, 3.961413322591302*^9}, {
   3.961413353947157*^9, 3.961413430196759*^9}, {3.961413461327351*^9, 
   3.9614135129961348`*^9}, {3.961414965307469*^9, 3.961414966982995*^9}, {
   3.961415003562476*^9, 3.961415061145825*^9}, {3.961465978901902*^9, 
   3.961465981572523*^9}, {3.961468159875207*^9, 3.961468164314286*^9}, {
   3.9614900920727386`*^9, 3.9614900945549383`*^9}, {3.961490272749649*^9, 
   3.961490312755329*^9}, {3.961490423366103*^9, 3.961490430087593*^9}, {
   3.9615123239620247`*^9, 3.9615123770846767`*^9}, {3.96157103519252*^9, 
   3.961571035289097*^9}},
 CellLabel->
  "In[320]:=",ExpressionUUID->"8b0f05fb-4a38-44ab-817a-ede47bf811a5"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "5.", " ", "Combine", " ", "the", " ", "global", " ", "with", " ", "the", 
     " ", "local", " ", "SOM"}], " ", "\[Dash]", " ", 
    RowBox[{"the", " ", "CLIPedia", " ", "model"}], " ", "\[Dash]", 
    "\[NonBreakingSpace]", 
    RowBox[{"and", " ", 
     RowBox[{"export", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"Monitor", "[", 
     RowBox[{
      RowBox[{"allSubSoms", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Import", "[", 
          RowBox[{"FileNameJoin", "[", 
           RowBox[{"{", 
            RowBox[{"subSomFolder", ",", 
             RowBox[{
              RowBox[{"ToString", "@", "i"}], "<>", "\"\<.wxf\>\""}]}], "}"}],
            "]"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"Length", "@", "cellPathList"}]}], "}"}]}], "]"}]}], ",", 
      "i"}], "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"somKernel", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<soms\>\"", ",", "\"\<kernels\>\"", ",", 
         "\"\<global_som_kernel.wxf\>\""}], "}"}], "]"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"fullSom", "=", 
     RowBox[{"Association", "[", 
      RowBox[{
       RowBox[{"\"\<kernel\>\"", "\[Rule]", "somKernel"}], ",", 
       RowBox[{"\"\<lengths\>\"", "->", 
        RowBox[{"Total", "/@", 
         RowBox[{"allSubSoms", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "\"\<lengths\>\""}], "]"}], "]"}]}]}], " ", 
       ",", 
       RowBox[{"\"\<soms\>\"", "->", "allSubSoms"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{"somFolder", ",", "\"\<som.wxf\>\""}], "}"}], "]"}], ",", 
      "fullSom"}], "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.933411713353103*^9, 3.933411724602116*^9}, {
   3.9334117549133277`*^9, 3.9334117910078344`*^9}, {3.9334125008587685`*^9, 
   3.9334125110231915`*^9}, {3.9334126853019805`*^9, 
   3.9334127679008336`*^9}, {3.933414314385912*^9, 3.9334143801169586`*^9}, {
   3.9614104141084948`*^9, 3.9614104142264767`*^9}, {3.961490339193715*^9, 
   3.961490339360675*^9}, {3.9614903859077587`*^9, 3.961490415281548*^9}, {
   3.961490499609805*^9, 3.9614905084994373`*^9}, 3.961512411522159*^9, {
   3.961571039143978*^9, 3.961571040275386*^9}},
 CellLabel->
  "In[321]:=",ExpressionUUID->"4bdef416-83b0-42e6-a2cd-7f091505708b"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["13. Render CLIPedia",
 FontSize->24,
 FontColor->RGBColor[0., 0., 0.]]], "Subtitle",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004653855638*^9}, {
   3.9255429588956685`*^9, 3.9255429656805353`*^9}, {3.933419738072833*^9, 
   3.933419738467922*^9}, {3.961339364151065*^9, 3.961339392280257*^9}, {
   3.961390164835906*^9, 3.961390173814896*^9}, 3.961393054862067*^9, {
   3.961426955932397*^9, 3.9614270283665447`*^9}, 3.961427104011215*^9, {
   3.961427204583488*^9, 3.961427235669896*^9}, {3.961427411911541*^9, 
   3.961427419047023*^9}, 
   3.961465356099455*^9},ExpressionUUID->"47cb4725-ddfd-4ca5-8d8a-\
284118a0d542"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "1.", " ", "Import", " ", "the", " ", "trained", " ", "CLIPedia", " ", 
    "model"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"clipedia", "=", 
    RowBox[{"Import", "[", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<soms\>\"", ",", "\"\<som.wxf\>\""}], 
       "}"}], "]"}], "]"}]}], ";"}]}]], "Input",
 CellChangeTimes->{{3.961428020648921*^9, 3.961428040245574*^9}, {
  3.961428194705223*^9, 3.961428198617931*^9}, {3.9614904654286957`*^9, 
  3.961490487539109*^9}, {3.9614905182389183`*^9, 3.961490524765517*^9}},
 CellLabel->"In[56]:=",ExpressionUUID->"007bfe7b-311e-4b48-867e-3dd1afb7b0e5"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "2.", " ", "If", " ", "not", " ", "done", " ", "already", " ", "in", " ", 
     "this", " ", "session"}], ",", " ", 
    RowBox[{
     RowBox[{
     "evaluate", " ", "CLIPedia", " ", "initialization", " ", "functions", 
      " ", "by", " ", "clicking", " ", "yes", " ", "on", " ", "the", " ", 
      "notebook", " ", "pop"}], "-", "up"}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"functions", "=", 
     RowBox[{"NotebookOpen", "[", 
      RowBox[{
       RowBox[{"FileNameJoin", "[", 
        RowBox[{"{", 
         RowBox[{
         "$repoFolder", ",", "\"\<code\>\"", ",", 
          "\"\<clipedia_functions.nb\>\""}], "}"}], "]"}], ",", 
       RowBox[{"Visible", "->", "True"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"SelectionMove", "[", 
     RowBox[{"functions", ",", "Before", ",", "Notebook"}], "]"}], ";", 
    RowBox[{"SelectionMove", "[", 
     RowBox[{"functions", ",", "Next", ",", "Cell"}], "]"}], ";", 
    RowBox[{"SelectionEvaluate", "[", "functions", "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.907645997965927*^9, 3.907646078557015*^9}, {
   3.907646185435628*^9, 3.907646186015532*^9}, {3.907646774687398*^9, 
   3.907646814543491*^9}, {3.907661852666642*^9, 3.907661892204844*^9}, {
   3.907662006350642*^9, 3.9076620119726*^9}, {3.9076663041483603`*^9, 
   3.907666304789756*^9}, {3.907686797040777*^9, 3.907686797747974*^9}, {
   3.919525496418584*^9, 3.919525497699961*^9}, {3.9197060623198233`*^9, 
   3.9197060667885957`*^9}, {3.919706114058092*^9, 3.919706128982294*^9}, {
   3.919781912755134*^9, 3.919781912795006*^9}, {3.919781947934552*^9, 
   3.919781966935747*^9}, {3.919848414262558*^9, 3.9198484146468883`*^9}, 
   3.935473720200501*^9, {3.935473838189433*^9, 3.935473841354582*^9}, {
   3.935638957223358*^9, 3.935638957326006*^9}, {3.9356390560379343`*^9, 
   3.935639058711771*^9}, {3.935658322424658*^9, 3.9356583225402327`*^9}, {
   3.935723004354435*^9, 3.935723004805295*^9}, {3.9359163367825336`*^9, 
   3.93591633723468*^9}, {3.936092399212842*^9, 3.936092399329157*^9}, 
   3.936158161570262*^9, {3.936260859452054*^9, 3.936260860115284*^9}, {
   3.937883982539661*^9, 3.9378839829721127`*^9}, {3.937995756107422*^9, 
   3.937995756221203*^9}, {3.938014732793124*^9, 3.9380147341018*^9}, 
   3.938016470467143*^9, 3.938016528755129*^9, {3.940414521626555*^9, 
   3.94041452456884*^9}, {3.9409089709718437`*^9, 3.940908971329804*^9}, {
   3.941016945740665*^9, 3.941016946103167*^9}, {3.9411006293110933`*^9, 
   3.9411006299214354`*^9}, {3.941234308389617*^9, 3.94123430887071*^9}, {
   3.9416718384564342`*^9, 3.941671838551146*^9}, {3.942299796095441*^9, 
   3.942299797625595*^9}, {3.943377137832711*^9, 3.943377138576899*^9}, {
   3.9563266467496433`*^9, 3.956326653817576*^9}, 3.961253113290951*^9, {
   3.961253529276929*^9, 3.9612535802263517`*^9}, {3.961253673538267*^9, 
   3.961253684603194*^9}, {3.96125372879198*^9, 3.961253766586738*^9}, 
   3.961314552173787*^9, {3.961321579753784*^9, 3.9613215894888973`*^9}, {
   3.961489392814011*^9, 3.961489392888639*^9}, 3.9615707454610157`*^9, {
   3.9615708916307364`*^9, 3.961570891922319*^9}, 3.961572371308964*^9},
 CellLabel->"In[57]:=",ExpressionUUID->"8126c39b-35f3-4d11-8ef0-7770464b09b2"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "3.", " ", "Get", " ", "a", " ", "view", " ", "of", " ", "CLIPedia", " ", 
    "as", " ", "an", " ", "unrolled", " ", "map"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"img", "=", 
     RowBox[{
      RowBox[{"RenderSomBackground", "[", 
       RowBox[{
       "clipedia", ",", "1000", ",", "\"\<PrincipalComponentsAnalysis\>\""}], 
       "]"}], "[", 
      RowBox[{"[", "1", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"Show", "[", 
    RowBox[{"img", ",", 
     RowBox[{"ImageSize", "->", "Medium"}]}], "]"}]}]}]], "Input",
 CellChangeTimes->{{3.961490515569433*^9, 3.961490529488412*^9}, {
  3.96157306344742*^9, 3.9615730641195307`*^9}},
 CellLabel->
  "In[165]:=",ExpressionUUID->"844f4ff5-7dd1-42f8-9e7a-43530d5fd954"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "4.", " ", "Get", " ", "a", " ", "view", " ", "of", " ", "CLIPedia", " ", 
    "as", " ", "a", " ", 
    RowBox[{"torus", ".", " ", "mapOffest"}], " ", "parameter", " ", 
    "determines", " ", "how", " ", "the", " ", "map", " ", "is", " ", 
    "wrapped", " ", "around", " ", "the", " ", 
    RowBox[{"donut", "."}]}], "*)"}], "\n", 
  RowBox[{
   RowBox[{
    RowBox[{"mapOffset", "=", "100"}], ";", 
    RowBox[{"imgNew", "=", 
     RowBox[{"ImageAssemble", "[", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"ImageTake", "[", 
          RowBox[{"img", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{"Max", "[", 
               RowBox[{"ImageDimensions", "@", "img"}], "]"}], "-", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"Max", "[", 
                 RowBox[{"ImageDimensions", "@", "img"}], "]"}], "-", 
                "mapOffset"}], ")"}], "+", "1"}], ",", 
             RowBox[{"Max", "[", 
              RowBox[{"ImageDimensions", "@", "img"}], "]"}]}], "}"}]}], 
          "]"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"ImageTake", "[", 
          RowBox[{"img", ",", "mapOffset"}], "]"}], "}"}]}], "}"}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{"clipediaTorus", "=", 
    RowBox[{"ParametricPlot3D", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"2", "+", 
           RowBox[{"Cos", "[", "v", "]"}]}], ")"}], " ", 
         RowBox[{"Cos", "[", "u", "]"}]}], ",", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"2", "+", 
           RowBox[{"Cos", "[", "v", "]"}]}], ")"}], " ", 
         RowBox[{"Sin", "[", "u", "]"}]}], ",", 
        RowBox[{"Sin", "[", "v", "]"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"u", ",", "0", ",", 
        RowBox[{"2", " ", "Pi"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"v", ",", "0", ",", 
        RowBox[{"2", " ", "Pi"}]}], "}"}], ",", 
      RowBox[{"PlotStyle", "->", 
       RowBox[{"Texture", "[", "imgNew", "]"}]}], ",", 
      RowBox[{"Mesh", "->", "None"}], ",", 
      RowBox[{"Lighting", "->", 
       RowBox[{"{", 
        RowBox[{"\"\<Ambient\>\"", ",", "White"}], "}"}]}], ",", 
      RowBox[{"PlotPoints", "->", "100"}], ",", 
      RowBox[{"Axes", "->", "None"}], ",", " ", 
      RowBox[{"Boxed", "->", "False"}]}], "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.9614905362828712`*^9, 3.961490561878448*^9}, {
  3.961512447787614*^9, 3.9615124520185633`*^9}, {3.961573071954982*^9, 
  3.9615730720286217`*^9}},
 CellLabel->
  "In[167]:=",ExpressionUUID->"50cbc3a9-b86e-4072-b9f8-5e0092e6721b"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["14. Complete Folder Structure",
 FontSize->24,
 FontColor->RGBColor[0., 0., 0.]]], "Subtitle",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004653855638*^9}, {
   3.9255429588956685`*^9, 3.9255429656805353`*^9}, {3.933419738072833*^9, 
   3.933419738467922*^9}, {3.961339364151065*^9, 3.961339392280257*^9}, {
   3.961390164835906*^9, 3.961390173814896*^9}, 3.961393054862067*^9, {
   3.961426955932397*^9, 3.9614270283665447`*^9}, 3.961427104011215*^9, {
   3.961427204583488*^9, 3.961427235669896*^9}, {3.961427411911541*^9, 
   3.961427419047023*^9}, {3.961427888942782*^9, 3.9614278910145273`*^9}, {
   3.961428651383741*^9, 3.96142867152108*^9}, 
   3.961465360013031*^9},ExpressionUUID->"35764354-0ed4-4e3c-b435-\
57dfcc2d1b85"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "1.", " ", "Select", " ", "project", " ", "folder", " ", "and", " ", 
     "import", " ", "pre"}], "-", 
    RowBox[{"processed", " ", 
     RowBox[{"files", "."}]}]}], "*)"}], "\n", 
  RowBox[{
   RowBox[{
    RowBox[{"offsets", "=", 
     RowBox[{"Import", "@", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<build\>\"", ",", "\"\<offsets.wxf\>\""}], 
        "}"}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"pageIds", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<indices\>\"", ",", 
         "\"\<pageIds.json\>\""}], "}"}], "]"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"pageFolder", "=", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<data\>\"", ",", "\"\<pages\>\""}], 
       "}"}], "]"}]}], ";"}]}]}]], "Input",
 CellChangeTimes->{
  3.961490595676853*^9, {3.961490937687963*^9, 3.961490948608348*^9}, 
   3.961491008400195*^9, {3.961511816945696*^9, 3.9615118172388906`*^9}},
 CellLabel->"In[56]:=",ExpressionUUID->"b1a2fa47-b490-4eea-be46-153235da2a21"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "2.", " ", "Define", " ", "a", " ", "single", " ", "log", " ", "file", " ",
     "to", " ", "record", " ", 
    RowBox[{"process", ".", " ", "This"}], " ", "will", " ", "be", " ", 
    "overwritten", " ", "for", " ", "each", " ", "new", " ", "encoding", " ", 
    RowBox[{"session", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"logFilePath", "=", 
    RowBox[{"FileNameJoin", "[", 
     RowBox[{"{", 
      RowBox[{"$buildFolder", ",", "\"\<build\>\"", ",", "\"\<logs\>\"", ",", 
       RowBox[{"\"\<pagelog\>\"", "<>", "\"\<.txt\>\""}]}], "}"}], "]"}]}], 
   ";"}]}]], "Input",
 CellChangeTimes->{{3.925545195607813*^9, 3.9255452032863975`*^9}, {
   3.9256290441589828`*^9, 3.9256290686145725`*^9}, 3.925646844922707*^9, {
   3.9613890927890673`*^9, 3.961389096458434*^9}, {3.9613893494581623`*^9, 
   3.961389392335256*^9}, {3.961396954904188*^9, 3.9613969615630207`*^9}, {
   3.9613970288323727`*^9, 3.961397028963064*^9}, {3.961415981881052*^9, 
   3.9614159870764017`*^9}, {3.961416026619151*^9, 3.961416026956019*^9}, 
   3.9614259747354517`*^9, {3.961490822180909*^9, 3.96149082229181*^9}, {
   3.961490968278893*^9, 3.961490971212943*^9}},
 CellLabel->"In[59]:=",ExpressionUUID->"2dd9e662-dfe1-4273-afd0-fe4ee02a85c8"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"X", ".", " ", "If"}], " ", "you", " ", "started", " ", 
     "copying", " ", "across", " ", "and", " ", "something", " ", "crashed"}],
     ",", " ", 
    RowBox[{
    "see", " ", "at", " ", "which", " ", "batch", " ", "you", " ", "left", 
     " ", "off", " ", "by", " ", "reading", " ", "the", " ", "log", " ", 
     "file"}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"log", "=", 
     RowBox[{"Import", "[", 
      RowBox[{"logFilePath", ",", "\"\<List\>\""}], "]"}]}], ";"}], "\n", 
   RowBox[{"last", "=", 
    RowBox[{"Last", "@", "log"}]}]}]}]], "Input",
 CellChangeTimes->{{3.925545195607813*^9, 3.9255452032863975`*^9}, {
   3.9256290441589828`*^9, 3.9256290686145725`*^9}, 3.925646844922707*^9, {
   3.9313455928764706`*^9, 3.9313455943917017`*^9}, {3.934258906596924*^9, 
   3.9342589184861164`*^9}, {3.961415983530541*^9, 3.961416019011993*^9}, {
   3.9614908304929247`*^9, 3.961490855738243*^9}},
 CellLabel->
  "In[333]:=",ExpressionUUID->"f79fc529-faed-4e61-b536-974dce8bf684"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "3.", " ", "Input", " ", "start", " ", "and", " ", "end", " ", "positions",
     " ", "of", " ", "the", " ", "offset", " ", "list", " ", "to", " ", 
    "start", " ", 
    RowBox[{"parsing", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"start", "=", "1"}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Start", " ", "position", " ", "for", " ", 
      RowBox[{"parsing", ".", " ", 
       RowBox[{"Add", " ", "'"}]}], "last"}], "+", 
     RowBox[{
      RowBox[{"1", "'"}], " ", "here", " ", "if", " ", "you", " ", "are", " ",
       "picking", " ", "up", " ", "after", " ", "an", " ", 
      RowBox[{"interruption", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"end", "=", "10"}], ";"}], "  ", 
   RowBox[{"(*", 
    RowBox[{"End", " ", "position", " ", "for", " ", 
     RowBox[{"parsing", ".", " ", "Change"}], " ", 
     RowBox[{"to", " ", "'"}], 
     RowBox[{
      RowBox[{"Length", "@", "offset"}], "'"}], " ", "to", " ", "process", 
     " ", "the", " ", "full", " ", 
     RowBox[{"dump", "."}]}], "*)"}]}]}]], "Input",
 CellChangeTimes->{{3.961426022319757*^9, 3.961426022601368*^9}, 
   3.961512480026102*^9},
 CellLabel->"In[60]:=",ExpressionUUID->"abc60644-fe87-48a5-b307-ef5f289804a5"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "4.", " ", "Export", " ", "page", " ", "batches", " ", "as", " ", "single",
     " ", "pages", " ", "into", " ", "your", " ", "repository"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"Quiet", "[", 
     RowBox[{"Close", "[", "logFilePath", "]"}], "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Quiet", "@", 
     RowBox[{"DeleteFile", "[", "logFilePath", "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"OpenWrite", "[", "logFilePath", "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"Monitor", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"offset", "=", 
          RowBox[{"offsets", "[", 
           RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"assoc", "=", 
          RowBox[{"Import", "[", 
           RowBox[{
            RowBox[{"FileNameJoin", "[", 
             RowBox[{"{", 
              RowBox[{
              "$buildFolder", ",", "\"\<build\>\"", ",", "\"\<batches\>\"", 
               ",", 
               RowBox[{"StringTake", "[", 
                RowBox[{
                 RowBox[{"ToString", "@", "offset"}], ",", 
                 RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
               RowBox[{
                RowBox[{"ToString", "@", "offset"}], "<>", 
                "\"\<.json\>\""}]}], "}"}], "]"}], ",", "\"\<RawJSON\>\""}], 
           "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"ids", "=", 
          RowBox[{"Keys", "@", "assoc"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"Table", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"Export", "[", 
             RowBox[{
              RowBox[{"FileNameJoin", "[", 
               RowBox[{"{", 
                RowBox[{"pageFolder", ",", 
                 RowBox[{"StringTake", "[", 
                  RowBox[{
                   RowBox[{"assoc", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"ids", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "\"\<id\>\""}], 
                    "]"}], "]"}], ",", 
                   RowBox[{"UpTo", "[", "4", "]"}]}], "]"}], ",", 
                 RowBox[{
                  RowBox[{"assoc", "[", 
                   RowBox[{"[", 
                    RowBox[{
                    RowBox[{"ids", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "\"\<id\>\""}], 
                    "]"}], "]"}], "<>", "\"\<.json\>\""}]}], "}"}], "]"}], 
              ",", 
              RowBox[{"KeyDrop", "[", 
               RowBox[{
                RowBox[{"assoc", "[", 
                 RowBox[{"[", 
                  RowBox[{"ids", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                "\"\<wikiCode\>\""}], "]"}]}], "]"}], ";"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"{", 
            RowBox[{"j", ",", 
             RowBox[{"Length", "@", "ids"}]}], "}"}]}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"WriteString", "[", 
          RowBox[{"logFilePath", ",", 
           RowBox[{
            RowBox[{"ToString", "@", "i"}], "<>", "\"\<\\n\>\""}]}], "]"}], 
         ";"}], ",", "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"i", ",", "start", ",", "end"}], "}"}]}], "]"}], ";"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "j", ",", "k"}], "}"}]}], "]"}]}]}]], "Input",
 CellChangeTimes->{{3.934255697291608*^9, 3.934255707609355*^9}, {
  3.9342587622850285`*^9, 3.934258836943488*^9}, {3.9342589504309416`*^9, 
  3.934258980090562*^9}, {3.934259073809778*^9, 3.934259106688233*^9}, {
  3.934259188038446*^9, 3.934259197909831*^9}, {3.934259297897297*^9, 
  3.9342593657835417`*^9}, {3.9343405091931343`*^9, 3.934340581869293*^9}, {
  3.934340628729838*^9, 3.9343406326803927`*^9}, {3.9346413220733805`*^9, 
  3.934641351825925*^9}, {3.934641406600913*^9, 3.934641417838583*^9}, {
  3.934641487438491*^9, 3.9346414900759106`*^9}, {3.9614260996063347`*^9, 
  3.9614261164773207`*^9}, {3.9614262732652817`*^9, 3.96142630144284*^9}, {
  3.961490868405519*^9, 3.9614908854206057`*^9}, {3.9614909887447863`*^9, 
  3.961491001324932*^9}},
 CellLabel->"In[62]:=",ExpressionUUID->"4b1b0f62-df85-416a-b9cd-d5d5b2f973c2"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "5.", " ", "Delete", " ", "pages", " ", "that", " ", "are", " ", "not", 
     " ", "used"}], ",", " ", 
    RowBox[{
     RowBox[{"e", ".", "g", ".", " ", "because"}], " ", "they", " ", "carry", 
     " ", "too", " ", "little", " ", "text", " ", "to", " ", "be", " ", 
     "present", " ", "in", " ", 
     RowBox[{"encodings", "."}]}]}], "*)"}], "\n", 
  RowBox[{
   RowBox[{
    RowBox[{"pageFiles", "=", 
     RowBox[{"FileBaseName", "/@", 
      RowBox[{"Select", "[", 
       RowBox[{
        RowBox[{"FileNames", "[", 
         RowBox[{"All", ",", "pageFolder", ",", "2"}], "]"}], ",", 
        RowBox[{"StringContainsQ", "[", "\"\<.json\>\"", "]"}]}], "]"}]}]}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{"badIds", "=", 
    RowBox[{"Complement", "[", 
     RowBox[{"pageFiles", ",", "pageIds"}], "]"}]}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Monitor", "[", 
     RowBox[{
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"DeleteFile", "[", 
         RowBox[{"FileNameJoin", "[", 
          RowBox[{"{", 
           RowBox[{"pageFolder", ",", 
            RowBox[{"StringTake", "[", 
             RowBox[{
              RowBox[{"badIds", "[", 
               RowBox[{"[", "i", "]"}], "]"}], ",", 
              RowBox[{"UpTo", "[", "4", "]"}]}], "]"}], ",", 
            RowBox[{
             RowBox[{"badIds", "[", 
              RowBox[{"[", "i", "]"}], "]"}], "<>", "\"\<.json\>\""}]}], 
           "}"}], "]"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Length", "@", "badIds"}]}], "}"}]}], "]"}], ",", "i"}], 
     "]"}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.935200177188674*^9, 3.935200181489335*^9}, {
   3.9352023859330077`*^9, 3.935202416466199*^9}, 3.961426473215055*^9, {
   3.961490898479354*^9, 3.961490928557987*^9}},
 CellLabel->"In[66]:=",ExpressionUUID->"5adb02d9-faee-4715-bb72-7fc0ad0c3f83"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "6.", " ", "Make", " ", "a", " ", "dictionary", " ", "mapping", " ", 
     "all", " ", "used", " ", "page", " ", "ids", " ", "to", " ", 
     RowBox[{"titles", ".", " ", "If"}], " ", "you", " ", "process", " ", 
     "the", " ", "full", " ", "dump"}], ",", " ", 
    RowBox[{
     RowBox[{"uncomment", " ", "'"}], 
     RowBox[{
      RowBox[{"Length", "@", "offset"}], "'"}], " ", "and", " ", "delete", 
     " ", "the", " ", "10", " ", "before", " ", "to", " ", "process", " ", 
     "the", " ", "full", " ", 
     RowBox[{"dump", "."}]}]}], "*)"}], "\n", 
  RowBox[{
   RowBox[{
    RowBox[{"Monitor", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"idList", "=", 
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"offset", "=", 
            RowBox[{"offsets", "[", 
             RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"assoc", "=", 
            RowBox[{"Import", "[", 
             RowBox[{
              RowBox[{"FileNameJoin", "[", 
               RowBox[{"{", 
                RowBox[{
                "$buildFolder", ",", "\"\<build\>\"", ",", "\"\<batches\>\"", 
                 ",", 
                 RowBox[{"StringTake", "[", 
                  RowBox[{
                   RowBox[{"ToString", "@", "offset"}], ",", 
                   RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], ",", 
                 RowBox[{
                  RowBox[{"ToString", "@", "offset"}], "<>", 
                  "\"\<.json\>\""}]}], "}"}], "]"}], ",", "\"\<RawJSON\>\""}],
              "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"assoc", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "\"\<title\>\""}], "]"}], "]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", "10"}], 
           RowBox[{"(*", 
            RowBox[{"Length", "@", "offsets"}], "*)"}], "}"}]}], "]"}]}], 
       ";"}], ",", "i"}], "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"idAssoc", "=", 
     RowBox[{"Association", "@", "idList"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<data\>\"", ",", "\"\<indices\>\"", ",", 
         "\"\<idTitleIndex.wxf\>\""}], "}"}], "]"}], ",", "idAssoc"}], "]"}], 
    ";"}]}]}]], "Input",
 CellChangeTimes->{{3.9614266153283587`*^9, 3.961426709968253*^9}, {
   3.9614267708229094`*^9, 3.961426825487426*^9}, 3.961490814848871*^9, {
   3.961491019950227*^9, 3.961491023801985*^9}, {3.961491170171604*^9, 
   3.961491181594737*^9}},
 CellLabel->"In[69]:=",ExpressionUUID->"c7fd4385-0fd5-4b2d-86b2-6fc00612392c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "7.", " ", "Finish", " ", "your", " ", "own", " ", "CLIPedia", " ", 
    "repository", " ", "by", " ", "copying", " ", "across", " ", "notebook", 
    " ", "files", " ", "with", " ", "initialization", " ", "and", " ", 
    "inference", " ", 
    RowBox[{"functions", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"CopyDirectory", "[", 
     RowBox[{
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{"$repoFolder", ",", "\"\<code\>\""}], "}"}], "]"}], ",", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{"$buildFolder", ",", "\"\<code\>\""}], "}"}], "]"}]}], "]"}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"CreateDirectory", "[", 
     RowBox[{"FileNameJoin", "[", 
      RowBox[{"{", 
       RowBox[{"$buildFolder", ",", "\"\<notebooks\>\""}], "}"}], "]"}], 
     "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"CopyFile", "[", 
     RowBox[{
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$repoFolder", ",", "\"\<notebooks\>\"", ",", 
         "\"\<clipedia_inference.nb\>\""}], "}"}], "]"}], ",", 
      RowBox[{"FileNameJoin", "[", 
       RowBox[{"{", 
        RowBox[{
        "$buildFolder", ",", "\"\<notebooks\>\"", ",", 
         "\"\<clipedia_inference.nb\>\""}], "}"}], "]"}]}], "]"}], 
    ";"}]}]}]], "Input",
 CellChangeTimes->{{3.9614286758242207`*^9, 3.961428678896763*^9}, {
   3.961428754244397*^9, 3.961428779388328*^9}, {3.9614910337524633`*^9, 
   3.961491140059181*^9}, 3.96149118394208*^9, {3.961512701961302*^9, 
   3.9615127134014463`*^9}, {3.961512761126443*^9, 3.961512770105452*^9}, {
   3.96151284359435*^9, 3.961512846209197*^9}},
 CellLabel->"In[75]:=",ExpressionUUID->"fbdb6ea5-cad9-4229-837c-98b641a26c97"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["15. Start Navigating your CLIPedia",
 FontSize->24,
 FontColor->RGBColor[0., 0., 0.]]], "Subtitle",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004653855638*^9}, {
   3.9255429588956685`*^9, 3.9255429656805353`*^9}, {3.933419738072833*^9, 
   3.933419738467922*^9}, {3.961339364151065*^9, 3.961339392280257*^9}, {
   3.961390164835906*^9, 3.961390173814896*^9}, 3.961393054862067*^9, {
   3.961426955932397*^9, 3.9614270283665447`*^9}, 3.961427104011215*^9, {
   3.961427204583488*^9, 3.961427235669896*^9}, {3.961427411911541*^9, 
   3.961427419047023*^9}, {3.961427888942782*^9, 3.9614278910145273`*^9}, {
   3.961428651383741*^9, 3.96142867152108*^9}, 3.961465360013031*^9, {
   3.9614911973320513`*^9, 
   3.961491208355035*^9}},ExpressionUUID->"32c0d81a-cfb0-4648-806f-\
7236740f5cda"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"1.", " ", "You", " ", "built", " ", "your", " ", "own", " ", 
     RowBox[{"CLIPedia", ".", " ", "To"}], " ", "explore", " ", "it"}], ",", 
    " ", 
    RowBox[{
    "you", " ", "need", " ", "to", " ", "treat", " ", "it", " ", "as", " ", 
     "a", " ", 
     RowBox[{"root", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"$repoFolder", "=", "$buildFolder"}], ";"}]}]], "Input",
 CellChangeTimes->{{3.961491458013692*^9, 3.961491543954651*^9}},
 CellLabel->
  "In[366]:=",ExpressionUUID->"6ecb6f85-afd5-4ff9-9232-2f520d795710"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
    "2.", " ", "Open", " ", "the", " ", "inference", " ", "notebook", " ", 
     "and", " ", "explore", " ", "its", " ", 
     RowBox[{"functions", ".", " ", "note"}], " ", "that", " ", "if", " ", 
     "you", " ", "processed", " ", "only", " ", "up", " ", "until", " ", 
     "offset", " ", "10"}], ",", " ", 
    RowBox[{"you", " ", "are", " ", "working", " ", "with", " ", "only", " ", 
     RowBox[{"ca", ".", " ", "0.004"}], "%", " ", "of", " ", "the", " ", 
     "full", " ", "corpus", " ", "of", " ", "CLIPedia"}], ",", " ", 
    RowBox[{
    "certain", " ", "functions", " ", "might", " ", "not", " ", "have", " ", 
     "enough", " ", "data", " ", "to", " ", "work", " ", 
     RowBox[{"reliably", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"NotebookOpen", "[", 
    RowBox[{"FileNameJoin", "[", 
     RowBox[{"{", 
      RowBox[{
      "$repoFolder", ",", "\"\<notebooks\>\"", ",", 
       "\"\<clipedia_inference.nb\>\""}], "}"}], "]"}], "]"}], 
   ";"}]}]], "Input",
 CellChangeTimes->{{3.961491550866783*^9, 3.9614916114569597`*^9}, {
   3.9614916936443253`*^9, 3.961491750651264*^9}, {3.961512532951545*^9, 
   3.9615125444635878`*^9}, 3.9615128737989492`*^9},
 CellLabel->
  "In[368]:=",ExpressionUUID->"d4194089-2db7-467a-9fa7-b1a0df52302f"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["Initialization Functions",
 FontColor->RGBColor[0.4, 0.4000152590218967, 0.4]]], "Subtitle",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004670496183*^9}, {
  3.9241006465262146`*^9, 3.924100650918215*^9}, {3.9242581271173253`*^9, 
  3.9242581297813253`*^9}, {3.96142730167209*^9, 3.961427306455673*^9}, {
  3.9614653032373657`*^9, 3.961465314612693*^9}, {3.961493408437636*^9, 
  3.9614934087781563`*^9}},ExpressionUUID->"b8ca7295-826f-4639-a233-\
d97c6cfae09d"],

Cell[CellGroupData[{

Cell["WikiCode Parsing Helpers", "Subsubsection",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004670496183*^9}, {
  3.9241006465262146`*^9, 3.924100650918215*^9}, {3.9242581271173253`*^9, 
  3.9242581297813253`*^9}, {3.96142730167209*^9, 3.961427306455673*^9}, {
  3.9614653032373657`*^9, 3.961465314612693*^9}, {3.96149290833879*^9, 
  3.9614929110436296`*^9}, {3.961493138362278*^9, 3.9614931452069483`*^9}, {
  3.96149340559212*^9, 3.961493406636104*^9}, {3.961495506665543*^9, 
  3.9614955267780037`*^9}},
 FontColor->RGBColor[
  0.4, 0.4000152590218967, 
   0.4],ExpressionUUID->"21ef4915-7f34-4cd9-83bc-0ecd98031d25"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", 
     RowBox[{
      RowBox[{"-", "title"}], " ", "page", " ", "title", " ", "string"}]}], 
    ",", " ", 
    RowBox[{
     RowBox[{
      RowBox[{"-", "content"}], " ", "page", " ", "content", " ", "string"}], 
     ";", 
     RowBox[{"Output", ":", 
      RowBox[{
       RowBox[{"-", "True"}], " ", "if", " ", "the", " ", "page", " ", 
       "passes", " ", "basic", " ", "content", " ", "checks"}]}]}], ",", " ", 
    RowBox[{
    "False", " ", "if", " ", "it", " ", "is", " ", "likely", " ", "a", " ", 
     "stub"}], ",", " ", "disambiguation", ",", " ", "redirect", ",", " ", 
    RowBox[{
     RowBox[{
      RowBox[{"or", " ", "a", " ", "non"}], "-", 
      RowBox[{"article", " ", "namespace"}]}], ";", 
     RowBox[{"Description", ":", " ", 
      RowBox[{
      "Checks", " ", "whether", " ", "a", " ", "Wikipedia", " ", "page", " ", 
       "title", " ", "and", " ", "content", " ", "suggest", " ", "the", " ", 
       "page", " ", "is", " ", "substantive", " ", "for", " ", "the", " ", 
       "corpus"}]}]}], ",", 
    RowBox[{
    "excluding", " ", "known", " ", "patterns", " ", "such", " ", "as", " ", 
     "disambiguation", " ", "pages"}], ",", " ", "stubs", ",", " ", 
    "redirects", ",", " ", 
    RowBox[{"or", " ", "administrative", " ", 
     RowBox[{"namespaces", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"CheckPages", "[", 
    RowBox[{"title_", ",", "content_"}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"test1", ",", " ", "test2"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"test1", "=", 
       RowBox[{"StringContainsQ", "[", 
        RowBox[{"content", ",", 
         RowBox[{"Alternatives", "@@", 
          RowBox[{"{", 
           RowBox[{
           "\"\<{{Disambiguation}}\>\"", ",", "\"\<{{Stub}}\>\"", ",", 
            "\"\<#REDIRECT\>\"", ",", "\"\<<redirect title\>\"", ",", 
            "\"\<{{Disambiguation|\>\"", ",", "\"\<{{Disambig}}\>\"", ",", 
            "\"\<{{Disamb}}\>\"", ",", "\"\<{{Dab}}\>\""}], "}"}]}], ",", 
         RowBox[{"IgnoreCase", "->", "True"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"test2", "=", 
       RowBox[{"StringStartsQ", "[", 
        RowBox[{"title", ",", 
         RowBox[{"Alternatives", "@@", 
          RowBox[{"{", 
           RowBox[{
           "\"\<Wikipedia:\>\"", ",", "\"\<File:\>\"", ",", "\"\<Help:\>\"", 
            ",", "\"\<Draft:\>\"", ",", "\"\<Template:\>\"", ",", 
            "\"\<MediaWiki:\>\"", ",", "\"\<Category:\>\"", ",", 
            "\"\<Module:\>\"", ",", "\"\<Portal:\>\"", ",", 
            "\"\<TimedText:\>\"", ",", "\"\<UN/LOCODE:\>\"", ",", 
            "\"\<ATCvet code \>\"", ",", "\"\<ATC code \>\"", ",", 
            "\"\<Athletics at the \>\"", ",", "\"\<Cycling at the \>\"", ",", 
            "\"\<Births in \>\"", ",", "\"\<Electoral district of \>\"", ",", 
            "\"\<Independent candidates\>\"", ",", 
            "\"\<National Register of Historic\>\"", ",", "\"\<List of\>\"", 
            ",", 
            RowBox[{"\"\<List of\>\"", "~~", "___", "~~", "\"\<:\>\""}], ",", 
            RowBox[{"\"\<Meanings of\>\"", "~~", "___", "~~", "\"\<:\>\""}], 
            ",", 
            RowBox[{"\"\<ISO\>\"", "~~", "___", "~~", "\"\<:\>\""}], ",", 
            RowBox[{"___", "~~", "\"\<.ogg.\>\""}]}], "}"}]}]}], "]"}]}], ";",
       "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"MemberQ", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"test1", ",", "test2"}], "}"}], ",", "True"}], "]"}], ",", 
        "False", ",", "True"}], "]"}]}]}], "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.923568518193385*^9, 3.923568549889559*^9}, {
  3.9235688061985483`*^9, 3.9235688581582994`*^9}, {3.9235690616591415`*^9, 
  3.9235690761106057`*^9}, {3.9235692677673903`*^9, 3.9235692754560895`*^9}, {
  3.923569554098516*^9, 3.92356955824467*^9}, {3.9235714522358923`*^9, 
  3.9235714798708105`*^9}, {3.9243217011190014`*^9, 3.9243217086357536`*^9}, {
  3.9243217430084076`*^9, 3.9243217939325514`*^9}, {3.961338400318392*^9, 
  3.961338400791589*^9}, {3.9614930394956284`*^9, 3.9614931282778482`*^9}},
 CellLabel->"In[29]:=",ExpressionUUID->"d38b88b3-8a2a-42f0-bdaa-30b49f362185"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", 
     RowBox[{
      RowBox[{"-", "contentPath"}], " ", "path", " ", "to", " ", "compressed",
       " ", "Wikipedia", " ", "dump", " ", "file"}]}], ",", " ", 
    RowBox[{
     RowBox[{"-", "start"}], " ", "start", " ", "byte", " ", "position"}], 
    ",", " ", 
    RowBox[{
     RowBox[{"-", "end"}], " ", "end", " ", "byte", " ", "position"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"-", "tempFolder"}], " ", "temporary", " ", "folder", " ", 
      "for", " ", "extraction"}], ";", 
     RowBox[{"Output", ":", 
      RowBox[{
       RowBox[{"-", "String"}], " ", "of", " ", "decompressed", " ", "XML", 
       " ", "content", " ", "between", " ", "start", " ", "and", " ", "end", 
       " ", "positions"}]}], ";", 
     RowBox[{"Description", ":", " ", 
      RowBox[{
      "Extracts", " ", "a", " ", "specific", " ", "byte", " ", "range", " ", 
       "from", " ", "a", " ", "compressed", " ", "Wikipedia", " ", "XML", " ",
        "dump", " ", 
       RowBox[{"(", 
        RowBox[{".", "bz2"}], ")"}]}]}]}], ",", 
    RowBox[{
    "writes", " ", "it", " ", "to", " ", "a", " ", "temporary", " ", "file"}],
     ",", " ", 
    RowBox[{"unpacks", " ", "it", " ", "using", " ", "ExtractArchive"}], ",", 
    RowBox[{
     RowBox[{
     "and", " ", "returns", " ", "the", " ", "decompressed", " ", "UTF"}], 
     "-", 
     RowBox[{"8", " ", "text", " ", "content", " ", "as", " ", "a", " ", 
      RowBox[{"string", "."}]}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"ExtractXMLsFromWikiDump", "[", 
    RowBox[{"contentPath_", ",", "start_", ",", "end_", ",", "tempFolder_"}], 
    "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "stream", ",", "content", ",", "decompressedPath", ",", 
       "decompressedContent"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"stream", "=", 
       RowBox[{"OpenRead", "[", 
        RowBox[{"contentPath", ",", 
         RowBox[{"BinaryFormat", "->", "True"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"SetStreamPosition", "[", 
       RowBox[{"stream", ",", "start"}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"content", "=", 
       RowBox[{"BinaryReadList", "[", 
        RowBox[{"stream", ",", "\"\<Byte\>\"", ",", 
         RowBox[{"end", "-", "start"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Close", "[", "stream", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Quiet", "@", 
       RowBox[{"DeleteFile", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"FileNameJoin", "[", 
           RowBox[{"{", 
            RowBox[{"tempFolder", ",", 
             RowBox[{"\"\<buffer\>\"", "<>", "#"}]}], "}"}], "]"}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"\"\<.xml\>\"", ",", "\"\<xml.bz2\>\""}], "}"}]}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"Export", "[", 
       RowBox[{
        RowBox[{"FileNameJoin", "[", 
         RowBox[{"{", 
          RowBox[{"tempFolder", ",", "\"\<buffer.xml.bz2\>\""}], "}"}], "]"}],
         ",", "content", ",", "\"\<Byte\>\""}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"decompressedPath", "=", 
       RowBox[{"ExtractArchive", "[", 
        RowBox[{
         RowBox[{"FileNameJoin", "[", 
          RowBox[{"{", 
           RowBox[{"tempFolder", ",", "\"\<buffer.xml.bz2\>\""}], "}"}], 
          "]"}], ",", "tempFolder", ",", 
         RowBox[{"OverwriteTarget", "->", "True"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"decompressedContent", "=", 
       RowBox[{"FromCharacterCode", "[", 
        RowBox[{
         RowBox[{"BinaryReadList", "[", 
          RowBox[{
           RowBox[{"First", "@", "decompressedPath"}], ",", "\"\<Byte\>\""}], 
          "]"}], ",", "\"\<UTF8\>\""}], "]"}]}], ";", "\[IndentingNewLine]", 
      "decompressedContent"}]}], "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.923548603505927*^9, 3.923548776478746*^9}, {
  3.9235488217969265`*^9, 3.923548823834021*^9}, {3.923548865054682*^9, 
  3.9235488663762517`*^9}, {3.9235572160934467`*^9, 3.923557286301141*^9}, {
  3.923557351561098*^9, 3.923557354465251*^9}, {3.9236500363741145`*^9, 
  3.9236500397475605`*^9}, {3.9614931622232933`*^9, 3.96149317842705*^9}},
 CellLabel->"In[30]:=",ExpressionUUID->"1aa24f51-52e8-4ec0-be5c-e4ca9053f3d0"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", 
     RowBox[{
      RowBox[{"-", "xmlContent"}], " ", "string", " ", "containing", " ", 
      "Wikipedia", " ", "XML", " ", "dump", " ", "content"}]}], ";", 
    RowBox[{"Output", ":", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"-", "List"}], " ", "of", " ", "individual"}], " ", "<", 
        "page", ">"}], "..."}], "<", 
      RowBox[{"/", "page"}], ">", " ", 
      RowBox[{"XML", " ", "document", " ", "strings"}]}]}], ";", 
    RowBox[{"Description", ":", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"Extracts", " ", "all", " ", "individual"}], " ", "<", "page",
         ">"}], "..."}], "<", 
      RowBox[{"/", "page"}], ">", " ", 
      RowBox[{
      "blocks", " ", "from", " ", "the", " ", "provided", " ", "Wikipedia", 
       " ", "XML", " ", "content", " ", "string"}]}]}]}], "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"ExtractXMLDocuments", "[", "xmlContent_", "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "docs", "}"}], ",", 
      RowBox[{
       RowBox[{"docs", "=", 
        RowBox[{"StringCases", "[", 
         RowBox[{"xmlContent", ",", 
          RowBox[{
           RowBox[{"\"\<<page>\>\"", "~~", 
            RowBox[{"Shortest", "[", "content___", "]"}], "~~", 
            "\"\<</page>\>\""}], ":>", "content"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"docs", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"\"\<<page>\>\"", "<>", "#", "<>", "\"\<</page>\>\""}], 
          "&"}], "/@", "docs"}]}], ";", "docs"}]}], "]"}]}], ";"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9235507910883837`*^9, 3.9235508018594584`*^9}, 
   3.9235514040049334`*^9, {3.9235671274520903`*^9, 3.9235671351858406`*^9}, {
   3.9235684289265575`*^9, 3.9235684359097295`*^9}, {3.9614932257251062`*^9, 
   3.9614932668642387`*^9}, {3.961493366631794*^9, 3.961493369640382*^9}},
 CellLabel->"In[31]:=",ExpressionUUID->"3fff1234-2fb3-4e71-91d4-f5354095eb42"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Input", ":", 
      RowBox[{
       RowBox[{
        RowBox[{"-", "tags"}], " ", "list", " ", "of", " ", "XML", " ", "or", 
        " ", "HTML"}], "-", 
       RowBox[{"like", " ", "tag", " ", "strings"}]}]}], ";", 
     RowBox[{"Output", ":", 
      RowBox[{
       RowBox[{"-", "List"}], " ", "with", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"matched", " ", "tag", " ", "pairs"}], ",", " ", 
         RowBox[{"unmatched", " ", "opening", " ", "tags"}], ",", " ", 
         RowBox[{
          RowBox[{
          "other", " ", "tags", " ", "like", " ", "comments", " ", "or", " ", 
           "self"}], "-", "closing"}], ",", " ", 
         RowBox[{"quote", " ", "tags"}]}], "}"}]}]}], ";", 
     RowBox[{"Description", ":", " ", 
      RowBox[{
      "Validates", " ", "opening", " ", "and", " ", "closing", " ", "tag", 
       " ", "pairs", " ", "in", " ", "a", " ", "list", " ", "of", " ", 
       "tags"}]}]}], ",", 
    RowBox[{"identifying", " ", "matched", " ", "pairs"}], ",", 
    RowBox[{"remaining", " ", "unclosed", " ", "tags"}], ",", " ", 
    RowBox[{"other", " ", "elements", " ", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"like", " ", "comments", " ", "or", " ", "self"}], "-", 
       RowBox[{"closing", " ", "tags"}]}], ")"}]}], ",", 
    RowBox[{
     RowBox[{
     "and", " ", "special", " ", "quote", " ", "tags", " ", "such", " ", 
      "as"}], "<", "poem", ">", "or", "<", "blockquote", ">", 
     RowBox[{
     "to", " ", "help", " ", "with", " ", "the", " ", "meaningful", " ", 
      "cleaning", " ", "of", " ", 
      RowBox[{"WikiCode", "."}]}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"ValidateTagPairs", "[", "tags_", "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"stack", "=", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"tagPairings", "=", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"otherTags", "=", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"quoteTags", "=", 
         RowBox[{"{", "}"}]}], ",", "tagName", ",", "tagType"}], "}"}], ",", 
      RowBox[{"(*", 
       RowBox[{"Loop", " ", "over", " ", "each", " ", "tag"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"tagType", "=", "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"StringMatchQ", "[", 
              RowBox[{"tag", ",", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                 "RegularExpression", "[", "\"\<<;![^>]*?>;\>\"", "]"}], ",", 
                 RowBox[{
                 "RegularExpression", "[", "\"\<<;[^>]*?/>;\>\"", "]"}], ",", 
                 RowBox[{
                 "RegularExpression", "[", "\"\<<;!--[\\\\s\\\\S]*?-->;\>\"", 
                  "]"}]}], "}"}]}], "]"}], ",", "\"\<Other\>\"", ",", 
             "\[IndentingNewLine]", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"StringMatchQ", "[", 
                RowBox[{"tag", ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{
                   "RegularExpression", "[", "\"\<<;[^>]*?poem>;\>\"", "]"}], 
                   ",", 
                   RowBox[{
                   "RegularExpression", "[", "\"\<<;[^>]*?blockquote>;\>\"", 
                    "]"}]}], "}"}]}], "]"}], ",", "\"\<Quote\>\"", ",", 
               "\[IndentingNewLine]", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{"StringMatchQ", "[", 
                  RowBox[{"tag", ",", 
                   RowBox[{
                   "RegularExpression", "[", "\"\<<;[^/;].*>;\>\"", "]"}]}], 
                  "]"}], ",", "\"\<Open\>\"", ",", "\"\<Close\>\""}], "]"}]}],
               "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"tagName", "=", 
           RowBox[{"StringReplace", "[", 
            RowBox[{"tag", ",", 
             RowBox[{
              RowBox[{
              "RegularExpression", "[", "\"\<<;(/?)(.*?)>;\>\"", "]"}], ":>", 
              "\"\<$2\>\""}]}], " ", 
            RowBox[{"(*", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"Extract", " ", "tag", " ", "name", " ", "without"}], 
                "<"}], ";"}], ",", " ", 
              RowBox[{">", 
               RowBox[{",", 
                RowBox[{
                 RowBox[{"or", "/"}], ">"}]}]}]}], "*)"}], "]"}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"Switch", "[", 
           RowBox[{"tagType", ",", "\[IndentingNewLine]", "\"\<Open\>\"", ",", 
            RowBox[{"AppendTo", "[", 
             RowBox[{"stack", ",", 
              RowBox[{"{", 
               RowBox[{"tagName", ",", "tag"}], "}"}]}], "]"}], ",", 
            "\[IndentingNewLine]", "\"\<Close\>\"", ",", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"stack", "!=", 
               RowBox[{"{", "}"}]}], ",", 
              RowBox[{
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"StringContainsQ", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Last", "[", "stack", "]"}], "[", 
                    RowBox[{"[", "1", "]"}], "]"}], ",", "tagName"}], "]"}], "||", 
                  RowBox[{"StringContainsQ", "[", 
                   RowBox[{"tagName", ",", 
                    RowBox[{
                    RowBox[{"Last", "[", "stack", "]"}], "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "||", 
                  RowBox[{"StringMatchQ", "[", 
                   RowBox[{"tag", ",", "\"\</>\>\""}], "]"}]}], ",", 
                 RowBox[{
                  RowBox[{"AppendTo", "[", 
                   RowBox[{"tagPairings", ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Last", "[", "stack", "]"}], "[", 
                    RowBox[{"[", "2", "]"}], "]"}], ",", "tag"}], "}"}]}], 
                   "]"}], ";", "\[IndentingNewLine]", 
                  RowBox[{"stack", "=", 
                   RowBox[{"Most", "[", "stack", "]"}]}]}]}], "]"}], " ", 
               ";"}]}], 
             RowBox[{"(*", 
              RowBox[{"Pop", " ", "from", " ", "stack"}], "*)"}], "]"}], ",", 
            "\[IndentingNewLine]", "\"\<Other\>\"", ",", 
            RowBox[{"AppendTo", "[", 
             RowBox[{"otherTags", ",", "tag"}], "]"}], ",", 
            "\[IndentingNewLine]", "\"\<Quote\>\"", ",", 
            RowBox[{"AppendTo", "[", 
             RowBox[{"quoteTags", ",", "tag"}], "]"}]}], "]"}], ";"}], ",", 
         RowBox[{"(*", 
          RowBox[{"Properly", " ", "define", " ", "iteration", " ", 
           RowBox[{"variable", "'"}], 
           RowBox[{"tag", "'"}], " ", "over", " ", "the", " ", "list", " ", 
           "of", " ", "tags"}], "*)"}], 
         RowBox[{"{", 
          RowBox[{"tag", ",", "tags"}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"tagPairings", ",", 
         RowBox[{"stack", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", "otherTags", ",", 
         "quoteTags"}], "}"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9236323420078015`*^9, 3.9236323420088053`*^9}, {
   3.923632420727916*^9, 3.9236324325358124`*^9}, {3.9236324849207935`*^9, 
   3.9236325274670334`*^9}, {3.923632588093462*^9, 3.9236325968230624`*^9}, {
   3.9236330702169933`*^9, 3.923633079968828*^9}, {3.923633649663551*^9, 
   3.92363372033982*^9}, {3.9236344560015955`*^9, 3.923634512094083*^9}, {
   3.923636506230977*^9, 3.9236365139802265`*^9}, {3.923637382139163*^9, 
   3.9236374961666584`*^9}, {3.92363756016052*^9, 3.923637720133336*^9}, {
   3.9236380936824665`*^9, 3.9236381136883135`*^9}, {3.923638160386078*^9, 
   3.9236381630835476`*^9}, 3.923638488941925*^9, {3.923638655098942*^9, 
   3.9236386769261203`*^9}, {3.923638722089584*^9, 3.923638776649893*^9}, {
   3.9236388437895613`*^9, 3.9236388448185854`*^9}, {3.923638909956676*^9, 
   3.9236389203247614`*^9}, {3.9236389791821117`*^9, 3.923638993699933*^9}, {
   3.923639193911485*^9, 3.92363920511371*^9}, {3.9236396121387672`*^9, 
   3.9236397596344953`*^9}, {3.9236412308875213`*^9, 3.923641246014984*^9}, {
   3.923641307553775*^9, 3.923641307708285*^9}, {3.923897472609593*^9, 
   3.923897474543717*^9}, 3.924065839399244*^9, {3.92407680976661*^9, 
   3.9240768196132154`*^9}, {3.9240770684396505`*^9, 3.924077253997794*^9}, 
   3.9244101581907525`*^9, {3.92441042363933*^9, 3.924410433982738*^9}, {
   3.961493292949188*^9, 3.96149338627507*^9}},
 CellLabel->"In[32]:=",ExpressionUUID->"c757bde9-89ac-434f-ad41-2e7245335e0f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Input", ":", 
      RowBox[{
       RowBox[{"-", "imgLink"}], " ", "local", " ", "image", " ", "link", " ",
        "or", " ", "file", " ", "path", " ", "string"}]}], ";", 
     RowBox[{"Output", ":", 
      RowBox[{
       RowBox[{"-", "Direct"}], " ", "URL", " ", "string", " ", "to", " ", 
       "the", " ", "image", " ", "on", " ", "Wikipedia"}]}]}], ",", " ", 
    RowBox[{
     RowBox[{
     "or", " ", "empty", " ", "string", " ", "if", " ", "unavailable"}], ";", 
     RowBox[{"Description", ":", 
      RowBox[{
      "Fetches", " ", "the", " ", "public", " ", "Wikipedia", " ", "URL", " ",
        "of", " ", "a", " ", "given", " ", "image", " ", "file", " ", "by", 
       " ", "querying", " ", "the", " ", "Wikipedia", " ", "API", " ", "for", 
       " ", "the", " ", "imageinfo", " ", "property", " ", "using", " ", 
       "the", " ", "file", " ", "title", " ", "extracted", " ", "from", " ", 
       "the", " ", "provided", " ", 
       RowBox[{"link", "."}]}]}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"FetchImageURL", "[", "imgLink_", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"fileTitle", ",", "apiUrl", ",", "response", ",", "json"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"fileTitle", "=", 
       RowBox[{"Last", "@", 
        RowBox[{"FileNameSplit", "@", "imgLink"}]}]}], ";", 
      RowBox[{"apiUrl", "=", 
       RowBox[{
       "\"\<https://en.wikipedia.org/w/api.php?action=query&titles=\>\"", "<>", 
        RowBox[{"URLEncode", "[", "fileTitle", "]"}], "<>", 
        "\"\<&prop=imageinfo&iiprop=url&format=json\>\""}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"response", "=", 
       RowBox[{"URLRead", "[", 
        RowBox[{"apiUrl", ",", "\"\<Body\>\""}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"json", "=", 
       RowBox[{"ImportString", "[", 
        RowBox[{"response", ",", "\"\<RawJSON\>\""}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"StringQ", "[", "#", "]"}], ",", "#", ",", "\"\<\>\""}], 
         "]"}], "&"}], "@", 
       RowBox[{"json", "[", 
        RowBox[{"[", 
         RowBox[{
         "\"\<query\>\"", ",", "\"\<pages\>\"", ",", "1", ",", 
          "\"\<imageinfo\>\"", ",", "1", ",", "\"\<url\>\""}], "]"}], 
        "]"}]}]}]}], "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.923647968782483*^9, 3.9236480569568167`*^9}, {
   3.9236481242749357`*^9, 3.923648126592845*^9}, 3.923648183743285*^9, {
   3.923648223431078*^9, 3.923648234281247*^9}, {3.924088339659685*^9, 
   3.9240883521312037`*^9}, {3.96149342414354*^9, 3.961493437087344*^9}},
 CellLabel->"In[33]:=",ExpressionUUID->"2dac2235-d9e7-4ddf-9a96-bf81eae88d8c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Input", ":", 
      RowBox[{
       RowBox[{"-", "string"}], " ", "raw", " ", "HTML", " ", "or", " ", 
       "WikiCode", " ", "string"}]}], ";", 
     RowBox[{"Output", ":", 
      RowBox[{
       RowBox[{"-", "List"}], " ", "of", " ", 
       RowBox[{"{", 
        RowBox[{
        "cleaned", " ", "string", " ", "without", " ", "HTML", " ", "or", " ",
          "reference", " ", "tags", " ", "association", " ", "mapping", " ", 
         "reference", " ", "numbers", " ", "to", " ", "reference", " ", 
         "text"}], "}"}]}]}], ";", 
     RowBox[{"Description", ":", " ", 
      RowBox[{
      "Cleans", " ", "WikiCode", " ", "by", " ", "removing", " ", "or", " ", 
       "simplifying", " ", "tags"}]}]}], ",", " ", 
    RowBox[{"processing", " ", "<", "ref", ">", " ", 
     RowBox[{"elements", " ", "into", " ", "numbered", " ", "markers"}]}], 
    ",", 
    RowBox[{
     RowBox[{"removing", " ", "non"}], "-", 
     RowBox[{"reference", " ", "HTML", " ", "tags"}]}], ",", 
    RowBox[{"converting", " ", "quotes"}], ",", " ", "lists", ",", " ", 
    RowBox[{
    "and", " ", "citations", " ", "into", " ", "simplified", " ", "text", " ",
      "form"}], ",", 
    RowBox[{
    "and", " ", "returning", " ", "both", " ", "the", " ", "cleaned", " ", 
     "text", " ", "and", " ", "a", " ", "reference", " ", "mapping", " ", 
     RowBox[{"association", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"ClearHTML", "[", "string_", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "tags", ",", "matchedPairs", ",", "purge0", ",", "purge1", ",", 
       "purge2", ",", "purge3", ",", "purge4", ",", "tempContent", ",", 
       "refMarkers", ",", "nonRefs", ",", "inTextRefCases", ",", "inTextRef", 
       ",", "numbersRefNoDup", ",", "refAssoc", ",", "numbersRef", ",", 
       "inTextRefClean", ",", "inTextRefThread"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Step", " ", "1"}], ":", " ", 
       RowBox[{"Find", " ", "HTML", " ", "tags", " ", "to", " ", "filter"}]}],
       "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"tags", "=", 
       RowBox[{"StringCases", "[", 
        RowBox[{"string", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"RegularExpression", "[", "\"\<<;[^<>]*>;\>\"", "]"}], ",", 
           RowBox[{
           "RegularExpression", "[", "\"\<<;!--[\\\\s\\\\S]*?-->;\>\"", 
            "]"}]}], "}"}]}], "]"}]}], ";", 
      RowBox[{"matchedPairs", "=", 
       RowBox[{"ValidateTagPairs", "[", "tags", "]"}]}], ";", 
      RowBox[{"refMarkers", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"Pick", "[", 
          RowBox[{"#", ",", 
           RowBox[{"StringContainsQ", "[", 
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}], ",", "\"\<<;ref\>\""}], "]"}]}],
           "]"}], "&"}], "/@", 
        RowBox[{"matchedPairs", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", 
      RowBox[{"nonRefs", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"Pick", "[", 
          RowBox[{"#", ",", 
           RowBox[{"!", 
            RowBox[{"StringContainsQ", "[", 
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "1", "]"}], "]"}], ",", "\"\<<;ref\>\""}], 
             "]"}]}]}], "]"}], "&"}], "/@", 
        RowBox[{"matchedPairs", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Step", " ", "2"}], ":", " ", 
        RowBox[{"Deal", " ", "with", " ", "Ref", " ", "in", " ", "HTML"}]}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "@", "refMarkers"}], ">", "0"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"inTextRefCases", "=", 
          RowBox[{"DeleteDuplicates", "@", 
           RowBox[{"Flatten", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"StringCases", "[", 
               RowBox[{"string", ",", 
                RowBox[{"Shortest", "[", 
                 RowBox[{
                  RowBox[{"#", "[", 
                   RowBox[{"[", "1", "]"}], "]"}], "~~", "___", "~~", 
                  RowBox[{"#", "[", 
                   RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], "]"}], "&"}], "/@",
              "refMarkers"}], "]"}]}]}], ";", 
         RowBox[{"inTextRef", "=", 
          RowBox[{"StringCases", "[", 
           RowBox[{"string", ",", "inTextRefCases"}], "]"}]}], ";", 
         RowBox[{"numbersRefNoDup", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"StringJoin", "[", 
             RowBox[{"{", 
              RowBox[{"\"\<[\>\"", ",", 
               RowBox[{"ToString", "@", "#"}], ",", "\"\<]\>\""}], "}"}], 
             "]"}], "&"}], "/@", 
           RowBox[{"Range", "[", 
            RowBox[{"Length", "@", 
             RowBox[{"DeleteDuplicates", "@", "inTextRef"}]}], "]"}]}]}], ";",
          "\[IndentingNewLine]", 
         RowBox[{"refAssoc", "=", 
          RowBox[{"AssociationThread", "[", 
           RowBox[{
            RowBox[{"DeleteDuplicates", "@", "inTextRef"}], "->", 
            "numbersRefNoDup"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"numbersRef", "=", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"refAssoc", "[", 
             RowBox[{"[", 
              RowBox[{"inTextRef", "[", 
               RowBox[{"[", "i", "]"}], "]"}], "]"}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", 
              RowBox[{"Length", "@", "inTextRef"}]}], "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"inTextRefClean", "=", 
          RowBox[{
           RowBox[{
            RowBox[{"StringReplace", "[", 
             RowBox[{
              RowBox[{"StringReplace", "[", 
               RowBox[{
                RowBox[{"StringTrim", "[", 
                 RowBox[{"StringReplace", "[", 
                  RowBox[{
                   RowBox[{"StringReplace", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"\"\<|\>\"", "~~", 
                    RowBox[{
                    RowBox[{"Except", "[", 
                    RowBox[{"{", 
                    RowBox[{"\"\<=\>\"", "|", "\"\<|\>\""}], "}"}], "]"}], 
                    "..."}], "~~", "\"\<=\>\""}], "->", "\"\<|\>\""}], ",", 
                    RowBox[{
                    RowBox[{"RegularExpression", "[", "\"\<^{{\>\"", "]"}], 
                    "->", "\"\<{\>\""}]}], "}"}]}], "]"}], ",", 
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    "\"\<{Snf\>\"", "|", "\"\<{Sfn\>\"", "|", "\"\<{Sfnm\>\"",
                     "|", "\"\<{sfnm\>\"", "|", "\"\<{Sfnm\>\"", "|", 
                    "\"\<{sfn\>\"", "|", "\"\<{snf\>\"", "|", 
                    "\"\<{sfnref\>\"", "|", "\"\<{Sfnref\>\"", "|", 
                    "\"\<{harv\>\"", "|", "\"\<{Harv\>\"", "|", 
                    "\"\<{cite\>\"", "|", "\"\<{Cite\>\"", "|", 
                    "\"\<{citation\>\"", "|", "\"\<{Citation\>\""}], ")"}], "~~", 
                    RowBox[{
                    RowBox[{"Except", "[", 
                    RowBox[{"{", "\"\<|\>\"", "}"}], "]"}], "..."}], "~~", 
                    "\"\<|\>\""}], "->", "\"\<\>\""}], ",", 
                    RowBox[{
                    RowBox[{"\"\<{{\>\"", "~~", 
                    RowBox[{
                    RowBox[{"Except", "[", 
                    RowBox[{"{", "\"\<}\>\"", "}"}], "]"}], "..."}], "~~", 
                    "\"\<}\>\""}], "->", "\"\<\>\""}], ",", 
                    RowBox[{
                    RowBox[{"\"\<<\>\"", "~~", 
                    RowBox[{
                    RowBox[{"Except", "[", 
                    RowBox[{"{", "\"\<>\>\"", "}"}], "]"}], "..."}], "~~", 
                    "\"\<>\>\""}], "->", "\"\<\>\""}], ",", 
                    RowBox[{"\"\< | \>\"", "->", "\"\<, \>\""}], ",", 
                    RowBox[{"\"\< |\>\"", "->", "\"\<, \>\""}], ",", 
                    RowBox[{"\"\<| \>\"", "->", "\"\<, \>\""}], ",", 
                    RowBox[{"\"\<|\>\"", "->", "\"\<, \>\""}], ",", 
                    RowBox[{"\"\< : \>\"", "->", "\"\<: \>\""}], ",", 
                    RowBox[{"\"\<}}\>\"", "->", "\"\<\>\""}], ",", 
                    RowBox[{"\"\<{{\>\"", "->", "\"\<\>\""}]}], "}"}]}], 
                  "]"}], "]"}], ",", 
                RowBox[{
                 RowBox[{"RegularExpression", "[", "\"\<,\\\\s*$\>\"", "]"}], 
                 "->", "\"\<\>\""}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"\"\<&;\>\"", "->", "\"\<&\>\""}], ",", 
                RowBox[{"\"\<\\\";\>\"", "->", "\"\<\\\"\>\""}], ",", 
                RowBox[{"\"\< , \>\"", "->", "\"\<, \>\""}], ",", 
                RowBox[{"\"\< , \>\"", "->", "\"\<, \>\""}], ",", 
                RowBox[{"\"\<]]\>\"", "->", "\"\<\>\""}], ",", 
                RowBox[{"\"\<[[\>\"", "->", "\"\<\>\""}], ",", 
                RowBox[{"\"\<''\>\"", "->", "\"\<\\\"\>\""}], ",", 
                RowBox[{"\"\<{\>\"", "->", "\"\<\>\""}], ",", 
                RowBox[{"\"\<}\>\"", "->", "\"\<\>\""}], ",", 
                RowBox[{"\"\<[\>\"", "->", "\"\<\>\""}], ",", 
                RowBox[{"\"\<]\>\"", "->", "\"\<\>\""}], ",", 
                RowBox[{"\"\<\\n\>\"", "->", "\"\<\>\""}]}], "}"}]}], "]"}], 
            "&"}], "@", 
           RowBox[{"StringDelete", "[", 
            RowBox[{
             RowBox[{"DeleteDuplicates", "@", "inTextRef"}], ",", 
             RowBox[{"Flatten", "@", "refMarkers"}]}], "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"inTextRefThread", "=", 
          RowBox[{"AssociationThread", "[", 
           RowBox[{"numbersRefNoDup", "->", "inTextRefClean"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"purge0", "=", 
          RowBox[{"StringReplace", "[", 
           RowBox[{"string", ",", 
            RowBox[{"Thread", "[", 
             RowBox[{"inTextRef", "->", "numbersRef"}], "]"}]}], "]"}]}], 
         ";"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"inTextRefThread", "=", 
          RowBox[{"Association", "[", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"purge0", "=", "string"}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "Step", " ", "3", " ", "Delete", " ", "all", " ", "non", " ", 
        "reference", " ", "tags"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"purge1", "=", 
       RowBox[{"StringDelete", "[", 
        RowBox[{"purge0", ",", 
         RowBox[{"matchedPairs", "[", 
          RowBox[{"[", "3", "]"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"purge2", "=", "purge1"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{"purge2", "=", 
         RowBox[{"StringDelete", "[", 
          RowBox[{"purge2", ",", 
           RowBox[{
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Length", "@", "#"}], "==", "0"}], ",", "#", ",", 
               RowBox[{"First", "@", "#"}]}], "]"}], "&"}], "@", 
            RowBox[{"StringCases", "[", 
             RowBox[{"purge2", ",", 
              RowBox[{"Shortest", "[", 
               RowBox[{
                RowBox[{"nonRefs", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1"}], "]"}], "]"}], "~~", "___", "~~", 
                RowBox[{"nonRefs", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "2"}], "]"}], "]"}]}], "]"}]}], "]"}]}]}],
           "]"}]}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Length", "[", "nonRefs", "]"}]}], "}"}]}], "]"}], ";", 
      RowBox[{"purge3", "=", 
       RowBox[{"StringDelete", "[", 
        RowBox[{"purge2", ",", 
         RowBox[{"matchedPairs", "[", 
          RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"purge4", "=", 
       RowBox[{"StringReplace", "[", 
        RowBox[{"purge3", ",", 
         RowBox[{
          RowBox[{
           RowBox[{"#", "->", "\"\<\\\"\>\""}], "&"}], "/@", 
          RowBox[{"matchedPairs", "[", 
           RowBox[{"[", "4", "]"}], "]"}]}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{"purge4", ",", "inTextRefThread"}], "}"}]}]}], 
    "\[IndentingNewLine]", "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9236422999852715`*^9, 3.9236423238368416`*^9}, {
   3.9236424489818487`*^9, 3.9236425276431675`*^9}, {3.9236426712888403`*^9, 
   3.9236427512688503`*^9}, {3.92364278129393*^9, 3.923642782053089*^9}, {
   3.923642841135556*^9, 3.9236428431461945`*^9}, 3.9236474384792333`*^9, {
   3.9237396186930037`*^9, 3.923739663131883*^9}, {3.9238975171360455`*^9, 
   3.9238975981877036`*^9}, {3.923897766247942*^9, 3.923897780212943*^9}, {
   3.923916729307378*^9, 3.9239167319585223`*^9}, {3.923917858194709*^9, 
   3.923917875807403*^9}, {3.9239183080179367`*^9, 3.9239184149167805`*^9}, {
   3.9239184506179495`*^9, 3.9239184535753527`*^9}, {3.923922690900379*^9, 
   3.9239227780833178`*^9}, {3.9239228283110476`*^9, 3.923922853468847*^9}, {
   3.923922917753669*^9, 3.9239229570060253`*^9}, {3.9239231290693016`*^9, 
   3.923923130120861*^9}, {3.9239232226212125`*^9, 3.9239232518859577`*^9}, {
   3.92392411867789*^9, 3.9239241259029074`*^9}, {3.923924695943609*^9, 
   3.923924696921685*^9}, {3.923925859738785*^9, 3.9239258628151274`*^9}, 
   3.923925999105748*^9, {3.923926060337489*^9, 3.923926092371087*^9}, 
   3.923931142334388*^9, {3.9239313006662207`*^9, 3.923931302743184*^9}, 
   3.9239378294962177`*^9, {3.924017615962492*^9, 3.9240176189746647`*^9}, {
   3.924077269023774*^9, 3.9240773081500015`*^9}, {3.9240774790785465`*^9, 
   3.9240775232626534`*^9}, 3.9240817879825697`*^9, {3.9240832761801214`*^9, 
   3.924083281820998*^9}, 3.9240868204723654`*^9, {3.9240872073185263`*^9, 
   3.924087217077185*^9}, {3.924087575827518*^9, 3.924087577845436*^9}, {
   3.961493465391971*^9, 3.961493497124851*^9}, {3.961494024561398*^9, 
   3.9614940317547894`*^9}, {3.961494243534335*^9, 3.961494302192946*^9}, 
   3.96149487294536*^9},
 CellLabel->"In[34]:=",ExpressionUUID->"3ce88bf2-2ea1-4e73-9c48-9e5346b6f124"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", 
     RowBox[{"-", "string"}]}], ",", 
    RowBox[{
     RowBox[{"-", "marker"}], " ", "to", " ", "identify", " ", "segments", 
     " ", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"e", ".", "g", "."}], ",", "\"\<{{refn\>\""}], ")"}]}], ",", 
    RowBox[{
     RowBox[{"-", "start"}], " ", "marker", " ", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"e", ".", "g", "."}], ",", "\"\<{{\>\""}], ")"}]}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"-", "end"}], " ", "marker", " ", 
      RowBox[{"(", "\"\<}}\>\"", ")"}]}], ";", 
     RowBox[{"Output", ":", 
      RowBox[{
       RowBox[{"-", "Association"}], " ", "of", " ", 
       RowBox[{"{", 
        RowBox[{"start", ",", "end"}], "}"}], " ", "positions", " ", "to", 
       " ", "extracted", " ", "substrings"}]}], ";", 
     RowBox[{"Description", ":", 
      RowBox[{"Finds", " ", "segments", " ", "by", " ", "marker"}]}]}], ",", 
    RowBox[{
    "extracts", " ", "nested", " ", "substrings", " ", "between", " ", 
     "start", " ", "and", " ", "end"}], ",", 
    RowBox[{"and", " ", "maps", " ", "them", " ", "to", " ", 
     RowBox[{"positions", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"ExtractNestedSegments", "[", 
    RowBox[{
    "string_String", ",", "marker_String", ",", "start_String", ",", 
     "end_String"}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "markerPositions", ",", "startPositions", ",", "endPositions", ",", 
       "positions", ",", "validPos", ",", "segments", ",", 
       "validStringSegments", ",", "validStringPositions", ",", "processed", 
       ",", "processedStrings", ",", "processedPositions"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"markerPositions", "=", 
       RowBox[{"First", "/@", 
        RowBox[{"StringPosition", "[", 
         RowBox[{"string", ",", "marker"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"startPositions", "=", 
       RowBox[{"Prepend", "[", 
        RowBox[{"markerPositions", ",", "1"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"endPositions", "=", 
       RowBox[{
        RowBox[{"Append", "[", 
         RowBox[{"markerPositions", ",", 
          RowBox[{"StringLength", "[", "string", "]"}]}], "]"}], "-", "1"}]}],
       ";", "\[IndentingNewLine]", 
      RowBox[{"positions", "=", 
       RowBox[{"Transpose", "[", 
        RowBox[{"{", 
         RowBox[{"startPositions", ",", "endPositions"}], "}"}], "]"}]}], ";",
       "\[IndentingNewLine]", 
      RowBox[{"segments", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"StringTake", "[", 
          RowBox[{"string", ",", 
           RowBox[{"{", 
            RowBox[{"#", ",", "#2"}], "}"}]}], "]"}], "&"}], "@@@", 
        "positions"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"validPos", "=", 
       RowBox[{"MapIndexed", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"StringContainsQ", "[", 
              RowBox[{"#1", ",", "marker"}], "]"}], "&&", 
             RowBox[{"StringContainsQ", "[", 
              RowBox[{"#1", ",", "end"}], "]"}]}], ",", 
            RowBox[{"List", "[", 
             RowBox[{"First", "[", "#2", "]"}], "]"}], ",", "Nothing"}], 
           "]"}], "&"}], ",", "segments"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"validStringSegments", "=", 
       RowBox[{"Extract", "[", 
        RowBox[{"segments", ",", "validPos"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"validStringPositions", "=", 
       RowBox[{"Extract", "[", 
        RowBox[{"positions", ",", "validPos"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"processed", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"#", "===", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"{", "}"}], ",", 
                RowBox[{"{", "}"}]}], "}"}]}], ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"{", "segment", "}"}], ",", 
               RowBox[{"{", 
                RowBox[{"{", 
                 RowBox[{"1", ",", 
                  RowBox[{"StringLength", "@", "segment"}]}], "}"}], "}"}]}], 
              "}"}], ",", "#"}], "]"}], "&"}], "@", 
          RowBox[{"ExtractNestedSubstrings", "[", 
           RowBox[{"segment", ",", "start", ",", "end", ",", "False"}], 
           "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"segment", ",", "validStringSegments"}], "}"}]}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"processedStrings", "=", 
       RowBox[{"processed", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"processedPositions", "=", 
       RowBox[{
        RowBox[{"Flatten", "[", 
         RowBox[{
          RowBox[{"processed", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "2"}], "]"}], "]"}], ",", "1"}], "]"}], "+", 
        RowBox[{"validStringPositions", "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}], "-", "1"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"AssociationThread", "[", 
       RowBox[{"processedPositions", "->", "processedStrings"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.923730813381441*^9, 3.923730941268642*^9}, {
   3.923730973613451*^9, 3.9237310350528307`*^9}, {3.923731370221383*^9, 
   3.923731389828339*^9}, {3.9237314973176756`*^9, 3.923731508581123*^9}, {
   3.9237329309806547`*^9, 3.9237329521816483`*^9}, 3.9237330150774612`*^9, {
   3.9237330667413254`*^9, 3.923733097924673*^9}, {3.923733142957201*^9, 
   3.92373314492426*^9}, {3.923900850494251*^9, 3.923900853669878*^9}, {
   3.923901392702818*^9, 3.923901410769581*^9}, {3.9239014442539873`*^9, 
   3.9239015633859196`*^9}, {3.923901781994344*^9, 3.9239018529418573`*^9}, {
   3.9239057924945307`*^9, 3.923905879020382*^9}, {3.9239059115603905`*^9, 
   3.923905921616364*^9}, 3.924104156166548*^9, {3.9241090429075813`*^9, 
   3.924109045596582*^9}, {3.961493520677392*^9, 3.961493553285171*^9}, {
   3.9614935900078783`*^9, 3.961493672115415*^9}, {3.9614937072916527`*^9, 
   3.961493834640367*^9}, {3.9614939512189217`*^9, 3.961494002101849*^9}, {
   3.961494034611846*^9, 3.96149407090335*^9}, {3.9614941103283157`*^9, 
   3.961494122102693*^9}, {3.961494174443575*^9, 3.9614942383045073`*^9}, {
   3.961494312152245*^9, 3.9614943134696703`*^9}, {3.961494586048705*^9, 
   3.961494593448708*^9}, {3.961494643138695*^9, 3.9614946632341537`*^9}, {
   3.961494735293847*^9, 3.961494860278143*^9}},
 CellLabel->"In[35]:=",ExpressionUUID->"0ca3d6c5-cf7e-484c-b76a-092e5fd96902"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", 
     RowBox[{"-", "string"}]}], ",", " ", 
    RowBox[{
     RowBox[{"-", "marker"}], " ", "to", " ", "split"}], ",", " ", 
    RowBox[{
     RowBox[{"-", "start"}], " ", "marker"}], ",", " ", 
    RowBox[{
     RowBox[{
      RowBox[{"-", "end"}], " ", "marker"}], ";", 
     RowBox[{"Output", ":", 
      RowBox[{
       RowBox[{"-", "List"}], " ", "of", " ", "substrings", " ", "between", 
       " ", "start", " ", "and", " ", "end", " ", "after", " ", "marker"}]}], 
     ";", 
     RowBox[{"Description", ":", " ", 
      RowBox[{"Splits", " ", "string", " ", "by", " ", "marker"}]}]}], ",", 
    " ", 
    RowBox[{
    "finds", " ", "segments", " ", "with", " ", "marker", " ", "and", " ", 
     "end", " ", "with", " ", "ExtractNestedSegments"}], ",", 
    RowBox[{"and", " ", "extracts", " ", "nested", " ", "substrings"}], ",", 
    " ", 
    RowBox[{
     RowBox[{"e", ".", "g", ".", " ", "used"}], " ", "for", " ", 
     RowBox[{"filenames", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"ExtractFileNames", "[", 
    RowBox[{
    "string_String", ",", "marker_String", ",", "start_String", ",", 
     "end_String"}], "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"segments", ",", "validLinks", ",", "processedLinks"}], "}"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"StringLength", "@", "string"}], ">", "0"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"segments", "=", 
         RowBox[{"Prepend", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"marker", "<>", "#"}], "&"}], "/@", 
            RowBox[{"Rest", "[", 
             RowBox[{"StringSplit", "[", 
              RowBox[{"string", ",", "marker"}], "]"}], "]"}]}], ",", 
           RowBox[{"First", "[", 
            RowBox[{"StringSplit", "[", 
             RowBox[{"string", ",", "marker"}], "]"}], "]"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"validLinks", "=", 
         RowBox[{"Select", "[", 
          RowBox[{"segments", ",", 
           RowBox[{
            RowBox[{
             RowBox[{"StringContainsQ", "[", 
              RowBox[{"#", ",", "marker"}], "]"}], "&&", 
             RowBox[{"StringContainsQ", "[", 
              RowBox[{"#", ",", "end"}], "]"}]}], "&"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"processedLinks", "=", 
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"ExtractNestedSubstrings", "[", 
              RowBox[{"#", ",", "start", ",", "end", ",", "False"}], "]"}], 
             "[", 
             RowBox[{"[", "1", "]"}], "]"}], "&"}], "/@", "validLinks"}], 
          "]"}]}]}], ",", "\[IndentingNewLine]", "\"\<\>\""}], "]"}]}], 
    "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.923730813381441*^9, 3.923730941268642*^9}, {
   3.923730973613451*^9, 3.9237310350528307`*^9}, {3.923731370221383*^9, 
   3.923731389828339*^9}, {3.9237314973176756`*^9, 3.923731508581123*^9}, {
   3.9237329309806547`*^9, 3.9237329521816483`*^9}, 3.9237330150774612`*^9, {
   3.9237330667413254`*^9, 3.923733097924673*^9}, {3.923733142957201*^9, 
   3.92373314492426*^9}, {3.923900850494251*^9, 3.923900853669878*^9}, {
   3.923901392702818*^9, 3.9239013990385427`*^9}, {3.9239015066154585`*^9, 
   3.9239015078953605`*^9}, {3.923906156506024*^9, 3.923906160509652*^9}, {
   3.9239075284165373`*^9, 3.9239075309870825`*^9}, {3.924532985890553*^9, 
   3.9245330241692843`*^9}, {3.961494349295848*^9, 3.961494377895483*^9}, {
   3.9614944176740217`*^9, 3.961494482054266*^9}, {3.961494687419438*^9, 
   3.961494715797789*^9}},
 CellLabel->"In[36]:=",ExpressionUUID->"30235d10-fb5b-4cee-b68d-3f7cc9b60979"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", 
     RowBox[{
      RowBox[{"-", "text"}], " ", "string"}]}], ",", " ", 
    RowBox[{"start", " ", "delimiter"}], ",", " ", 
    RowBox[{"end", " ", "delimiter"}], ",", " ", 
    RowBox[{
     RowBox[{
     "allToggle", " ", "True", " ", "to", " ", "extract", " ", "all", " ", 
      "or", " ", "False", " ", "for", " ", "first"}], ";", 
     RowBox[{"Output", ":", 
      RowBox[{
       RowBox[{"-", "List"}], " ", 
       RowBox[{"{", 
        RowBox[{"substrings", ",", "positions"}], "}"}]}]}], ";", 
     RowBox[{"Description", ":", " ", 
      RowBox[{
      "Extracts", " ", "nested", " ", "substrings", " ", "between", " ", 
       "start", " ", "and", " ", "end"}]}]}], ",", 
    RowBox[{"tracking", " ", "depth", " ", "for", " ", "nested", " ", 
     RowBox[{"pairs", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"ExtractNestedSubstrings", "[", 
     RowBox[{"text_String", ",", "start_String", ",", "end_String", ",", 
      RowBox[{"allToggle_", ":", "True"}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"depth", "=", "0"}], ",", 
        RowBox[{"inBlock", "=", "False"}], ",", 
        RowBox[{"startPosition", "=", "0"}], ",", 
        RowBox[{"captures", "=", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"positions", "=", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"i", "=", "1"}], ",", "char", ",", 
        RowBox[{"startLength", "=", 
         RowBox[{"StringLength", "[", "start", "]"}]}], ",", 
        RowBox[{"endLength", "=", 
         RowBox[{"StringLength", "[", "end", "]"}]}], ",", "checkStart", ",", 
        "checkEnd", ",", "test"}], "}"}], ",", 
      RowBox[{
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"allToggle", "||", 
            RowBox[{
             RowBox[{"Length", "@", "captures"}], "==", "0"}]}], ",", 
           RowBox[{"i", "<=", 
            RowBox[{"StringLength", "[", "text", "]"}]}], ",", "False"}], 
          "]"}], ",", 
         RowBox[{
          RowBox[{"char", "=", 
           RowBox[{"StringTake", "[", 
            RowBox[{"text", ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", 
               RowBox[{"Min", "[", 
                RowBox[{
                 RowBox[{"i", "+", "startLength", "-", "1"}], ",", 
                 RowBox[{"StringLength", "[", "text", "]"}]}], "]"}]}], 
              "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"checkStart", "=", 
           RowBox[{"(", 
            RowBox[{"char", "===", "start"}], ")"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"checkEnd", "=", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"StringTake", "[", 
              RowBox[{"text", ",", 
               RowBox[{"{", 
                RowBox[{"i", ",", 
                 RowBox[{"Min", "[", 
                  RowBox[{
                   RowBox[{"i", "+", "endLength", "-", "1"}], ",", 
                   RowBox[{"StringLength", "[", "text", "]"}]}], "]"}]}], 
                "}"}]}], "]"}], "===", "end"}], ")"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{"checkStart", ",", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"depth", "==", "0"}], ",", 
               RowBox[{
                RowBox[{"inBlock", "=", "True"}], ";", 
                RowBox[{"(*", 
                 RowBox[{
                 "Start", " ", "of", " ", "a", " ", "new", " ", "block"}], 
                 "*)"}], 
                RowBox[{"startPosition", "=", "i"}], ";"}]}], " ", 
              RowBox[{"(*", 
               RowBox[{"Record", " ", "the", " ", "start", " ", "position"}], 
               "*)"}], "]"}], ";", "\[IndentingNewLine]", 
             RowBox[{"depth", "++"}], ";", "\[IndentingNewLine]", 
             RowBox[{"i", "+=", "startLength"}], ";", 
             RowBox[{"(*", 
              RowBox[{
              "Move", " ", "index", " ", "past", " ", "the", " ", "start", 
               " ", "delimiter"}], "*)"}], 
             RowBox[{"Continue", "[", "]"}], ";"}]}], "]"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{"checkEnd", ",", 
            RowBox[{
             RowBox[{"depth", "--"}], ";", "\[IndentingNewLine]", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"depth", "==", "0"}], "&&", "inBlock"}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"test", "=", 
                 RowBox[{"If", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"StringLength", "@", "text"}], ">=", 
                    RowBox[{"(", 
                    RowBox[{"endLength", "+", "i"}], ")"}]}], ",", 
                   RowBox[{"StringTake", "[", 
                    RowBox[{"text", ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"i", "+", "endLength"}], ",", 
                    RowBox[{"i", "+", "endLength"}]}], "}"}]}], "]"}], ",", 
                   "False"}], "]"}]}], ";", "\[IndentingNewLine]", 
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{"test", "===", "\"\<]\>\""}], ",", 
                  "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{"AppendTo", "[", 
                    RowBox[{"captures", ",", 
                    RowBox[{"StringTake", "[", 
                    RowBox[{"text", ",", 
                    RowBox[{"{", 
                    RowBox[{"startPosition", ",", 
                    RowBox[{"i", "+", "endLength"}]}], "}"}]}], "]"}]}], 
                    "]"}], ";", "\[IndentingNewLine]", 
                   RowBox[{"AppendTo", "[", 
                    RowBox[{"positions", ",", 
                    RowBox[{"{", 
                    RowBox[{"startPosition", ",", 
                    RowBox[{"i", "+", "endLength"}]}], "}"}]}], "]"}], ";"}], 
                  ",", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{"AppendTo", "[", 
                    RowBox[{"captures", ",", 
                    RowBox[{"StringTake", "[", 
                    RowBox[{"text", ",", 
                    RowBox[{"{", 
                    RowBox[{"startPosition", ",", 
                    RowBox[{"i", "+", "endLength", "-", "1"}]}], "}"}]}], 
                    "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
                   RowBox[{"AppendTo", "[", 
                    RowBox[{"positions", ",", 
                    RowBox[{"{", 
                    RowBox[{"startPosition", ",", 
                    RowBox[{"i", "+", "endLength", "-", "1"}]}], "}"}]}], 
                    "]"}], ";"}]}], "]"}], ";", 
                RowBox[{"(*", 
                 RowBox[{
                 "Capture", " ", "the", " ", "complete", " ", "block"}], 
                 "*)"}], 
                RowBox[{"inBlock", "=", "False"}], ";"}]}], "]"}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"i", "+=", "endLength"}], ";", 
             RowBox[{"(*", 
              RowBox[{
              "Move", " ", "index", " ", "past", " ", "the", " ", "end", " ", 
               "delimiter"}], "*)"}], 
             RowBox[{"Continue", "[", "]"}], ";"}]}], "]"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"i", "++"}], ";"}]}], " ", 
        RowBox[{"(*", 
         RowBox[{
         "Continue", " ", "to", " ", "next", " ", "character", " ", "if", " ",
           "no", " ", "delimiter", " ", "matched"}], "*)"}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"captures", ",", "positions"}], "}"}]}]}], "]"}]}], 
   ";"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9237293571768756`*^9, 3.9237294461259255`*^9}, 
   3.9237296142334156`*^9, {3.9237306453524475`*^9, 3.9237306881255703`*^9}, {
   3.9237307427345963`*^9, 3.923730747677971*^9}, 3.9237316576058416`*^9, {
   3.9239006356179857`*^9, 3.923900677237815*^9}, {3.9240037573793*^9, 
   3.9240037678505793`*^9}, 3.9240038651945586`*^9, {3.9240040234678183`*^9, 
   3.9240040894810567`*^9}, {3.9240041476267996`*^9, 
   3.9240041516901627`*^9}, {3.924004253042922*^9, 3.924004296449503*^9}, {
   3.9240043306988306`*^9, 3.9240043686735697`*^9}, {3.9240044818587236`*^9, 
   3.9240044951138973`*^9}, 3.9240045256666193`*^9, {3.9614945235681973`*^9, 
   3.961494562825932*^9}},
 CellLabel->"In[37]:=",ExpressionUUID->"26c9d838-304a-46e0-8e13-41facd61f52f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", 
     RowBox[{
      RowBox[{"-", "string"}], " ", "text", " ", "to", " ", "process"}]}], 
    ",", " ", 
    RowBox[{
     RowBox[{"-", "marker"}], " ", "substring", " ", "indicating", " ", 
     "style", " ", "box", " ", "sections"}], ",", 
    RowBox[{
     RowBox[{"-", "start"}], " ", "start", " ", "delimiter"}], ",", 
    RowBox[{
     RowBox[{"-", "end"}], " ", "end", " ", "delimiter"}], ",", " ", 
    RowBox[{
     RowBox[{
      RowBox[{"-", "threshold"}], " ", "length", " ", "above", " ", "which", 
      " ", "style", " ", "markup", " ", "is", " ", "removed"}], ";", 
     RowBox[{"Output", ":", 
      RowBox[{
       RowBox[{"-", "List"}], " ", "of", " ", 
       RowBox[{"{", 
        RowBox[{"original", ",", "cleaned"}], "}"}], " ", "string", " ", 
       "pairs", " ", "for", " ", "replacement"}]}], ";", 
     RowBox[{"Description", ":", 
      RowBox[{"Extracts", " ", "style", " ", "box", " ", "sections"}]}]}], 
    ",", " ", 
    RowBox[{
    "removes", " ", "style", " ", "or", " ", "table", " ", "markup", " ", 
     "if", " ", "content", " ", "exceeds", " ", "threshold"}], ",", 
    RowBox[{
    "and", " ", "prepares", " ", "replacements", " ", "for", " ", "cleaned", 
     " ", 
     RowBox[{"output", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"CleanLanguageTags", "[", "string_", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "tags", ",", "tagsSplit", ",", "tagsType", ",", "matchingConditions", 
       ",", "matchingPos", ",", "tagsClean", ",", "tagsExtract"}], "}"}], ",",
      "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"tags", "=", 
       RowBox[{"StringCases", "[", 
        RowBox[{"string", ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<\\\\{\\\\{([^\\\\}]|\\\\}[^\\\\}])*\\\\}\\\\}\>\"", "]"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"tags", "=", 
       RowBox[{"Select", "[", 
        RowBox[{"tags", ",", 
         RowBox[{
          RowBox[{
           RowBox[{"StringLength", "[", "#", "]"}], "<", "400"}], "&"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"tagsClean", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Length", "[", 
               RowBox[{"StringSplit", "[", 
                RowBox[{"#", ",", "\"\<|\>\""}], "]"}], "]"}], "==", "1"}], 
             ",", 
             RowBox[{"Last", "[", 
              RowBox[{"StringSplit", "[", 
               RowBox[{"tag", ",", "\"\<{{\>\""}], "]"}], "]"}], ",", "#"}], 
            "]"}], "&"}], "@", 
          RowBox[{"StringDelete", "[", 
           RowBox[{"tag", ",", 
            RowBox[{"StringCases", "[", 
             RowBox[{"tag", ",", 
              RowBox[{
              "RegularExpression", "[", 
               "\"\<(?<!^)\\\\{\\\\{.*?\\\\}\\\\}\>\"", "]"}]}], "]"}]}], 
           "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"tag", ",", "tags"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"tagsSplit", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"StringSplit", "[", 
          RowBox[{"#", ",", "\"\<|\>\""}], "]"}], "&"}], "/@", 
        "tagsClean"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"tagsType", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"Which", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"StringContainsQ", "[", 
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}], ",", 
             RowBox[{"Alternatives", "@", 
              RowBox[{"{", 
               RowBox[{
               "\"\<{{Nihongo\>\"", ",", "\"\<{{illm\>\"", ",", 
                "\"\<{{Interlanguage link\>\""}], "}"}]}], ",", 
             RowBox[{"IgnoreCase", "->", "True"}]}], "]"}], ",", 
           "\"\<second\>\"", ",", "\[IndentingNewLine]", 
           RowBox[{"StringContainsQ", "[", 
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}], ",", 
             RowBox[{"Alternatives", "@", 
              RowBox[{"{", 
               RowBox[{"\"\<{{Flag\>\"", ",", "\"\<{{Flagicon\>\""}], "}"}]}],
              ",", 
             RowBox[{"IgnoreCase", "->", "True"}]}], "]"}], ",", 
           "\"\<delete\>\"", ",", 
           RowBox[{"!", 
            RowBox[{"StringContainsQ", "[", 
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "1", "]"}], "]"}], ",", 
              RowBox[{"Alternatives", "@", 
               RowBox[{"{", 
                RowBox[{
                "\"\<{{Nihongo\>\"", ",", "\"\<{{illm\>\"", ",", 
                 "\"\<{{Interlanguage link\>\""}], "}"}]}], ",", 
              RowBox[{"IgnoreCase", "->", "True"}]}], "]"}]}], ",", 
           "\"\<last\>\""}], "]"}], "&"}], "/@", "tagsSplit"}]}], ";", 
      RowBox[{"matchingConditions", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"!", 
          RowBox[{"StringMatchQ", "[", 
           RowBox[{"#", ",", 
            RowBox[{"Alternatives", "@", 
             RowBox[{"{", 
              RowBox[{"\"\<\>\"", ",", "\"\<}}\>\"", ",", "\"\<{{\>\""}], 
              "}"}]}]}], "]"}]}], "&&", 
         RowBox[{"!", 
          RowBox[{"StringContainsQ", "[", 
           RowBox[{"#", ",", "\"\<=\>\""}], "]"}]}]}], "&"}]}], ";", 
      RowBox[{"matchingPos", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"Position", "[", 
          RowBox[{"#", ",", 
           RowBox[{"_String", "?", "matchingConditions"}]}], "]"}], "&"}], "/@",
         "tagsSplit"}]}], ";", 
      RowBox[{"tagsExtract", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"StringReplace", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Which", "[", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"tagsType", "[", 
               RowBox[{"[", "i", "]"}], "]"}], "==", "\"\<last\>\""}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Length", "@", 
                 RowBox[{"matchingPos", "[", 
                  RowBox[{"[", "i", "]"}], "]"}]}], ">", "0"}], ",", 
               RowBox[{"Extract", "[", 
                RowBox[{
                 RowBox[{"tagsSplit", "[", 
                  RowBox[{"[", "i", "]"}], "]"}], ",", 
                 RowBox[{"Last", "[", 
                  RowBox[{"matchingPos", "[", 
                   RowBox[{"[", "i", "]"}], "]"}], "]"}]}], "]"}], ",", 
               "\"\<\>\""}], "]"}], ",", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"tagsType", "[", 
               RowBox[{"[", "i", "]"}], "]"}], "==", "\"\<second\>\""}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Length", "@", 
                 RowBox[{"matchingPos", "[", 
                  RowBox[{"[", "i", "]"}], "]"}]}], ">", "1"}], ",", 
               RowBox[{"Extract", "[", 
                RowBox[{
                 RowBox[{"tagsSplit", "[", 
                  RowBox[{"[", "i", "]"}], "]"}], ",", 
                 RowBox[{"matchingPos", "[", 
                  RowBox[{"[", 
                   RowBox[{"i", ",", "2"}], "]"}], "]"}]}], "]"}], ",", 
               "\"\<\>\""}], "]"}], ",", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"tagsType", "[", 
               RowBox[{"[", "i", "]"}], "]"}], "==", "\"\<delete\>\""}], ",", 
             "\[IndentingNewLine]", "\"\<\>\""}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"\"\<}}\>\"", "->", "\"\<\>\""}], ",", 
             RowBox[{"\"\<{{\>\"", "->", "\"\<\>\""}], ",", 
             RowBox[{"\"\<'''\>\"", "->", "\"\<\\\"\>\""}], ",", 
             RowBox[{"\"\<''\>\"", "->", "\"\<\\\"\>\""}]}], "}"}]}], "]"}], 
         ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"Length", "@", "matchingPos"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"StringReplace", "[", 
       RowBox[{"string", ",", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"#", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "->", 
           RowBox[{"StringReplace", "[", 
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}], ",", 
             RowBox[{"\"\<;\>\"", "->", "\"\<\>\""}]}], "]"}]}], "&"}], "/@", 
         RowBox[{"Transpose", "[", 
          RowBox[{"{", 
           RowBox[{"tags", ",", "tagsExtract"}], "}"}], "]"}]}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9241603498483763`*^9, 3.924160358254377*^9}, {
   3.9241608454696827`*^9, 3.924160981438079*^9}, {3.924161088158433*^9, 
   3.9241611185115047`*^9}, 3.9241612509118996`*^9, {3.9241630994763713`*^9, 
   3.924163136486514*^9}, 3.924163210559659*^9, 3.9241632534319563`*^9, {
   3.9241633414397097`*^9, 3.924163407366785*^9}, {3.9241639615280714`*^9, 
   3.924164020303287*^9}, {3.9241641695350947`*^9, 3.9241641813823795`*^9}, 
   3.9241674226230764`*^9, {3.9241675423526864`*^9, 3.924167542718687*^9}, {
   3.924167620622248*^9, 3.9241676262142487`*^9}, {3.9241677943835983`*^9, 
   3.924167837533745*^9}, {3.9241711902073565`*^9, 3.9241711925493555`*^9}, 
   3.924171836903056*^9, {3.924171867687194*^9, 3.924171932013671*^9}, {
   3.9241721031750183`*^9, 3.9241721880381536`*^9}, {3.924172516189434*^9, 
   3.9241726146387434`*^9}, 3.9241727150479784`*^9, {3.9242591499131813`*^9, 
   3.924259150502181*^9}, {3.924342250569397*^9, 3.924342268909171*^9}, {
   3.9243426859441805`*^9, 3.9243426930413475`*^9}, {3.9243427344303637`*^9, 
   3.924342752437563*^9}, {3.9243430577562294`*^9, 3.924343101784419*^9}, {
   3.924408220389005*^9, 3.9244082276058226`*^9}, {3.9244083702551374`*^9, 
   3.924408373609702*^9}, {3.9244324053292637`*^9, 3.924432423851227*^9}, {
   3.92443312931634*^9, 3.9244331365253105`*^9}, {3.924434445899692*^9, 
   3.9244344463420773`*^9}, {3.924435008304433*^9, 3.9244350187467375`*^9}, {
   3.9244363378440156`*^9, 3.9244363460462656`*^9}, {3.924436983014611*^9, 
   3.92443698944267*^9}, {3.9244371837616396`*^9, 3.9244372352379026`*^9}, {
   3.9244375840496283`*^9, 3.9244375843589325`*^9}, {3.961338418445723*^9, 
   3.961338419712475*^9}, {3.961494911817975*^9, 3.961494943152742*^9}, {
   3.9614950235956097`*^9, 3.961495026253462*^9}, {3.961495065235585*^9, 
   3.961495077710287*^9}},
 CellLabel->"In[38]:=",ExpressionUUID->"a0962fc2-ab06-4c3a-bc3c-e9054b96990c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", 
     RowBox[{
      RowBox[{"-", "string"}], " ", "text", " ", "to", " ", "process"}]}], 
    ",", 
    RowBox[{
     RowBox[{"-", "marker"}], " ", "substring", " ", "indicating", " ", 
     "style", " ", "box", " ", "sections"}], ",", 
    RowBox[{
     RowBox[{"-", "start"}], " ", "start", " ", "delimiter"}], ",", 
    RowBox[{
     RowBox[{"-", "end"}], " ", "end", " ", "delimiter"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"-", "threshold"}], " ", "length", " ", "above", " ", "which", 
      " ", "style", " ", "markup", " ", "is", " ", "removed"}], ";", 
     RowBox[{"Output", ":", 
      RowBox[{
       RowBox[{"-", "List"}], " ", "of", " ", 
       RowBox[{"{", 
        RowBox[{"original", ",", " ", "cleaned"}], "}"}], " ", "string", " ", 
       "pairs", " ", "for", " ", "replacement"}]}], ";", 
     RowBox[{"Description", ":", 
      RowBox[{"Extracts", " ", "style", " ", "box", " ", "sections"}]}]}], 
    ",", " ", 
    RowBox[{
    "removes", " ", "style", " ", "or", " ", "table", " ", "markup", " ", 
     "if", " ", "content", " ", "exceeds", " ", "threshold"}], ",", 
    RowBox[{
     RowBox[{
     "and", " ", "prepares", " ", "replacements", " ", "for", " ", "cleaned", 
      " ", "output"}], " ", "-", " ", 
     RowBox[{"prevents", " ", "formatted", " ", "text", " ", "getting", " ", 
      RowBox[{"lost", "."}]}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"FindStringInStyleBoxes", "[", 
    RowBox[{
    "string_", ",", "marker_", ",", "start_", ",", "end_", ",", 
     "threshold_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"styleBoxCases", ",", "styleBoxReplacements"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"styleBoxCases", "=", 
       RowBox[{"ExtractFileNames", "[", 
        RowBox[{"string", ",", "marker", " ", ",", "start", ",", "end"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"styleBoxReplacements", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"StringRiffle", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"StringLength", "@", "#"}], ">", "threshold"}], 
                    ",", 
                    RowBox[{"StringReplace", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    "RegularExpression", "[", 
                    "\"\<(?i)(\\\\{\\\\|\\\\s?style|\\\\|\\\\s?style)[\\\\s\\\
\\S]*?\\\\|\>\"", "]"}], "->", "\"\<\>\""}], ",", 
                    RowBox[{"\"\<{|\>\"", "->", "\"\<\>\""}], ",", 
                    RowBox[{"\"\<|}\>\"", "->", "\"\<\>\""}], ",", 
                    RowBox[{"\"\<+\>\"", "->", "\"\<\>\""}]}], "}"}]}], "]"}],
                     ",", "\"\<\>\""}], "]"}], "&"}], "/@", 
                 RowBox[{"If", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"Length", "@", "#"}], ">", "1"}], ",", 
                   RowBox[{"#", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ";;"}], "]"}], "]"}], ",", "#"}], "]"}]}], 
                "&"}], "@", 
               RowBox[{"StringSplit", "[", 
                RowBox[{"#", ",", "\"\< | \>\""}], "]"}]}], "&"}], "/@", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Length", "@", "#"}], ">", "1"}], ",", 
               RowBox[{"#", "[", 
                RowBox[{"[", 
                 RowBox[{"2", ";;"}], "]"}], "]"}], ",", "#"}], "]"}]}], 
            "&"}], "@", 
           RowBox[{"StringSplit", "[", 
            RowBox[{"#", ",", "\"\<|-\>\""}], "]"}]}], "]"}], "&"}], "/@", 
        "styleBoxCases"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"#", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "->", 
         RowBox[{"#", "[", 
          RowBox[{"[", "2", "]"}], "]"}]}], "&"}], "/@", 
       RowBox[{"Transpose", "[", 
        RowBox[{"{", 
         RowBox[{"styleBoxCases", ",", "styleBoxReplacements"}], "}"}], 
        "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9242812457822094`*^9, 3.9242813959976077`*^9}, 
   3.924281571407838*^9, 3.9242821000690403`*^9, 3.9242826577764053`*^9, 
   3.9242827446136703`*^9, {3.924282828952747*^9, 3.9242828308732176`*^9}, 
   3.924282884748375*^9, {3.9242834481345882`*^9, 3.9242834851042037`*^9}, {
   3.9242836237229004`*^9, 3.924283643566604*^9}, 3.9242837114404287`*^9, {
   3.924283994375836*^9, 3.924284024966485*^9}, {3.924284149874016*^9, 
   3.924284149978527*^9}, {3.924284209064844*^9, 3.924284233765153*^9}, {
   3.9242843010057383`*^9, 3.9242843077593226`*^9}, {3.9242856137161193`*^9, 
   3.924285616292779*^9}, {3.92428603662339*^9, 3.9242860619816275`*^9}, {
   3.9242861386843596`*^9, 3.9242861520639887`*^9}, {3.9242866224143867`*^9, 
   3.9242866271704226`*^9}, {3.924286740392872*^9, 3.9242867804280443`*^9}, {
   3.92432005243396*^9, 3.92432007573731*^9}, {3.961494961580867*^9, 
   3.961494969051793*^9}, 3.9614950132003613`*^9, {3.9614952542889347`*^9, 
   3.961495286781081*^9}},
 CellLabel->"In[39]:=",ExpressionUUID->"d5d05a87-4571-4326-92e8-687ebf13a5d9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Input", ":", 
      RowBox[{
       RowBox[{"-", "wikiCode"}], " ", "raw", " ", "Wiki", " ", "markup", " ",
        "string"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Output", ":", 
      RowBox[{
       RowBox[{"-", "Association"}], " ", "with", " ", "cleaned", " ", 
       "plain", " ", "text"}]}]}], ",", " ", 
    RowBox[{"extracted", " ", "references"}], ",", "sources", ",", " ", 
    RowBox[{"media", " ", "captions"}], ",", " ", 
    RowBox[{
     RowBox[{"and", " ", "media", " ", "links"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Description", ":", " ", 
      RowBox[{
      "Cleans", " ", "and", " ", "parses", " ", "Wiki", " ", "markup", " ", 
       "by", " ", "removing", " ", "templates"}]}]}], ",", " ", 
    RowBox[{"nested", " ", "references"}], ",", " ", 
    RowBox[{"language", " ", "and", " ", "style", " ", "tags"}], ",", 
    RowBox[{"media", " ", "frames"}], ",", " ", 
    RowBox[{
     RowBox[{"and", " ", "other", " ", "Wiki"}], "-", 
     RowBox[{"specific", " ", 
      RowBox[{"markup", ".", " ", "Extracts"}], " ", "in"}], "-", 
     RowBox[{"text", " ", "references"}]}], ",", " ", 
    RowBox[{"bibliography", " ", "entries"}], ",", 
    RowBox[{"media", " ", "captions"}], ",", " ", 
    RowBox[{
    "and", " ", "file", " ", "links", " ", "into", " ", "separate", " ", 
     "fields", " ", "returning", " ", "a", " ", "structured", " ", 
     "plaintext", " ", "version", " ", "along", " ", "with", " ", "relevant", 
     " ", "metadata", " ", "for", " ", "downstream", " ", 
     RowBox[{"use", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"CleanWikiCode", "[", "wikiCode_", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "wikiCodeHTML", ",", "mainSection", ",", "mainSectionSplit", ",", 
       "inTextRef", ",", "numbersRefNoDup", ",", "refAssoc", ",", 
       "numbersRef", ",", "inTextRefClean", ",", "inTextRefThread", ",", 
       "mainSectionNoRef", ",", "fileLinks", ",", "fileLinksSimple", ",", 
       "ite", ",", "numbersFiles", ",", "links", ",", "linksThread", ",", 
       "captions", ",", "captionsThread", ",", "mainSectionNoRefNoLink", ",", 
       "body", ",", "referenceSection", ",", "references", ",", 
       "cleanCitRefReplacements", ",", "biblioRef", ",", "biblioRefPos", ",", 
       "biblioRefClean", ",", "sources", ",", "para", ",", "htmlRefAssoc", 
       ",", "deleteTemp"}], "}"}], ",", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Attempts", " ", "splitting", " ", "at", " ", "key", " ", "headers", 
       " ", "to", " ", "find", " ", "the", " ", "main", " ", "section"}], 
      "*)"}], 
     RowBox[{
      RowBox[{"mainSectionSplit", "=", 
       RowBox[{"StringSplit", "[", 
        RowBox[{"wikiCode", ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<={1,6}\\\\s?((?i)references)\\\\s?={1,6}\>\"", "]"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mainSection", "=", 
       RowBox[{
        RowBox[{"StringSplit", "[", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "@", "mainSectionSplit"}], ">", "0"}], ",", 
            RowBox[{"mainSectionSplit", "[", 
             RowBox[{"[", "1", "]"}], "]"}], ",", "mainSectionSplit"}], "]"}],
           ",", 
          RowBox[{
          "RegularExpression", "[", 
           "\"\<={1,6}\\\\s?((?i)see also)\\\\s?={1,6}\>\"", "]"}]}], "]"}], 
        "[", 
        RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mainSection", "=", 
       RowBox[{
        RowBox[{"StringSplit", "[", 
         RowBox[{"mainSection", ",", 
          RowBox[{
          "RegularExpression", "[", 
           "\"\<={1,6}\\\\s?((?i)notes)\\\\s?={1,6}\>\"", "]"}]}], "]"}], "[", 
        RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mainSection", "=", 
       RowBox[{
        RowBox[{"StringSplit", "[", 
         RowBox[{"mainSection", ",", 
          RowBox[{
          "RegularExpression", "[", 
           "\"\<={1,6}\\\\s?((?i)selected bibliography)\\\\s?={1,6}\>\"", 
           "]"}]}], "]"}], "[", 
        RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mainSection", "=", 
       RowBox[{
        RowBox[{"StringSplit", "[", 
         RowBox[{"mainSection", ",", 
          RowBox[{
          "RegularExpression", "[", 
           "\"\<={1,6}\\\\s?((?i)bibliography)\\\\s?={1,6}\>\"", "]"}]}], 
         "]"}], "[", 
        RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"referenceSection", "=", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Length", "@", "mainSectionSplit"}], ">", "0"}], ",", 
         RowBox[{"Last", "@", "mainSectionSplit"}], ",", "mainSectionSplit"}],
         "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mainSection", "=", 
       RowBox[{"StringReplace", "[", 
        RowBox[{
         RowBox[{"DecodeHTML", "[", "mainSection", "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"\"\<{{nbsp}}\>\"", "->", "\"\< \>\""}], "}"}]}], "]"}]}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "Find", " ", "possibly", " ", "nested", " ", "templates", " ", "that", 
        " ", "need", " ", "to", " ", "be", " ", "deleted"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{"mainSection", "=", 
         RowBox[{"StringDelete", "[", 
          RowBox[{"mainSection", ",", 
           RowBox[{"ExtractFileNames", "[", 
            RowBox[{
            "mainSection", ",", "\"\<{{efn|Pronunciation\>\"", ",", 
             "\"\<{{\>\"", ",", "\"\<}}\>\""}], "]"}]}], "]"}]}], ",", "2"}], 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{"mainSection", "=", 
         RowBox[{"StringDelete", "[", 
          RowBox[{"mainSection", ",", 
           RowBox[{"ExtractFileNames", "[", 
            RowBox[{
            "mainSection", ",", "\"\<{{Infobox\>\"", ",", "\"\<{{\>\"", ",", 
             "\"\<}}\>\""}], "]"}]}], "]"}]}], ",", "2"}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{"mainSection", "=", 
         RowBox[{"StringDelete", "[", 
          RowBox[{"mainSection", ",", 
           RowBox[{"ExtractFileNames", "[", 
            RowBox[{
            "mainSection", ",", "\"\<{{Distinguish\>\"", ",", "\"\<{{\>\"", 
             ",", "\"\<}}\>\""}], "]"}]}], "]"}]}], ",", "2"}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{"mainSection", "=", 
         RowBox[{"StringDelete", "[", 
          RowBox[{"mainSection", ",", 
           RowBox[{"ExtractFileNames", "[", 
            RowBox[{
            "mainSection", ",", "\"\<{{Unbulleted list\>\"", ",", 
             "\"\<{{\>\"", ",", "\"\<}}\>\""}], "]"}]}], "]"}]}], ",", "2"}], 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{"mainSection", "=", 
         RowBox[{"StringDelete", "[", 
          RowBox[{"mainSection", ",", 
           RowBox[{"ExtractFileNames", "[", 
            RowBox[{
            "mainSection", ",", "\"\<{{etymology|\>\"", ",", "\"\<{{\>\"", 
             ",", "\"\<}}\>\""}], "]"}]}], "]"}]}], ",", "2"}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{"mainSection", "=", 
         RowBox[{"StringDelete", "[", 
          RowBox[{"mainSection", ",", 
           RowBox[{"ExtractFileNames", "[", 
            RowBox[{
            "mainSection", ",", "\"\<{{Redirect\>\"", ",", "\"\<{{\>\"", ",", 
             "\"\<}}\>\""}], "]"}]}], "]"}]}], ",", "2"}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{"mainSection", "=", 
         RowBox[{"StringDelete", "[", 
          RowBox[{"mainSection", ",", 
           RowBox[{"ExtractFileNames", "[", 
            RowBox[{
            "mainSection", ",", "\"\<{{Automatic taxobox\>\"", ",", 
             "\"\<{{\>\"", ",", "\"\<}}\>\""}], "]"}]}], "]"}]}], ",", "2"}], 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{"mainSection", "=", 
         RowBox[{"StringDelete", "[", 
          RowBox[{"mainSection", ",", 
           RowBox[{"ExtractFileNames", "[", 
            RowBox[{
            "mainSection", ",", "\"\<{{Quote box\>\"", ",", "\"\<{{\>\"", 
             ",", "\"\<}}\>\""}], "]"}]}], "]"}]}], ",", "2"}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{"mainSection", "=", 
         RowBox[{"StringDelete", "[", 
          RowBox[{"mainSection", ",", 
           RowBox[{"ExtractFileNames", "[", 
            RowBox[{
            "mainSection", ",", "\"\<{{Weather box\>\"", ",", "\"\<{{\>\"", 
             ",", "\"\<}}\>\""}], "]"}]}], "]"}]}], ",", "2"}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{"mainSection", "=", 
         RowBox[{"StringDelete", "[", 
          RowBox[{"mainSection", ",", 
           RowBox[{"ExtractFileNames", "[", 
            RowBox[{
            "mainSection", ",", "\"\<{{Div col\>\"", ",", "\"\<{{\>\"", ",", 
             "\"\<}}\>\""}], "]"}]}], "]"}]}], ",", "2"}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Delete", " ", "non"}], "-", 
        RowBox[{"nested", " ", "Wikipedia", " ", "templates", " ", "case"}], 
        "-", 
        RowBox[{"insensitively", " ", "with", " ", "Regex"}]}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"deleteTemp", "=", 
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
         "RegularExpression", "[", 
          "\"\<\\\\{\\\\|\\\\s?class[\\\\s\\\\S]*?\\\\|\\\\}\>\"", "]"}], ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<(?i)\\\\{\\\\{IPAc-en[^}]*\\\\}\\\\}\>\"", "]"}], ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<(?i)\\\\{\\\\{Main[^}]*\\\\}\\\\}\>\"", "]"}], ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<(?i)\\\\{\\\\{respell[^}]*\\\\}\\\\}\>\"", "]"}], ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<(?i)\\\\{\\\\{IMSLP[^}]*\\\\}\\\\}\>\"", "]"}], ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<(?i)\\\\{\\\\{short description[^}]*\\\\}\\\\}\>\"", "]"}], 
         ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<(?i)\\\\{\\\\{Pp-move[^}]*\\\\}\\\\}\>\"", "]"}], ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<(?i)\\\\{\\\\{Use dmy[^}]*\\\\}\\\\}\>\"", "]"}], ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<(?i)\\\\{\\\\{chem2\\\\|[^}]*\\\\}\\\\}\>\"", "]"}], ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<(?i)\\\\{\\\\{chem\\\\|[^}]*\\\\}\\\\}\>\"", "]"}], ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<(?i)\\\\{\\\\{rp\\\\|[^}]*\\\\}\\\\}\>\"", "]"}], ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<(?i)\\\\{\\\\{anchor\\\\|[^}]*\\\\}\\\\}\>\"", "]"}], ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<(?i)\\\\{\\\\{DentalFormula\\\\|[^}]*\\\\}\\\\}\>\"", "]"}], 
         ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<(?i)\\\\{\\\\{Listen\\\\|[^}]*\\\\}\\\\}\>\"", "]"}], ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<(?i)\\\\{\\\\{Maplink\\\\|[^}]*\\\\}\\\\}\>\"", "]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<(?i)\\\\{\\\\{interlinear\\\\|[^}]*\\\\}\\\\}\>\"", "]"}], ",",
          "\[IndentingNewLine]", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<(?i)\\\\{\\\\{fs interlinear\\\\|[^}]*\\\\}\\\\}\>\"", "]"}], 
         ",", "\[IndentingNewLine]", 
         RowBox[{
         "RegularExpression", "[", "\"\<\\\\{\\\\{IPA[^}]*\\\\}\\\\}\>\"", 
          "]"}], ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<\\\\{\\\\{YouTube\\\\|[^}]*\\\\}\\\\}\>\"", "]"}], ",", 
         RowBox[{
         "RegularExpression", "[", 
          "\"\<\\\\{\\\\{fact\\\\|[^}]*\\\\}\\\\}\>\"", "]"}]}], " ", "}"}]}],
       ";", "\[IndentingNewLine]", 
      RowBox[{"mainSection", "=", 
       RowBox[{"StringReplace", "[", 
        RowBox[{"mainSection", ",", 
         RowBox[{
          RowBox[{"Alternatives", "@@", "deleteTemp"}], "->", "\"\<\>\""}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "Free", " ", "quotes", " ", "from", " ", "their", " ", "templates"}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"mainSection", "=", 
       RowBox[{"StringReplace", "[", 
        RowBox[{"mainSection", ",", 
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "->", 
             RowBox[{"\"\<\\\"\>\"", "<>", 
              RowBox[{"StringReplace", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{
                   RowBox[{
                   "RegularExpression", "[", 
                    "\"\<(?i)\\\\{\\\\{\\\\s?blockquote[\\\\s\\\\S]*?\\\\|\>\"\
", "]"}], "->", "\"\<\>\""}], ",", 
                  RowBox[{
                   RowBox[{
                   "RegularExpression", "[", "\"\<(?i)text*?=\>\"", "]"}], 
                   "->", "\"\<\>\""}]}], "}"}]}], "]"}], "<>", 
              "\"\<\\\"\>\""}]}], "&"}], "/@", 
           RowBox[{"StringCases", "[", 
            RowBox[{"mainSection", ",", 
             RowBox[{
             "RegularExpression", "[", 
              "\"\<(?i)\\\\{\\\\{\\\\s?blockquote[\\\\s\\\\S]*?\\\\}\\\\}\>\"\
", "]"}]}], "]"}]}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "Free", " ", "poems", " ", "from", " ", "their", " ", "templates"}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"mainSection", "=", 
       RowBox[{"StringReplace", "[", 
        RowBox[{"mainSection", ",", 
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "->", 
             RowBox[{"\"\<\\\"\>\"", "<>", 
              RowBox[{"StringTrim", "@", 
               RowBox[{
                RowBox[{"StringSplit", "[", 
                 RowBox[{
                  RowBox[{"StringReplace", "[", 
                   RowBox[{"#", ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    "RegularExpression", "[", 
                    "\"\<(?i)\\\\{\\\\{\\\\s?(subst:)?poem[\\\\s\\\\S]*?\\\\|\
\>\"", "]"}], "->", "\"\<\>\""}], ",", 
                    RowBox[{
                    RowBox[{
                    "RegularExpression", "[", "\"\<(?i)(text|1)\\\\s*?=\>\"", 
                    "]"}], "->", "\"\<\>\""}]}], "}"}]}], "]"}], ",", 
                  "\"\<|\>\""}], "]"}], "[", 
                RowBox[{"[", "1", "]"}], "]"}]}], "<>", "\"\<\\\"\>\""}]}], 
            "&"}], "/@", 
           RowBox[{"StringCases", "[", 
            RowBox[{"mainSection", ",", 
             RowBox[{
             "RegularExpression", "[", 
              "\"\<(?i)\\\\{\\\\{\\\\s?(subst:)?poem[\\\\s\\\\S]*?\\\\}\\\\}\>\
\"", "]"}]}], "]"}]}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "Delete", " ", "style", " ", "box", " ", "frames", " ", "that", " ", 
        "might", " ", "contain", " ", "good", " ", "text"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"mainSection", "=", 
       RowBox[{"StringReplace", "[", 
        RowBox[{"mainSection", ",", 
         RowBox[{"FindStringInStyleBoxes", "[", 
          RowBox[{
          "mainSection", ",", "\"\<{| style=\>\"", ",", "\"\<{|\>\"", ",", 
           "\"\<|}\>\"", ",", "100"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"mainSection", "==", 
       RowBox[{"StringReplace", "[", 
        RowBox[{"mainSection", ",", 
         RowBox[{"FindStringInStyleBoxes", "[", 
          RowBox[{
          "mainSection", ",", "\"\<{|style=\>\"", ",", "\"\<{|\>\"", ",", 
           "\"\<|}\>\"", ",", "100"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Replace", " ", "patterns", " ", 
        RowBox[{"of", " ", "[", 
         RowBox[{"[", "]"}], "]"}], " ", "with", " ", "captured", " ", 
        RowBox[{"{", 
         RowBox[{"{", "}"}], "}"}], " ", "inside"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"mainSection", "=", 
       RowBox[{"StringReplace", "[", 
        RowBox[{"mainSection", ",", 
         RowBox[{"StringCases", "[", 
          RowBox[{"mainSection", ",", 
           RowBox[{
            RowBox[{
            "RegularExpression", "[", 
             "\"\<\\\\[\\\\[(?!File:|Image:)[^\\\\|\\\\]]*\\\\|(\\\\{\\\\{[^\\\
\\|\\\\}]+\\\\|[^\\\\}]+\\\\}\\\\})[^\\\\]]*\\\\]\\\\]\>\"", "]"}], ":>", 
            RowBox[{"Rule", "[", 
             RowBox[{"\"\<$0\>\"", ",", "\"\<$1\>\""}], "]"}]}]}], "]"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "Replace", " ", "patterns", " ", "with", " ", "captured", " ", 
        "content", " ", 
        RowBox[{"inside", "[", 
         RowBox[{"[", 
          RowBox[{
           RowBox[{"and", " ", "before"}], "|", " ", 
           RowBox[{
           "to", " ", "get", " ", "rid", " ", "of", " ", "double", " ", 
            "terms"}]}]}]}]}], "*)"}], 
      RowBox[{"mainSection", "=", 
       RowBox[{"StringReplace", "[", 
        RowBox[{"mainSection", ",", 
         RowBox[{
          RowBox[{
          "RegularExpression", "[", 
           "\"\<\\\\[\\\\[(?!File:|Image:)([^\\\\|\\\\]]*\\\\|)([^\\\\|\\\\]]+\
)[^\\\\]]*\\\\]\\\\]\>\"", "]"}], ":>", 
          RowBox[{"\"\<[[\>\"", "<>", "\"\<$2\>\"", "<>", "\"\<]]\>\""}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Replace", " ", "unit", " ", "conversions"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"mainSection", "=", 
       RowBox[{"StringReplace", "[", 
        RowBox[{"mainSection", ",", 
         RowBox[{
          RowBox[{
           RowBox[{"#", "->", 
            RowBox[{"StringRiffle", "[", 
             RowBox[{
              RowBox[{"StringSplit", "[", 
               RowBox[{
                RowBox[{"StringDelete", "[", 
                 RowBox[{"#", ",", 
                  RowBox[{"{", 
                   RowBox[{"\"\<{{\>\"", ",", "\"\<}}\>\""}], "}"}]}], "]"}], 
                ",", "\"\<|\>\""}], "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"2", ";;", 
                RowBox[{"UpTo", "[", "3", "]"}]}], "]"}], "]"}], "]"}]}], 
           "&"}], "/@", 
          RowBox[{"StringCases", "[", 
           RowBox[{"mainSection", ",", 
            RowBox[{"\"\<{{convert|\>\"", "~~", 
             RowBox[{
              RowBox[{"Except", "[", "\"\<}\>\"", "]"}], ".."}], "~~", 
             "\"\<}}\>\""}]}], "]"}]}]}], "]"}]}], ";", "\[IndentingNewLine]",
       "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "Read", " ", "out", " ", "and", " ", "match", " ", "HTML", " ", 
        "Tags"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"mainSection", ",", "htmlRefAssoc"}], "}"}], "=", 
       RowBox[{"ClearHTML", "[", "mainSection", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"mainSection", "=", 
       RowBox[{"StringDelete", "[", 
        RowBox[{"mainSection", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"RegularExpression", "[", "\"\<<;[^<>]*>;\>\"", "]"}], ",", 
           RowBox[{
           "RegularExpression", "[", "\"\<<;!--[\\\\s\\\\S]*?-->;\>\"", 
            "]"}]}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Get", " ", "in"}], "-", 
        RowBox[{
        "text", " ", "references", " ", "and", " ", "replace", " ", "them", 
         " ", "with", " ", "numbers"}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"inTextRef", "=", 
       RowBox[{"Flatten", "[", 
        RowBox[{"Values", "[", 
         RowBox[{"Sort", "@", 
          RowBox[{"Merge", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"ExtractNestedSegments", "[", 
               RowBox[{
               "mainSection", ",", "#", ",", "\"\<{{\>\"", ",", 
                "\"\<}}\>\""}], "]"}], "&"}], "/@", 
             RowBox[{"{", 
              RowBox[{
              "\"\<{{refn\>\"", ",", "\"\<{{Refn\>\"", ",", "\"\<{{sfn\>\"", 
               ",", "\"\<{{Sfn\>\"", ",", "\"\<{{snf\>\"", ",", 
               "\"\<{{Snf\>\"", ",", "\"\<{{harv\>\"", ",", "\"\<{{Harv\>\"", 
               ",", "\"\<{{efn\>\"", ",", "\"\<{{Efn\>\"", ",", 
               "\"\<{{cite\>\"", ",", "\"\<{{Cite\>\""}], "}"}]}], ",", 
            "Identity"}], "]"}]}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"numbersRefNoDup", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"StringJoin", "[", 
          RowBox[{"{", 
           RowBox[{"\"\<[\>\"", ",", 
            RowBox[{"ToString", "@", 
             RowBox[{"(", 
              RowBox[{"#", "+", 
               RowBox[{"Length", "@", "htmlRefAssoc"}]}], ")"}]}], ",", 
            "\"\<]\>\""}], "}"}], "]"}], "&"}], "/@", 
        RowBox[{"Range", "[", 
         RowBox[{"Length", "@", 
          RowBox[{"DeleteDuplicates", "@", "inTextRef"}]}], "]"}]}]}], ";", 
      RowBox[{"refAssoc", "=", 
       RowBox[{"AssociationThread", "[", 
        RowBox[{
         RowBox[{"DeleteDuplicates", "@", "inTextRef"}], "->", 
         "numbersRefNoDup"}], "]"}]}], ";", 
      RowBox[{"numbersRef", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"refAssoc", "[", 
          RowBox[{"[", 
           RowBox[{"inTextRef", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "]"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"Length", "@", "inTextRef"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"inTextRefClean", "=", 
       RowBox[{"inTextRefClean", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"StringReplace", "[", 
           RowBox[{
            RowBox[{"StringReplace", "[", 
             RowBox[{
              RowBox[{"StringTrim", "[", 
               RowBox[{"StringReplace", "[", 
                RowBox[{
                 RowBox[{"StringReplace", "[", 
                  RowBox[{"#", ",", 
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"\"\<|\>\"", "~~", 
                    RowBox[{
                    RowBox[{"Except", "[", 
                    RowBox[{"{", 
                    RowBox[{"\"\<=\>\"", "|", "\"\<|\>\""}], "}"}], "]"}], 
                    "..."}], "~~", "\"\<=\>\""}], "->", "\"\<|\>\""}], ",", 
                    RowBox[{
                    RowBox[{"RegularExpression", "[", "\"\<^{{\>\"", "]"}], 
                    "->", "\"\<{\>\""}]}], "}"}]}], "]"}], ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    "\"\<{Refn\>\"", "|", "\"\<{refn\>\"", "|", 
                    "\"\<{Snf\>\"", "|", "\"\<{Sfn\>\"", "|", "\"\<{Sfnm\>\"",
                     "|", "\"\<{sfnm\>\"", "|", "\"\<{Sfnm\>\"", "|", 
                    "\"\<{sfn\>\"", "|", "\"\<{snf\>\"", "|", 
                    "\"\<{sfnref\>\"", "|", "\"\<{Sfnref\>\"", "|", 
                    "\"\<{harv\>\"", "|", "\"\<{Harv\>\"", "|", 
                    "\"\<{cite\>\"", "|", "\"\<{Cite\>\"", "|", 
                    "\"\<{citation\>\"", "|", "\"\<{Citation\>\"", "|", 
                    "\"\<{efn\>\"", "|", "\"\<{Efn\>\""}], ")"}], "~~", 
                    RowBox[{
                    RowBox[{"Except", "[", 
                    RowBox[{"{", "\"\<|\>\"", "}"}], "]"}], "..."}], "~~", 
                    "\"\<|\>\""}], "->", "\"\<\>\""}], ",", 
                   RowBox[{
                    RowBox[{"\"\<{{\>\"", "~~", 
                    RowBox[{
                    RowBox[{"Except", "[", 
                    RowBox[{"{", "\"\<}\>\"", "}"}], "]"}], "..."}], "~~", 
                    "\"\<}\>\""}], "->", "\"\<\>\""}], ",", 
                   RowBox[{
                    RowBox[{"\"\<<\>\"", "~~", 
                    RowBox[{
                    RowBox[{"Except", "[", 
                    RowBox[{"{", "\"\<>\>\"", "}"}], "]"}], "..."}], "~~", 
                    "\"\<>\>\""}], "->", "\"\<\>\""}], ",", 
                   RowBox[{"\"\< | \>\"", "->", "\"\<, \>\""}], ",", 
                   RowBox[{"\"\< |\>\"", "->", "\"\<, \>\""}], ",", 
                   RowBox[{"\"\<| \>\"", "->", "\"\<, \>\""}], ",", 
                   RowBox[{"\"\<|\>\"", "->", "\"\<, \>\""}], ",", 
                   RowBox[{"\"\< : \>\"", "->", "\"\<: \>\""}], ",", 
                   RowBox[{"\"\<}}\>\"", "->", "\"\<\>\""}], ",", 
                   RowBox[{"\"\<{{\>\"", "->", "\"\<\>\""}]}], "}"}]}], "]"}],
                "]"}], ",", 
              RowBox[{
               RowBox[{"RegularExpression", "[", "\"\<,\\\\s*$\>\"", "]"}], 
               "->", "\"\<\>\""}]}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"\"\<&;\>\"", "->", "\"\<&\>\""}], ",", 
              RowBox[{"\"\<\\\";\>\"", "->", "\"\<\\\"\>\""}], ",", 
              RowBox[{"\"\< , \>\"", "->", "\"\<, \>\""}], ",", 
              RowBox[{"\"\< , \>\"", "->", "\"\<, \>\""}], ",", 
              RowBox[{"\"\<]]\>\"", "->", "\"\<\>\""}], ",", 
              RowBox[{"\"\<[[\>\"", "->", "\"\<\>\""}], ",", 
              RowBox[{"\"\<''\>\"", "->", "\"\<\\\"\>\""}], ",", 
              RowBox[{"\"\<{\>\"", "->", "\"\<\>\""}], ",", 
              RowBox[{"\"\<}\>\"", "->", "\"\<\>\""}], ",", 
              RowBox[{"\"\<[\>\"", "->", "\"\<\>\""}], ",", 
              RowBox[{"\"\<]\>\"", "->", "\"\<\>\""}], ",", 
              RowBox[{"\"\<\\n\>\"", "->", "\"\<\>\""}]}], "}"}]}], "]"}], 
          "&"}], "@", 
         RowBox[{"DeleteDuplicates", "@", "inTextRef"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"inTextRefThread", "=", 
       RowBox[{"Merge", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"htmlRefAssoc", ",", 
           RowBox[{"AssociationThread", "[", 
            RowBox[{"numbersRefNoDup", "->", "inTextRefClean"}], "]"}]}], 
          "}"}], ",", "First"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mainSectionNoRef", "=", 
       RowBox[{"StringReplace", "[", 
        RowBox[{"mainSection", ",", 
         RowBox[{"Thread", "[", 
          RowBox[{"inTextRef", "->", "numbersRef"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
        "Locate", " ", "Images", " ", "and", " ", "other", " ", "files"}], 
        ",", " ", 
        RowBox[{
        "iterate", " ", "through", " ", "body", " ", "to", " ", "find", " ", 
         "closing", " ", "paranthesis"}]}], "*)"}], 
      RowBox[{"fileLinks", "=", 
       RowBox[{"Flatten", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"ExtractFileNames", "[", 
           RowBox[{
           "mainSectionNoRef", ",", "#", ",", "\"\<[[\>\"", ",", 
            "\"\<]]\>\""}], "]"}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"\"\<[[File:\>\"", ",", "\"\<[[Image:\>\""}], "}"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"numbersFiles", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"StringJoin", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\"\<(Fig.\>\"", ",", 
             RowBox[{"ToString", "@", "#"}]}], "}"}], ",", "\"\<)\>\""}], 
          "]"}], "&"}], "/@", 
        RowBox[{"Range", "[", 
         RowBox[{"Length", "[", "fileLinks", "]"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"links", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Length", "@", "#"}], ">", "0"}], ",", 
           RowBox[{"StringJoin", "[", 
            RowBox[{"{", 
             RowBox[{
             "\"\<https://en.wikipedia.org/wiki/File:\>\"", ",", "#"}], "}"}],
             "]"}], ",", "\"\<\>\""}], "]"}], "&"}], "/@", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{"StringReplace", "[", 
            RowBox[{"#", ",", 
             RowBox[{"\"\< \>\"", "->", "\"\<_\>\""}]}], "]"}], "&"}], "/@", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             RowBox[{"StringDelete", "[", 
              RowBox[{
               RowBox[{"StringCases", "[", 
                RowBox[{"#", ",", 
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{"\"\<[[File\>\"", "|", "\"\<[[Image\>\""}], ")"}], 
                  "~~", 
                  RowBox[{
                   RowBox[{"Except", "[", "\"\<|\>\"", "]"}], ".."}], "~~", 
                  "\"\<|\>\""}]}], "]"}], ",", 
               RowBox[{"{", 
                RowBox[{
                "\"\<[[Image:\>\"", ",", "\"\<[[File:\>\"", ",", "\"\<|\>\"", 
                 ",", "\"\<;\>\""}], "}"}]}], "]"}], "&"}], "/@", 
            "fileLinks"}], ")"}]}], ")"}]}]}], ";", 
      RowBox[{"linksThread", "=", 
       RowBox[{"AssociationThread", "[", 
        RowBox[{"numbersFiles", "->", "links"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"captions", "=", "\[IndentingNewLine]", 
       RowBox[{"Table", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Length", "[", 
                 RowBox[{"StringCases", "[", 
                  RowBox[{"#", ",", 
                   RowBox[{
                   "RegularExpression", "[", "\"\<\\\\[\\\\d+$\>\"", "]"}]}], 
                  "]"}], "]"}], "===", "0"}], ",", "#", ",", 
               RowBox[{"#", "<>", "\"\<]\>\""}]}], "]"}], "&"}], "@", 
            "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Length", "[", 
                RowBox[{"StringCases", "[", 
                 RowBox[{"#", ",", 
                  RowBox[{
                  "RegularExpression", "[", 
                   "\"\<=\\\\s*[-+]?\\\\d*\\\\.?\\\\d+\>\"", "]"}]}], "]"}], 
                "]"}], "===", "0"}], ",", "#", ",", "\"\<\>\""}], "]"}]}], 
           "&"}], "@", "\[IndentingNewLine]", 
          RowBox[{"StringDelete", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"StringReplace", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"StringReplace", "[", 
               RowBox[{"fileLink", ",", 
                RowBox[{
                 RowBox[{
                  RowBox[{"Rule", "@@@", 
                   RowBox[{"Transpose", "[", 
                    RowBox[{"{", 
                    RowBox[{"#", ",", 
                    RowBox[{"StringReplace", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"\"\<|\>\"", "->", "\"\</\>\""}]}], "]"}]}], 
                    "}"}], "]"}]}], "&"}], "@", 
                 RowBox[{"StringCases", "[", 
                  RowBox[{
                   RowBox[{"StringDelete", "[", 
                    RowBox[{"fileLink", ",", 
                    RowBox[{"{", 
                    RowBox[{"\"\<[[File:\>\"", "|", "\"\<[[Image:\>\""}], 
                    "}"}]}], "]"}], ",", 
                   RowBox[{"Shortest", "[", 
                    RowBox[{"\"\<[[\>\"", "~~", 
                    RowBox[{
                    RowBox[{"Except", "[", "\"\<]\>\"", "]"}], ".."}], "~~", 
                    "\"\<]]\>\""}], "]"}]}], "]"}]}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"\"\<\\\";\>\"", "->", "\"\<\\\"\>\""}], ",", 
                RowBox[{"\"\<''\>\"", "->", "\"\<\\\"\>\""}], ",", 
                RowBox[{"\"\<alt=\>\"", "->", "\"\<\>\""}]}], "}"}]}], "]"}], 
            ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"RegularExpression", "[", "\"\<(\\\\d+px)\>\"", "]"}], 
              ",", 
              RowBox[{"\"\<[[\>\"", "~~", "___", "~~", "\"\<|\>\""}], ",", 
              "\"\<[[\>\"", ",", "\"\<]]\>\""}], "}"}]}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"fileLink", ",", 
           RowBox[{"StringDelete", "[", 
            RowBox[{"fileLinks", ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"\"\<{{sfn\>\"", "|", "\"\<{{snf\>\""}], ")"}], "~~",
                 "___", "~~", "\"\<|\>\""}], ",", 
               RowBox[{"Shortest", "[", 
                RowBox[{"\"\<{{\>\"", "~~", 
                 RowBox[{
                  RowBox[{"Except", "[", "\"\<}\>\"", "]"}], ".."}], "~~", 
                 "\"\<}}\>\""}], "]"}]}], "}"}]}], "]"}]}], "}"}]}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"captionsThread", "=", 
       RowBox[{"AssociationThread", "[", 
        RowBox[{"numbersFiles", "->", "captions"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"mainSectionNoRefNoLink", "=", 
       RowBox[{"StringReplace", "[", 
        RowBox[{"mainSectionNoRef", ",", 
         RowBox[{"Thread", "[", 
          RowBox[{"fileLinks", "->", "numbersFiles"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
        "Clean", " ", "up", " ", "language", " ", "related", " ", "tags"}], 
        ",", " ", 
        RowBox[{
        "before", " ", "deleting", " ", "potential", " ", "conflicts"}]}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"mainSectionNoRefNoLink", "=", 
       RowBox[{"StringDelete", "[", 
        RowBox[{"mainSectionNoRefNoLink", ",", 
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"ExtractNestedSubstrings", "[", 
              RowBox[{"#", ",", "\"\<{{\>\"", ",", "\"\<}}\>\""}], "]"}], "[", 
             RowBox[{"[", "1", "]"}], "]"}], "&"}], "/@", 
           RowBox[{"StringCases", "[", 
            RowBox[{"mainSectionNoRefNoLink", ",", 
             RowBox[{
             "RegularExpression", "[", "\"\<(?m)^\\\\{.{0,148}(?=$|\\n)\>\"", 
              "]"}]}], "]"}]}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mainSectionNoRefNoLink", "=", 
       RowBox[{"FixedPoint", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"StringReplace", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"\"\<\\n;:\>\"", "->", "\"\<\\n\>\""}], ",", 
              RowBox[{"\"\<\\n;\>\"", "->", "\"\<\\n\>\""}], ",", 
              RowBox[{"\"\<\\n:\>\"", "->", "\"\<\\n\>\""}], ",", 
              RowBox[{"\"\<\\n \>\"", "->", "\"\<\\n\>\""}], ",", 
              RowBox[{"\"\<\\n \>\"", "->", "\"\<\\n\>\""}]}], "}"}]}], "]"}],
           "&"}], ",", 
         RowBox[{"StringReplace", "[", 
          RowBox[{
           RowBox[{"StringReplace", "[", 
            RowBox[{
             RowBox[{"StringReplace", "[", 
              RowBox[{
               RowBox[{"CleanLanguageTags", "[", 
                RowBox[{"StringDelete", "[", 
                 RowBox[{
                  RowBox[{"StringReplace", "[", 
                   RowBox[{"mainSectionNoRefNoLink", ",", 
                    RowBox[{
                    RowBox[{
                    "RegularExpression", "[", 
                    "\"\<(?m)^\\\\s*\\\\{\\\\{[^\\\\}]*\\\\}\\\\}\\\\s*$\>\"",
                     "]"}], "->", "\"\<\>\""}]}], "]"}], ",", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{
                    "RegularExpression", "[", 
                    "\"\<\\\\{\\\\{[^|}]*?\\\\}\\\\}\>\"", "]"}], ",", 
                    RowBox[{
                    "RegularExpression", "[", 
                    "\"\<\\\\{\\\\{citation[^}]*?\\\\}\\\\}\>\"", "]"}]}], 
                   "}"}]}], "]"}], "]"}], ",", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"\"\<  \>\"", "->", "\"\< \>\""}], ",", 
                 RowBox[{"\"\<( \>\"", "->", "\"\<(\>\""}]}], "}"}]}], "]"}], 
             ",", 
             RowBox[{"{", 
              RowBox[{"\"\<  \>\"", "->", "\"\< \>\""}], "}"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"\"\<, )\>\"", "->", "\"\<)\>\""}], ",", 
             RowBox[{"\"\<,)\>\"", "->", "\"\<)\>\""}], ",", 
             RowBox[{"\"\<. )\>\"", "->", "\"\<)\>\""}], ",", 
             RowBox[{"\"\<.)\>\"", "->", "\"\<)\>\""}], ",", 
             RowBox[{"\"\<; )\>\"", "->", "\"\<)\>\""}], ",", 
             RowBox[{"\"\<;)\>\"", "->", "\"\<)\>\""}], ",", 
             RowBox[{"\"\<: )\>\"", "->", "\"\<)\>\""}], ",", 
             RowBox[{"\"\<:)\>\"", "->", "\"\<)\>\""}]}], "}"}]}], "]"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Attempt", " ", "deleting", " ", "left"}], "-", 
        RowBox[{"over", " ", "classes"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{"mainSectionNoRefNoLink", "=", 
         RowBox[{"StringDelete", "[", 
          RowBox[{"mainSectionNoRefNoLink", ",", "\[IndentingNewLine]", 
           RowBox[{"ExtractFileNames", "[", 
            RowBox[{
            "mainSectionNoRefNoLink", ",", "\"\<{|\>\"", ",", "\"\<{|\>\"", 
             ",", "\"\<|}\>\""}], "]"}]}], "]"}]}], ",", "2"}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Delete", " ", "dates"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"mainSectionNoRefNoLink", "=", 
       RowBox[{"StringDelete", "[", 
        RowBox[{"mainSectionNoRefNoLink", ",", 
         RowBox[{
          RowBox[{
           RowBox[{"Pick", "[", 
            RowBox[{"#", ",", 
             RowBox[{
              RowBox[{"StringLength", "@", "#"}], "<", "100"}]}], "]"}], 
           "&"}], "/@", 
          RowBox[{"StringCases", "[", 
           RowBox[{"mainSectionNoRefNoLink", ",", 
            RowBox[{
            "RegularExpression", "[", 
             "\"\<\\\\{\\\\{[^|}]*\\\\|date=[^|}]*\\\\}\\\\}\>\"", "]"}]}], 
           "]"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Delete", " ", "left"}], "-", 
        RowBox[{"over", " ", "links"}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"mainSectionNoRefNoLink", "=", 
       RowBox[{"StringDelete", "[", 
        RowBox[{"mainSectionNoRefNoLink", ",", 
         RowBox[{"Shortest", "[", 
          RowBox[{"\"\<[http\>\"", "~~", 
           RowBox[{
            RowBox[{"Except", "[", "\"\<]\>\"", "]"}], ".."}], "~~", 
           "\"\<]\>\""}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
        "Delete", " ", "stray", " ", "lines", " ", "that", " ", "are", " ", 
         "no", " ", "titles"}], ",", " ", 
        RowBox[{"but", " ", "random", " ", "remnants"}], ",", " ", 
        RowBox[{"as", " ", "well", " ", "as", " ", "lists"}]}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"mainSectionNoRefNoLink", "=", 
       RowBox[{"StringDelete", "[", 
        RowBox[{"mainSectionNoRefNoLink", ",", 
         RowBox[{
         "RegularExpression", "[", "\"\<(?m)^\\\\|.{0,148}(?=$|\\n)\>\"", 
          "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mainSectionNoRefNoLink", "=", 
       RowBox[{"StringDelete", "[", 
        RowBox[{"mainSectionNoRefNoLink", ",", 
         RowBox[{
         "RegularExpression", "[", "\"\<(?m)^\\\\{\\\\|.{0,148}(?=$|\\n)\>\"",
           "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mainSectionNoRefNoLink", "=", 
       RowBox[{"StringDelete", "[", 
        RowBox[{"mainSectionNoRefNoLink", ",", 
         RowBox[{
         "RegularExpression", "[", "\"\<(?m)^\\\\!.{0,148}(?=$|\\n)\>\"", 
          "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mainSectionNoRefNoLink", "=", 
       RowBox[{"StringDelete", "[", 
        RowBox[{"mainSectionNoRefNoLink", ",", 
         RowBox[{
         "RegularExpression", "[", "\"\<(?m)^\\\\*.{0,198}(?=$|\\n)\>\"", 
          "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mainSectionNoRefNoLink", "=", 
       RowBox[{"StringDelete", "[", 
        RowBox[{"mainSectionNoRefNoLink", ",", 
         RowBox[{
         "RegularExpression", "[", "\"\<(?m)^\\\\#.{0,198}(?=$|\\n)\>\"", 
          "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mainSectionNoRefNoLink", "=", 
       RowBox[{"StringDelete", "[", 
        RowBox[{"mainSectionNoRefNoLink", ",", 
         RowBox[{
         "RegularExpression", "[", "\"\<(?m)^\\\\:.{0,148}(?=$|\\n)\>\"", 
          "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mainSectionNoRefNoLink", "=", 
       RowBox[{"StringDelete", "[", 
        RowBox[{"mainSectionNoRefNoLink", ",", 
         RowBox[{
         "RegularExpression", "[", "\"\<(?m)^\\\\_.{0,148}(?=$|\\n)\>\"", 
          "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mainSectionNoRefNoLink", "=", 
       RowBox[{"StringDelete", "[", 
        RowBox[{"mainSectionNoRefNoLink", ",", 
         RowBox[{
         "RegularExpression", "[", "\"\<(?m)^\\\\-.{0,148}(?=$|\\n)\>\"", 
          "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mainSectionNoRefNoLink", "=", 
       RowBox[{"StringDelete", "[", 
        RowBox[{"mainSectionNoRefNoLink", ",", 
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"ExtractNestedSubstrings", "[", 
              RowBox[{"#", ",", "\"\<[[\>\"", ",", "\"\<]]\>\""}], "]"}], "[", 
             RowBox[{"[", "1", "]"}], "]"}], "&"}], "/@", 
           RowBox[{"StringCases", "[", 
            RowBox[{"mainSectionNoRefNoLink", ",", 
             RowBox[{
             "RegularExpression", "[", 
              "\"\<(?m)^\\\\[\\[.{0,98}(?=$|\\n)\>\"", "]"}]}], "]"}]}], 
          "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Get", " ", "bibliography"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"references", "=", 
       RowBox[{"Flatten", "[", 
        RowBox[{"StringCases", "[", 
         RowBox[{"referenceSection", ",", 
          RowBox[{"\"\<{{cite\>\"", "~~", 
           RowBox[{
            RowBox[{"Except", "[", "\"\<}\>\"", "]"}], ".."}], "~~", 
           "\"\<}}\>\""}]}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Clean", " ", "bibliography"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"cleanCitRefReplacements", "=", 
       RowBox[{"Table", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"biblioRef", "=", 
           RowBox[{"StringCases", "[", 
            RowBox[{
             RowBox[{"references", "[", 
              RowBox[{"[", "i", "]"}], "]"}], ",", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{
               "\"\<{{Snf\>\"", "|", "\"\<{{Sfn\>\"", "|", "\"\<{{Sfnm\>\"", 
                "|", "\"\<{{sfnm\>\"", "|", "\"\<{{Sfnm\>\"", "|", 
                "\"\<{{sfn\>\"", "|", "\"\<{{snf\>\"", "|", 
                "\"\<{{sfnref\>\"", "|", "\"\<{{Sfnref\>\"", "|", 
                "\"\<{{SfnRef\>\"", "|", "\"\<{{snfref\>\"", "|", 
                "\"\<{{Snfref\>\"", "|", "\"\<{{SnfRef\>\"", "|", 
                "\"\<{{harv\>\"", "|", "\"\<{{Harv\>\""}], ")"}], "~~", 
              RowBox[{
               RowBox[{"Except", "[", "\"\<}\>\"", "]"}], ".."}], "~~", 
              "\"\<}}\>\""}]}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"biblioRefPos", "=", 
           RowBox[{"Flatten", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Position", "[", 
               RowBox[{"inTextRef", ",", "#"}], "]"}], "&"}], "/@", 
             "biblioRef"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"biblioRefClean", "=", 
           RowBox[{
            RowBox[{
             RowBox[{"StringRiffle", "[", 
              RowBox[{
               RowBox[{"StringTrim", "@", "#"}], ",", "\"\<, \>\""}], "]"}], 
             "&"}], "/@", 
            RowBox[{"Partition", "[", 
             RowBox[{
              RowBox[{"StringDelete", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"Pick", "[", 
                   RowBox[{"#", ",", 
                    RowBox[{"Not", "@", 
                    RowBox[{"StringContainsQ", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"Alternatives", "@@", 
                    RowBox[{"{", 
                    RowBox[{
                    "\"\<{{Snf\>\"", "|", "\"\<{{Sfn\>\"", "|", 
                    "\"\<{{Sfnm\>\"", "|", "\"\<{{sfnm\>\"", "|", 
                    "\"\<{{Sfnm\>\"", "|", "\"\<{{sfn\>\"", "|", 
                    "\"\<{{snf\>\"", "|", "\"\<{{sfnref\>\"", "|", 
                    "\"\<{{Sfnref\>\"", "|", "\"\<{{SfnRef\>\"", "|", 
                    "\"\<{{snfref\>\"", "|", "\"\<{{Snfref\>\"", "|", 
                    "\"\<{{SnfRef\>\"", "|", "\"\<{{harv\>\"", "|", 
                    "\"\<{{Harv\>\"", "|", "\"\<{{cite\>\""}], "}"}]}]}], 
                    "]"}]}]}], "]"}], "&"}], "/@", 
                 RowBox[{"Flatten", "[", 
                  RowBox[{"StringSplit", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"StringReplace", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{
                    RowBox[{"StringCases", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"\"\<|\>\"", "~~", 
                    RowBox[{
                    RowBox[{"Except", "[", 
                    RowBox[{"{", 
                    RowBox[{"\"\<=\>\"", "|", "\"\<|\>\""}], "}"}], "]"}], 
                    ".."}], "~~", "\"\<=\>\""}]}], "]"}], "->", 
                    "\"\<|\>\""}]}], "]"}], "&"}], "/@", "biblioRef"}], ",", 
                    "\"\<|\>\""}], "]"}], "]"}]}], ",", 
                RowBox[{"{", 
                 RowBox[{"\"\<}}\>\"", ",", "\"\<{{\>\""}], "}"}]}], "]"}], 
              ",", 
              RowBox[{"UpTo", "[", "3", "]"}]}], "]"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Thread", "[", 
           RowBox[{"biblioRef", "->", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"ToString", "@", "biblioRefClean"}], "==", 
               "\"\<{}\>\""}], ",", "\"\<\>\"", ",", 
              RowBox[{"\"\<[No. \>\"", "<>", 
               RowBox[{"StringRiffle", "[", 
                RowBox[{
                 RowBox[{"ToString", "/@", "biblioRefPos"}], ",", 
                 "\"\<, \>\""}], "]"}], "<>", "\"\<]: \>\"", "<>", 
               RowBox[{"StringRiffle", "[", 
                RowBox[{"biblioRefClean", ",", "\"\<; \>\""}], "]"}]}]}], 
             "]"}]}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"Length", "@", "references"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Make", " ", "clean", " ", "list", " ", "of", " ", "sources"}],
        "*)"}], "\[IndentingNewLine]", 
      RowBox[{"references", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"StringReplace", "[", 
          RowBox[{
           RowBox[{"references", "[", 
            RowBox[{"[", "i", "]"}], "]"}], ",", 
           RowBox[{"cleanCitRefReplacements", "[", 
            RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"Length", "@", "references"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"sources", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"StringTrim", "[", 
          RowBox[{"StringReplace", "[", 
           RowBox[{
            RowBox[{"StringTrim", "[", 
             RowBox[{"StringReplace", "[", 
              RowBox[{
               RowBox[{"StringReplace", "[", 
                RowBox[{
                 RowBox[{"StringReplace", "[", 
                  RowBox[{
                   RowBox[{"StringReplace", "[", 
                    RowBox[{
                    RowBox[{"DecodeHTML", "[", 
                    RowBox[{"references", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "]"}], ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"\"\<[[\>\"", "->", "\"\<\>\""}], ",", 
                    RowBox[{"\"\<]]\>\"", "->", "\"\<\>\""}], ",", 
                    RowBox[{
                    RowBox[{
                    "RegularExpression", "[", 
                    "\"\<(?i)\\\\{\\\\{(cite|ref|!)[^|]*\\\\|\>\"", "]"}], 
                    "->", "\"\<|\>\""}]}], "}"}]}], "]"}], ",", 
                   RowBox[{
                    RowBox[{
                    "RegularExpression", "[", "\"\<(?i)\\\\|[^=]*\\\\=\>\"", 
                    "]"}], "->", "\"\<, \>\""}]}], "]"}], ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"\"\< |\>\"", "->", "\"\<, \>\""}], ",", 
                   RowBox[{"\"\<|\>\"", "->", "\"\<,\>\""}], ",", 
                   RowBox[{"\"\<=\>\"", "->", "\"\<: \>\""}], ",", 
                   RowBox[{
                    RowBox[{"\"\<<;\>\"", "~~", 
                    RowBox[{
                    RowBox[{"Except", "[", "\"\<>\>\"", "]"}], ".."}], "~~", 
                    "\"\<>;\>\""}], "->", "\"\<\>\""}], ",", 
                   RowBox[{"\"\<  \>\"", "->", "\"\< \>\""}], ",", 
                   RowBox[{"\"\<}}\>\"", "->", "\"\<\>\""}]}], "}"}]}], "]"}],
                ",", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"\"\<\\n\>\"", "->", "\"\<,\>\""}], ",", 
                 RowBox[{"\"\< , \>\"", "->", "\"\<, \>\""}], ",", 
                 RowBox[{"\"\<{{!\>\"", "->", "\"\<\>\""}], ",", 
                 RowBox[{"\"\< : \>\"", "->", "\"\<: \>\""}], ",", 
                 RowBox[{"\"\<  \>\"", "->", "\"\< \>\""}], ",", 
                 RowBox[{"\"\<''\>\"", "->", "\"\<\\\"\>\""}]}], "}"}]}], 
              "]"}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"\"\<  \>\"", "->", "\"\< \>\""}], ",", 
              RowBox[{"\"\<,,\>\"", "->", "\"\<,\>\""}], ",", 
              RowBox[{
               RowBox[{"StartOfString", "~~", "\"\<,\>\""}], "->", 
               "\"\<\>\""}], ",", 
              RowBox[{
               RowBox[{"\"\<,\>\"", "~~", "EndOfString"}], "->", 
               "\"\<\>\""}]}], "}"}]}], "]"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"Length", "@", "references"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "Apply", " ", "multiple", " ", "string", " ", "operations", " ", "to", 
        " ", "get", " ", "the", " ", "final", " ", "text"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"body", "=", 
       RowBox[{"FixedPoint", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"StringReplace", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
              "RegularExpression", "[", 
               "\"\<([:;.,])(?:\\\\s|\\\\n)+([:;.,])\>\"", "]"}], ":>", 
              "\"\<$1\>\""}], "}"}]}], "]"}], "&"}], ",", 
         RowBox[{"ToString", "@", 
          RowBox[{"StringTrim", "[", "\[IndentingNewLine]", 
           RowBox[{"FixedPoint", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"StringReplace", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{
                   RowBox[{
                   "RegularExpression", "[", 
                    "\"\<([ \\t]*(\\r?\\n|\\r)){3,}\>\"", "]"}], "->", 
                   "\"\<\\n\\n\>\""}], ",", 
                  RowBox[{
                   RowBox[{
                   "RegularExpression", "[", "\"\<(\\r?\\n|\\r)[ \\t]*\>\"", 
                    "]"}], "->", "\"\<$1\>\""}], ",", 
                  RowBox[{"\"\<|\>\"", "->", "\"\</\>\""}], ",", 
                  RowBox[{
                   RowBox[{"RegularExpression", "[", "\"\<'{2,}\>\"", "]"}], 
                   "->", "\"\<\\\"\>\""}], ",", 
                  RowBox[{"\"\<* \>\"", "->", "\"\<\>\""}], ",", 
                  RowBox[{"\"\<*\>\"", "->", "\"\<\>\""}], ",", 
                  RowBox[{"\"\<&;\>\"", "->", "\"\<&\>\""}], ",", 
                  RowBox[{"\"\<( :\>\"", "->", "\"\<(\>\""}], ",", 
                  RowBox[{"\"\<( ;\>\"", "->", "\"\<(\>\""}], ",", 
                  RowBox[{"\"\<\\\"\\\"\>\"", "->", "\"\<\\\"\>\""}], ",", 
                  RowBox[{"\"\<\\\" \\\"\>\"", "->", "\"\<\\\"\>\""}], ",", 
                  RowBox[{"\"\<(;\>\"", "->", "\"\<(\>\""}], ",", 
                  RowBox[{"\"\<(:\>\"", "->", "\"\<(\>\""}], ",", 
                  RowBox[{"\"\<( ,\>\"", "->", "\"\<(\>\""}], ",", 
                  RowBox[{"\"\<( \>\"", "->", "\"\<(\>\""}], ",", 
                  RowBox[{"\"\<(,\>\"", "->", "\"\<(\>\""}], ",", 
                  RowBox[{"\"\< )\>\"", "->", "\"\<)\>\""}], ",", 
                  RowBox[{"\"\<()\>\"", "->", "\"\<\>\""}], ",", 
                  RowBox[{"\"\< . \>\"", "->", "\"\<. \>\""}], ",", 
                  RowBox[{"\"\< , \>\"", "->", "\"\<, \>\""}], ",", 
                  RowBox[{"\"\< ; \>\"", "->", "\"\<; \>\""}], ",", 
                  RowBox[{"\"\< : \>\"", "->", "\"\<: \>\""}], ",", 
                  RowBox[{"\"\<}\>\"", "->", "\"\<\>\""}], ",", 
                  RowBox[{
                  "\"\<\[OpenCurlyDoubleQuote]\>\"", "->", "\"\<\\\"\>\""}], 
                  ",", 
                  RowBox[{
                  "\"\<\[CloseCurlyDoubleQuote]\>\"", "->", "\"\<\\\"\>\""}], 
                  ",", 
                  RowBox[{"\"\<  \>\"", "->", "\"\< \>\""}], ",", 
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{
                    "\"\<======\>\"", "|", "\"\<=====\>\"", "|", 
                    "\"\<====\>\"", "|", "\"\<===\>\"", "|", "\"\<==\>\""}], 
                    ")"}], "->", "\"\<\\n\\n\>\""}]}], "}"}]}], "]"}], "&"}], 
             ",", 
             RowBox[{"FixedPoint", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"StringReplace", "[", 
                 RowBox[{"#", ",", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{
                    RowBox[{
                    "RegularExpression", "[", "\"\<\\\\n#\\\\s?\>\"", "]"}], 
                    "->", "\"\<\\n\>\""}], ",", 
                    RowBox[{
                    RowBox[{
                    "RegularExpression", "[", "\"\<\\\\n:\\\\s?\>\"", "]"}], 
                    "->", "\"\<\\n\>\""}], ",", 
                    RowBox[{
                    RowBox[{
                    "RegularExpression", "[", "\"\<\\\\n;\\\\s?\>\"", "]"}], 
                    "->", "\"\<\\n\>\""}], ",", 
                    RowBox[{
                    RowBox[{
                    "RegularExpression", "[", "\"\<\\\\n\\\\.\\\\s?\>\"", 
                    "]"}], "->", "\"\<\\n\>\""}], ",", 
                    RowBox[{
                    RowBox[{
                    "RegularExpression", "[", "\"\<\\\\n,\\\\s?\>\"", "]"}], 
                    "->", "\"\<\\n\>\""}], ",", 
                    RowBox[{
                    RowBox[{
                    "RegularExpression", "[", "\"\<\\\\n!\\\\s?\>\"", "]"}], 
                    "->", "\"\<\\n\>\""}], ",", 
                    RowBox[{
                    RowBox[{
                    "RegularExpression", "[", "\"\<\\\\n\\\\?\\\\s?\>\"", 
                    "]"}], "->", "\"\<\\n\>\""}], ",", 
                    RowBox[{
                    RowBox[{
                    "RegularExpression", "[", "\"\<\\\\n\\\"\>\"", "]"}], 
                    "->", "\"\<\\\"\>\""}], ",", 
                    RowBox[{
                    RowBox[{
                    "RegularExpression", "[", "\"\<\\\\n\\\\\\\\s?\>\"", 
                    "]"}], "->", "\"\<\\n\>\""}]}], "}"}]}], "]"}], "&"}], 
               ",", "\[IndentingNewLine]", 
               RowBox[{"StringDelete", "[", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"StringDelete", "[", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{"StringReplace", "[", 
                    RowBox[{
                    RowBox[{"CleanTextSimple", "[", 
                    RowBox[{"StringReplace", "[", "\[IndentingNewLine]", 
                    RowBox[{"mainSectionNoRefNoLink", ",", " ", 
                    RowBox[{"{", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{"\"\<{{\>\"", "|", "\"\<{\>\""}], ")"}], "~~", 
                    RowBox[{
                    RowBox[{"Except", "[", "\"\<}\>\"", "]"}], ".."}], "~~", 
                    RowBox[{"(", 
                    RowBox[{"\"\<}}\>\"", "|", "\"\<}\>\""}], ")"}]}], "->", 
                    "\"\<\>\""}], ",", 
                    RowBox[{"\"\<\\\";\>\"", "->", "\"\<\\\"\>\""}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{"\"\<[[\>\"", "->", "\"\<\>\""}], ",", 
                    RowBox[{"\"\<]]\>\"", "->", "\"\<\>\""}]}], "}"}]}], 
                    "]"}], "]"}], ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"\"\<()\>\"", "->", "\"\<\>\""}], ",", " ", 
                    RowBox[{
                    RowBox[{"\"\<<!-- \>\"", "~~", 
                    RowBox[{
                    RowBox[{"Except", "[", "\"\<>\>\"", "]"}], ".."}], "~~", 
                    "\"\< -->\>\""}], "->", "\"\<\>\""}]}], "}"}]}], "]"}], 
                   ",", 
                   RowBox[{
                   "RegularExpression", "[", 
                    "\"\<(?m)^\\\\s*\\\\|.{0,48}\\\\n\>\"", "]"}]}], "]"}], 
                 ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{
                   "RegularExpression", "[", 
                    "\"\<\\\\{\\\\{|\\\\}\\\\}|\\\\(\\\\s*\\\\)\\\\s\>\"", 
                    "]"}], ",", "\"\<wikt:\>\""}], "}"}]}], "]"}]}], "]"}]}], 
            "]"}], "]"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Export", " ", "extracted", " ", "data"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Association", "[", 
       RowBox[{
        RowBox[{"\"\<text\>\"", "->", "body"}], ",", 
        RowBox[{"\"\<sources\>\"", "->", "sources"}], ",", 
        RowBox[{"\"\<references\>\"", "->", "inTextRefThread"}], ",", 
        RowBox[{"\"\<mediaCaptions\>\"", "->", "captionsThread"}], ",", 
        RowBox[{"\"\<mediaLinks\>\"", "->", "linksThread"}]}], 
       RowBox[{"(*", 
        RowBox[{",", 
         RowBox[{"\"\<mediaDownloadLinks\>\"", "->", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             RowBox[{"#1", "->", 
              RowBox[{"FetchImageURL", "[", "#2", "]"}]}], "&"}], "@@@", 
            "linksThread"}], ")"}]}]}], "*)"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9235847913664584`*^9, 3.9235850728370075`*^9}, {
   3.9235851983013353`*^9, 3.9235852202600975`*^9}, {3.9235852697174377`*^9, 
   3.9235853392458324`*^9}, {3.923585553489977*^9, 3.9235855567874146`*^9}, {
   3.923585947524989*^9, 3.923585952066431*^9}, {3.923586012063092*^9, 
   3.923586038090131*^9}, {3.9235860690506363`*^9, 3.9235860984629617`*^9}, 
   3.9235861721848392`*^9, {3.923586223538585*^9, 3.9235862300302043`*^9}, 
   3.9235862688448906`*^9, {3.9235864689805408`*^9, 3.923586507629839*^9}, {
   3.9235874931410723`*^9, 3.9235875395587206`*^9}, {3.9235875816793685`*^9, 
   3.923587611321501*^9}, {3.923588380278819*^9, 3.9235884169402056`*^9}, {
   3.923624683893344*^9, 3.9236247449335175`*^9}, {3.923624789829998*^9, 
   3.9236248305501957`*^9}, {3.9236267257702208`*^9, 3.923626754568534*^9}, {
   3.9236269714415483`*^9, 3.9236270240128517`*^9}, {3.92362706530379*^9, 
   3.9236270744261217`*^9}, {3.92362712970105*^9, 3.9236271466866913`*^9}, {
   3.923627195738306*^9, 3.9236272002339897`*^9}, {3.923627265063667*^9, 
   3.923627307654805*^9}, {3.9236273441804543`*^9, 3.923627575937974*^9}, 
   3.923627813267697*^9, {3.9236278674298525`*^9, 3.923627870865155*^9}, {
   3.92362792910478*^9, 3.923627944161244*^9}, {3.92362849387384*^9, 
   3.9236285125734835`*^9}, 3.923628807585223*^9, {3.9236421295692043`*^9, 
   3.923642140171189*^9}, {3.923642248126505*^9, 3.9236422928716464`*^9}, {
   3.923642914266145*^9, 3.92364292183978*^9}, {3.9236431120916624`*^9, 
   3.9236431900762625`*^9}, {3.923649588228563*^9, 3.9236496057965474`*^9}, 
   3.9236497479391513`*^9, {3.9236498816452894`*^9, 3.9236498869342575`*^9}, {
   3.923668861957262*^9, 3.9236688631620703`*^9}, {3.9236689292728148`*^9, 
   3.923668939663845*^9}, {3.9236733128405323`*^9, 3.923673368800233*^9}, {
   3.9236737509595737`*^9, 3.9236737511241517`*^9}, {3.9236739582533474`*^9, 
   3.9236739641180677`*^9}, {3.923674494754573*^9, 3.923674498135155*^9}, {
   3.923712652107974*^9, 3.923712685692459*^9}, 3.9237133199888926`*^9, {
   3.923713466859716*^9, 3.923713494987682*^9}, 3.9237136458923817`*^9, 
   3.923713724299226*^9, {3.9237137565722075`*^9, 3.9237139009724903`*^9}, {
   3.9237139885248528`*^9, 3.923714006772273*^9}, {3.9237143765402617`*^9, 
   3.9237144192199025`*^9}, {3.9237147600115204`*^9, 3.92371476062724*^9}, {
   3.923714868771685*^9, 3.92371492124699*^9}, {3.923715035898864*^9, 
   3.9237150521551747`*^9}, {3.923715140395303*^9, 3.923715140699443*^9}, {
   3.9237152236358542`*^9, 3.923715228771476*^9}, {3.9237152614107723`*^9, 
   3.923715357411496*^9}, {3.923715389220174*^9, 3.9237153984106555`*^9}, {
   3.9237154422273636`*^9, 3.9237154462674856`*^9}, 3.923715555435645*^9, 
   3.923715670125599*^9, {3.923717218579421*^9, 3.923717271756968*^9}, {
   3.923717364684007*^9, 3.923717369883794*^9}, {3.9237174623236017`*^9, 
   3.923717464203123*^9}, {3.9237176322920313`*^9, 3.923717637651184*^9}, {
   3.9237180395201473`*^9, 3.9237180414426584`*^9}, {3.923718088106451*^9, 
   3.923718145035877*^9}, {3.923718179723343*^9, 3.923718181939296*^9}, {
   3.923718744727279*^9, 3.9237187724745626`*^9}, {3.92371884210725*^9, 
   3.923718853179843*^9}, 3.923718974133849*^9, 3.923719241939823*^9, {
   3.92372414645895*^9, 3.9237241572180233`*^9}, {3.923724203027481*^9, 
   3.9237242230833416`*^9}, {3.9237261166439314`*^9, 
   3.9237261510023003`*^9}, {3.9237262700343266`*^9, 
   3.9237263211697626`*^9}, {3.923726358114647*^9, 3.9237263863142476`*^9}, {
   3.923726420218057*^9, 3.9237264238018537`*^9}, 3.9237265002744923`*^9, {
   3.923727268626636*^9, 3.923727273178551*^9}, {3.9237273475778694`*^9, 
   3.9237273488261538`*^9}, {3.9237274490828457`*^9, 
   3.9237274528498063`*^9}, {3.923737084931343*^9, 3.923737102072401*^9}, {
   3.923737234817048*^9, 3.9237372580580945`*^9}, {3.9237376959461937`*^9, 
   3.923737700560193*^9}, {3.9237380257214527`*^9, 3.9237380330561295`*^9}, {
   3.9237398395767417`*^9, 3.923739881335904*^9}, {3.923739934651635*^9, 
   3.923739953196581*^9}, {3.923740120641616*^9, 3.923740140495802*^9}, 
   3.9237403046961107`*^9, 3.9237404061356893`*^9, {3.9237405033451314`*^9, 
   3.9237405157676954`*^9}, {3.9237405994491196`*^9, 
   3.9237406146955986`*^9}, {3.9237415676900616`*^9, 
   3.9237415833201323`*^9}, {3.9238988158524017`*^9, 3.923898888229707*^9}, {
   3.923907337617527*^9, 3.9239073501083903`*^9}, {3.9239075056350365`*^9, 
   3.923907510523701*^9}, {3.9239077933945312`*^9, 3.9239078107564*^9}, {
   3.923907851257141*^9, 3.923907865085622*^9}, {3.9239079899060545`*^9, 
   3.9239079943515625`*^9}, {3.9239081239527826`*^9, 3.923908139101627*^9}, {
   3.9239126078817244`*^9, 3.92391260803335*^9}, {3.923912743592825*^9, 
   3.9239127480962214`*^9}, 3.923913016183679*^9, {3.9239157508013268`*^9, 
   3.9239157790380025`*^9}, {3.9239239950171814`*^9, 3.923924037142091*^9}, {
   3.9239240702199836`*^9, 3.9239240933925147`*^9}, {3.923924142423346*^9, 
   3.923924155324774*^9}, {3.923924683855548*^9, 3.9239246880111384`*^9}, {
   3.9239248505139947`*^9, 3.9239248604446635`*^9}, {3.9239252617947493`*^9, 
   3.9239252637876043`*^9}, 3.9239253682066045`*^9, {3.9239254469298177`*^9, 
   3.923925448285291*^9}, {3.923929893380851*^9, 3.9239299935154634`*^9}, {
   3.923930114685253*^9, 3.9239301340203524`*^9}, {3.9239311604394026`*^9, 
   3.9239311871149726`*^9}, 3.9239312244934764`*^9, {3.92393134292039*^9, 
   3.9239313749868927`*^9}, {3.923935720758489*^9, 3.9239357461535606`*^9}, 
   3.923936069577299*^9, {3.92393635425581*^9, 3.923936392170311*^9}, {
   3.923936582792512*^9, 3.9239366004548063`*^9}, 3.92393686901991*^9, {
   3.9239860650763903`*^9, 3.923986086453808*^9}, 3.9239861174023657`*^9, {
   3.9239870762090874`*^9, 3.923987079849491*^9}, {3.9239876414003687`*^9, 
   3.923987686944873*^9}, {3.923988203010499*^9, 3.9239882105079393`*^9}, {
   3.923988468229603*^9, 3.9239884741458654`*^9}, {3.923989906770632*^9, 
   3.923989908935576*^9}, {3.9239914588359766`*^9, 3.923991519495045*^9}, {
   3.9240023143593187`*^9, 3.924002325150996*^9}, 3.924002421735998*^9, {
   3.9240173533057537`*^9, 3.9240173728995914`*^9}, {3.924017413800866*^9, 
   3.924017464200498*^9}, {3.9240180700978613`*^9, 3.924018072500834*^9}, {
   3.9240190444419203`*^9, 3.924019044950878*^9}, {3.9240191204416466`*^9, 
   3.924019125427168*^9}, {3.9240191871586466`*^9, 3.9240191879236326`*^9}, {
   3.924019379305683*^9, 3.9240193914998245`*^9}, {3.9240195318510695`*^9, 
   3.92401954556627*^9}, {3.9240197270422964`*^9, 3.924019737472436*^9}, {
   3.924064832398113*^9, 3.924064834773382*^9}, {3.9240649258452077`*^9, 
   3.924064965821248*^9}, {3.9240659463407717`*^9, 3.924065951795665*^9}, 
   3.924066098100592*^9, {3.924066315494793*^9, 3.924066326412907*^9}, {
   3.924066465589193*^9, 3.9240664744838147`*^9}, {3.9240666656152267`*^9, 
   3.9240666741002192`*^9}, {3.9240667534135103`*^9, 3.924066756676046*^9}, {
   3.924066791885249*^9, 3.924066795020387*^9}, {3.9240668710532756`*^9, 
   3.924066887812126*^9}, {3.9240670158539667`*^9, 3.9240670199811883`*^9}, {
   3.9240674138443575`*^9, 3.9240674253804073`*^9}, {3.924067510286409*^9, 
   3.9240675289649334`*^9}, {3.924072033932873*^9, 3.9240720572278433`*^9}, {
   3.924072093701192*^9, 3.9240720970297318`*^9}, {3.9240721589330807`*^9, 
   3.924072166787389*^9}, 3.9240740772858458`*^9, {3.9240741549965825`*^9, 
   3.9240741578598957`*^9}, {3.924074367075963*^9, 3.9240743695239267`*^9}, {
   3.924074409292597*^9, 3.924074426099679*^9}, {3.92407462101193*^9, 
   3.9240746782127457`*^9}, {3.924074752996975*^9, 3.9240747551071863`*^9}, 
   3.924074797959449*^9, {3.9240748429644847`*^9, 3.924074846411274*^9}, {
   3.924074898604086*^9, 3.924074915395836*^9}, {3.9240749762997637`*^9, 
   3.9240749789791408`*^9}, {3.9240750456515408`*^9, 
   3.9240750561419773`*^9}, {3.9240751129714465`*^9, 3.924075177627853*^9}, {
   3.9240752470404434`*^9, 3.9240753323155575`*^9}, 3.9240753996362696`*^9, 
   3.924075535579858*^9, {3.924075692597698*^9, 3.9240757130117025`*^9}, {
   3.9240757593390107`*^9, 3.9240757657316675`*^9}, 3.9240757957714553`*^9, {
   3.924076155421195*^9, 3.9240761873729467`*^9}, {3.924076217659768*^9, 
   3.9240762838679295`*^9}, {3.9240763521483293`*^9, 3.924076378717696*^9}, {
   3.9240764835811987`*^9, 3.9240765138609967`*^9}, {3.9240788046519322`*^9, 
   3.9240788289630275`*^9}, {3.9240803246390533`*^9, 3.924080332467109*^9}, {
   3.924080369660552*^9, 3.924080376171985*^9}, {3.9240806012397175`*^9, 
   3.9240806072519436`*^9}, {3.924081116956607*^9, 3.92408114398864*^9}, 
   3.9240832605427933`*^9, 3.9240832964687157`*^9, {3.924086460152942*^9, 
   3.92408646278111*^9}, {3.924086833988459*^9, 3.9240868357481413`*^9}, {
   3.924086868126315*^9, 3.9240868810364227`*^9}, {3.9240869468128138`*^9, 
   3.9240869475390077`*^9}, {3.9240875910253215`*^9, 3.924087596084015*^9}, {
   3.924087689413574*^9, 3.9240876942765713`*^9}, {3.924087885851613*^9, 
   3.924087894178917*^9}, {3.924088808452602*^9, 3.924088838355673*^9}, {
   3.9240888779879727`*^9, 3.9240889110600386`*^9}, {3.9240889728993616`*^9, 
   3.9240889760833626`*^9}, {3.924089250898713*^9, 3.924089297763912*^9}, {
   3.924089446702488*^9, 3.9240894473954887`*^9}, {3.9240896332971115`*^9, 
   3.9240896508911123`*^9}, 3.924089711643397*^9, {3.9240897544202356`*^9, 
   3.9240898035543833`*^9}, {3.924089943580387*^9, 3.9240899520103874`*^9}, 
   3.924090183709779*^9, 3.92409095409201*^9, {3.9240915061932487`*^9, 
   3.924091509019249*^9}, 3.9240915975405483`*^9, {3.9240925089913244`*^9, 
   3.924092510898323*^9}, {3.92409370475097*^9, 3.9240937065140343`*^9}, {
   3.9240939019807987`*^9, 3.924093915706798*^9}, {3.924094053684603*^9, 
   3.9240940737647476`*^9}, {3.924094121636897*^9, 3.9240941617800164`*^9}, {
   3.924094591899065*^9, 3.9240946464663353`*^9}, {3.9240956510385904`*^9, 
   3.92409565312959*^9}, {3.9240958858669767`*^9, 3.9240959007131104`*^9}, {
   3.9240962052829523`*^9, 3.924096304990794*^9}, {3.9240967399214354`*^9, 
   3.924096760270435*^9}, {3.9240968126876416`*^9, 3.9240969187509756`*^9}, {
   3.924097299256755*^9, 3.9240973051847553`*^9}, {3.924098902722173*^9, 
   3.9240989053441734`*^9}, {3.924099068225145*^9, 3.924099285255214*^9}, {
   3.9240993168473463`*^9, 3.924099377526371*^9}, {3.924166611919536*^9, 
   3.924166613268608*^9}, {3.9241666519666767`*^9, 3.924166672183816*^9}, {
   3.9241681763381248`*^9, 3.924168214126193*^9}, {3.9241682576704197`*^9, 
   3.9241682633044863`*^9}, {3.924172345672473*^9, 3.924172357189472*^9}, {
   3.9241724524320145`*^9, 3.924172471958166*^9}, {3.9241770248646135`*^9, 
   3.9241770291886134`*^9}, {3.924177096519745*^9, 3.924177109264819*^9}, {
   3.9241772201362658`*^9, 3.924177237111407*^9}, {3.9241775605265713`*^9, 
   3.9241775996361494`*^9}, {3.9241776816315274`*^9, 
   3.9241777118146725`*^9}, {3.9241778256792955`*^9, 3.924177851973365*^9}, {
   3.924177914760502*^9, 3.924177927015806*^9}, {3.924177969330453*^9, 
   3.924177976474451*^9}, {3.9242843779063144`*^9, 3.9242844154221616`*^9}, {
   3.9243200220649204`*^9, 3.924320023643098*^9}, 3.92434335522165*^9, {
   3.9243501286495934`*^9, 3.9243501627791405`*^9}, 3.924350503979978*^9, {
   3.9244187837756987`*^9, 3.924418801128471*^9}, {3.924421886068486*^9, 
   3.9244219004729156`*^9}, {3.924434216158271*^9, 3.9244342366228547`*^9}, {
   3.9244343489317055`*^9, 3.9244344186132293`*^9}, {3.9244382114391546`*^9, 
   3.92443825045998*^9}, {3.924438337376919*^9, 3.924438345961873*^9}, {
   3.924438512111005*^9, 3.924438517840538*^9}, {3.924438896102086*^9, 
   3.9244389041753583`*^9}, {3.9244407060827246`*^9, 3.92444072708333*^9}, {
   3.9244408385910454`*^9, 3.924440853621355*^9}, {3.9244409206709113`*^9, 
   3.924440921244253*^9}, 3.924441343854887*^9, {3.9244415593893766`*^9, 
   3.9244415734372067`*^9}, {3.9244417735384073`*^9, 3.924441823352008*^9}, {
   3.9244419559547644`*^9, 3.9244419563443146`*^9}, {3.92444210234753*^9, 
   3.9244421061009064`*^9}, {3.9244426570014496`*^9, 3.924442674540803*^9}, {
   3.9244428060819016`*^9, 3.9244428062649574`*^9}, {3.9244437599592185`*^9, 
   3.924443893714133*^9}, {3.924443924619996*^9, 3.9244439246639977`*^9}, {
   3.924444014090143*^9, 3.9244440170776863`*^9}, {3.9244449570043945`*^9, 
   3.9244449875008917`*^9}, {3.9244451187888775`*^9, 
   3.9244451244870305`*^9}, {3.9244453032529783`*^9, 
   3.9244453296201572`*^9}, {3.9244458573222704`*^9, 3.924445913561548*^9}, {
   3.9244466839137983`*^9, 3.9244467039326115`*^9}, 3.924923181507583*^9, {
   3.9249251987859983`*^9, 3.924925216651429*^9}, 3.9249255011876583`*^9, {
   3.9249283164627547`*^9, 3.92492831766663*^9}, {3.9249288103406296`*^9, 
   3.924928856873457*^9}, {3.961495311469792*^9, 3.961495359460557*^9}},
 CellLabel->"In[40]:=",ExpressionUUID->"fdda6242-8802-489e-a38c-d03859de3a15"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Input", ":", 
      RowBox[{
       RowBox[{"-", "string"}], " ", "text", " ", "in", " ", "which", " ", 
       "spaces", " ", "before", " ", "punctuation", " ", "should", " ", "be", 
       " ", "removed"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Output", ":", 
      RowBox[{
       RowBox[{"-", "string"}], " ", "with", " ", "unnecessary", " ", 
       "spaces", " ", "deleted"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Description", ":", " ", 
      RowBox[{
      "Replaces", " ", "any", " ", "space", " ", "directly", " ", "before", 
       " ", "common", " ", "punctuation", " ", "marks", " ", "with", " ", 
       "just", " ", "the", " ", "punctuation"}]}]}], ",", " ", 
    RowBox[{"to", " ", "tidy", " ", "up", " ", 
     RowBox[{"text", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"DeleteSpacesBeforePunctuation", "[", "string_", "]"}], ":=", 
   RowBox[{"StringReplace", "[", 
    RowBox[{"string", ",", 
     RowBox[{
      RowBox[{
       RowBox[{"#", "->", 
        RowBox[{"First", "@", 
         RowBox[{"StringCases", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{
            "\"\<;\>\"", ",", "\"\<:\>\"", ",", "\"\<.\>\"", ",", "\"\<,\>\"",
              ",", "\"\<!\>\"", ",", "\"\<?\>\""}], "}"}]}], "]"}]}]}], "&"}],
       "/@", 
      RowBox[{"StringCases", "[", 
       RowBox[{"string", ",", 
        RowBox[{"\"\< \>\"", "~~", 
         RowBox[{"{", 
          RowBox[{
          "\"\<;\>\"", ",", "\"\<:\>\"", ",", "\"\<.\>\"", ",", "\"\<,\>\"", 
           ",", "\"\<!\>\"", ",", "\"\<?\>\""}], "}"}]}]}], "]"}]}]}], 
    "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9243440066556425`*^9, 3.9243440277700014`*^9}, 
   3.924344538623969*^9, {3.9243445720215855`*^9, 3.9243445881930485`*^9}, {
   3.924346189496089*^9, 3.924346199228858*^9}, {3.9244080413699856`*^9, 
   3.9244080748557405`*^9}, {3.9244445974584947`*^9, 
   3.9244445986745963`*^9}, {3.9614954006881733`*^9, 3.961495426550412*^9}},
 CellLabel->"In[41]:=",ExpressionUUID->"cb9052a6-acb4-4889-82b3-42f052bc70b4"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", 
     RowBox[{
      RowBox[{"-", "string"}], " ", "text", " ", "containing", " ", "HTML", 
      " ", "entities"}]}], ";", "\[IndentingNewLine]", 
    RowBox[{"Output", ":", " ", 
     RowBox[{
      RowBox[{"-", "string"}], " ", "with", " ", "common", " ", "HTML", " ", 
      "entities", " ", "decoded", " ", "into", " ", "Unicode", " ", 
      "characters"}]}], ";", "\[IndentingNewLine]", 
    RowBox[{"Description", ":", " ", 
     RowBox[{
      RowBox[{"Replaces", " ", "common", " ", "HTML", " ", "entities", " ", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"e", ".", "g", "."}], ",", 
         RowBox[{"&", "quot"}], ",", 
         RowBox[{"&", "lt"}], ",", 
         RowBox[{"&", "gt"}], ",", 
         RowBox[{
          RowBox[{"&", "amp"}], ";", "nbsp", ";"}]}], ")"}], " ", "with", " ",
        "their", " ", "corresponding", " ", "symbols", " ", "to", " ", "make",
        " ", "the", " ", "text", " ", "human"}], "-", 
      RowBox[{"readable", "."}]}]}]}], "*)"}], "\[IndentingNewLine]", "\n", 
  RowBox[{
   RowBox[{"DecodeHTML", "[", "string_String", "]"}], ":=", 
   RowBox[{"StringReplace", "[", 
    RowBox[{"string", ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\"\<&quot\>\"", "\[Rule]", "\"\<\\\"\>\""}], ",", 
       RowBox[{"\"\<&lt\>\"", "\[Rule]", "\"\<<\>\""}], ",", 
       RowBox[{"\"\<&gt\>\"", "\[Rule]", "\"\<>\>\""}], ",", 
       RowBox[{"\"\<&amp;nbsp;\>\"", "->", "\"\< \>\""}], ",", 
       RowBox[{"\"\<&amp;mdash;\>\"", "->", "\"\<\[LongDash]\>\""}], ",", 
       RowBox[{"\"\<&amp;ndash;\>\"", "->", "\"\<\[Dash]\>\""}], ",", 
       RowBox[{"\"\<&amp\>\"", "\[Rule]", "\"\<&\>\""}]}], "}"}]}], 
    "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9235880016581044`*^9, 3.9235880389694805`*^9}, {
   3.92358823339365*^9, 3.9235883418429604`*^9}, {3.923626537207283*^9, 
   3.9236266253778267`*^9}, 3.923648442945324*^9, {3.923648848003417*^9, 
   3.9236488698648*^9}, {3.923649146059847*^9, 3.9236491565043244`*^9}, {
   3.9236492209928226`*^9, 3.9236492351089883`*^9}, {3.9236493109025507`*^9, 
   3.9236493207577486`*^9}, {3.9236685379318905`*^9, 3.923668571335313*^9}, {
   3.923668618661828*^9, 3.923668637656665*^9}, {3.9237162243348675`*^9, 
   3.9237162247826333`*^9}, {3.9237183690474415`*^9, 3.923718381287239*^9}, {
   3.9237249195819683`*^9, 3.9237249331097565`*^9}, {3.923724988606174*^9, 
   3.923725001806016*^9}, {3.92372504072859*^9, 3.9237250442936306`*^9}, {
   3.923727582357935*^9, 3.923727641198036*^9}, {3.9239869620802526`*^9, 
   3.9239869846694145`*^9}, {3.9613384349172287`*^9, 3.961338435536014*^9}, {
   3.96149544875758*^9, 3.961495462623179*^9}},
 CellLabel->"In[42]:=",ExpressionUUID->"908b2675-b596-4674-a5d0-aa0f670a21a6"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["String Operation Helpers",
 FontColor->RGBColor[0.4, 0.4000152590218967, 0.4]]], "Subsubsection",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004670496183*^9}, {
  3.9241006465262146`*^9, 3.924100650918215*^9}, {3.9242581271173253`*^9, 
  3.9242581297813253`*^9}, {3.96142730167209*^9, 3.961427306455673*^9}, {
  3.9614653032373657`*^9, 3.961465314612693*^9}, {3.96149290833879*^9, 
  3.9614929110436296`*^9}, {3.961493138362278*^9, 3.9614931452069483`*^9}, {
  3.96149340559212*^9, 3.961493406636104*^9}, {3.961495506665543*^9, 
  3.9614955420045424`*^9}, {3.961495712027873*^9, 
  3.961495713033374*^9}},ExpressionUUID->"222abde2-5094-40e3-9495-\
1577c1c02ac8"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Input", ":", 
      RowBox[{
       RowBox[{"-", "text"}], " ", "string", " ", "of", " ", "raw", " ", 
       "text"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Output", ":", 
      RowBox[{
       RowBox[{"-", "list"}], " ", "of", " ", "lowercase", " ", "words", " ", 
       "with", " ", "stopwords"}]}]}], ",", " ", 
    RowBox[{"filler", " ", "words"}], ",", " ", 
    RowBox[{
     RowBox[{"and", " ", "irrelevant", " ", "tokens", " ", "removed"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Description", ":", " ", 
      RowBox[{
      "Cleans", " ", "and", " ", "splits", " ", "text", " ", "into", " ", 
       "words"}]}]}], ",", " ", 
    RowBox[{"excluding", " ", "common", " ", "short", " ", "forms", " ", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"e", ".", "g", "."}], ",", 
       RowBox[{"'", 
        RowBox[{"re", "'"}]}], ",", 
       RowBox[{"'", 
        RowBox[{"ll", "'"}]}]}], ")"}]}], ",", 
    RowBox[{"archaic", " ", "forms", " ", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"e", ".", "g", "."}], ",", 
       RowBox[{"'", 
        RowBox[{"thou", "'"}]}], ",", 
       RowBox[{"'", 
        RowBox[{"thy", "'"}]}]}], ")"}], " ", "and", " ", "tokens", " ", 
     "shorter", " ", "than", " ", "two", " ", 
     RowBox[{"characters", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"WordsfromText", "[", "text_", "]"}], ":=", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
     "Turn", " ", "text", " ", "into", " ", "list", " ", "of", " ", "words"}],
      ",", " ", 
     RowBox[{
     "dropping", " ", "stopwords", " ", "and", " ", "\"\<like\>\""}]}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{"ToLowerCase", "[", 
    RowBox[{"Select", "[", 
     RowBox[{
      RowBox[{"StringSplit", "[", 
       RowBox[{
        RowBox[{"CleanText", "[", "text", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"PunctuationCharacter", ",", "WhitespaceCharacter"}], 
         "}"}]}], "]"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"StringMatchQ", "[", 
          RowBox[{"#", ",", "\"\<amp\>\"", ",", 
           RowBox[{"IgnoreCase", "->", "True"}]}], "]"}], "==", "False"}], 
        " ", "&&", " ", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"StringMatchQ", "[", 
          RowBox[{"#", ",", "\"\<re\>\"", ",", 
           RowBox[{"IgnoreCase", "->", "True"}]}], "]"}], "==", "False"}], 
        " ", "&&", " ", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"StringMatchQ", "[", 
          RowBox[{"#", ",", "\"\<ll\>\"", ",", 
           RowBox[{"IgnoreCase", "->", "True"}]}], "]"}], "==", "False"}], 
        " ", "&&", " ", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"StringMatchQ", "[", 
          RowBox[{"#", ",", "\"\<ve\>\"", ",", 
           RowBox[{"IgnoreCase", "->", "True"}]}], "]"}], "==", "False"}], 
        " ", "&&", " ", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"StringMatchQ", "[", 
          RowBox[{"#", ",", "\"\<thou\>\"", ",", 
           RowBox[{"IgnoreCase", "->", "True"}]}], "]"}], "==", "False"}], 
        " ", "&&", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"StringMatchQ", "[", 
          RowBox[{"#", ",", "\"\<thy\>\"", ",", 
           RowBox[{"IgnoreCase", "->", "True"}]}], "]"}], "==", "False"}], 
        " ", "&&", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"StringMatchQ", "[", 
          RowBox[{"#", ",", "\"\<thee\>\"", ",", 
           RowBox[{"IgnoreCase", "->", "True"}]}], "]"}], "==", "False"}], 
        " ", "&&", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"StringMatchQ", "[", 
          RowBox[{"#", ",", "\"\<like\>\"", ",", 
           RowBox[{"IgnoreCase", "->", "True"}]}], "]"}], "==", "False"}], 
        " ", "&&", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"StringMatchQ", "[", 
          RowBox[{"#", ",", "\"\<et\>\"", ",", 
           RowBox[{"IgnoreCase", "->", "True"}]}], "]"}], "==", "False"}], 
        " ", "&&", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"StringMatchQ", "[", 
          RowBox[{"#", ",", "\"\<al\>\"", ",", 
           RowBox[{"IgnoreCase", "->", "True"}]}], "]"}], "==", "False"}], 
        " ", "&&", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"StringMatchQ", "[", 
          RowBox[{"#", ",", "\"\<fig\>\"", ",", 
           RowBox[{"IgnoreCase", "->", "True"}]}], "]"}], "==", "False"}], 
        " ", "&&", " ", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"StringContainsQ", "[", 
          RowBox[{"#", ",", "\"\<http\>\"", ",", 
           RowBox[{"IgnoreCase", "->", "True"}]}], "]"}], "==", "False"}], 
        " ", "&&", " ", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"StringContainsQ", "[", 
          RowBox[{"#", ",", "\"\<@\>\""}], "]"}], "==", "False"}], " ", "&&", 
        " ", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"StringLength", "@", "#"}], ">", "1"}]}], "&"}]}], "]"}], 
    "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.961495560783494*^9, 3.961495612263001*^9}},
 CellLabel->"In[43]:=",ExpressionUUID->"186a7356-b438-46a4-92ef-1b5e4cef4f3a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Input", ":", 
      RowBox[{
       RowBox[{"-", "text"}], " ", "raw", " ", "text", " ", "string"}]}], ";",
      "\[IndentingNewLine]", 
     RowBox[{"Output", ":", 
      RowBox[{
       RowBox[{"-", "cleaned"}], " ", "text", " ", "string", " ", "with", " ",
        "diacritics", " ", "removed"}]}]}], ",", " ", 
    RowBox[{"only", " ", "letters"}], ",", " ", "punctuation", ",", " ", 
    RowBox[{"and", " ", "whitespace", " ", "preserved"}], ",", " ", 
    RowBox[{
     RowBox[{
     "extra", " ", "spaces", " ", "reduced", " ", "to", " ", "single", " ", 
      "spaces"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Description", ":", " ", 
      RowBox[{
      "Inserts", " ", "spaces", " ", "after", " ", "punctuation"}]}]}], ",", 
    " ", 
    RowBox[{"removes", " ", "diacritics"}], ",", " ", 
    RowBox[{
     RowBox[{"filters", " ", "out", " ", "non"}], "-", 
     RowBox[{"alphabetic", "/", "non"}], "-", 
     RowBox[{"punctuation", " ", "characters"}]}], ",", " ", 
    RowBox[{"and", " ", "normalizes", " ", 
     RowBox[{"whitespace", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"CleanText", "[", "text_", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "char", ",", "addedSpaces", ",", "httplinks", ",", "textSpaced", ",", 
       "textCleaned"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"addedSpaces", "=", 
       RowBox[{
        RowBox[{"DeleteDuplicates", "@", 
         RowBox[{"Flatten", "@", 
          RowBox[{"StringPosition", "[", 
           RowBox[{"text", ",", "PunctuationCharacter"}], "]"}]}]}], "+", 
        "1"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"textSpaced", "=", 
       RowBox[{"StringInsert", "[", 
        RowBox[{"text", ",", "\"\< \>\"", ",", "addedSpaces"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"char", "=", 
       RowBox[{"Characters", "[", 
        RowBox[{"RemoveDiacritics", "[", "textSpaced", "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"textCleaned", "=", "\[IndentingNewLine]", 
       RowBox[{"StringJoin", "[", 
        RowBox[{"StringCases", "[", 
         RowBox[{"char", ",", " ", 
          RowBox[{
           RowBox[{"Alternatives", "@@", 
            RowBox[{"Alphabet", "[", "]"}]}], "|", 
           RowBox[{"Alternatives", "@@", 
            RowBox[{"ToUpperCase", "@", 
             RowBox[{"Alphabet", "[", "]"}]}]}], "|", "PunctuationCharacter", 
           "|", "WhitespaceCharacter"}]}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"StringReplace", "[", 
       RowBox[{"textCleaned", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"\"\< \>\"", "~~", 
           RowBox[{"\"\< \>\"", ".."}]}], "->", "\"\< \>\""}], "}"}]}], 
       "]"}]}]}], "\[IndentingNewLine]", "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.96149563359475*^9, 3.961495660064283*^9}},
 CellLabel->"In[44]:=",ExpressionUUID->"03fdd8e9-7efb-4842-92d0-e36f107b3721"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", 
     RowBox[{
      RowBox[{"-", "text"}], " ", "input", " ", "text", " ", "string"}]}], 
    ";", "\[IndentingNewLine]", 
    RowBox[{"Output", ":", 
     RowBox[{
      RowBox[{"-", "text"}], " ", "with", " ", "normalized", " ", "spaces", 
      " ", "and", " ", "line", " ", "breaks"}]}], ";", "\[IndentingNewLine]", 
    RowBox[{"Description", ":", " ", 
     RowBox[{
     "Replaces", " ", "multiple", " ", "consecutive", " ", "spaces", " ", 
      "with", " ", "a", " ", "single", " ", "space", " ", "and", " ", 
      "multiple", " ", "consecutive", " ", "newlines", " ", "with", " ", "a", 
      " ", "single", " ", 
      RowBox[{"newline", "."}]}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"CleanTextSimple", "[", "text_", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"spaces", ",", "returns"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"spaces", "=", 
       RowBox[{"StringReplace", "[", 
        RowBox[{"text", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"\"\< \>\"", "~~", 
            RowBox[{"\"\< \>\"", ".."}]}], "->", "\"\< \>\""}], "}"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"returns", "=", 
       RowBox[{"StringReplace", "[", 
        RowBox[{"spaces", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"\"\<\\n\>\"", "~~", 
            RowBox[{"\"\<\\n\>\"", ".."}]}], "->", "\"\<\\n\>\""}], "}"}]}], 
        "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{
  3.961495485618512*^9, {3.961495679050548*^9, 3.96149568794026*^9}},
 CellLabel->"In[45]:=",ExpressionUUID->"fce45bd4-035b-4a78-9bd9-8047475fd65b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", 
     RowBox[{
      RowBox[{"-", "text"}], " ", "input", " ", "string", " ", "to", " ", 
      "process"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"-", "minLen"}], ",", 
    RowBox[{
     RowBox[{
     "maxLen", " ", "minimum", " ", "and", " ", "maximum", " ", "paragraph", 
      " ", "lengths"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Output", ":", " ", 
      RowBox[{
       RowBox[{"-", "list"}], " ", "of", " ", "paragraphs", " ", "split", " ",
        "into", " ", "subparagraphs", " ", "where", " ", "appropriate"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"Description", ":", " ", 
      RowBox[{
      "Splits", " ", "the", " ", "input", " ", "text", " ", "into", " ", 
       "paragraphs", " ", 
       RowBox[{"(", 
        RowBox[{"based", " ", "on", " ", "line", " ", "breaks"}], ")"}], " ", 
       "and", " ", "further", " ", "divides", " ", "long", " ", "paragraphs", 
       " ", "into", " ", "subparagraphs", " ", "at", " ", "sentence", " ", 
       "boundaries", " ", "to", " ", "stay", " ", "within", " ", "the", " ", 
       "desired", " ", "length", " ", 
       RowBox[{"range", "."}]}]}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"Paragraphize", "[", 
    RowBox[{"text_", ",", "minLen_", ",", "maxLen_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "paragraphsRaw", ",", "paragraphs", ",", "paragraphsSplit", ",", 
       "paragraph", ",", "breakPos", ",", "breakPointLen", ",", 
       "breakPointPos", ",", "break", ",", "breakSeq"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"paragraphsRaw", "=", 
       RowBox[{"StringSplit", "[", 
        RowBox[{"text", ",", "\"\<\\n\>\""}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"paragraphs", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"StringTrim", "[", 
          RowBox[{"StringDelete", "[", 
           RowBox[{"#", ",", 
            RowBox[{"StringCases", "[", 
             RowBox[{"#", ",", 
              RowBox[{"\"\<==\>\"", "~~", " ", "___", "~~", "\"\<==\>\""}]}], 
             "]"}]}], "]"}], "]"}], "&"}], "/@", "paragraphsRaw"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"paragraphsSplit", "=", 
       RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"paragraph", "=", 
          RowBox[{"paragraphs", "[", 
           RowBox[{"[", "p", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"StringLength", "@", "paragraph"}], "!=", "0"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"breakPos", "=", 
             RowBox[{"StringPosition", "[", 
              RowBox[{"paragraph", ",", 
               RowBox[{"\"\<.\>\"", "~~", "WhitespaceCharacter"}]}], "]"}]}], 
            ";", "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{"Identify", " ", "how", " ", 
              RowBox[{"many", " ", ".", " ", "needed"}], " ", "to", " ", 
              "fill", " ", "subparagraph"}], "*)"}], "\[IndentingNewLine]", 
            RowBox[{"breakPointLen", "=", 
             RowBox[{"Ceiling", "[", 
              RowBox[{
               RowBox[{"Length", "@", "breakPos"}], "/", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"StringLength", "@", "paragraph"}], "/", "maxLen"}], 
                ")"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
             "Identify", " ", "Positions", " ", "where", " ", "to", " ", 
              "split"}], "*)"}], "\[IndentingNewLine]", 
            RowBox[{"breakPointPos", "=", 
             RowBox[{"Range", "[", 
              RowBox[{"breakPointLen", ",", 
               RowBox[{
                RowBox[{"Length", "@", "breakPos"}], "-", "1"}], ",", 
               "breakPointLen"}], "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{"Create", " ", "sequence", " ", "markers"}], "*)"}], 
            "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Length", "@", "breakPointPos"}], "!=", "0"}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"break", "=", 
                RowBox[{
                 RowBox[{
                  RowBox[{"Part", "[", 
                   RowBox[{"breakPos", ",", "#"}], "]"}], "&"}], "/@", 
                 "breakPointPos"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"breakSeq", "=", 
                RowBox[{"Join", "[", 
                 RowBox[{
                  RowBox[{"Table", "[", 
                   RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"i", "==", "1"}], ",", "\[IndentingNewLine]", 
                    RowBox[{"{", 
                    RowBox[{"1", ",", 
                    RowBox[{"break", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "2"}], "]"}], "]"}]}], "}"}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"break", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"i", "-", "1"}], ",", "2"}], "]"}], "]"}], "+", 
                    "1"}], ",", 
                    RowBox[{"break", "[", 
                    RowBox[{"[", 
                    RowBox[{"i", ",", "1"}], "]"}], "]"}]}], "}"}]}], "]"}], 
                    ",", 
                    RowBox[{"{", 
                    RowBox[{"i", ",", 
                    RowBox[{"Length", "@", "break"}]}], "}"}]}], "]"}], ",", 
                  RowBox[{"{", 
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"Last", "[", "break", "]"}], "[", 
                    RowBox[{"[", "2", "]"}], "]"}], "+", "1"}], ",", 
                    RowBox[{"StringLength", "@", "paragraph"}]}], "}"}], 
                   "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"(*", 
                RowBox[{
                "Split", " ", "Paragraphs", " ", "where", " ", "needed"}], 
                "*)"}], "\[IndentingNewLine]", 
               RowBox[{"paragraph", "=", 
                RowBox[{
                 RowBox[{
                  RowBox[{"StringTrim", "[", 
                   RowBox[{"StringTake", "[", 
                    RowBox[{"paragraph", ",", "#"}], "]"}], "]"}], "&"}], "/@",
                  "breakSeq"}]}]}], ",", "\[IndentingNewLine]", 
              RowBox[{"paragraph", "=", 
               RowBox[{"{", "paragraph", "}"}]}]}], "]"}], ";"}], ",", 
           RowBox[{
            RowBox[{"paragraph", "=", 
             RowBox[{"{", "paragraph", "}"}]}], ";"}]}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"paragraphsSplit", "=", 
          RowBox[{"AppendTo", "[", 
           RowBox[{"paragraphsSplit", ",", "paragraph"}], "]"}]}], ";"}], ",", 
        RowBox[{"{", 
         RowBox[{"p", ",", "1", ",", 
          RowBox[{"Length", "@", "paragraphs"}]}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "paragraphsSplit"}]}], "\[IndentingNewLine]", 
    "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.919691233500923*^9, 3.919691377947925*^9}, {
  3.9264104376138215`*^9, 3.9264104405081353`*^9}, {3.961495749612064*^9, 
  3.961495763863707*^9}},
 CellLabel->"In[46]:=",ExpressionUUID->"21188de8-a9d6-4c9a-9bad-4776924be27b"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["Image Collection Helpers",
 FontColor->RGBColor[0.4, 0.4000152590218967, 0.4]]], "Subsubsection",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004670496183*^9}, {
  3.9241006465262146`*^9, 3.924100650918215*^9}, {3.9242581271173253`*^9, 
  3.9242581297813253`*^9}, {3.96142730167209*^9, 3.961427306455673*^9}, {
  3.9614653032373657`*^9, 3.961465314612693*^9}, {3.96149290833879*^9, 
  3.9614929110436296`*^9}, {3.961493138362278*^9, 3.9614931452069483`*^9}, {
  3.96149340559212*^9, 3.961493406636104*^9}, {3.961495506665543*^9, 
  3.9614955420045424`*^9}, {3.961495720665277*^9, 
  3.961495742445867*^9}},ExpressionUUID->"a5ae03f5-8ce1-4fb5-9f1b-\
cad4c448a2ff"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Input", ":", 
      RowBox[{"-", "hashFilePath"}], ":", 
      RowBox[{
      "path", " ", "to", " ", "a", " ", "file", " ", "containing", " ", 
       "image", " ", "hashes"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Output", ":", 
      RowBox[{
       RowBox[{"-", "list"}], " ", "of", " ", "hashes", " ", "as", " ", 
       "strings"}]}]}], ",", 
    RowBox[{
     RowBox[{
     "or", " ", "an", " ", "empty", " ", "list", " ", "if", " ", "the", " ", 
      "file", " ", "is", " ", "missing"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Description", ":", " ", 
      RowBox[{
      "Loads", " ", "image", " ", "hashes", " ", "from", " ", "the", " ", 
       "given", " ", "file", " ", "if", " ", "it", " ", "exists"}]}]}], ",", 
    " ", 
    RowBox[{
    "ensuring", " ", "all", " ", "entries", " ", "are", " ", "returned", " ", 
     "as", " ", 
     RowBox[{"strings", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"LoadHashes", "[", "hashFilePath_", "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "file", "}"}], ",", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"FileExistsQ", "[", "hashFilePath", "]"}], ",", 
        RowBox[{"ToString", "/@", 
         RowBox[{"Import", "[", 
          RowBox[{"hashFilePath", ",", "\"\<List\>\""}], "]"}]}], ",", 
        RowBox[{"{", "}"}]}], "]"}]}], "]"}]}], ";"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{
  3.9247834365336847`*^9, {3.9249217341283174`*^9, 3.9249217353365817`*^9}, {
   3.9249311681606846`*^9, 3.9249311804836845`*^9}, {3.924937981147683*^9, 
   3.9249379995881786`*^9}, {3.961392099550758*^9, 3.9613921072678213`*^9}, {
   3.961495782566832*^9, 3.9614958450559807`*^9}},
 CellLabel->"In[47]:=",ExpressionUUID->"20549d1e-b531-4974-b55f-47be8110fb92"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", " ", 
     RowBox[{"-", "hash"}], ":", 
     RowBox[{"the", " ", "hash", " ", "string", " ", "to", " ", "save"}]}], 
    ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"-", 
      RowBox[{"hashFilePath", ":", 
       RowBox[{
       "path", " ", "to", " ", "the", " ", "file", " ", "where", " ", "the", 
        " ", "hash", " ", "should", " ", "be", " ", "appended"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Output", ":", " ", 
      RowBox[{
       RowBox[{"-", "none"}], " ", 
       RowBox[{"(", 
        RowBox[{"writes", " ", "directly", " ", "to", " ", "file"}], 
        ")"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Description", ":", " ", 
      RowBox[{
      "Appends", " ", "a", " ", "new", " ", "hash", " ", "to", " ", "the", 
       " ", "specified", " ", "hash", " ", "file"}]}]}], ",", " ", 
    RowBox[{
    "ensuring", " ", "it", " ", "is", " ", "recorded", " ", "after", " ", 
     "image", " ", 
     RowBox[{"download", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"SaveHash", "[", 
     RowBox[{"hash_", ",", "hashFilePath_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "stream", "}"}], ",", 
      RowBox[{
       RowBox[{"stream", "=", 
        RowBox[{"OpenAppend", "[", "hashFilePath", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Write", "[", 
        RowBox[{"stream", ",", "hash"}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"Close", "[", "stream", "]"}], ";"}]}], "]"}]}], 
   ";"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{
  3.961495780527731*^9, {3.9614958141637573`*^9, 3.961495822660367*^9}, {
   3.961495864011845*^9, 3.961495883363378*^9}},
 CellLabel->"In[48]:=",ExpressionUUID->"a2322915-85db-432a-94f2-ca27cca58df7"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", 
     RowBox[{
      RowBox[{"-", "urlDownload"}], " ", "URL"}]}], ",", " ", 
    RowBox[{
     RowBox[{"-", "urlHash"}], " ", "URL", " ", "listed", " ", "in", " ", 
     "WikiCode", " ", "for", " ", "hashing"}], ",", " ", 
    RowBox[{
     RowBox[{"-", "downloadPath"}], " ", "save", " ", "folder"}], ",", 
    RowBox[{
     RowBox[{"-", "hashFilePath"}], " ", "hash", " ", 
     RowBox[{"log", ".", " ", "\[IndentingNewLine]", 
      RowBox[{"Output", ":", " ", "None"}]}]}], ",", " ", 
    RowBox[{
    "saves", " ", "image", " ", "to", " ", "disk", " ", "and", " ", "updates",
      " ", "hash", " ", 
     RowBox[{"record", ".", "\[IndentingNewLine]", 
      RowBox[{"Description", ":", " ", 
       RowBox[{"Hashes", " ", "URL", " ", "with", " ", "MD5"}]}]}]}], ",", 
    " ", 
    RowBox[{
    "downloads", " ", "an", " ", "image", " ", "if", " ", "its", " ", "hash", 
     " ", "is", " ", "not", " ", "yet", " ", "in", " ", "the", " ", "log"}], 
    ",", " ", 
    RowBox[{"filters", " ", "out", " ", "icons"}], ",", " ", 
    RowBox[{"resizes", " ", "large", " ", "images"}], ",", 
    RowBox[{"saves", " ", "as", " ", "JPEG"}], ",", " ", 
    RowBox[{"and", " ", "records", " ", "the", " ", 
     RowBox[{"hash", ".", " ", "Written"}], " ", "for", " ", "maximum", " ", 
     RowBox[{"robustness", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"DownloadImageFast", "[", 
     RowBox[{
     "urlDownload_String", ",", "urlHash_String", ",", "downloadPath_String", 
      ",", "hashFilePath_"}], "]"}], ":=", "\[IndentingNewLine]", 
    RowBox[{"Block", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "hash", ",", "filePath", ",", "imageRaw", ",", "imageScaled", ",", 
        "link", ",", "pixelData", ",", "image", ",", "imageSize"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"hash", "=", 
        RowBox[{"StringTake", "[", 
         RowBox[{
          RowBox[{"ToString", "[", 
           RowBox[{"Abs", "[", 
            RowBox[{"Hash", "[", 
             RowBox[{"urlHash", ",", "\"\<MD5\>\""}], "]"}], "]"}], "]"}], 
          ",", "18"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"!", 
          RowBox[{"KeyExistsQ", "[", 
           RowBox[{"downloadedImages", ",", "hash"}], "]"}]}], ",", 
         RowBox[{
          RowBox[{"filePath", "=", 
           RowBox[{"FileNameJoin", "[", 
            RowBox[{"{", 
             RowBox[{"downloadPath", ",", 
              RowBox[{"StringTake", "[", 
               RowBox[{"hash", ",", "3"}], "]"}], ",", 
              RowBox[{"hash", "<>", "\"\<.jpg\>\""}]}], "}"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"link", "=", "urlDownload"}], ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"!", 
             RowBox[{"FileExistsQ", "[", "filePath", "]"}]}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"!", 
               RowBox[{"link", "===", "\"\<\>\""}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"imageRaw", "=", 
                RowBox[{"Quiet", "@", 
                 RowBox[{"Check", "[", 
                  RowBox[{
                   RowBox[{"Import", "[", 
                    RowBox[{"link", ",", 
                    RowBox[{"IncludeMetaInformation", "->", "None"}]}], "]"}],
                    ",", 
                   RowBox[{"Print", "[", 
                    RowBox[{"\"\<Unable to download \>\"", "<>", "link"}], 
                    "]"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{"ImageQ", "[", "imageRaw", "]"}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"imageSize", "=", 
                   RowBox[{"Times", "[", 
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"ImageDimensions", "[", "imageRaw", "]"}]}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{"!", 
                    RowBox[{"imageSize", ">", "100000000"}]}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"pixelData", "=", 
                    RowBox[{"ImageData", "[", 
                    RowBox[{"RemoveAlphaChannel", "[", "imageRaw", "]"}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                    RowBox[{"image", "=", 
                    RowBox[{"Image", "[", "pixelData", "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"!", 
                    RowBox[{"MemberQ", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"iconClassifier", "[", "image", "]"}], "}"}], ",",
                     "True"}], "]"}]}], ",", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"imageScaled", "=", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"imageSize", ">=", 
                    RowBox[{"(", 
                    RowBox[{"1024", "*", "1024"}], ")"}]}], ",", 
                    RowBox[{"ImageResize", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"First", "[", 
                    RowBox[{"Flatten", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Position", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"Max", "[", "#", "]"}]}], "]"}], "&"}], "@", 
                    RowBox[{"ImageDimensions", "[", "#", "]"}]}], "]"}], 
                    "]"}], "==", "1"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"1024", ",", "Automatic"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"Automatic", ",", "1024"}], "}"}]}], "]"}], ",", 
                    RowBox[{"Resampling", "->", "\"\<Lanczos\>\""}]}], "]"}], 
                    ",", "#"}], "]"}], "&"}], "@", "image"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"Export", "[", 
                    RowBox[{
                    "filePath", ",", "imageScaled", ",", "\"\<JPEG\>\""}], 
                    "]"}], ";", "\[IndentingNewLine]", 
                    RowBox[{"AssociateTo", "[", 
                    RowBox[{"downloadedImages", ",", 
                    RowBox[{"hash", "->", "True"}]}], "]"}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"SaveHash", "[", 
                    RowBox[{"hash", ",", "hashFilePath"}], "]"}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"Pause", "[", "0.001", "]"}], ";"}]}], "]"}]}]}], 
                   "]"}]}]}], "]"}]}]}], "]"}]}], "]"}], ";"}]}], 
        "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.924779371500639*^9, 3.924779397255707*^9}, {
   3.92478031349761*^9, 3.924780324872347*^9}, 3.924780410105177*^9, {
   3.9247824333861036`*^9, 3.9247824339456534`*^9}, 3.9247825308686466`*^9, {
   3.924783044521529*^9, 3.9247830622847033`*^9}, {3.924783138219556*^9, 
   3.924783147882511*^9}, {3.9247834931894126`*^9, 3.924783497133028*^9}, {
   3.9247839362411394`*^9, 3.9247839400282316`*^9}, {3.924784780672579*^9, 
   3.924784792225212*^9}, {3.9247849176514482`*^9, 3.9247849353910427`*^9}, {
   3.924785008086385*^9, 3.9247850180326586`*^9}, {3.9247850546672125`*^9, 
   3.9247850831203966`*^9}, 3.924785200731428*^9, {3.9247853192887096`*^9, 
   3.924785337529565*^9}, {3.924785415169422*^9, 3.9247854237170715`*^9}, {
   3.924791790603731*^9, 3.924791805285123*^9}, {3.924791923711466*^9, 
   3.9247919377532067`*^9}, {3.92479952191619*^9, 3.924799580165193*^9}, {
   3.9248478241670265`*^9, 3.9248478284465747`*^9}, {3.9248481331594105`*^9, 
   3.9248482372784853`*^9}, {3.924851233533375*^9, 3.9248513351006117`*^9}, {
   3.9249312114784966`*^9, 3.9249312393964725`*^9}, {3.9249315048597584`*^9, 
   3.924931510809402*^9}, {3.92494950213258*^9, 3.9249495069299593`*^9}, {
   3.924954519198613*^9, 3.9249545270704107`*^9}, {3.9249545654421387`*^9, 
   3.9249545761159916`*^9}, {3.9249566686823606`*^9, 3.924956674846059*^9}, 
   3.9270405408075094`*^9, {3.961390601607769*^9, 3.961390604446904*^9}, {
   3.961392075273868*^9, 3.961392106439116*^9}, {3.96147999528653*^9, 
   3.961479998657525*^9}, {3.961480116393465*^9, 3.961480157972974*^9}, {
   3.961480246646955*^9, 3.9614802551493397`*^9}, {3.961480488693347*^9, 
   3.9614805277517223`*^9}, {3.961480757532784*^9, 3.961480761865395*^9}, 
   3.9614811614379272`*^9, {3.9614813133705463`*^9, 3.9614813134541903`*^9}, {
   3.961482086091321*^9, 3.96148210254182*^9}, 3.961482676042993*^9, 
   3.961482953083475*^9, {3.961483227008069*^9, 3.961483227288041*^9}, 
   3.961486652314542*^9, {3.961495973610593*^9, 3.961496071253066*^9}, {
   3.961496129496372*^9, 3.961496239359469*^9}},
 CellLabel->"In[49]:=",ExpressionUUID->"d678b1c9-374c-4f38-8ab6-9c5f61ba93a1"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", 
     RowBox[{
      RowBox[{"-", "imgLinks"}], " ", "list", " ", "of", " ", "image", " ", 
      "file", " ", "links", " ", "from", " ", 
      RowBox[{"WikiCode", ".", "\[IndentingNewLine]", "Output"}]}], ":", " ", 
     RowBox[{
     "Association", " ", "mapping", " ", "each", " ", "file", " ", "name", 
      " ", "to", " ", "its", " ", "full", " ", "image", " ", 
      RowBox[{"URL", ".", "\[IndentingNewLine]", 
       RowBox[{"Description", ":", " ", 
        RowBox[{
        "Queries", " ", "the", " ", "Wikipedia", " ", "API", " ", "for", " ", 
         "a", " ", "batch", " ", "of", " ", "images", " ", "to", " ", "fetch",
          " ", "their", " ", "public", " ", "URLs"}]}]}]}]}], ",", 
    RowBox[{
    "returning", " ", "a", " ", "mapping", " ", "of", " ", "filename", " ", 
     RowBox[{"(", 
      RowBox[{"with", " ", "underscores"}], ")"}], " ", "to", " ", 
     RowBox[{"URL", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"FetchImageListURL", "[", "imgLinks_", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "fileTitles", ",", "apiUrl", ",", "response", ",", "json", ",", 
       "resultAssoc"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"fileTitles", "=", 
       RowBox[{"Last", "/@", 
        RowBox[{"FileNameSplit", "/@", "imgLinks"}]}]}], ";", 
      RowBox[{"apiUrl", "=", 
       RowBox[{
       "\"\<https://en.wikipedia.org/w/api.php?action=query&titles=\>\"", "<>", 
        RowBox[{"URLEncode", "[", 
         RowBox[{"StringRiffle", "[", 
          RowBox[{"fileTitles", ",", "\"\<|\>\""}], "]"}], "]"}], "<>", 
        "\"\<&prop=imageinfo&iiprop=url&format=json\>\""}]}], ";", 
      RowBox[{"response", "=", 
       RowBox[{"URLRead", "[", 
        RowBox[{"apiUrl", ",", "\"\<Body\>\""}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"json", "=", 
       RowBox[{"ImportString", "[", 
        RowBox[{"response", ",", "\"\<RawJSON\>\""}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"resultAssoc", "=", 
       RowBox[{"Association", "[", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"StringReplace", "[", 
            RowBox[{
             RowBox[{"Quiet", "[", 
              RowBox[{"Check", "[", 
               RowBox[{
                RowBox[{"json", "[", 
                 RowBox[{"[", 
                  RowBox[{
                  "\"\<query\>\"", ",", "\"\<pages\>\"", ",", "i", ",", 
                   "\"\<title\>\""}], "]"}], "]"}], ",", "\"\<\>\""}], "]"}], 
              "]"}], ",", 
             RowBox[{"\"\< \>\"", "->", "\"\<_\>\""}]}], "]"}], "->", 
           RowBox[{"Quiet", "[", 
            RowBox[{"Check", "[", 
             RowBox[{
              RowBox[{"json", "[", 
               RowBox[{"[", 
                RowBox[{
                "\"\<query\>\"", ",", "\"\<pages\>\"", ",", "i", ",", 
                 "\"\<imageinfo\>\"", ",", "1", ",", "\"\<url\>\""}], "]"}], 
               "]"}], ",", "\"\<\>\""}], "]"}], "]"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", 
            RowBox[{"Length", "[", 
             RowBox[{"json", "[", 
              RowBox[{"[", 
               RowBox[{"\"\<query\>\"", ",", "\"\<pages\>\""}], "]"}], "]"}], 
             "]"}]}], "}"}]}], "]"}], "]"}]}]}]}], "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.923647968782483*^9, 3.9236480569568167`*^9}, {
   3.9236481242749357`*^9, 3.923648126592845*^9}, 3.923648183743285*^9, {
   3.923648223431078*^9, 3.923648234281247*^9}, {3.924088339659685*^9, 
   3.9240883521312037`*^9}, 3.9247848771708145`*^9, 3.9247849126569867`*^9, 
   3.924848276646801*^9, {3.9248498893329897`*^9, 3.92484994048603*^9}, 
   3.924850020671301*^9, {3.924853900269702*^9, 3.9248539041813183`*^9}, {
   3.9248539557088833`*^9, 3.9248539828765717`*^9}, {3.9248545249333105`*^9, 
   3.9248545567554913`*^9}, {3.924854725565076*^9, 3.924854769404374*^9}, {
   3.9249215708675437`*^9, 3.9249215763401613`*^9}, {3.924931194049127*^9, 
   3.9249311971358776`*^9}, {3.961496262671006*^9, 3.9614962869535933`*^9}, {
   3.9614963536160994`*^9, 3.961496354269182*^9}},
 CellLabel->"In[50]:=",ExpressionUUID->"403f4ade-5328-497d-84b1-b2cb5b3b0d12"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", 
     RowBox[{
      RowBox[{"-", "imgLink"}], " ", "an", " ", "image", " ", "file", " ", 
      "links", " ", "from", " ", 
      RowBox[{"WikiCode", ".", "\[IndentingNewLine]", "Output"}]}], ":", " ", 
     RowBox[{
     "Association", " ", "mapping", " ", "the", " ", "file", " ", "name", " ",
       "to", " ", "its", " ", "full", " ", "image", " ", 
      RowBox[{"URL", ".", "\[IndentingNewLine]", 
       RowBox[{"Description", ":", " ", 
        RowBox[{
        "Queries", " ", "the", " ", "Wikipedia", " ", "API", " ", "for", " ", 
         "an", " ", "image", " ", "to", " ", "fetch", " ", "its", " ", 
         "public", " ", "URLs"}]}]}]}]}], ",", 
    RowBox[{
    "returning", " ", "a", " ", "mapping", " ", "of", " ", "filename", " ", 
     "to", " ", 
     RowBox[{"URL", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"FetchImageURL", "[", "imgLink_", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"fileTitle", ",", "apiUrl", ",", "response", ",", "json"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"fileTitle", "=", 
       RowBox[{"Last", "@", 
        RowBox[{"FileNameSplit", "@", "imgLink"}]}]}], ";", 
      RowBox[{"apiUrl", "=", 
       RowBox[{
       "\"\<https://en.wikipedia.org/w/api.php?action=query&titles=\>\"", "<>", 
        RowBox[{"URLEncode", "[", "fileTitle", "]"}], "<>", 
        "\"\<&prop=imageinfo&iiprop=url&format=json\>\""}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"response", "=", 
       RowBox[{"URLRead", "[", 
        RowBox[{"apiUrl", ",", "\"\<Body\>\""}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"json", "=", 
       RowBox[{"ImportString", "[", 
        RowBox[{"response", ",", "\"\<RawJSON\>\""}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"StringQ", "[", "#", "]"}], ",", "#", ",", "\"\<\>\""}], 
         "]"}], "&"}], "@", 
       RowBox[{"json", "[", 
        RowBox[{"[", 
         RowBox[{
         "\"\<query\>\"", ",", "\"\<pages\>\"", ",", "1", ",", 
          "\"\<imageinfo\>\"", ",", "1", ",", "\"\<url\>\""}], "]"}], 
        "]"}]}]}]}], "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.923647968782483*^9, 3.9236480569568167`*^9}, {
   3.9236481242749357`*^9, 3.923648126592845*^9}, 3.923648183743285*^9, {
   3.923648223431078*^9, 3.923648234281247*^9}, {3.924088339659685*^9, 
   3.9240883521312037`*^9}, 3.9247848771708145`*^9, 3.9247849126569867`*^9, 
   3.924848276646801*^9, {3.9614962969750566`*^9, 3.961496311711371*^9}, {
   3.961496345806431*^9, 3.961496363099791*^9}},
 CellLabel->"In[51]:=",ExpressionUUID->"cb31ae3c-b249-4f34-b942-0f6594e4b987"]
}, Closed]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["Various Other Helpers",
 FontColor->RGBColor[0.4, 0.4000152590218967, 0.4]]], "Subsubsection",
 CellChangeTimes->{{3.9240046088190184`*^9, 3.924004670496183*^9}, {
  3.9241006465262146`*^9, 3.924100650918215*^9}, {3.9242581271173253`*^9, 
  3.9242581297813253`*^9}, {3.96142730167209*^9, 3.961427306455673*^9}, {
  3.9614653032373657`*^9, 3.961465314612693*^9}, {3.96149290833879*^9, 
  3.9614929110436296`*^9}, {3.961493138362278*^9, 3.9614931452069483`*^9}, {
  3.96149340559212*^9, 3.961493406636104*^9}, {3.961495506665543*^9, 
  3.9614955420045424`*^9}, {3.961495712027873*^9, 3.961495713033374*^9}, {
  3.961496639245192*^9, 
  3.961496659482484*^9}},ExpressionUUID->"159fc013-7ea9-492f-95d4-\
619d9f6f997a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{"Input", ":", 
    RowBox[{
     RowBox[{"-", "stringElem"}], " ", "a", " ", "string", " ", 
     "representing", " ", "a", " ", "vector", " ", "and", " ", 
     RowBox[{"ID", ".", "\[IndentingNewLine]", "Output"}]}], ":", " ", 
    RowBox[{"List", " ", "with", " ", "two", " ", 
     RowBox[{"elements", ":", 
      RowBox[{"the", " ", "evaluated", " ", "vector", " ", 
       RowBox[{"(", 
        RowBox[{"as", " ", "expression"}], ")"}], " ", "and", " ", "the", " ",
        "ID", " ", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"as", " ", "string"}], ")"}], ".", "\[IndentingNewLine]", 
        "Description"}]}], ":", " ", 
      RowBox[{"Used", " ", "to", " ", "convert", " ", "incrementally", " ", 
       RowBox[{"written", ".", "txt"}], " ", "lines", " ", "into", " ", 
       "proper", " ", "expressions", " ", 
       RowBox[{"for", ".", "wxf"}], " ", 
       RowBox[{"export", "."}]}]}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"StringElemToExp", "[", "stringElem_", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"unBracketed", ",", "vecPart", ",", "idPart"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"unBracketed", "=", 
       RowBox[{"StringDrop", "[", 
        RowBox[{
         RowBox[{"StringDrop", "[", 
          RowBox[{"stringElem", ",", 
           RowBox[{"-", "1"}]}], "]"}], ",", "1"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"vecPart", "=", 
       RowBox[{"ToExpression", "@", 
        RowBox[{"First", "@", 
         RowBox[{"StringCases", "[", 
          RowBox[{"unBracketed", ",", 
           RowBox[{"\"\<{\>\"", "~~", "___", "~~", "\"\<}\>\""}]}], 
          "]"}]}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"idPart", "=", 
       RowBox[{"First", "@", 
        RowBox[{"StringDelete", "[", 
         RowBox[{
          RowBox[{"StringCases", "[", 
           RowBox[{"unBracketed", ",", 
            RowBox[{"\"\<}, \>\"", "~~", "___", "~~", "EndOfString"}]}], 
           "]"}], ",", "\"\<}, \>\""}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{"vecPart", ",", "idPart"}], "}"}]}]}], "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9325728256943045`*^9, 3.9325729347955513`*^9}, 
   3.932573083395735*^9, {3.9325731452704625`*^9, 3.932573146917719*^9}, {
   3.961496402372224*^9, 3.9614964961252623`*^9}},
 CellLabel->"In[52]:=",ExpressionUUID->"d4f01026-3dc3-4cb4-9456-4ff24f2e92cb"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", 
     RowBox[{
      RowBox[{"-", "vecList"}], " ", "list", " ", "of", " ", "vectors"}]}], 
    ",", " ", 
    RowBox[{
     RowBox[{"-", "dimensions"}], " ", "number", " ", "of", " ", "vec", " ", 
     RowBox[{"dimensions", ".", "\[IndentingNewLine]", 
      RowBox[{"Output", ":", " ", 
       RowBox[{
       "Association", " ", "representing", " ", "a", " ", "1", "D", " ", 
        "SOM", " ", "kernel", " ", "with", " ", "weights"}]}]}]}], ",", " ", 
    RowBox[{"coordinates", " ", "and", " ", 
     RowBox[{"distances", ".", "\[IndentingNewLine]", 
      RowBox[{"Description", ":", " ", 
       RowBox[{
       "Builds", " ", "a", " ", "1", "D", " ", "SOM", " ", "with", " ", 
        "only", " ", "one", " ", "cell", " ", "as", " ", 
        RowBox[{"placeholder", "."}]}]}]}]}]}], "*)"}], "\[IndentingNewLine]",
   "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"SomKernel1D", "[", 
    RowBox[{"vecList_", ",", "dimensions_"}], "]"}], ":=", 
   RowBox[{"Association", "[", 
    RowBox[{
     RowBox[{"\"\<dimensions\>\"", "\[Rule]", 
      RowBox[{"Association", "[", 
       RowBox[{
        RowBox[{"\"\<x\>\"", "\[Rule]", "1"}], ",", 
        RowBox[{"\"\<y\>\"", "\[Rule]", "1"}], ",", 
        RowBox[{"\"\<dim\>\"", "\[Rule]", 
         RowBox[{"{", "dimensions", "}"}]}], ",", 
        RowBox[{"\"\<len\>\"", "\[Rule]", "1"}]}], "]"}]}], ",", 
     RowBox[{"\"\<weights\>\"", "\[Rule]", "vecList"}], ",", 
     RowBox[{"\"\<coordinates\>\"", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"1", ",", "1"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "1"}], "}"}]}], "}"}]}], ",", 
     RowBox[{"\"\<distances\>\"", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0"}], "}"}]}], "}"}]}]}], "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9331427181230955`*^9, 3.933142718236849*^9}, {
  3.961496503615882*^9, 3.961496580176324*^9}},
 CellLabel->"In[53]:=",ExpressionUUID->"1112af70-1ecf-46a1-aa6e-716a8f537588"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Input", ":", 
     RowBox[{
      RowBox[{"-", "a"}], " ", "association"}]}], ",", " ", 
    RowBox[{
     RowBox[{"-", "old"}], "\[RightArrow]", 
     RowBox[{"new", ":", 
      RowBox[{"rule", " ", "specifying", " ", "key", " ", "to", " ", 
       RowBox[{"rename", ".", "\[IndentingNewLine]", "Output"}]}], ":", " ", 
      RowBox[{"Association", " ", "with", " ", 
       RowBox[{"key", "'"}], 
       RowBox[{"old", "'"}], " ", "renamed", " ", 
       RowBox[{"to", "'"}], 
       RowBox[{"new", "'"}], " ", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"only", " ", 
          RowBox[{"if", "'"}], 
          RowBox[{"old", "'"}], " ", "exists"}], ")"}], ".", 
        "\[IndentingNewLine]", 
        RowBox[{"Description", ":", 
         RowBox[{
         "Renames", " ", "a", " ", "key", " ", "in", " ", "an", " ", 
          "association", " ", "by", " ", "removing", " ", "old", " ", "key", 
          " ", "and", " ", "adding", " ", "the", " ", "same", " ", "value", 
          " ", "under", " ", "the", " ", "new", " ", "key", " ", 
          RowBox[{"name", "."}]}]}]}]}]}]}]}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"KeyRename", "[", 
     RowBox[{"a_", ",", 
      RowBox[{"old_", "->", "new_"}]}], "]"}], "/;", 
    RowBox[{"KeyExistsQ", "[", 
     RowBox[{"a", ",", "old"}], "]"}]}], ":=", 
   RowBox[{
    RowBox[{"KeyDrop", "[", "old", "]"}], "@", 
    RowBox[{"Append", "[", 
     RowBox[{"a", ",", 
      RowBox[{"new", "->", 
       RowBox[{"a", "[", "old", "]"}]}]}], "]"}]}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9334128795442524`*^9, 3.933412887668431*^9}, {
  3.961496593189204*^9, 3.961496620651985*^9}},
 CellLabel->"In[54]:=",ExpressionUUID->"66325189-6cf6-465e-adbb-aabbbd247203"]
}, Closed]]
}, Open  ]]
},
WindowSize->{1167, 895},
WindowMargins->{{Automatic, -1732}, {Automatic, -1039}},
TaggingRules-><|"TryRealOnly" -> False|>,
FrontEndVersion->"13.2 for Mac OS X ARM (64-bit) (January 30, 2023)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"d7829ee7-b8f7-46af-811c-e5b3f7e78d95"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 1752, 25, 68, "Subtitle",ExpressionUUID->"5ed89776-d21c-4e98-9c6c-7fac37757c5a"],
Cell[2335, 49, 4198, 64, 518, "Text",ExpressionUUID->"817b3842-8789-4a43-8eaa-553f12d61677"],
Cell[CellGroupData[{
Cell[6558, 117, 1275, 20, 43, "Subsubsection",ExpressionUUID->"b8ac1c47-f94d-4380-b270-3098cd6f14c3"],
Cell[7836, 139, 1046, 25, 73, "Input",ExpressionUUID->"b39657be-9544-4ffb-90c7-6b7bf751051f"],
Cell[8885, 166, 595, 12, 52, "Input",ExpressionUUID->"e47c6931-5574-4043-9923-498be9c01ef4"],
Cell[9483, 180, 632, 12, 52, "Input",ExpressionUUID->"0d4ce933-d37a-4dcf-8e9d-64a72c4ce194"]
}, Closed]]
}, Open  ]],
Cell[CellGroupData[{
Cell[10164, 198, 1379, 20, 53, "Subtitle",ExpressionUUID->"07c07820-a8cb-4be4-ba1d-db0d1f98c9db"],
Cell[11546, 220, 784, 19, 73, "Input",ExpressionUUID->"1af6b969-00fc-411c-8dea-e2862d6aadba"],
Cell[12333, 241, 1984, 42, 94, "Input",ExpressionUUID->"7ba81ac7-a0f4-4009-9651-eb158c3b0d54"],
Cell[14320, 285, 1715, 41, 94, "Input",ExpressionUUID->"513b3646-c5d1-41d4-a8c1-125273d69dc8"],
Cell[16038, 328, 3670, 85, 178, "Input",ExpressionUUID->"e8b5eac9-3c01-4836-8abf-94b56b3b9b3b"],
Cell[19711, 415, 1736, 41, 94, "Input",ExpressionUUID->"166624bb-21ab-486c-bde7-09ee304fd3ca"]
}, Closed]],
Cell[CellGroupData[{
Cell[21484, 461, 486, 8, 53, "Subtitle",ExpressionUUID->"c67c0c38-1c91-462a-b556-a20ea0290db9"],
Cell[21973, 471, 1984, 52, 115, "Input",ExpressionUUID->"fbce3267-2c48-4aba-8e94-b49831e059e3"],
Cell[23960, 525, 8837, 181, 451, "Input",ExpressionUUID->"517f4ccb-9008-4719-9d87-24f863c06d14"]
}, Closed]],
Cell[CellGroupData[{
Cell[32834, 711, 500, 8, 53, "Subtitle",ExpressionUUID->"9beedf0b-c77e-41f7-87de-1ba51c63f2a3"],
Cell[33337, 721, 1406, 32, 73, "Input",ExpressionUUID->"d38a2dbc-454a-4df6-bdad-cf559458552a"],
Cell[34746, 755, 1438, 33, 94, "Input",ExpressionUUID->"d89ef00d-e4cf-4708-9988-2fac207ce7f5"],
Cell[36187, 790, 1152, 22, 73, "Input",ExpressionUUID->"a2136016-fc8c-40a8-8695-51e75935481f"],
Cell[37342, 814, 1967, 51, 136, "Input",ExpressionUUID->"c23c9f21-2454-4428-b6e3-fc111fcfeab7"],
Cell[39312, 867, 1568, 35, 73, "Input",ExpressionUUID->"f47b576d-69c2-44e5-8af8-adfe97d50bf1"],
Cell[40883, 904, 18889, 368, 1060, "Input",ExpressionUUID->"cc16824e-220f-41af-9b6f-2a71b7cde641"]
}, Closed]],
Cell[CellGroupData[{
Cell[59809, 1277, 587, 10, 53, "Subtitle",ExpressionUUID->"ef86ed98-ed0e-41b2-9130-c5284615441a"],
Cell[60399, 1289, 1271, 30, 73, "Input",ExpressionUUID->"053ca3c0-4f12-45b3-9a33-9ab80e5aabe4"],
Cell[61673, 1321, 920, 22, 52, "Input",ExpressionUUID->"40195b49-f13c-4b86-ad77-45bb617622be"],
Cell[62596, 1345, 2456, 55, 178, "Input",ExpressionUUID->"3997653e-29a3-4f4e-80af-8af97f19491f"],
Cell[65055, 1402, 981, 21, 52, "Input",ExpressionUUID->"74cf77bf-8b13-4046-9b62-8c7a4d5f61ed"],
Cell[66039, 1425, 1712, 38, 73, "Input",ExpressionUUID->"0924d4f4-f3b1-4f92-abf3-f16dc69b4398"],
Cell[67754, 1465, 1482, 34, 73, "Input",ExpressionUUID->"e393f7bd-07a8-450f-ae72-ffaefa484415"],
Cell[69239, 1501, 11680, 239, 871, "Input",ExpressionUUID->"806236d5-4db9-4034-b560-e02cda9fea8b"],
Cell[80922, 1742, 5658, 137, 325, "Input",ExpressionUUID->"b88fd2ee-7567-482b-82c0-c8b759680c08"],
Cell[86583, 1881, 2060, 49, 136, "Input",ExpressionUUID->"8dfcc14b-4404-4e79-9a96-76d1e855d628"]
}, Closed]],
Cell[CellGroupData[{
Cell[88680, 1935, 709, 11, 53, "Subtitle",ExpressionUUID->"68ef834e-4c19-4129-ad21-37f8d0e2166e"],
Cell[89392, 1948, 2299, 55, 115, "Input",ExpressionUUID->"edd0a86a-d92e-4a36-88c2-8542e41c4e20"],
Cell[91694, 2005, 1284, 24, 52, "Input",ExpressionUUID->"6faee354-432f-4dd2-9234-de704f7fba60"],
Cell[92981, 2031, 1027, 23, 73, "Input",ExpressionUUID->"d6cf7414-71d1-450e-9c0b-dd4c05b9c723"],
Cell[94011, 2056, 1261, 31, 73, "Input",ExpressionUUID->"5aed0ec9-de2e-4656-b58e-dc3fb34c1edf"],
Cell[95275, 2089, 5900, 132, 556, "Input",ExpressionUUID->"d1bc3eef-eea7-4797-b3a9-ae47fbbca2b7"],
Cell[101178, 2223, 1267, 32, 73, "Input",ExpressionUUID->"3d972c8b-de6a-498a-af7f-96d633a6016b"],
Cell[102448, 2257, 6420, 144, 598, "Input",ExpressionUUID->"79cfe75b-d75f-4a1a-a504-79ed09fb563e"],
Cell[108871, 2403, 5651, 132, 325, "Input",ExpressionUUID->"146dccab-1fe0-4017-8106-48169e097172"]
}, Closed]],
Cell[CellGroupData[{
Cell[114559, 2540, 538, 9, 53, "Subtitle",ExpressionUUID->"36a39720-2e12-4747-b06b-b6db4f5c5b90"],
Cell[115100, 2551, 3143, 56, 115, "Input",ExpressionUUID->"e28a3d0a-c3d3-43a4-b1e8-c537692e0685"],
Cell[118246, 2609, 1858, 35, 81, "Text",ExpressionUUID->"3c8c002b-d897-490c-a1a0-5dffd17f1b0a"],
Cell[120107, 2646, 706, 16, 52, "Input",ExpressionUUID->"6c586f73-a23a-4df4-aa5c-7c3de6ee67e8"],
Cell[120816, 2664, 1221, 31, 73, "Input",ExpressionUUID->"c8c5b91b-e3bb-4dc1-a066-5e9a205a96a8"]
}, Closed]],
Cell[CellGroupData[{
Cell[122074, 2700, 638, 10, 53, "Subtitle",ExpressionUUID->"e33843b0-8cd5-43f6-a2df-1f01adb03be9"],
Cell[122715, 2712, 1667, 36, 73, "Input",ExpressionUUID->"5342ae80-29f7-4b79-a782-f979635219f8"],
Cell[124385, 2750, 880, 21, 73, "Input",ExpressionUUID->"80c891b3-d7de-4368-a5a7-5e3c2154e6e0"],
Cell[125268, 2773, 1090, 22, 52, "Input",ExpressionUUID->"003d96e0-6241-4eef-9385-fc70c2778b93"],
Cell[126361, 2797, 1260, 34, 73, "Input",ExpressionUUID->"8a626119-c1e9-42d7-bdd4-eef520d605c2"],
Cell[127624, 2833, 1598, 36, 73, "Input",ExpressionUUID->"d49eb4f3-caaf-4648-a6af-0eb8cbfa2442"],
Cell[129225, 2871, 12809, 255, 724, "Input",ExpressionUUID->"a3f72262-4a11-4460-a5b2-b9ed7ae1521a"],
Cell[142037, 3128, 2200, 53, 115, "Input",ExpressionUUID->"e65f8261-a3ca-482a-ba9d-8e0234a317e0"],
Cell[144240, 3183, 1466, 37, 73, "Input",ExpressionUUID->"200ddaa2-eb0d-4aa0-8b61-66a25fc89b11"],
Cell[145709, 3222, 1427, 33, 73, "Input",ExpressionUUID->"997055a7-d0e8-47eb-b46d-c0cd6158cdb9"],
Cell[147139, 3257, 1111, 26, 52, "Input",ExpressionUUID->"f8bc7bfa-562a-4a4c-b22a-6989bb8a88e6"]
}, Closed]],
Cell[CellGroupData[{
Cell[148287, 3288, 553, 9, 53, "Subtitle",ExpressionUUID->"dd260183-d7e8-40a1-b44e-4b189156f773"],
Cell[148843, 3299, 1680, 36, 73, "Input",ExpressionUUID->"df7a0ea1-ee1e-42f3-a090-29f015c9148a"],
Cell[150526, 3337, 880, 21, 73, "Input",ExpressionUUID->"7c235dcf-305c-45f8-b2d0-eebc02aebb0a"],
Cell[151409, 3360, 1142, 23, 52, "Input",ExpressionUUID->"8eb974d8-412e-40f6-ac0f-8f99d9fde1f2"],
Cell[152554, 3385, 1308, 34, 73, "Input",ExpressionUUID->"ed2e60fe-8eb2-4490-9fab-83f70068c975"],
Cell[153865, 3421, 2465, 60, 241, "Input",ExpressionUUID->"79f079b9-b59c-425f-99d3-725e35ae11e0"],
Cell[156333, 3483, 1051, 25, 73, "Input",ExpressionUUID->"3fbac153-4ea3-48ab-9878-5415e842ebd0"],
Cell[157387, 3510, 4423, 86, 199, "Input",ExpressionUUID->"c01180ae-89c1-4da2-a63c-8d86b0b9c599"],
Cell[161813, 3598, 1244, 33, 73, "Input",ExpressionUUID->"dbfda469-8de6-4eb8-be0f-e38a341b567a"]
}, Closed]],
Cell[CellGroupData[{
Cell[163094, 3636, 612, 10, 53, "Subtitle",ExpressionUUID->"5d47f12a-30df-4b89-8298-a8c9e68b1fe7"],
Cell[163709, 3648, 1843, 44, 136, "Input",ExpressionUUID->"01351a9b-6802-45cc-9fe5-ca0aa547b698"],
Cell[165555, 3694, 2293, 57, 136, "Input",ExpressionUUID->"d7710ac5-52d1-42be-b0b2-ca9bac7a9799"],
Cell[167851, 3753, 5798, 91, 94, "Input",ExpressionUUID->"6de1e746-d5d3-4428-91ff-ace0c6e38fd3"],
Cell[173652, 3846, 1538, 28, 52, "Input",ExpressionUUID->"8725f7af-e302-4429-821d-8cc1e9c50d35"],
Cell[175193, 3876, 6494, 146, 556, "Input",ExpressionUUID->"4e0b063c-2210-4b8f-af16-3004228c1387"]
}, Closed]],
Cell[CellGroupData[{
Cell[181724, 4027, 608, 10, 53, "Subtitle",ExpressionUUID->"6f60c0b3-9822-4974-b90b-42b0618094f3"],
Cell[182335, 4039, 1864, 41, 94, "Input",ExpressionUUID->"14db4755-fa2a-4ac8-a8b5-c9f72f9bf272"],
Cell[184202, 4082, 3266, 59, 115, "Input",ExpressionUUID->"08bc8266-d436-433e-b90a-2c8622ac5fae"],
Cell[187471, 4143, 887, 24, 94, "Input",ExpressionUUID->"eea333cd-e8dd-4bdf-b53a-e9c93740231c"],
Cell[188361, 4169, 2300, 44, 94, "Input",ExpressionUUID->"4ea7e9b4-78c7-41c2-ba79-f08e9549cc34"],
Cell[190664, 4215, 3229, 58, 94, "Input",ExpressionUUID->"7e2d6fdc-ffa7-4c45-9ff3-75cf71b5e98a"],
Cell[193896, 4275, 994, 24, 52, "Input",ExpressionUUID->"49c6bc1b-0d40-4450-bf68-29de7e955eb0"],
Cell[194893, 4301, 2365, 60, 178, "Input",ExpressionUUID->"cd7c3dc5-ad45-4aba-ba51-2d9965237b6a"],
Cell[197261, 4363, 1657, 38, 94, "Input",ExpressionUUID->"7bc5ee36-e937-4c4c-8199-594ca3205afa"]
}, Closed]],
Cell[CellGroupData[{
Cell[198955, 4406, 624, 10, 53, "Subtitle",ExpressionUUID->"b0cc2099-e438-478c-8350-eed824b016fe"],
Cell[199582, 4418, 1155, 33, 94, "Input",ExpressionUUID->"da7f74db-540c-4e24-8d71-edcfcfc3ef5b"],
Cell[200740, 4453, 3364, 60, 115, "Input",ExpressionUUID->"f478c23f-f9dd-4171-998f-b9800faff8a0"],
Cell[204107, 4515, 1170, 25, 52, "Input",ExpressionUUID->"8c94445a-6148-4759-9e29-039f1db25ab2"],
Cell[205280, 4542, 2433, 63, 157, "Input",ExpressionUUID->"b346586a-4ea5-4f99-a48d-ac675d5cee9e"],
Cell[207716, 4607, 2647, 55, 136, "Input",ExpressionUUID->"2c3b7ca5-4908-4162-be53-1a663e725e02"],
Cell[210366, 4664, 1446, 37, 73, "Input",ExpressionUUID->"478a1aaf-b586-4cce-921b-026818658212"],
Cell[211815, 4703, 1051, 25, 73, "Input",ExpressionUUID->"a4f07034-0003-4e9b-aa63-d2f8ad5b6478"],
Cell[212869, 4730, 1178, 25, 52, "Input",ExpressionUUID->"ba47e437-c8ca-4930-a898-e66c226c5b70"],
Cell[214050, 4757, 2074, 49, 157, "Input",ExpressionUUID->"21916066-a37b-4072-8b9d-2f5476a98205"],
Cell[216127, 4808, 2584, 69, 178, "Input",ExpressionUUID->"ae6a6418-5e6c-4005-947c-1716abf7a394"],
Cell[218714, 4879, 780, 19, 52, "Input",ExpressionUUID->"af2cb664-e47b-4053-bd2f-6da0231b7b71"],
Cell[219497, 4900, 1485, 35, 73, "Input",ExpressionUUID->"fe54f940-f3d0-49d1-bd08-2ab988a617d9"],
Cell[220985, 4937, 7897, 163, 535, "Input",ExpressionUUID->"8aaf3241-445f-4230-a84b-69487cd609d9"],
Cell[228885, 5102, 2743, 62, 136, "Input",ExpressionUUID->"9737e175-73ec-4f54-a076-e2ddcc96e65a"],
Cell[231631, 5166, 1374, 36, 73, "Input",ExpressionUUID->"ce0dd666-569e-4bf0-850d-cbb92a45da0e"],
Cell[233008, 5204, 4410, 112, 304, "Input",ExpressionUUID->"ec59775e-cb76-474a-bb4b-d5c4c524841c"]
}, Closed]],
Cell[CellGroupData[{
Cell[237455, 5321, 1078, 16, 53, "Subtitle",ExpressionUUID->"b48c9232-109e-4eb3-9cef-598fdf8aa314"],
Cell[238536, 5339, 2151, 54, 136, "Input",ExpressionUUID->"00b302bb-3bfb-4e06-b49c-afb75a82a4e6"],
Cell[240690, 5395, 3318, 60, 115, "Input",ExpressionUUID->"adc4fda1-e852-4a65-8f46-fcfb5aa37e05"],
Cell[244011, 5457, 1217, 32, 52, "Input",ExpressionUUID->"7822cb52-00b8-4493-9e69-182815f65edd"],
Cell[245231, 5491, 15465, 336, 1102, "Input",ExpressionUUID->"8b0f05fb-4a38-44ab-817a-ede47bf811a5"],
Cell[260699, 5829, 2656, 67, 115, "Input",ExpressionUUID->"4bdef416-83b0-42e6-a2cd-7f091505708b"]
}, Closed]],
Cell[CellGroupData[{
Cell[263392, 5901, 655, 11, 53, "Subtitle",ExpressionUUID->"47cb4725-ddfd-4ca5-8d8a-284118a0d542"],
Cell[264050, 5914, 718, 16, 52, "Input",ExpressionUUID->"007bfe7b-311e-4b48-867e-3dd1afb7b0e5"],
Cell[264771, 5932, 3336, 59, 115, "Input",ExpressionUUID->"8126c39b-35f3-4d11-8ef0-7770464b09b2"],
Cell[268110, 5993, 824, 22, 73, "Input",ExpressionUUID->"844f4ff5-7dd1-42f8-9e7a-43530d5fd954"],
Cell[268937, 6017, 2753, 72, 157, "Input",ExpressionUUID->"50cbc3a9-b86e-4072-b9f8-5e0092e6721b"]
}, Closed]],
Cell[CellGroupData[{
Cell[271727, 6094, 762, 12, 53, "Subtitle",ExpressionUUID->"35764354-0ed4-4e3c-b435-57dfcc2d1b85"],
Cell[272492, 6108, 1318, 36, 94, "Input",ExpressionUUID->"b1a2fa47-b490-4eea-be46-153235da2a21"],
Cell[273813, 6146, 1301, 24, 52, "Input",ExpressionUUID->"2dd9e662-dfe1-4273-afd0-fe4ee02a85c8"],
Cell[275117, 6172, 1100, 25, 73, "Input",ExpressionUUID->"f79fc529-faed-4e61-b536-974dce8bf684"],
Cell[276220, 6199, 1321, 32, 73, "Input",ExpressionUUID->"abc60644-fe87-48a5-b307-ef5f289804a5"],
Cell[277544, 6233, 4453, 103, 346, "Input",ExpressionUUID->"4b1b0f62-df85-416a-b9cd-d5d5b2f973c2"],
Cell[282000, 6338, 1962, 50, 94, "Input",ExpressionUUID->"5adb02d9-faee-4715-bb72-7fc0ad0c3f83"],
Cell[283965, 6390, 2866, 69, 241, "Input",ExpressionUUID->"c7fd4385-0fd5-4b2d-86b2-6fc00612392c"],
Cell[286834, 6461, 1847, 45, 115, "Input",ExpressionUUID->"fbdb6ea5-cad9-4229-837c-98b641a26c97"]
}, Closed]],
Cell[CellGroupData[{
Cell[288718, 6511, 819, 13, 53, "Subtitle",ExpressionUUID->"32c0d81a-cfb0-4648-806f-7236740f5cda"],
Cell[289540, 6526, 613, 15, 70, "Input",ExpressionUUID->"6ecb6f85-afd5-4ff9-9232-2f520d795710"],
Cell[290156, 6543, 1345, 29, 70, "Input",ExpressionUUID->"d4194089-2db7-467a-9fa7-b1a0df52302f"]
}, Closed]],
Cell[CellGroupData[{
Cell[291538, 6577, 492, 7, 53, "Subtitle",ExpressionUUID->"b8ca7295-826f-4639-a233-d97c6cfae09d"],
Cell[CellGroupData[{
Cell[292055, 6588, 628, 10, 45, "Subsubsection",ExpressionUUID->"21ef4915-7f34-4cd9-83bc-0ecd98031d25"],
Cell[292686, 6600, 4432, 94, 70, "Input",ExpressionUUID->"d38b88b3-8a2a-42f0-bdaa-30b49f362185",
 InitializationCell->True],
Cell[297121, 6696, 4482, 104, 70, "Input",ExpressionUUID->"1aa24f51-52e8-4ec0-be5c-e4ca9053f3d0",
 InitializationCell->True],
Cell[301606, 6802, 2153, 53, 70, "Input",ExpressionUUID->"3fff1234-2fb3-4e71-91d4-f5354095eb42",
 InitializationCell->True],
Cell[303762, 6857, 9130, 202, 70, "Input",ExpressionUUID->"c757bde9-89ac-434f-ad41-2e7245335e0f",
 InitializationCell->True],
Cell[312895, 7061, 2957, 68, 70, "Input",ExpressionUUID->"2dac2235-d9e7-4ddf-9a96-bf81eae88d8c",
 InitializationCell->True],
Cell[315855, 7131, 14859, 326, 70, "Input",ExpressionUUID->"3ce88bf2-2ea1-4e73-9c48-9e5346b6f124",
 InitializationCell->True],
Cell[330717, 7459, 7027, 165, 70, "Input",ExpressionUUID->"0ca3d6c5-cf7e-484c-b76a-092e5fd96902",
 InitializationCell->True],
Cell[337747, 7626, 3962, 93, 70, "Input",ExpressionUUID->"30235d10-fb5b-4cee-b68d-3f7cc9b60979",
 InitializationCell->True],
Cell[341712, 7721, 8811, 201, 70, "Input",ExpressionUUID->"26c9d838-304a-46e0-8e13-41facd61f52f",
 InitializationCell->True],
Cell[350526, 7924, 10910, 251, 70, "Input",ExpressionUUID->"a0962fc2-ab06-4c3a-bc3c-e9054b96990c",
 InitializationCell->True],
Cell[361439, 8177, 5671, 130, 70, "Input",ExpressionUUID->"d5d05a87-4571-4326-92e8-687ebf13a5d9",
 InitializationCell->True],
Cell[367113, 8309, 73969, 1564, 70, "Input",ExpressionUUID->"fdda6242-8802-489e-a38c-d03859de3a15",
 InitializationCell->True],
Cell[441085, 9875, 2227, 51, 70, "Input",ExpressionUUID->"cb9052a6-acb4-4889-82b3-42f052bc70b4",
 InitializationCell->True],
Cell[443315, 9928, 2846, 55, 70, "Input",ExpressionUUID->"908b2675-b596-4674-a5d0-aa0f670a21a6",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[446198, 9988, 692, 10, 37, "Subsubsection",ExpressionUUID->"222abde2-5094-40e3-9495-1577c1c02ac8"],
Cell[446893, 10000, 5351, 130, 70, "Input",ExpressionUUID->"186a7356-b438-46a4-92ef-1b5e4cef4f3a",
 InitializationCell->True],
Cell[452247, 10132, 3148, 76, 70, "Input",ExpressionUUID->"03fdd8e9-7efb-4842-92d0-e36f107b3721",
 InitializationCell->True],
Cell[455398, 10210, 1865, 46, 70, "Input",ExpressionUUID->"fce45bd4-035b-4a78-9bd9-8047475fd65b",
 InitializationCell->True],
Cell[457266, 10258, 7882, 180, 70, "Input",ExpressionUUID->"21188de8-a9d6-4c9a-9bad-4776924be27b",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[465185, 10443, 692, 10, 37, "Subsubsection",ExpressionUUID->"a5ae03f5-8ce1-4fb5-9f1b-cad4c448a2ff"],
Cell[465880, 10455, 1944, 47, 70, "Input",ExpressionUUID->"20549d1e-b531-4974-b55f-47be8110fb92",
 InitializationCell->True],
Cell[467827, 10504, 1925, 49, 70, "Input",ExpressionUUID->"a2322915-85db-432a-94f2-ca27cca58df7",
 InitializationCell->True],
Cell[469755, 10555, 9669, 198, 70, "Input",ExpressionUUID->"d678b1c9-374c-4f38-8ab6-9c5f61ba93a1",
 InitializationCell->True],
Cell[479427, 10755, 4402, 96, 70, "Input",ExpressionUUID->"403f4ade-5328-497d-84b1-b2cb5b3b0d12",
 InitializationCell->True],
Cell[483832, 10853, 2899, 67, 70, "Input",ExpressionUUID->"cb31ae3c-b249-4f34-b942-0f6594e4b987",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[486768, 10925, 738, 11, 37, "Subsubsection",ExpressionUUID->"159fc013-7ea9-492f-95d4-619d9f6f997a"],
Cell[487509, 10938, 2603, 60, 70, "Input",ExpressionUUID->"d4f01026-3dc3-4cb4-9456-4ff24f2e92cb",
 InitializationCell->True],
Cell[490115, 11000, 2229, 54, 70, "Input",ExpressionUUID->"1112af70-1ecf-46a1-aa6e-716a8f537588",
 InitializationCell->True],
Cell[492347, 11056, 1890, 47, 70, "Input",ExpressionUUID->"66325189-6cf6-465e-adbb-aabbbd247203",
 InitializationCell->True]
}, Closed]]
}, Open  ]]
}
]
*)

